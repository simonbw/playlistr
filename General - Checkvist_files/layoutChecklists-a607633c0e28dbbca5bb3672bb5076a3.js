// Copyright (c) 2005-2010 Thomas Fuchs (http://script.aculo.us, http://mir.aculo.us)
// Contributors:
//  Justin Palmer (http://encytemedia.com/)
//  Mark Pilgrim (http://diveintomark.org/)
//  Martin Bialasinki
//
// script.aculo.us is freely distributable under the terms of an MIT-style license.
// For details, see the script.aculo.us web site: http://script.aculo.us/
// converts rgb() and #xxx to #xxxxxx format,
// returns self (or first argument) if not convertable
function maxkir_shareEmailSubmit(){maxkir.Share._on_send($("sendInvitationButton").form)}String.prototype.parseColor=function(){var a="#";if(this.slice(0,4)=="rgb("){var b=this.slice(4,this.length-1).split(","),c=0;do a+=parseInt(b[c]).toColorPart();while(++c<3)}else if(this.slice(0,1)=="#"){if(this.length==4)for(var c=1;c<4;c++)a+=(this.charAt(c)+this.charAt(c)).toLowerCase();this.length==7&&(a=this.toLowerCase())}return a.length==7?a:arguments[0]||this},Element.collectTextNodes=function(a){return $A($(a).childNodes).collect(function(a){return a.nodeType==3?a.nodeValue:a.hasChildNodes()?Element.collectTextNodes(a):""}).flatten().join("")},Element.collectTextNodesIgnoreClass=function(a,b){return $A($(a).childNodes).collect(function(a){return a.nodeType==3?a.nodeValue:a.hasChildNodes()&&!Element.hasClassName(a,b)?Element.collectTextNodesIgnoreClass(a,b):""}).flatten().join("")},Element.setContentZoom=function(a,b){return a=$(a),a.setStyle({fontSize:b/100+"em"}),Prototype.Browser.WebKit&&window.scrollBy(0,0),a},Element.getInlineOpacity=function(a){return $(a).style.opacity||""},Element.forceRerendering=function(a){try{a=$(a);var b=document.createTextNode(" ");a.appendChild(b),a.removeChild(b)}catch(c){}};var Effect={_elementDoesNotExistError:{name:"ElementDoesNotExistError",message:"The specified DOM element does not exist, but is required for this effect to operate"},Transitions:{linear:Prototype.K,sinoidal:function(a){return-Math.cos(a*Math.PI)/2+.5},reverse:function(a){return 1-a},flicker:function(a){var a=-Math.cos(a*Math.PI)/4+.75+Math.random()/4;return a>1?1:a},wobble:function(a){return-Math.cos(a*Math.PI*9*a)/2+.5},pulse:function(a,b){return-Math.cos(a*((b||5)-.5)*2*Math.PI)/2+.5},spring:function(a){return 1-Math.cos(a*4.5*Math.PI)*Math.exp(-a*6)},none:function(a){return 0},full:function(a){return 1}},DefaultOptions:{duration:1,fps:100,sync:!1,from:0,to:1,delay:0,queue:"parallel"},tagifyText:function(a){var b="position:relative";Prototype.Browser.IE&&(b+=";zoom:1"),a=$(a),$A(a.childNodes).each(function(c){c.nodeType==3&&(c.nodeValue.toArray().each(function(d){a.insertBefore((new Element("span",{style:b})).update(d==" "?String.fromCharCode(160):d),c)}),Element.remove(c))})},multiple:function(a,b){var c;(typeof a=="object"||Object.isFunction(a))&&a.length?c=a:c=$(a).childNodes;var d=Object.extend({speed:.1,delay:0},arguments[2]||{}),e=d.delay;$A(c).each(function(a,c){new b(a,Object.extend(d,{delay:c*d.speed+e}))})},PAIRS:{slide:["SlideDown","SlideUp"],blind:["BlindDown","BlindUp"],appear:["Appear","Fade"]},toggle:function(a,b,c){return a=$(a),b=(b||"appear").toLowerCase(),Effect[Effect.PAIRS[b][a.visible()?1:0]](a,Object.extend({queue:{position:"end",scope:a.id||"global",limit:1}},c||{}))}};Effect.DefaultOptions.transition=Effect.Transitions.sinoidal,Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[],this.interval=null},_each:function(a){this.effects._each(a)},add:function(a){var b=(new Date).getTime(),c=Object.isString(a.options.queue)?a.options.queue:a.options.queue.position;switch(c){case"front":this.effects.findAll(function(a){return a.state=="idle"}).each(function(b){b.startOn+=a.finishOn,b.finishOn+=a.finishOn});break;case"with-last":b=this.effects.pluck("startOn").max()||b;break;case"end":b=this.effects.pluck("finishOn").max()||b}a.startOn+=b,a.finishOn+=b,(!a.options.queue.limit||this.effects.length<a.options.queue.limit)&&this.effects.push(a),this.interval||(this.interval=setInterval(this.loop.bind(this),15))},remove:function(a){this.effects=this.effects.reject(function(b){return b==a}),this.effects.length==0&&(clearInterval(this.interval),this.interval=null)},loop:function(){var a=(new Date).getTime();for(var b=0,c=this.effects.length;b<c;b++)this.effects[b]&&this.effects[b].loop(a)}}),Effect.Queues={instances:$H(),get:function(a){return Object.isString(a)?this.instances.get(a)||this.instances.set(a,new Effect.ScopedQueue):a}},Effect.Queue=Effect.Queues.get("global"),Effect.Base=Class.create({position:null,start:function(a){a&&a.transition===!1&&(a.transition=Effect.Transitions.linear),this.options=Object.extend(Object.extend({},Effect.DefaultOptions),a||{}),this.currentFrame=0,this.state="idle",this.startOn=this.options.delay*1e3,this.finishOn=this.startOn+this.options.duration*1e3,this.fromToDelta=this.options.to-this.options.from,this.totalTime=this.finishOn-this.startOn,this.totalFrames=this.options.fps*this.options.duration,this.render=function(){function a(a,b){a.options[b+"Internal"]&&a.options[b+"Internal"](a),a.options[b]&&a.options[b](a)}return function(b){this.state==="idle"&&(this.state="running",a(this,"beforeSetup"),this.setup&&this.setup(),a(this,"afterSetup")),this.state==="running"&&(b=this.options.transition(b)*this.fromToDelta+this.options.from,this.position=b,a(this,"beforeUpdate"),this.update&&this.update(b),a(this,"afterUpdate"))}}(),this.event("beforeStart"),this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).add(this)},loop:function(a){if(a>=this.startOn){if(a>=this.finishOn){this.render(1),this.cancel(),this.event("beforeFinish"),this.finish&&this.finish(),this.event("afterFinish");return}var b=(a-this.startOn)/this.totalTime,c=(b*this.totalFrames).round();c>this.currentFrame&&(this.render(b),this.currentFrame=c)}},cancel:function(){this.options.sync||Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).remove(this),this.state="finished"},event:function(a){this.options[a+"Internal"]&&this.options[a+"Internal"](this),this.options[a]&&this.options[a](this)},inspect:function(){var a=$H();for(property in this)Object.isFunction(this[property])||a.set(property,this[property]);return"#<Effect:"+a.inspect()+",options:"+$H(this.options).inspect()+">"}}),Effect.Parallel=Class.create(Effect.Base,{initialize:function(a){this.effects=a||[],this.start(arguments[1])},update:function(a){this.effects.invoke("render",a)},finish:function(a){this.effects.each(function(b){b.render(1),b.cancel(),b.event("beforeFinish"),b.finish&&b.finish(a),b.event("afterFinish")})}}),Effect.Tween=Class.create(Effect.Base,{initialize:function(a,b,c){a=Object.isString(a)?$(a):a;var d=$A(arguments),e=d.last(),f=d.length==5?d[3]:null;this.method=Object.isFunction(e)?e.bind(a):Object.isFunction(a[e])?a[e].bind(a):function(b){a[e]=b},this.start(Object.extend({from:b,to:c},f||{}))},update:function(a){this.method(a)}}),Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}))},update:Prototype.emptyFunction}),Effect.Opacity=Class.create(Effect.Base,{initialize:function(a){this.element=$(a);if(!this.element)throw Effect._elementDoesNotExistError;Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});var b=Object.extend({from:this.element.getOpacity()||0,to:1},arguments[1]||{});this.start(b)},update:function(a){this.element.setOpacity(a)}}),Effect.Move=Class.create(Effect.Base,{initialize:function(a){this.element=$(a);if(!this.element)throw Effect._elementDoesNotExistError;var b=Object.extend({x:0,y:0,mode:"relative"},arguments[1]||{});this.start(b)},setup:function(){this.element.makePositioned(),this.originalLeft=parseFloat(this.element.getStyle("left")||"0"),this.originalTop=parseFloat(this.element.getStyle("top")||"0"),this.options.mode=="absolute"&&(this.options.x=this.options.x-this.originalLeft,this.options.y=this.options.y-this.originalTop)},update:function(a){this.element.setStyle({left:(this.options.x*a+this.originalLeft).round()+"px",top:(this.options.y*a+this.originalTop).round()+"px"})}}),Effect.MoveBy=function(a,b,c){return new Effect.Move(a,Object.extend({x:c,y:b},arguments[3]||{}))},Effect.Scale=Class.create(Effect.Base,{initialize:function(a,b){this.element=$(a);if(!this.element)throw Effect._elementDoesNotExistError;var c=Object.extend({scaleX:!0,scaleY:!0,scaleContent:!0,scaleFromCenter:!1,scaleMode:"box",scaleFrom:100,scaleTo:b},arguments[2]||{});this.start(c)},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||!1,this.elementPositioning=this.element.getStyle("position"),this.originalStyle={},["top","left","width","height","fontSize"].each(function(a){this.originalStyle[a]=this.element.style[a]}.bind(this)),this.originalTop=this.element.offsetTop,this.originalLeft=this.element.offsetLeft;var a=this.element.getStyle("font-size")||"100%";["em","px","%","pt"].each(function(b){a.indexOf(b)>0&&(this.fontSize=parseFloat(a),this.fontSizeType=b)}.bind(this)),this.factor=(this.options.scaleTo-this.options.scaleFrom)/100,this.dims=null,this.options.scaleMode=="box"&&(this.dims=[this.element.offsetHeight,this.element.offsetWidth]),/^content/.test(this.options.scaleMode)&&(this.dims=[this.element.scrollHeight,this.element.scrollWidth]),this.dims||(this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth])},update:function(a){var b=this.options.scaleFrom/100+this.factor*a;this.options.scaleContent&&this.fontSize&&this.element.setStyle({fontSize:this.fontSize*b+this.fontSizeType}),this.setDimensions(this.dims[0]*b,this.dims[1]*b)},finish:function(a){this.restoreAfterFinish&&this.element.setStyle(this.originalStyle)},setDimensions:function(a,b){var c={};this.options.scaleX&&(c.width=b.round()+"px"),this.options.scaleY&&(c.height=a.round()+"px");if(this.options.scaleFromCenter){var d=(a-this.dims[0])/2,e=(b-this.dims[1])/2;this.elementPositioning=="absolute"?(this.options.scaleY&&(c.top=this.originalTop-d+"px"),this.options.scaleX&&(c.left=this.originalLeft-e+"px")):(this.options.scaleY&&(c.top=-d+"px"),this.options.scaleX&&(c.left=-e+"px"))}this.element.setStyle(c)}}),Effect.Highlight=Class.create(Effect.Base,{initialize:function(a){this.element=$(a);if(!this.element)throw Effect._elementDoesNotExistError;var b=Object.extend({startcolor:"#ffff99"},arguments[1]||{});this.start(b)},setup:function(){if(this.element.getStyle("display")=="none"){this.cancel();return}this.oldStyle={},this.options.keepBackgroundImage||(this.oldStyle.backgroundImage=this.element.getStyle("background-image"),this.element.setStyle({backgroundImage:"none"})),this.options.endcolor||(this.options.endcolor=this.element.getStyle("background-color").parseColor("#ffffff")),this.options.restorecolor||(this.options.restorecolor=this.element.style.backgroundColor||""),this._base=$R(0,2).map(function(a){return parseInt(this.options.startcolor.slice(a*2+1,a*2+3),16)}.bind(this)),this._delta=$R(0,2).map(function(a){return parseInt(this.options.endcolor.slice(a*2+1,a*2+3),16)-this._base[a]}.bind(this))},update:function(a){this.element.setStyle({backgroundColor:$R(0,2).inject("#",function(b,c,d){return b+(this._base[d]+this._delta[d]*a).round().toColorPart()}.bind(this))})},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}))}}),Effect.ScrollTo=function(a){var b=arguments[1]||{},c=document.viewport.getScrollOffsets(),d=$(a).cumulativeOffset();return b.offset&&(d[1]+=b.offset),new Effect.Tween(null,c.top,d[1],b,function(a){scrollTo(c.left,a.round())})},Effect.Fade=function(a){a=$(a);var b=a.getInlineOpacity(),c=Object.extend({from:a.getOpacity()||1,to:0,afterFinishInternal:function(a){if(a.options.to!=0)return;a.element.hide().setStyle({opacity:b})}},arguments[1]||{});return new Effect.Opacity(a,c)},Effect.Appear=function(a){a=$(a);var b=Object.extend({from:a.getStyle("display")=="none"?0:a.getOpacity()||0,to:1,afterFinishInternal:function(a){a.element.forceRerendering()},beforeSetup:function(a){a.element.setOpacity(a.options.from).show()}},arguments[1]||{});return new Effect.Opacity(a,b)},Effect.Puff=function(a){a=$(a);var b={opacity:a.getInlineOpacity(),position:a.getStyle("position"),top:a.style.top,left:a.style.left,width:a.style.width,height:a.style.height};return new Effect.Parallel([new Effect.Scale(a,200,{sync:!0,scaleFromCenter:!0,scaleContent:!0,restoreAfterFinish:!0}),new Effect.Opacity(a,{sync:!0,to:0})],Object.extend({duration:1,beforeSetupInternal:function(a){Position.absolutize(a.effects[0].element)},afterFinishInternal:function(a){a.effects[0].element.hide().setStyle(b)}},arguments[1]||{}))},Effect.BlindUp=function(a){return a=$(a),a.makeClipping(),new Effect.Scale(a,0,Object.extend({scaleContent:!1,scaleX:!1,restoreAfterFinish:!0,afterFinishInternal:function(a){a.element.hide().undoClipping()}},arguments[1]||{}))},Effect.BlindDown=function(a){a=$(a);var b=a.getDimensions();return new Effect.Scale(a,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:0,scaleMode:{originalHeight:b.height,originalWidth:b.width},restoreAfterFinish:!0,afterSetup:function(a){a.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(a){a.element.undoClipping()}},arguments[1]||{}))},Effect.SwitchOff=function(a){a=$(a);var b=a.getInlineOpacity();return new Effect.Appear(a,Object.extend({duration:.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(a){new Effect.Scale(a.element,1,{duration:.3,scaleFromCenter:!0,scaleX:!1,scaleContent:!1,restoreAfterFinish:!0,beforeSetup:function(a){a.element.makePositioned().makeClipping()},afterFinishInternal:function(a){a.element.hide().undoClipping().undoPositioned().setStyle({opacity:b})}})}},arguments[1]||{}))},Effect.DropOut=function(a){a=$(a);var b={top:a.getStyle("top"),left:a.getStyle("left"),opacity:a.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(a,{x:0,y:100,sync:!0}),new Effect.Opacity(a,{sync:!0,to:0})],Object.extend({duration:.5,beforeSetup:function(a){a.effects[0].element.makePositioned()},afterFinishInternal:function(a){a.effects[0].element.hide().undoPositioned().setStyle(b)}},arguments[1]||{}))},Effect.Shake=function(a){a=$(a);var b=Object.extend({distance:20,duration:.5},arguments[1]||{}),c=parseFloat(b.distance),d=parseFloat(b.duration)/10,e={top:a.getStyle("top"),left:a.getStyle("left")};return new Effect.Move(a,{x:c,y:0,duration:d,afterFinishInternal:function(a){new Effect.Move(a.element,{x:-c*2,y:0,duration:d*2,afterFinishInternal:function(a){new Effect.Move(a.element,{x:c*2,y:0,duration:d*2,afterFinishInternal:function(a){new Effect.Move(a.element,{x:-c*2,y:0,duration:d*2,afterFinishInternal:function(a){new Effect.Move(a.element,{x:c*2,y:0,duration:d*2,afterFinishInternal:function(a){new Effect.Move(a.element,{x:-c,y:0,duration:d,afterFinishInternal:function(a){a.element.undoPositioned().setStyle(e)}})}})}})}})}})}})},Effect.SlideDown=function(a){a=$(a).cleanWhitespace();var b=a.down().getStyle("bottom"),c=a.getDimensions();return new Effect.Scale(a,100,Object.extend({scaleContent:!1,scaleX:!1,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:c.height,originalWidth:c.width},restoreAfterFinish:!0,afterSetup:function(a){a.element.makePositioned(),a.element.down().makePositioned(),window.opera&&a.element.setStyle({top:""}),a.element.makeClipping().setStyle({height:"0px"}).show()},afterUpdateInternal:function(a){a.element.down().setStyle({bottom:a.dims[0]-a.element.clientHeight+"px"})},afterFinishInternal:function(a){a.element.undoClipping().undoPositioned(),a.element.down().undoPositioned().setStyle({bottom:b})}},arguments[1]||{}))},Effect.SlideUp=function(a){a=$(a).cleanWhitespace();var b=a.down().getStyle("bottom"),c=a.getDimensions();return new Effect.Scale(a,window.opera?0:1,Object.extend({scaleContent:!1,scaleX:!1,scaleMode:"box",scaleFrom:100,scaleMode:{originalHeight:c.height,originalWidth:c.width},restoreAfterFinish:!0,afterSetup:function(a){a.element.makePositioned(),a.element.down().makePositioned(),window.opera&&a.element.setStyle({top:""}),a.element.makeClipping().show()},afterUpdateInternal:function(a){a.element.down().setStyle({bottom:a.dims[0]-a.element.clientHeight+"px"})},afterFinishInternal:function(a){a.element.hide().undoClipping().undoPositioned(),a.element.down().undoPositioned().setStyle({bottom:b})}},arguments[1]||{}))},Effect.Squish=function(a){return new Effect.Scale(a,window.opera?1:0,{restoreAfterFinish:!0,beforeSetup:function(a){a.element.makeClipping()},afterFinishInternal:function(a){a.element.hide().undoClipping()}})},Effect.Grow=function(a){a=$(a);var b=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{}),c={top:a.style.top,left:a.style.left,height:a.style.height,width:a.style.width,opacity:a.getInlineOpacity()},d=a.getDimensions(),e,f,g,h;switch(b.direction){case"top-left":e=f=g=h=0;break;case"top-right":e=d.width,f=h=0,g=-d.width;break;case"bottom-left":e=g=0,f=d.height,h=-d.height;break;case"bottom-right":e=d.width,f=d.height,g=-d.width,h=-d.height;break;case"center":e=d.width/2,f=d.height/2,g=-d.width/2,h=-d.height/2}return new Effect.Move(a,{x:e,y:f,duration:.01,beforeSetup:function(a){a.element.hide().makeClipping().makePositioned()},afterFinishInternal:function(a){new Effect.Parallel([new Effect.Opacity(a.element,{sync:!0,to:1,from:0,transition:b.opacityTransition}),new Effect.Move(a.element,{x:g,y:h,sync:!0,transition:b.moveTransition}),new Effect.Scale(a.element,100,{scaleMode:{originalHeight:d.height,originalWidth:d.width},sync:!0,scaleFrom:window.opera?1:0,transition:b.scaleTransition,restoreAfterFinish:!0})],Object.extend({beforeSetup:function(a){a.effects[0].element.setStyle({height:"0px"}).show()},afterFinishInternal:function(a){a.effects[0].element.undoClipping().undoPositioned().setStyle(c)}},b))}})},Effect.Shrink=function(a){a=$(a);var b=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{}),c={top:a.style.top,left:a.style.left,height:a.style.height,width:a.style.width,opacity:a.getInlineOpacity()},d=a.getDimensions(),e,f;switch(b.direction){case"top-left":e=f=0;break;case"top-right":e=d.width,f=0;break;case"bottom-left":e=0,f=d.height;break;case"bottom-right":e=d.width,f=d.height;break;case"center":e=d.width/2,f=d.height/2}return new Effect.Parallel([new Effect.Opacity(a,{sync:!0,to:0,from:1,transition:b.opacityTransition}),new Effect.Scale(a,window.opera?1:0,{sync:!0,transition:b.scaleTransition,restoreAfterFinish:!0}),new Effect.Move(a,{x:e,y:f,sync:!0,transition:b.moveTransition})],Object.extend({beforeStartInternal:function(a){a.effects[0].element.makePositioned().makeClipping()},afterFinishInternal:function(a){a.effects[0].element.hide().undoClipping().undoPositioned().setStyle(c)}},b))},Effect.Pulsate=function(a){a=$(a);var b=arguments[1]||{},c=a.getInlineOpacity(),d=b.transition||Effect.Transitions.linear,e=function(a){return 1-d(-Math.cos(a*(b.pulses||5)*2*Math.PI)/2+.5)};return new Effect.Opacity(a,Object.extend(Object.extend({duration:2,from:0,afterFinishInternal:function(a){a.element.setStyle({opacity:c})}},b),{transition:e}))},Effect.Fold=function(a){a=$(a);var b={top:a.style.top,left:a.style.left,width:a.style.width,height:a.style.height};return a.makeClipping(),new Effect.Scale(a,5,Object.extend({scaleContent:!1,scaleX:!1,afterFinishInternal:function(c){new Effect.Scale(a,1,{scaleContent:!1,scaleY:!1,afterFinishInternal:function(a){a.element.hide().undoClipping().setStyle(b)}})}},arguments[1]||{}))},Effect.Morph=Class.create(Effect.Base,{initialize:function(a){this.element=$(a);if(!this.element)throw Effect._elementDoesNotExistError;var b=Object.extend({style:{}},arguments[1]||{});if(!Object.isString(b.style))this.style=$H(b.style);else if(b.style.include(":"))this.style=b.style.parseStyle();else{this.element.addClassName(b.style),this.style=$H(this.element.getStyles()),this.element.removeClassName(b.style);var c=this.element.getStyles();this.style=this.style.reject(function(a){return a.value==c[a.key]}),b.afterFinishInternal=function(a){a.element.addClassName(a.options.style),a.transforms.each(function(b){a.element.style[b.style]=""})}}this.start(b)},setup:function(){function a(a){if(!a||["rgba(0, 0, 0, 0)","transparent"].include(a))a="#ffffff";return a=a.parseColor(),$R(0,2).map(function(b){return parseInt(a.slice(b*2+1,b*2+3),16)})}this.transforms=this.style.map(function(b){var c=b[0],d=b[1],e=null;if(d.parseColor("#zzzzzz")!="#zzzzzz")d=d.parseColor(),e="color";else if(c=="opacity")d=parseFloat(d),Prototype.Browser.IE&&!this.element.currentStyle.hasLayout&&this.element.setStyle({zoom:1});else if(Element.CSS_LENGTH.test(d)){var f=d.match(/^([\+\-]?[0-9\.]+)(.*)$/);d=parseFloat(f[1]),e=f.length==3?f[2]:null}var g=this.element.getStyle(c);return{style:c.camelize(),originalValue:e=="color"?a(g):parseFloat(g||0),targetValue:e=="color"?a(d):d,unit:e}}.bind(this)).reject(function(a){return a.originalValue==a.targetValue||a.unit!="color"&&(isNaN(a.originalValue)||isNaN(a.targetValue))})},update:function(a){var b={},c,d=this.transforms.length;while(d--)b[(c=this.transforms[d]).style]=c.unit=="color"?"#"+Math.round(c.originalValue[0]+(c.targetValue[0]-c.originalValue[0])*a).toColorPart()+Math.round(c.originalValue[1]+(c.targetValue[1]-c.originalValue[1])*a).toColorPart()+Math.round(c.originalValue[2]+(c.targetValue[2]-c.originalValue[2])*a).toColorPart():(c.originalValue+(c.targetValue-c.originalValue)*a).toFixed(3)+(c.unit===null?"":c.unit);this.element.setStyle(b,!0)}}),Effect.Transform=Class.create({initialize:function(a){this.tracks=[],this.options=arguments[1]||{},this.addTracks(a)},addTracks:function(a){return a.each(function(a){a=$H(a);var b=a.values().first();this.tracks.push($H({ids:a.keys().first(),effect:Effect.Morph,options:{style:b}}))}.bind(this)),this},play:function(){return new Effect.Parallel(this.tracks.map(function(a){var b=a.get("ids"),c=a.get("effect"),d=a.get("options"),e=[$(b)||$$(b)].flatten();return e.map(function(a){return new c(a,Object.extend({sync:!0},d))})}).flatten(),this.options)}}),Element.CSS_PROPERTIES=$w("backgroundColor backgroundPosition borderBottomColor borderBottomStyle borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth borderRightColor borderRightStyle borderRightWidth borderSpacing borderTopColor borderTopStyle borderTopWidth bottom clip color fontSize fontWeight height left letterSpacing lineHeight marginBottom marginLeft marginRight marginTop markerOffset maxHeight maxWidth minHeight minWidth opacity outlineColor outlineOffset outlineWidth paddingBottom paddingLeft paddingRight paddingTop right textIndent top width wordSpacing zIndex"),Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/,String.__parseStyleElement=document.createElement("div"),String.prototype.parseStyle=function(){var a,b=$H();return Prototype.Browser.WebKit?a=(new Element("div",{style:this})).style:(String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>',a=String.__parseStyleElement.childNodes[0].style),Element.CSS_PROPERTIES.each(function(c){a[c]&&b.set(c,a[c])}),Prototype.Browser.IE&&this.include("opacity")&&b.set("opacity",this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1]),b},document.defaultView&&document.defaultView.getComputedStyle?Element.getStyles=function(a){var b=document.defaultView.getComputedStyle($(a),null);return Element.CSS_PROPERTIES.inject({},function(a,c){return a[c]=b[c],a})}:Element.getStyles=function(a){a=$(a);var b=a.currentStyle,c;return c=Element.CSS_PROPERTIES.inject({},function(a,c){return a[c]=b[c],a}),c.opacity||(c.opacity=a.getOpacity()),c},Effect.Methods={morph:function(a,b){return a=$(a),new Effect.Morph(a,Object.extend({style:b},arguments[2]||{})),a},visualEffect:function(a,b,c){a=$(a);var d=b.dasherize().camelize(),e=d.charAt(0).toUpperCase()+d.substring(1);return new Effect[e](a,c),a},highlight:function(a,b){return a=$(a),new Effect.Highlight(a,b),a}},$w("fade appear grow shrink fold blindUp blindDown slideUp slideDown pulsate shake puff squish switchOff dropOut").each(function(a){Effect.Methods[a]=function(b,c){return b=$(b),Effect[a.charAt(0).toUpperCase()+a.substring(1)](b,c),b}}),$w("getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles").each(function(a){Effect.Methods[a]=Element[a]}),Element.addMethods(Effect.Methods);if(typeof Effect=="undefined")throw"controls.js requires including script.aculo.us' effects.js library";var Autocompleter={};Autocompleter.Base=Class.create({baseInitialize:function(a,b,c){a=$(a),this.element=a,this.update=$(b),this.hasFocus=!1,this.changed=!1,this.active=!1,this.index=0,this.entryCount=0,this.oldElementValue=this.element.value,this.setOptions?this.setOptions(c):this.options=c||{},this.options.listItemsSelector=this.options.listItemsSelector||"ul li",this.options.paramName=this.options.paramName||this.element.name,this.options.tokens=this.options.tokens||[],this.options.frequency=this.options.frequency||.4,this.options.minChars=this.options.minChars||1,this.options.onShow=this.options.onShow||this.defaultOnShow,this.options.onHide=this.options.onHide||this.defaultOnHide,this.options.updateElement=this.options.updateElement||this.defaultUpdateElement,typeof this.options.tokens=="string"&&(this.options.tokens=Array(this.options.tokens)),this.options.tokens.include("\n")||this.options.tokens.push("\n"),this.observer=null,this.element.setAttribute("autocomplete","off"),Element.hide(this.update),this._observers=[],this._observers.push(this.element.on("blur",this.onBlur.bind(this))),this._observers.push(this.element.on("keydown",this.onKeyDown.bind(this))),this._observers.push(this.update.on("mouseover",this.options.listItemsSelector,this.onHover.bind(this))),this._observers.push(this.update.on("click",this.options.listItemsSelector,this.onClick.bind(this)))},dispose:function(){this._observers.each(function(a){a.stop()}),this._observers=[]},show:function(){if(this.active)return;this.active=!0,Element.getStyle(this.update,"display")=="none"&&this.options.onShow(this.element,this.update),!this.iefix&&Prototype.Browser.IE&&Element.getStyle(this.update,"position")=="absolute"&&(new Insertion.After(this.update,'<iframe id="'+this.update.id+'_iefix" '+'style="display:none;position:absolute;filter:progid:DXImageTransform.Microsoft.Alpha(opacity=0);" '+'src="javascript:false;" frameborder="0" scrolling="no"></iframe>'),this.iefix=$(this.update.id+"_iefix")),this.iefix&&setTimeout(this.fixIEOverlapping.bind(this),50)},fixIEOverlapping:function(){Position.clone(this.update,this.iefix,{setTop:!this.update.style.height});var a=this.update.getStyle("z-index")||2;this.iefix.style.zIndex=a,this.update.style.zIndex=a+1,Element.show(this.iefix)},defaultOnShow:function(a,b){if(!b.style.position||b.style.position=="absolute")b.style.position="absolute",Position.clone(a,b,{setHeight:!1,offsetTop:a.offsetHeight});Effect.Appear(b,{duration:.15})},hide:function(){this.observer&&clearTimeout(this.observer),this.stopIndicator(),Element.getStyle(this.update,"display")!="none"&&this.options.onHide(this.element,this.update),this.iefix&&Element.hide(this.iefix),this.active=!1},defaultOnHide:function(a,b){new Effect.Fade(b,{duration:.15})},startIndicator:function(){this.options.indicator&&Element.show(this.options.indicator)},stopIndicator:function(){this.options.indicator&&Element.hide(this.options.indicator)},onKeyDown:function(a){if(this.active)switch(a.keyCode){case Event.KEY_TAB:case Event.KEY_RETURN:this.selectEntry()&&Event.stop(a);return;case Event.KEY_ESC:this.hide(),Event.stop(a);return;case Event.KEY_LEFT:case Event.KEY_RIGHT:this.triggerCompletion();return;case Event.KEY_UP:this.markPrevious(),this.render(),Event.stop(a);return;case Event.KEY_DOWN:this.markNext(),this.render(),Event.stop(a);return}else if(a.keyCode==Event.KEY_TAB||a.keyCode==Event.KEY_RETURN||a.keyCode==Event.KEY_ESC||a.keyCode==Event.KEY_UP||a.keyCode==Event.KEY_DOWN||Prototype.Browser.WebKit>0&&a.keyCode==0)return;this.changed=!0,this.hasFocus=!0,this.triggerCompletion()},triggerCompletion:function(){this.observer&&clearTimeout(this.observer),this.observer=setTimeout(this.onObserverEvent.bind(this),this.options.frequency*1e3)},activate:function(){this.changed=!1,this.hasFocus=!0,this.getUpdatedChoices()},onHover:function(a){if(!this.active)return;var b=Event.findElement(a,"LI");this.index!=b.autocompleteIndex&&(this.index=b.autocompleteIndex,this.render()),Event.stop(a)},onClick:function(a){if(!this.active)return;var b=Event.findElement(a,"LI");this.index=b.autocompleteIndex,this.selectEntry(),Event.stop(a)},onBlur:function(){setTimeout(function(){this.active&&this.hide()}.bind(this),250),this.hasFocus=!1},render:function(){if(this.entryCount>0){var a=this.entries();for(var b=0;b<this.entryCount;b++)a[b][this.index==b?"addClassName":"removeClassName"]("selected");this.hasFocus&&this.show()}else this.hide()},markPrevious:function(){this.index>0?this.index--:this.index=this.entryCount-1,this.getEntry(this.index).scrollIntoView(!1)},markNext:function(){this.index<this.entryCount-1?this.index++:this.index=0,this.getEntry(this.index).scrollIntoView(!1)},getEntry:function(a){return this.entries()[a]},entries:function(){return this.update.select(this.options.listItemsSelector)},getCurrentEntry:function(){return this.index>=0?this.getEntry(this.index):null},selectEntry:function(){this.onObserverEvent();var a=this.updateElement();return this.hide(),a},updateElement:function(){var a=this.getCurrentEntry();return a?(this.options.updateElement.call(this,a),this.oldElementValue=this.element.value,this.element.focus(),this.options.afterUpdateElement&&this.options.afterUpdateElement(this.element,a),!0):!1},defaultUpdateElement:function(a){if(!a)return;var b="";if(this.options.select){var c=$(a).select("."+this.options.select)||[];c.length>0&&(b=Element.collectTextNodes(c[0],this.options.select))}else b=Element.collectTextNodesIgnoreClass(a,"informal");this.replaceTokenWith(b)},replaceTokenWith:function(a){var b=this.getTokenBounds();if(b[0]!=-1){var c=this.element.value.substr(0,b[0]),d=this.element.value.substr(b[0]).match(/^\s+/);d&&(c+=d[0]),this.element.value=c+a+this.element.value.substr(b[1])}else this.element.value=a},updateChoices:function(a){if(!this.changed&&this.hasFocus&&this.update.innerHTML!=a){this.update.innerHTML=a;var b=this.entries();if(b){this.entryCount=b.length;for(var c=0;c<this.entryCount;c++)b[c].autocompleteIndex=c}else this.entryCount=0;this.stopIndicator(),this.index>=this.entryCount&&(this.index=0),this.entryCount==1&&this.options.autoSelect?this.selectEntry():this.render()}},onObserverEvent:function(){this.changed=!1,this.tokenBounds=null,this.getToken().length>=this.options.minChars?this.getUpdatedChoices():this.hide(),this.oldElementValue=this.element.value},getToken:function(){var a=this.getTokenBounds();return this.element.value.substring(a[0],a[1]).strip()},getTokenBounds:function(){if(null!=this.tokenBounds)return this.tokenBounds;var a=this.element.value;if(a.strip().empty())return[-1,0];var b=this.getFirstDifferencePos(a,this.oldElementValue),c=b==this.oldElementValue.length?1:0,d=-1,e=a.length,f;for(var g=0,h=this.options.tokens.length;g<h;++g)f=a.lastIndexOf(this.options.tokens[g],b+c-1),f>d&&(d=f),f=a.indexOf(this.options.tokens[g],b+c),-1!=f&&f<e&&(e=f);return this.tokenBounds=[d+1,e]},getFirstDifferencePos:function(a,b){var c=Math.min(a.length,b.length);for(var d=0;d<c;++d)if(a[d]!=b[d])return d;return c},_f:null}),Ajax.Autocompleter=Class.create(Autocompleter.Base,{initialize:function(a,b,c,d){this.baseInitialize(a,b,d),this.options.asynchronous=!0,this.options.onComplete=this.onComplete.bind(this),this.options.defaultParams=this.options.parameters||null,this.url=c},getUpdatedChoices:function(){this.startIndicator();var a=encodeURIComponent(this.options.paramName)+"="+encodeURIComponent(this.getToken());this.options.parameters=this.options.callback?this.options.callback(this.element,a):a,this.options.defaultParams&&(this.options.parameters+="&"+this.options.defaultParams),new Ajax.Request(this.url,this.options)},onComplete:function(a){this.updateChoices(a.responseText)}}),Autocompleter.Local=Class.create(Autocompleter.Base,{initialize:function(a,b,c,d){this.baseInitialize(a,b,d),this.options.array=c},getUpdatedChoices:function(){this.updateChoices(this.options.selector(this))},setOptions:function(a){this.options=Object.extend({choices:10,partialSearch:!0,partialChars:2,ignoreCase:!0,fullSearch:!1,selector:function(
a){var b=[],c=[],d=a.getToken();for(var e=0;e<a.options.array.length&&b.length<a.options.choices;e++){var f=a.options.array[e],g=a.options.ignoreCase?f.toLowerCase().indexOf(d.toLowerCase()):f.indexOf(d);while(g!=-1){if(g==0&&f.length!=d.length){b.push("<li><strong>"+f.substr(0,d.length)+"</strong>"+f.substr(d.length)+"</li>");break}if(d.length>=a.options.partialChars&&a.options.partialSearch&&g!=-1)if(a.options.fullSearch||/\s/.test(f.substr(g-1,1))){c.push("<li>"+f.substr(0,g)+"<strong>"+f.substr(g,d.length)+"</strong>"+f.substr(g+d.length)+"</li>");break}g=a.options.ignoreCase?f.toLowerCase().indexOf(d.toLowerCase(),g+1):f.indexOf(d,g+1)}}return c.length&&(b=b.concat(c.slice(0,a.options.choices-b.length))),"<ul>"+b.join("")+"</ul>"}},a||{})}}),Field.scrollFreeActivate=function(a){setTimeout(function(){Field.activate(a)},1)},Ajax.InPlaceEditor=Class.create({initialize:function(a,b,c){this.url=b,this.element=$(a),this.prepareOptions(),this._controls={},arguments.callee.dealWithDeprecatedOptions(c),Object.extend(this.options,c||{}),!this.options.formId&&this.element.id&&(this.options.formId=this.element.id+"-inplaceeditor",$(this.options.formId)&&(this.options.formId="")),this.options.externalControl&&(this.options.externalControl=$(this.options.externalControl)),this.options.externalControl||(this.options.externalControlOnly=!1),this.element.title=this.options.clickToEditText,this._boundCancelHandler=this.handleFormCancellation.bind(this),this._boundComplete=(this.options.onComplete||Prototype.emptyFunction).bind(this),this._boundFailureHandler=this.handleAJAXFailure.bind(this),this._boundSubmitHandler=this.handleFormSubmission.bind(this),this._boundWrapperHandler=this.wrapUp.bind(this),this.registerListeners()},checkForEscapeOrReturn:function(a){if(!this._editing||a.ctrlKey||a.altKey||a.shiftKey)return;Event.KEY_ESC==a.keyCode?this.handleFormCancellation(a):Event.KEY_RETURN==a.keyCode&&this.handleFormSubmission(a)},createControl:function(a,b,c){var d=this.options[a+"Control"],e=this.options[a+"Text"];if("button"==d){var f=document.createElement("input");f.type="submit",f.value=e,f.className="editor_"+a+"_button","cancel"==a&&(f.onclick=this._boundCancelHandler),this._form.appendChild(f),this._controls[a]=f}else if("link"==d){var g=document.createElement("a");g.href="#",g.appendChild(document.createTextNode(e)),g.onclick="cancel"==a?this._boundCancelHandler:this._boundSubmitHandler,g.className="editor_"+a+"_link",c&&(g.className+=" "+c),this._form.appendChild(g),this._controls[a]=g}},createEditField:function(){var a=this.options.loadTextURL?this.options.loadingText:this.getText(),b;if(1>=this.options.rows&&!/\r|\n/.test(this.getText())){b=document.createElement("input"),b.type="text";var c=this.options.size||this.options.cols||0;0<c&&(b.size=c)}else b=document.createElement("textarea"),b.rows=1>=this.options.rows?this.options.autoRows:this.options.rows,b.cols=this.options.cols||40;b.name=this.options.paramName,b.value=a,b.className="editor_field",this.options.submitOnBlur&&(b.onblur=this._boundSubmitHandler),this._controls.editor=b,this.options.loadTextURL&&this.loadExternalText(),this._form.appendChild(this._controls.editor)},createForm:function(){function b(b,c){var d=a.options["text"+b+"Controls"];if(!d||c===!1)return;a._form.appendChild(document.createTextNode(d))}var a=this;this._form=$(document.createElement("form")),this._form.id=this.options.formId,this._form.addClassName(this.options.formClassName),this._form.onsubmit=this._boundSubmitHandler,this.createEditField(),b("Before",this.options.okControl||this.options.cancelControl),this.createControl("ok",this._boundSubmitHandler),b("Between",this.options.okControl&&this.options.cancelControl),this.createControl("cancel",this._boundCancelHandler,"editor_cancel"),b("After",this.options.okControl||this.options.cancelControl)},destroy:function(){this._oldInnerHTML&&(this.element.innerHTML=this._oldInnerHTML),this.leaveEditMode(),this.unregisterListeners()},enterEditMode:function(a){if(this._saving||this._editing)return;this._editing=!0,this.triggerCallback("onEnterEditMode"),this.options.externalControl&&this.options.externalControl.hide(),this.element.hide(),this.createForm(),this.element.parentNode.insertBefore(this._form,this.element),this.options.onFormCustomization&&this.options.onFormCustomization(this,this._form),this.options.loadTextURL||this.postProcessEditField(),a&&Event.stop(a)},getText:function(){return this.element.innerHTML.unescapeHTML()},handleAJAXFailure:function(a){this.triggerCallback("onFailure",a),this._oldInnerHTML&&(this.element.innerHTML=this._oldInnerHTML,this._oldInnerHTML=null)},handleFormCancellation:function(a){this.wrapUp(),a&&Event.stop(a)},handleFormSubmission:function(a){var b=this._form,c=$F(this._controls.editor);this.prepareSubmission();var d=this.options.callback(b,c)||"";Object.isString(d)&&(d=d.toQueryParams()),d.editorId=this.element.id;var e;this.options.htmlResponse?(e=Object.extend({evalScripts:!0},this.options.ajaxOptions),Object.extend(e,{parameters:d,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler}),maxkir.AjaxUpdater({success:this.element},this.url,e)):(e=Object.extend({method:"get"},this.options.ajaxOptions),Object.extend(e,{parameters:d,onComplete:this._boundWrapperHandler,onFailure:this._boundFailureHandler}),maxkir.AjaxRequest(this.url,e)),a&&Event.stop(a)},leaveEditMode:function(){this.element.removeClassName(this.options.savingClassName),this.removeForm(),this.element.show(),this.options.externalControl&&this.options.externalControl.show(),this._saving=!1,this._editing=!1,this._oldInnerHTML=null,this.triggerCallback("onLeaveEditMode")},loadExternalText:function(){this._form.addClassName(this.options.loadingClassName),this._controls.editor.disabled=!0;var a=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(a,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(a){this._form.removeClassName(this.options.loadingClassName);var b=a.responseText;this.options.stripLoadedTextTags&&(b=b.stripTags()),this._controls.editor.value=b,this._controls.editor.disabled=!1,this.postProcessEditField()}.bind(this),onFailure:this._boundFailureHandler}),new Ajax.Request(this.options.loadTextURL,a)},postProcessEditField:function(){var a=this.options.fieldPostCreation;a&&$(this._controls.editor)["focus"==a?"focus":"activate"]()},prepareOptions:function(){this.options=Object.clone(Ajax.InPlaceEditor.DefaultOptions),Object.extend(this.options,Ajax.InPlaceEditor.DefaultCallbacks),[this._extraDefaultOptions].flatten().compact().each(function(a){Object.extend(this.options,a)}.bind(this))},prepareSubmission:function(){this._saving=!0,this.removeForm(),this.showSaving()},registerListeners:function(){this._listeners={};var a;$H(Ajax.InPlaceEditor.Listeners).each(function(b){a=this[b.value].bind(this),this._listeners[b.key]=a,this.options.externalControlOnly||this.element.observe(b.key,a),this.options.externalControl&&this.options.externalControl.observe(b.key,a)}.bind(this))},removeForm:function(){if(!this._form)return;this._form.remove(),this._form=null,this._controls={}},showSaving:function(){this._oldInnerHTML=this.element.innerHTML,this.element.addClassName(this.options.savingClassName),this.element.show()},triggerCallback:function(a,b){"function"==typeof this.options[a]&&this.options[a](this,b)},unregisterListeners:function(){$H(this._listeners).each(function(a){this.options.externalControlOnly||this.element.stopObserving(a.key,a.value),this.options.externalControl&&this.options.externalControl.stopObserving(a.key,a.value)}.bind(this))},wrapUp:function(a){this.leaveEditMode(),this._boundComplete(a,this.element)}}),Object.extend(Ajax.InPlaceEditor.prototype,{dispose:Ajax.InPlaceEditor.prototype.destroy}),Ajax.InPlaceCollectionEditor=Class.create(Ajax.InPlaceEditor,{initialize:function($super,a,b,c){this._extraDefaultOptions=Ajax.InPlaceCollectionEditor.DefaultOptions,$super(a,b,c)},createEditField:function(){var a=document.createElement("select");a.name=this.options.paramName,a.size=1,this._controls.editor=a,this._collection=this.options.collection||[],this.options.loadCollectionURL?this.loadCollection():this.checkForExternalText(),this._form.appendChild(this._controls.editor)},loadCollection:function(){this._form.addClassName(this.options.loadingClassName),this.showLoadingText(this.options.loadingCollectionText);var options=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(options,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(transport){var js=transport.responseText.strip();if(!/^\[.*\]$/.test(js))throw"Server returned an invalid collection representation.";this._collection=eval(js),this.checkForExternalText()}.bind(this),onFailure:this.onFailure}),new Ajax.Request(this.options.loadCollectionURL,options)},showLoadingText:function(a){this._controls.editor.disabled=!0;var b=this._controls.editor.firstChild;b||(b=document.createElement("option"),b.value="",this._controls.editor.appendChild(b),b.selected=!0),b.update((a||"").stripScripts().stripTags())},checkForExternalText:function(){this._text=this.getText(),this.options.loadTextURL?this.loadExternalText():this.buildOptionList()},loadExternalText:function(){this.showLoadingText(this.options.loadingText);var a=Object.extend({method:"get"},this.options.ajaxOptions);Object.extend(a,{parameters:"editorId="+encodeURIComponent(this.element.id),onComplete:Prototype.emptyFunction,onSuccess:function(a){this._text=a.responseText.strip(),this.buildOptionList()}.bind(this),onFailure:this.onFailure}),new Ajax.Request(this.options.loadTextURL,a)},buildOptionList:function(){this._form.removeClassName(this.options.loadingClassName),this._collection=this._collection.map(function(a){return 2===a.length?a:[a,a].flatten()});var a="value"in this.options?this.options.value:this._text,b=this._collection.any(function(b){return b[0]==a}.bind(this));this._controls.editor.update("");var c;this._collection.each(function(d,e){c=document.createElement("option"),c.value=d[0],c.selected=b?d[0]==a:0==e,c.appendChild(document.createTextNode(d[1])),this._controls.editor.appendChild(c)}.bind(this)),this._controls.editor.disabled=!1,Field.scrollFreeActivate(this._controls.editor)}}),Ajax.InPlaceEditor.prototype.initialize.dealWithDeprecatedOptions=function(a){function b(b,c){if(b in a||c===undefined)return;a[b]=c}if(!a)return;b("cancelControl",a.cancelLink?"link":a.cancelButton?"button":a.cancelLink==a.cancelButton==!1?!1:undefined),b("okControl",a.okLink?"link":a.okButton?"button":a.okLink==a.okButton==!1?!1:undefined),b("highlightColor",a.highlightcolor),b("highlightEndColor",a.highlightendcolor)},Object.extend(Ajax.InPlaceEditor,{DefaultOptions:{ajaxOptions:{},autoRows:3,cancelControl:"link",cancelText:"cancel",clickToEditText:"Click to edit",externalControl:null,externalControlOnly:!1,fieldPostCreation:"activate",formClassName:"singleLineForm",formId:null,highlightColor:"#ffff99",highlightEndColor:"#ffffff",htmlResponse:!0,loadingClassName:"inplaceeditor-loading",loadingText:"Loading...",okControl:"button",okText:"ok",paramName:"value",rows:1,savingClassName:"inplaceeditor-saving",size:0,stripLoadedTextTags:!1,submitOnBlur:!1,textAfterControls:"",textBeforeControls:"",textBetweenControls:""},DefaultCallbacks:{callback:function(a){return Form.serialize(a)},onComplete:function(a,b){new Effect.Highlight(b,{startcolor:this.options.highlightColor,keepBackgroundImage:!0})},onEnterEditMode:null,onFailure:function(a){alert("Error communication with the server: "+a.responseText.stripTags())},onFormCustomization:null,onLeaveEditMode:null},Listeners:{click:"enterEditMode",keydown:"checkForEscapeOrReturn"}}),Ajax.InPlaceCollectionEditor.DefaultOptions={loadingCollectionText:"Loading options..."},Form.Element.DelayedObserver=Class.create({initialize:function(a,b,c){this.delay=b||.5,this.element=$(a),this.callback=c,this.timer=null,this.lastValue=$F(this.element),Event.observe(this.element,"keyup",this.delayedListener.bindAsEventListener(this))},delayedListener:function(){if(this.lastValue==$F(this.element))return;this.timer&&clearTimeout(this.timer),this.timer=setTimeout(this.onTimerEvent.bind(this),this.delay*1e3),this.lastValue=$F(this.element)},onTimerEvent:function(){this.timer=null,this.callback(this.element,$F(this.element))}});if(Object.isUndefined(Effect))throw"dragdrop.js requires including script.aculo.us' effects.js library";var Droppables={drops:[],remove:function(a){this.drops=this.drops.reject(function(b){return b.element==$(a)})},add:function(a){a=$(a);var b=Object.extend({greedy:!0,hoverclass:null,tree:!1},arguments[1]||{});if(b.containment){b._containers=[];var c=b.containment;Object.isArray(c)?c.each(function(a){b._containers.push($(a))}):b._containers.push($(c))}b.accept&&(b.accept=[b.accept].flatten()),b.element=a,this.drops.push(b)},findDeepestChild:function(a){deepest=a[0];for(i=1;i<a.length;++i)Element.isParent(a[i].element,deepest.element)&&(deepest=a[i]);return deepest},isContained:function(a,b){var c;return b.tree?c=a.treeNode:c=a.parentNode,b._containers.detect(function(a){return c==a})},isAffected:function(a,b,c){return c.element!=b&&(!c._containers||this.isContained(b,c))&&(!c.accept||Element.classNames(b).detect(function(a){return c.accept.include(a)}))&&Position.within(c.element,a[0],a[1])},deactivate:function(a){a.hoverclass&&Element.removeClassName(a.element,a.hoverclass),this.last_active=null},activate:function(a){a.hoverclass&&Element.addClassName(a.element,a.hoverclass),this.last_active=a},show:function(a,b){if(!this.drops.length)return;var c,d=[];this.drops.each(function(c){Droppables.isAffected(a,b,c)&&d.push(c)}),d.length>0&&(c=Droppables.findDeepestChild(d)),this.last_active&&this.last_active!=c&&this.deactivate(this.last_active),c&&(Position.within(c.element,a[0],a[1]),c.onHover&&c.onHover(b,c.element,Position.overlap(c.overlap,c.element)),c!=this.last_active&&Droppables.activate(c))},fire:function(a,b){if(!this.last_active)return;Position.prepare();if(this.isAffected([Event.pointerX(a),Event.pointerY(a)],b,this.last_active)&&this.last_active.onDrop)return this.last_active.onDrop(b,this.last_active.element,a),!0},reset:function(){this.last_active&&this.deactivate(this.last_active)}},Draggables={drags:[],observers:[],register:function(a){this.drags.length==0&&(this.eventMouseUp=this.endDrag.bindAsEventListener(this),this.eventMouseMove=this.updateDrag.bindAsEventListener(this),this.eventKeypress=this.keyPress.bindAsEventListener(this),Event.observe(document,"mouseup",this.eventMouseUp),Event.observe(document,"mousemove",this.eventMouseMove),Event.observe(document,"keypress",this.eventKeypress)),this.drags.push(a)},unregister:function(a){this.drags=this.drags.reject(function(b){return b==a}),this.drags.length==0&&(Event.stopObserving(document,"mouseup",this.eventMouseUp),Event.stopObserving(document,"mousemove",this.eventMouseMove),Event.stopObserving(document,"keypress",this.eventKeypress))},activate:function(a){a.options.delay?this._timeout=setTimeout(function(){Draggables._timeout=null,window.focus(),Draggables.activeDraggable=a}.bind(this),a.options.delay):(window.focus(),this.activeDraggable=a)},deactivate:function(){this.activeDraggable=null},updateDrag:function(a){if(!this.activeDraggable)return;var b=[Event.pointerX(a),Event.pointerY(a)];if(this._lastPointer&&this._lastPointer.inspect()==b.inspect())return;this._lastPointer=b,this.activeDraggable.updateDrag(a,b)},endDrag:function(a){this._timeout&&(clearTimeout(this._timeout),this._timeout=null);if(!this.activeDraggable)return;this._lastPointer=null,this.activeDraggable.endDrag(a),this.activeDraggable=null},keyPress:function(a){this.activeDraggable&&this.activeDraggable.keyPress(a)},addObserver:function(a){this.observers.push(a),this._cacheObserverCallbacks()},removeObserver:function(a){this.observers=this.observers.reject(function(b){return b.element==a}),this._cacheObserverCallbacks()},notify:function(a,b,c){this[a+"Count"]>0&&this.observers.each(function(d){d[a]&&d[a](a,b,c)}),b.options[a]&&b.options[a](b,c)},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(a){Draggables[a+"Count"]=Draggables.observers.select(function(b){return b[a]}).length})}},Draggable=Class.create({initialize:function(a){var b={handle:!1,reverteffect:function(a,b,c){var d=Math.sqrt(Math.abs(b^2)+Math.abs(c^2))*.02;new Effect.Move(a,{x:-c,y:-b,duration:d,queue:{scope:"_draggable",position:"end"}})},endeffect:function(a){var b=Object.isNumber(a._opacity)?a._opacity:1;new Effect.Opacity(a,{duration:.2,from:.7,to:b,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[a]=!1}})},zindex:1e3,revert:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,snap:!1,delay:0};(!arguments[1]||Object.isUndefined(arguments[1].endeffect))&&Object.extend(b,{starteffect:function(a){a._opacity=Element.getOpacity(a),Draggable._dragging[a]=!0,new Effect.Opacity(a,{duration:.2,from:a._opacity,to:.7})}});var c=Object.extend(b,arguments[1]||{});this.element=$(a),c.handle&&Object.isString(c.handle)&&(this.handle=this.element.down("."+c.handle,0)),this.handle||(this.handle=$(c.handle)),this.handle||(this.handle=this.element),c.scroll&&!c.scroll.scrollTo&&!c.scroll.outerHTML&&(c.scroll=$(c.scroll),this._isScrollChild=Element.childOf(this.element,c.scroll)),this.options=c,this.dragging=!1,this.eventMouseDown=this.initDrag.bindAsEventListener(this),Event.observe(this.handle,"mousedown",this.eventMouseDown),Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown),Draggables.unregister(this)},currentDelta:function(){return[parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")]},initDrag:function(a){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element])return;if(Event.isLeftClick(a)&&(a.shiftKey||!document.location.href.match(/checklists\/\d+/))){var b=Event.element(a);if(!(!(tag_name=b.tagName.toUpperCase())||tag_name!="INPUT"&&tag_name!="SELECT"&&tag_name!="OPTION"&&tag_name!="BUTTON"&&tag_name!="TEXTAREA"))return;var c=[Event.pointerX(a),Event.pointerY(a)],d=this.element.cumulativeOffset();this.offset=[0,1].map(function(a){return c[a]-d[a]}),Draggables.activate(this),Event.stop(a),a.target.beingDragged=!0}},startDrag:function(a){this.dragging=!0,this.delta||(this.delta=this.currentDelta()),this.options.zindex&&(this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0),this.element.style.zIndex=this.options.zindex),this.options.ghosting&&(this._clone=this.element.cloneNode(!0),this._originallyAbsolute=this.element.getStyle("position")=="absolute",this._originallyAbsolute||Position.absolutize(this.element),this.element.parentNode.insertBefore(this._clone,this.element));if(this.options.scroll)if(this.options.scroll==window){var b=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=b.left,this.originalScrollTop=b.top}else this.originalScrollLeft=this.options.scroll.scrollLeft,this.originalScrollTop=this.options.scroll.scrollTop;Draggables.notify("onStart",this,a),this.options.starteffect&&this.options.starteffect(this.element)},updateDrag:function(event,pointer){this.dragging||this.startDrag(event),this.options.quiet||(Position.prepare(),Droppables.show(pointer,this.element)),Draggables.notify("onDrag",this,event),this.draw(pointer),this.options.change&&this.options.change(this);if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window)with(this._getWindowScroll(this.options.scroll))p=[left,top,left+width,top+height];else p=Position.page(this.options.scroll).toArray(),p[0]+=this.options.scroll.scrollLeft+Position.deltaX,p[1]+=this.options.scroll.scrollTop+Position.deltaY,p.push(p[0]+this.options.scroll.offsetWidth),p.push(p[1]+this.options.scroll.offsetHeight);var speed=[0,0];pointer[0]<p[0]+this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)),pointer[1]<p[1]+this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)),pointer[0]>p[2]-this.options.scrollSensitivity&&(speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)),pointer[1]>p[3]-this.options.scrollSensitivity&&(speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)),this.startScrolling(speed)}Prototype.Browser.WebKit&&window.scrollBy(0,0),Event.stop(event)},finishDrag:function(a,b){this.dragging=!1;if(this.options.quiet){Position.prepare();var c=[Event.pointerX(a),Event.pointerY(a)];Droppables.show(c,this.element)}setTimeout(function(){a.target.beingDragged=!1},100),this.options.ghosting&&(this._originallyAbsolute||Position.relativize(this.element),delete this._originallyAbsolute,Element.remove(this._clone),this._clone=null);var d=!1;b&&(d=Droppables.fire(a,this.element),d||(d=!1)),d&&this.options.onDropped&&this.options.onDropped(this.element),Draggables.notify("onEnd",this,a);var e=this.options.revert;e&&Object.isFunction(e)&&(e=e(this.element));var f=this.currentDelta();e&&this.options.reverteffect?(d==0||e!="failure")&&this.options.reverteffect(this.element,f[1]-this.delta[1],f[0]-this.delta[0]):this.delta=f,this.options.zindex&&(this.element.style.zIndex=this.originalZ),this.options.endeffect&&this.options.endeffect(this.element),Draggables.deactivate(this),Droppables.reset()},keyPress:function(a){if(a.keyCode!=Event.KEY_ESC)return;this.finishDrag(a,!1),Event.stop(a)},endDrag:function(a){if(!this.dragging)return;this.stopScrolling(),this.finishDrag(a,!0),Event.stop(a)},draw:function(a){var b=this.element.cumulativeOffset();if(this.options.ghosting){var c=Position.realOffset(this.element);b[0]+=c[0]-Position.deltaX,b[1]+=c[1]-Position.deltaY}var d=this.currentDelta();b[0]-=d[0],b[1]-=d[1],this.options.scroll&&this.options.scroll!=window&&this._isScrollChild&&(b[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft,b[1]-=this.options.scroll.scrollTop-this.originalScrollTop);var e=[0,1].map(function(c){return a[c]-b[c]-this.offset[c]}.bind(this));this.options.snap&&(Object.isFunction(this.options.snap)?e=this.options.snap(e[0],e[1],this):Object.isArray(this.options.snap)?e=e.map(function(a,b){return(a/this.options.snap[b]).round()*this.options.snap[b]}.bind(this)):e=e.map(function(a){return(a/this.options.snap).round()*this.options.snap}.bind(this)));var f=this.element.style;if(!this.options.constraint||this.options.constraint=="horizontal")f.left=e[0]+"px";if(!this.options.constraint||this.options.constraint=="vertical")f.top=e[1]+"px";f.visibility=="hidden"&&(f.visibility="")},stopScrolling:function(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null,Draggables._lastScrollPointer=null)},startScrolling:function(a){if(!a[0]&&!a[1])return;this.scrollSpeed=[a[0]*this.options.scrollSpeed,a[1]*this.options.scrollSpeed],this.lastScrolled=new Date,this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var current=new Date,delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window)with(this._getWindowScroll(this.options.scroll))if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1e3;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}else this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1e3,this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1e3;Position.prepare(),Droppables.show(Draggables._lastPointer,this.element),Draggables.notify("onDrag",this),this._isScrollChild&&(Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer),Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1e3,Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1e3,Draggables._lastScrollPointer[0]<0&&(Draggables._lastScrollPointer[0]=0),Draggables._lastScrollPointer[1]<0&&(Draggables._lastScrollPointer[1]=0),this.draw(Draggables._lastScrollPointer)),this.options.change&&this.options.change(this)},_getWindowScroll:function(w){var T,L,W,H;with(w.document)w.document.documentElement&&documentElement.scrollTop?(T=documentElement.scrollTop,L=documentElement.scrollLeft):w.document.body&&(T=body.scrollTop,L=body.scrollLeft),w.innerWidth?(W=w.innerWidth,H=w.innerHeight):w.document.documentElement&&documentElement.clientWidth?(W=documentElement.clientWidth,H=documentElement.clientHeight):(W=body.offsetWidth,H=body.offsetHeight);return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(a,b){this.element=$(a),this.observer=b},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark(),this.lastValue!=Sortable.serialize(this.element)&&this.observer(this.element)}}),Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(a){while(a.tagName.toUpperCase()!="BODY"){if(a.id&&Sortable.sortables[a.id])return a;a=a.parentNode}},options:function(a){a=Sortable._findRootElement($(a));if(!a)return;return Sortable.sortables[a.id]},destroy:function(a){a=$(a);var b=Sortable.sortables[a.id];b&&(Draggables.removeObserver(b.element),b.droppables.each(function(a){Droppables.remove(a)}),b.draggables.invoke("destroy"),delete Sortable.sortables[b.element.id])},create:function(a){a=$(a);var b=Object.extend({element:a,tag:"li",dropOnEmpty:!1,tree:!1,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:a,handle:!1,only:!1,delay:0,hoverclass:null,ghosting:!1,quiet:!1,scroll:!1,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:!1,handles:!1,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(a);var c={revert:!0,quiet:b.quiet,scroll:b.scroll,scrollSpeed:b.scrollSpeed,scrollSensitivity:b.scrollSensitivity,delay:b.delay,ghosting:b.ghosting,constraint:b.constraint,handle:b.handle};b.starteffect&&(c.starteffect=b.starteffect),b.reverteffect?c.reverteffect=b.reverteffect:b.ghosting&&(c.reverteffect=function(a){a.style.top=0,a.style.left=0}),b.endeffect&&(c.endeffect=b.endeffect),b.zindex&&(c.zindex=b.zindex);var d={overlap:b.overlap,containment:b.containment,tree:b.tree,hoverclass:b.hoverclass,onHover:Sortable.onHover},e={onHover:Sortable.onEmptyHover,overlap:b.overlap,containment:b.containment,hoverclass:b.hoverclass};Element.cleanWhitespace(a),b.draggables=[],b.droppables=[];if(b.dropOnEmpty||b.tree)Droppables.add(a,e),b.droppables.push(a);(b.elements||this.findElements(a,b)||[]).each(function(e,f){var g=b.handles?$(b.handles[f]):b.handle?$(e).select("."+b.handle)[0]:e;b.draggables.push(new Draggable(e,Object.extend(c,{handle:g}))),Droppables.add(e,d),b.tree&&(e.treeNode=a),b.droppables.push(e)}),b.tree&&a.select(b.treeTag+"."+b.treeTagClass).each(function(c){Droppables.add(c,e),c.treeNode=a,b.droppables.push(c)}),this.sortables[a.identify()]=b,Draggables.addObserver(new SortableObserver(a,b.onUpdate))},findElements:function(a,b){return Element.findChildren(a,b.only,!!b.tree,b.tag)},findTreeElements:function(a,b){return Element.findChildren(a,b.only,!!b.tree,b.treeTag)},onHover:function(a,b,c){if(Element.isParent(b,a))return;if(c>.33&&c<.66&&Sortable.options(b).tree)return;if(c>.5){Sortable.mark(b,"before");if(b.previousSibling!=a){var d=a.parentNode;a.style.visibility="hidden",b.parentNode.insertBefore(a,b),b.parentNode!=d&&Sortable.options(d).onChange(a),Sortable.options(b.parentNode).onChange(a)}}else{Sortable.mark(b,"after");var e=b.nextSibling||null;if(e!=a){var d=a.parentNode;a.style.visibility="hidden",b.parentNode.insertBefore(a,e),b.parentNode!=d&&Sortable.options(d).onChange(a),Sortable.options(b.parentNode).onChange(a)}}},onEmptyHover:function(a,b,c){var d=a.parentNode,e=Sortable.options(b);if(!Element.isParent(b,a)){var f,g=Sortable.findElements(b,{tag:e.tag,only:e.only}),h=null;if(g){var i=Element.offsetSize(b,e.overlap)*(1-c);for(f=0;f<g.length;f+=1)if(i-Element.offsetSize(g[f],e.overlap)>=0)i-=Element.offsetSize(g[f],e.overlap);else{if(i-Element.offsetSize(g[f],e.overlap)/2>=0){h=f+1<g.length?g[f+1]:null;break}h=g[f];break}}b.insertBefore(a,h),Sortable.options(d).onChange(a),e.onChange(a)}},unmark:function(){Sortable._marker&&Sortable._marker.hide()},mark:function(a,b){var c=Sortable.options(a.parentNode);if(c&&!c.ghosting)return;Sortable._marker||(Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"}),document.getElementsByTagName("body").item(0).appendChild(Sortable._marker));var d=a.cumulativeOffset();Sortable._marker.setStyle({left:d[0]+"px",top:d[1]+"px"}),b=="after"&&(c.overlap=="horizontal"?Sortable._marker.setStyle({left:d[0]+a.clientWidth+"px"}):Sortable._marker.setStyle({top:d[1]+a.clientHeight+"px"})),Sortable._marker.show()},_tree:function(a,b,c){var d=Sortable.findElements(a,b)||[];for(var e=0;e<d.length;++e){var f=d[e].id.match(b.format);if(!f)continue;var g={id:encodeURIComponent(f?f[1]:null),element:a,parent:c,children:[],position:c.children.length,container:$(d[e]).down(b.treeTag+"."+b.treeTagClass)};g.container&&this._tree(g.container,b,g),c.children.push(g)}return c},tree:function(a){a=$(a);var b=this.options(a),c=Object.extend({tag:b.tag,treeTag:b.treeTag,only:b.only,treeTagClass:b.treeTagClass,name:a.id,format:b.format},arguments[1]||{}),d={id:null,parent:null,children:[],container:a,position:0};return Sortable._tree(a,c,d)},_constructIndex:function(a){var b="";do a.id&&(b="["+a.position+"]"+b);while((a=a.parent)!=null);return b},sequence:function(a){a=$(a);var b=Object.extend(this.options(a),arguments[1]||{});return $(this.findElements(a,b)||[]).map(function(a){return a.id.match(b.format)?a.id.match(b.format)[1]:""})},setSequence:function(a,b){a=$(a);var c=Object.extend(this.options(a),arguments[2]||{}),d={};this.findElements(a,c).each(function(a){a.id.match(c.format)&&(d[a.id.match(c.format)[1]]=[a,a.parentNode]),a.parentNode.removeChild(a)}),b.each(function(a){var b=d[a];b&&(b[1].appendChild(b[0]),delete d[a])})},serialize:function(a){a=$(a);var b=Object.extend(Sortable.options(a),arguments[1]||{}),c=encodeURIComponent(arguments[1]&&arguments[1].name?arguments[1].name:a.id);return b.tree?Sortable.tree(a,arguments[1]).children.map(function(a){return[c+Sortable._constructIndex(a)+"[id]="+encodeURIComponent(a.id)].concat(a.children.map(arguments.callee))}).flatten().join("&"):Sortable.sequence(a,arguments[1]).map(function(a){return c+"[]="+encodeURIComponent(a)}).join("&")}};Element.isParent=function(a,b){return!a.parentNode||a==b?!1:a.parentNode==b?!0:Element.isParent(a.parentNode,b)},Element.findChildren=function(a,b,c,d){if(!a.hasChildNodes())return null;d=d.toUpperCase(),b&&(b=[b].flatten());var e=[];return $A(a.childNodes).each(function(a){a.tagName&&a.tagName.toUpperCase()==d&&(!b||Element.classNames(a).detect(function(a){return b.include(a)}))&&e.push(a);if(c){var f=Element.findChildren(a,b,c,d);f&&e.push(f)}}),e.length>0?e.flatten():[]},Element.offsetSize=function(a,b){return a["offset"+(b=="vertical"||b=="height"?"Height":"Width")]},maxkir.ui=maxkir.ui||{},maxkir.ui.Message=function(a,b){maxkir.info("User message: "+a);if(window.curr_message){var c=document.querySelector(".humanizedMessage");c&&c._innerHTML.indexOf(a)===-1&&(c.innerHTML+="<br>"+a,c._innerHTML+="<br>"+a);return}b||(b={}),this.options=b;var d=document.createElement("div");d.className="humanizedMessage",maxkir.theme&&(d.style.backgroundColor=maxkir.theme.navigation),d.innerHTML=a,d._innerHTML=a,document.body.appendChild(d);var e=Element.getDimensions(d),f=maxkir.screen(),g=100,h=b.left||(f[0]-e.width)/2;d.style.left=h+"px",d.style.top=g+"px",this.element=d,$(d).setOpacity(.3),maxkir.animate(300,function(a){this._stopped?this._hide():($(d).setOpacity(.3+a*.55),a==1&&setTimeout(this.installHiders.bind(this),1500))}.bind(this)),window.curr_message=this,maxkir.isMobile&&setTimeout(function(){this.hide()}.bind(this),3e3)},maxkir.extend(maxkir.ui.Message,{hide:function(){this._stopped=!0,this.boundHandler?this.hideHandler():setTimeout(function(){this.hide()}.bind(this),200)},installHiders:function(){this.boundHandler=this.hideHandler.bindAsEventListener(this);var a=(new Date).getTime();this.boundHandler2=function(){(new Date).getTime()-a>1200&&this.boundHandler&&this.boundHandler.apply(this,arguments)}.bind(this),Event.observe(document,"keydown",this.boundHandler),Event.observe(document.body,"mousedown",this.boundHandler),Event.observe(document.body,"mousemove",this.boundHandler2)},hideHandler:function(){this._hide(),Event.stopObserving(document,"keydown",this.boundHandler),Event.stopObserving(document.body,"mousedown"
,this.boundHandler),Event.stopObserving(document.body,"mousemove",this.boundHandler2),this.boundHandler=null,this.boundHandler2=null},setOnHide:function(a){this.options.onHide=a},_hide:function(){window.curr_message=null,document.body.contains(this.element)&&maxkir.animate(300,function(a){$(this.element).setOpacity(1-a),a===1&&(this.element.remove(),this.options.onHide&&this.options.onHide())}.bind(this))}}),maxkir.ui=maxkir.ui||{},maxkir.ui.Autocompleter=function(a,b,c,d){var e=this;a=$(a),d.onHide=function(a,b){e.defaultOnHide(a,b),e.index=-1},Autocompleter.Base.prototype.baseInitialize.call(this,a,b,d),this.options.array=c,this._handlers=[],this.index=-1,this.invoke_completer_onclick_handler=a.on("click",function(){setTimeout(function(){this.hasFocus=!0,this.onObserverEvent()}.bind(this),20)}.bind(this))},maxkir.extend(maxkir.ui.Autocompleter,{setOptions:function(a){this.options=Object.extend({choices:10,partialSearch:!0,partialChars:2,minChars:1,frequency:.25,ignoreCase:!0,separator:"",fullSearch:!0,updateElement:this.updateElementWithHandlers},a||{})},trigger_activation:function(){this.onKeyDown({keyCode:Event.KEY_RIGHT})},addHandler:function(a){this._handlers.push(a)},dispose:function(){this.invoke_completer_onclick_handler.stop(),this._handlers=null,this.options.array=[],Autocompleter.Base.prototype.dispose.call(this)},selectEntry:function(){return Autocompleter.Base.prototype.selectEntry.call(this)?(this.element.value=this.element.value+this.options.separator,!0):!1},markNext:function(){this.index<this.entryCount-1?this.index++:this.index=0,maxkir.scrollTo(this.getEntry(this.index),5)},markPrevious:function(){this.index>0?this.index--:this.index=this.entryCount-1,maxkir.scrollTo(this.getEntry(this.index),5)},getUpdatedChoices:function(){var a=this.createCompletionItems(),b=this.selectAndCreateListHtml(a),c=maxkir.get_selection_range(this.element),d=this.getToken();this.foreachHandler("createFilteredItemsString",function(a){b+=a.createFilteredItemsString(this.element,d,c,this)}.bind(this)),this.updateChoices("<ul>"+b+"</ul>"),this.foreachHandler("onUpdateChoices",function(a){a.onUpdateChoices(this.element,d,c,this)}.bind(this))},foreachHandler:function(a,b){var c=$A(this._handlers);for(var d=0;d<c.length;d++)c[d][a]&&b.call(this,c[d])},createCompletionItems:function(){var a=[],b=maxkir.get_selection_range(this.element);return this.foreachHandler("createItems",function(c){var d=c.createItems(this.element,this.getToken(),b);a=a.concat(d)}),a=a.concat(this.options.array),a},selectAndCreateListHtml:function(a){var b=[],c=[],d=this.getToken().toLowerCase();a=a||this.options.array,maxkir.debug("selectAndCreateListHtml: '"+d+"' in "+a);var e=!1;for(var f=0;f<a.length&&b.length<this.options.choices;f++){var g=a[f],h=g,i=g.indexOf("<span");i>0&&(h=h.substr(0,i));var j=h.toLowerCase().indexOf(d);while(j!=-1){if(j==0&&d.length<=h.length){b.push(this.create_li_tag(g)+"<strong>"+g.substr(0,d.length)+"</strong>"+g.substr(d.length)+"</li>"),e=e||d.length==h.length;break}if(this.options.partialSearch&&d.length>=this.options.partialChars&&d.length<h.length)if(this.options.fullSearch||this.partial_match(g,j)){c.push(this.create_li_tag(g)+g.substr(0,j)+"<strong>"+g.substr(j,d.length)+"</strong>"+g.substr(j+d.length)+"</li>");break}j=h.toLowerCase().indexOf(d,j+1)}}return b.length&&this.index<0&&(this.index=0),c.length&&(b=b.concat(c.slice(0,this.options.choices-b.length))),b.length===1&&e&&(b=[]),b.join("")},partial_match:function(a,b){if(b==0)return!0;if(/(\s|\^)/.test(a.substr(b-1,1))){var c=a.lastIndexOf("<",b),d=a.lastIndexOf(">",b);return d>=c}return!1},create_li_tag:function(){return"<li>"},getTokenBounds:function(){if(null!=this.tokenBounds)return this.tokenBounds;var a=maxkir.get_selection_range(this.element),b=null;return this.foreachHandler("getCustomTokenBounds",function(c){var d=c.getCustomTokenBounds(this.element,a);if(!b||d&&d[1]-d[0]>b[1]-b[0])b=d}),this.tokenBounds=b,this.tokenBounds||(this.tokenBounds=Autocompleter.Base.prototype.getTokenBounds.call(this)),this.tokenBounds},updateElementWithHandlers:function(a){if(!a)return;var b=!1;this.foreachHandler("updateElement",function(c){b||(b=c.updateElement(a))}),!b&&a&&this.defaultUpdateElement(a)},replaceTokenWith:function(a){var b=this.getTokenBounds()[0];Autocompleter.Base.prototype.replaceTokenWith.call(this,a),setTimeout(function(){maxkir.set_selection_textarea(this.element,b+a.length+this.options.separator.length,0)}.bind(this),10)},f_:null},Autocompleter.Base);var DateExtension=function(a){var b=864e5,c=7*b;a.MD=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],a.WD=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],a.prototype.cl_format_date=function(b,d){if(this.is_today())return b?"today":"";if(this.is_tomorrow())return"tomorrow";if(this.is_yesterday())return"yesterday";var e=new a,f="",g=this.getTime()>e.getTime()&&this.getTime()-e.getTime()<c;if(g){if(d)return this.weekday();f=this.weekday()+", "}var h="";if(d||e.getFullYear()!=this.getFullYear())h=", "+this.getFullYear();return f+a.MD[this.getMonth()]+" "+this.getDate()+h},a.prototype.cl_format_time=function(){var c=this.cl_format_date(!0),d=function(a){return a>9?a:"0"+a};return Math.abs(this.getTime()-(new a).getTime())<2*b+100&&(c+=", "+d(this.getHours())+":"+d(this.getMinutes())),c},a.prototype.diff_days=function(){var c=(new a).beginning_of_day(),d=(new a(this.getTime())).beginning_of_day();return Math.round((d.getTime()-c.getTime())/b)},a.prototype.is_today=function(){return this._same_date(new a)},a.prototype.is_tomorrow=function(){var c=new a((new a).getTime()+b);return this._same_date(c)},a.prototype.is_after_tomorrow=function(){return this.beginning_of_day().getTime()-(new a).beginning_of_day().getTime()>b},a.prototype.is_yesterday=function(){var c=new a((new a).getTime()-b);return this._same_date(c)},a.prototype.is_overdue=function(){return(new a).beginning_of_day().getTime()>this.getTime()},a.prototype.weekday=function(){return a.WD[this.getDay()]},a.prototype._same_date=function(a){return a.getDate()==this.getDate()&&Math.abs(a.getTime()-this.getTime())<=b},a.prototype.beginning_of_day=function(){return this.setHours(0,0,0,0),this},a.prototype.end_of_day=function(){return this.setHours(23,59,59,999),this},a.prototype.beginning_of_week=function(){return this.getDay()==0?this.setDate(this.getDate()-6):this.setDate(this.getDate()-this.getDay()+1),this.beginning_of_day()},a.prototype.end_of_week=function(){this.setDate(this.getDate()+7);var b=this.beginning_of_week();return new a(b.getTime()-1)},a.prototype.beginning_of_month=function(){return this.setDate(1),this.beginning_of_day()},a.prototype.end_of_month=function(){return this.setDate(1),this.setMonth(this.getMonth()+1),new a(this.beginning_of_month().getTime()-1)},a.prototype.beginning_of_year=function(){return this.setDate(1),this.setMonth(0),this.beginning_of_month()},a.prototype.end_of_year=function(){return this.setDate(1),this.setMonth(11),this.end_of_month()}};DateExtension(Date),maxkir=window.maxkir||{},maxkir.dates={within:function(a,b){if(!b)return a=="none";if(a=="any")return!0;this.initialize();var c=a.toLowerCase();if(c=="asap")return"asap"==b.toString().toLowerCase();if(c=="now"&&"asap"==b.toString().toLowerCase())return!0;var d=this.msecs(b),e=this.date_matchers[c];if(e)return e(d);var f=/(\d+)(h|d|w)\w*/.exec(c);if(f){var g=0;f[2]=="h"&&(g=f[1]),f[2]=="d"&&(g=f[1]*24),f[2]=="w"&&(g=f[1]*24*7);var h=(new Date).getTime()-g*3600*1e3;return d>=h}var i=maxkir.dates.date(d);i.setHours(0);var j=this._convert_to_date(a);return j.setHours(0),i.getTime()==j.getTime()?!0:!1},_convert_to_date:function(a){return a=a.replace(/[-\\]/g,"/").replace(/(\d?\d)\/(\d?\d)\/(\d{4})/,"$3/$2/$1"),a.search(/\d{4}/)<0&&(a+=" "+(new Date).getFullYear()),new Date(a)},msecs:function(a){return a&&a.replace?Date.parse(a.replace(/-/g,"/")+" 12:00:00"):a>0?a:a.getTime?a.getTime():Date.parse(a)},date:function(a){return new Date(this.msecs(a))},initialize:function(){if(this._initialized)return;this.date_matchers={},this.date_matchers.asap=function(a){return a.toString().toLowerCase()=="asap"},this.date_matchers.today=function(a){var b=(new Date).beginning_of_day().getTime(),c=(new Date).end_of_day().getTime();return a>=b&&a<=c},this.date_matchers.tomorrow=function(a){var b=(new Date).end_of_day().getTime(),c=(new Date).end_of_day();return c.setDate(c.getDate()+1),c=c.getTime(),a<=c&&a>b},this.date_matchers.yesterday=function(a){var b=(new Date).beginning_of_day().getTime(),c=(new Date).beginning_of_day();c.setDate(c.getDate()-1);var d=c.getTime();return a>=d&&a<b},this.date_matchers.week=function(a){var b=(new Date).beginning_of_week().getTime(),c=(new Date).end_of_week().getTime();return a>=b&&a<=c},this.date_matchers["this week"]=this.date_matchers.week,this.date_matchers["current week"]=this.date_matchers.week,this.date_matchers["last week"]=function(a){var b=(new Date).beginning_of_week().getTime(),c=(new Date).beginning_of_week();return c.setDate(c.getDate()-1),c=c.beginning_of_week().getTime(),a>=c&&a<b},this.date_matchers["previous week"]=this.date_matchers["last week"],this.date_matchers["last month"]=function(a){var b=(new Date).beginning_of_month().getTime(),c=(new Date).beginning_of_month();return c.setDate(c.getDate()-1),c=c.beginning_of_month().getTime(),a>=c&&a<b},this.date_matchers["previous month"]=this.date_matchers["last month"],this.date_matchers["next week"]=function(a){var b=(new Date).end_of_week().getTime(),c=(new Date(b+1)).end_of_week().getTime();return a>b&&a<=c},this.date_matchers.month=function(a){var b=(new Date).beginning_of_month().getTime(),c=(new Date).end_of_month().getTime();return a>=b&&a<=c},this.date_matchers["this month"]=this.date_matchers.month,this.date_matchers["current month"]=this.date_matchers.month,this.date_matchers["next month"]=function(a){var b=(new Date).end_of_month().getTime(),c=(new Date(b+1)).end_of_month().getTime();return a>b&&a<=c},this.date_matchers["this year"]=function(a){var b=(new Date).end_of_year().getTime(),c=(new Date).beginning_of_year().getTime();return a<=b&&a>=c},this.date_matchers.year=this.date_matchers["this year"],this.date_matchers["current year"]=this.date_matchers["this year"],this.date_matchers["next year"]=function(a){var b=(new Date).end_of_year().getTime(),c=(new Date(b+1)).end_of_year().getTime();return a>b&&a<=c},this.date_matchers.now=function(a){var b=(new Date).end_of_day().getTime();return a<=b},this.date_matchers.overdue=function(a){var b=(new Date).beginning_of_day().getTime();return a<b},this._initialized=!0}},maxkir.TimeoutAction=function(a,b,c,d){this.start_delay=a,this.stop_delay=b,this.state="none",this.activate_action=c,this.stop_action=d,this.bound_starting=this.starting.bind(this),this.bound_stopping=this.stopping.bind(this),this.bound_activate=this.activate.bind(this),this.bound_stop=this.stop.bind(this)},maxkir.extend(maxkir.TimeoutAction,{get_state:function(){return this.state},starting:function(){this.state=="none"?this.start_delay>0?(this.starting_timeout=window.setTimeout(this.bound_activate,this.start_delay),this.set_state("starting")):this.activate():this.state!="starting"&&(this.state=="stopping"?(this.exit_stopping(),this.set_state("active")):this.state!="active")},activate:function(){this.state=="none"?this.do_activate():this.state=="starting"?(this.exit_starting(),this.do_activate()):this.state=="stopping"?(this.exit_stopping(),this.set_state("active")):this.state!="active"},stopping:function(){this.state!="none"&&(this.state=="starting"?(this.exit_starting(),this.set_state("none")):this.state!="stopping"&&this.state=="active"&&(this.stop_delay>0?(this.stopping_timeout=window.setTimeout(this.bound_stop,this.stop_delay),this.set_state("stopping")):this.stop()))},stop:function(){this.state!="none"&&(this.state=="starting"?(this.exit_starting(),this.set_state("none")):this.state=="stopping"?(this.exit_stopping(),this.do_stop()):this.state=="active"&&this.do_stop())},do_activate:function(){this.set_state("active"),this.activate_action()},do_stop:function(){this.set_state("none"),this.stop_action()},set_state:function(a){this.state=a},exit_starting:function(){window.clearTimeout(this.starting_timeout),this.starting_timeout=null},exit_stopping:function(){window.clearTimeout(this.stopping_timeout),this.starting_timeout=null}}),maxkir.ui=maxkir.ui||{},maxkir.ui.Textarea=function(a,b){this.editField=$(a),this.wrapper=document.createElement("div"),this.wrapper.className="textareaWrapper",this.editField.parentNode.replaceChild(this.wrapper,this.editField),this.wrapper.appendChild(this.editField),this._value_on_start=this.editField.value,this.options=Object.extend({onCancel:Prototype.emptyFunction,onSubmit:Prototype.emptyFunction,max_width:this.editField.getWidth(),paddingRight:10},b||{});var c=function(){return this.editField&&this.editField.completer_active&&this.editField.completer_active()}.bind(this);this.boundTextAreaTransformer_AndSubmitter=function(a){if(a.stopped)return;var b=!(a.ctrlKey||a.altKey||a.shiftKey||a.metaKey);if(Event.KEY_RETURN==a.keyCode){if(a.ctrlKey||a.metaKey){this.options.onSubmit(),Event.stop(a);return}if(c()&&this.editField.completer_focused()){maxkir.debug("Ignore Enter when completer is focused");return}if(!this._multiline_submit&&b){this.options.onSubmit(),Event.stop(a);return}a.shiftKey&&(this._enable_multiline_submit(!0),this.make_multiline(),this.scrollIntoView(),this.editField.value.blank()&&Event.stop(a)),this.fix_multiline(!0)}if(c()){maxkir.debug("Ignore while completer is active");return}if(Event.KEY_ESC==a.keyCode&&b){this._value_before_cancel=this.editField.value,this.options.onCancel(a);if(this.options.onEscUndo&&maxkir.Undo&&Math.abs(this._value_on_start.length-this._value_before_cancel.length)>3){var d=this;setTimeout(function(){maxkir.Undo.show_undo("Your edits were discarded",function(){d.options.onEscUndo(d._value_before_cancel)})},20)}}this._update_multiline_submit_mode()}.bind(this)},maxkir.extend(maxkir.ui.Textarea,{start:function(a){!a||parseInt(a)<14?(this.editField.style.height="",this.initial_height=0):(this.editField.style.height=a,this.initial_height=parseInt(a)),this.one_line=!0,this._enable_multiline_submit(!1),this._update_multiline_submit_mode(),this.editField.addClassName("one_line"),this.editField.style.width="",this.editField.style.paddingRight=this.options.paddingRight+"px",this.editField.scrollTop=this.editField.scrollHeight,this.dispose(),this.line_height=maxkir.CursorPosition.getTextMetrics(this.editField,"H",this._padding_right())[1],this._set_horizontal_width(!0,Prototype.emptyFunction),maxkir.info("Start textarea support, enforced height "+this.initial_height+"; scroll height: "+this.editField.scrollHeight+"; line_height: "+this.line_height+"; height: "+this.editField.offsetHeight),this.kbd_handler=this.editField.on("keydown",this.boundTextAreaTransformer_AndSubmitter),this.fix_multiline(!0);var b;this.updater_inteval=setInterval(function(){b!=this.editField.value&&(b=this.editField.value,this.fix_multiline(!1))}.bind(this),100);var c=this;setTimeout(function(){c.editField.focus()},10)},dispose:function(){this.insertedButton&&(maxkir.remove_element(this.insertedButton),this.insertedButton=null),this.kbd_handler&&this.kbd_handler.stop(),this.updater_inteval&&(clearInterval(this.updater_inteval),this.updater_inteval=null,maxkir.info("Dispose textarea support"))},prepare_submit_and_cancel:function(){if(this.insertedButton)return;var a=this.editField.parentNode,b=a.next("input");if(!b)return;var c=document.createElement("button");c.className="submit",c.innerHTML="&#9166;",c.old_title=b.value,b.parentNode.insertBefore(c,b),c.on("click",function(a){b.click(),Event.stop(a)}),b.style.display="none",this.insertedButton=c,this._update_submit_button();var d=a.next("a");d.title="Cancel [Esc]",d.innerHTML="&#x2715;",this.initial_height>0&&this.initial_height<=30&&[c,d].forEach(function(a){a.style.height=this.initial_height+"px",a.style.lineHeight=this.initial_height-2+"px"}.bind(this))},_update_submit_button:function(){this.insertedButton&&(this.insertedButton.title=(this.insertedButton.old_title||"")+(this._multiline_submit?maxkir.MAC?" [⌘Enter]":" [Ctrl+Enter]":" [Enter]"),this._multiline_submit&&(this.insertedButton.innerHTML=maxkir.MAC?"⌘&#9166;":"&#x2713;"))},calculate_field_max_params:function(){if(this.options.max_width)this.max_width=this.options.max_width;else{var a=this.editField.up("form");if(a){this.max_width=this._right_boundary()-maxkir.getPageOffset(this.editField)[0];var b=12;this.max_width+=b}else this.max_width=(maxkir.screen()[0]-maxkir.getPageOffset(this.editField)[0])/1.7}this.max_height=maxkir.screen()[1]-100},_right_boundary:function(){if(!this._right_boundary_val){var a=this.editField.up("form");this._right_boundary_val=maxkir.getPageOffset(a)[0]+a.getWidth()}return this._right_boundary_val},fix_multiline:function(a){this.need_multiline()&&this._set_horizontal_width(a,this.fix_multiline_and_height.bind(this,a))},fix_multiline_and_height:function(a){this.should_update_scrolling=!1,this.need_multiline()&&this.make_multiline();if(this.editField.getHeight()<this.editField.scrollHeight){var b=this.editField.scrollHeight+25;b>this.max_height&&(b=this.max_height),this.should_update_scrolling=!0,this.change_style(a,this.editField.getHeight(),b,"height",this.finalize_resize.bind(this,a))}else this.finalize_resize(a)},finalize_resize:function(a){this.calculate_field_max_params(),this.should_update_scrolling&&this.scrollIntoView(a),this.options.onResize&&this.options.onResize(this)},_set_horizontal_width:function(a,b){this.calculate_field_max_params();var c=this.get_max_line_width()+35;c<300&&(c=300),c>this.editField.getWidth()&&this.editField.getWidth()<this.max_width?this.change_style(a,this.editField.getWidth(),this.max_width,"width",b):b()},change_style:function(a,b,c,d,e){if(c<=b)return;maxkir.debug("textarea: change  "+d+" from "+b+" to "+c);if(a){this.editField.style[d]=c+"px",e&&e();return}maxkir.animate(100,function(a){this.editField.style[d]=b+Math.round((c-b)*a)+"px",a==1&&e&&e()}.bind(this))},make_multiline:function(){this.is_multiline()||(this.editField.removeClassName("one_line"),this.editField.style.height="",this.one_line=!1,this.should_update_scrolling=!0,this._update_multiline_submit_mode())},_enable_multiline_submit:function(a){"use strict";var b=maxkir.user&&maxkir.user.get_boolean_pref("enter_always_submits");b&&(a=!1),a&&!this._multiline_submit?(this._multiline_submit=!0,this._update_submit_button(),this._append_footer_hint()):!a&&this._multiline_submit&&(this._multiline_submit=!1,this._update_submit_button(),this._remove_footer_hint())},_remove_footer_hint:function(){this._hintFooter&&(this._hintFooter.remove(),this._hintFooter=null)},_append_footer_hint:function(){"use strict";var a=document.createElement("footer");a.className="multilineHint",this._hintFooter=a;var b=I18N("multiline_footer_hint");maxkir.MAC&&(b=b.replace(/Ctrl\+/,"⌘")),a.innerHTML=b,this.wrapper.appendChild(a)},_update_multiline_submit_mode:function(){this.editField.value.trim().indexOf("\n")>=0&&this._enable_multiline_submit(!0)},scrollIntoView:function(a){maxkir.debug("textarea: scrollIntoView"),this.should_update_scrolling=!1,maxkir.scrollTo(this.editField,null,this.editField.getHeight(),!a)},need_multiline:function(){return this.editField.scrollHeight>this.editField.offsetHeight},is_multiline:function(){return!this.one_line},get_max_line_width:function(){var a=$F(this.editField).split(/\n/),b=0;for(var c=0;c<a.length;c++){var d=a[c],e=maxkir.CursorPosition.getTextMetrics(this.editField,d,this._padding_right())[0];e>b&&(b=e)}return b},_padding_right:function(){return parseInt(this.editField.style.paddingRight)}}),maxkir.ui=maxkir.ui||{},maxkir.ui.InplaceEditor=function(a,b,c,d){delete Ajax.InPlaceEditor.Listeners.click,delete Ajax.InPlaceEditor.Listeners.keydown,d=d||{};var e={okButton:!0,cancelLink:!0,okText:"Save",cancelText:maxkir.isMobile?" X ":"x",rows:4,submitHandlerPromise:null,no_dblclick:!1,submitOnBlur:!1,evalScripts:!0,htmlResponse:!1,highlightcolor:"#ffffff",callback:function(a,b){maxkir.EditTracker.stop_editing(this.element.id);if(b&&b.escapeHTML&&this.element){this.updateOnSaving(this.element,b);var c="&";return maxkir.refresher&&(c+=maxkir.refresher.add_on()),Form.serialize(a)+c}return""}.bind(this),onFailure:function(a){maxkir.error("AJAX call error from editor",+a)},onComplete:function(a,b){a&&a.responseText&&this.updateOnComplete(b,a)}.bind(this),onEnterEditMode:function(){this.original_text=this.getText(),this.element_height=this.element.offsetHeight}.bind(this),onFormCustomization:function(a,b){this.editField=$(this._controls.editor),this.editorFieldId=this.editField.identify(),maxkir.EditTracker.start_editing(this.editorFieldId),this.customizeEditField()}.bind(this),ajaxOptions:d},f=function(a,b){for(var c in b){if(!b.hasOwnProperty(c))continue;var d=b[c];typeof d=="function"&&typeof a[c]=="function"?maxkir.run_after(a,c,d):a[c]=b[c]}};f(e,c),e.no_dblclick?delete Ajax.InPlaceEditor.Listeners.dblclick:Ajax.InPlaceEditor.Listeners.dblclick="enterEditMode",this.avoid_submit_without_change(),Ajax.InPlaceEditor.prototype.initialize.call(this,a,b,e),this.element.title=e.no_dblclick?"":"Double-click to edit text"},maxkir.extend(maxkir.ui.InplaceEditor,{isEditing:function(){return this._editing},removeForm:function(){this._form&&(this._form.parentNode&&this._form.remove(),this._form=null),this._controls={}},install_click_editor:function(){this.element.title="Click to edit";var a=function(a){this.enterEditMode(a)}.bind(this);this._listeners.click=a,this.element.observe("click",a)},handleFormSubmission:function(a){if(typeof this.options.submitHandlerPromise=="function"){var b=this._form,c=$F(this._controls.editor);this.prepareSubmission();var d=this.options.callback(b,c)||"";Object.isString(d)&&(d=d.toQueryParams());var e=this;this.options.submitHandlerPromise(d).then(this._boundWrapperHandler,function(){e._boundFailureHandler(),e._boundWrapperHandler()}),a&&Event.stop(a)}else Ajax.InPlaceEditor.prototype.handleFormSubmission.apply(this,arguments)},avoid_submit_without_change:function(){maxkir.run_around(this,"handleFormSubmission",function(){var a=$A(arguments),b=a.shift(),c=$F(this._controls.editor);return c==this.original_text?(this.handleFormCancellation(),!1):b.apply(this,a)}.bind(this))},add_textarea_support:function(){this.maxkir_textarea=new maxkir.ui.Textarea(this.editField,{max_width:null,onSubmit:this.inplaceEditorSubmitOnEnter.bind(this),onCancel:this.inplaceEditorCancelOnEscape.bind(this),onEscUndo:this.options.onEscUndo.bind(this)});var a=this.editField.value.indexOf("\n")>=0;this.maxkir_textarea.start(a?0:this.element_height+"px",!this.options.okButton),this.maxkir_textarea.prepare_submit_and_cancel()},esc_undo:function(a,b){a.enterEditMode(),a.editField.value=b},inplaceEditorSubmitOnEnter:function(){this.handleFormSubmission()},inplaceEditorCancelOnEscape:function(a){this.handleFormCancellation(),Event.stop(a)},_focused:function(){return this.editField==document.activeElement},customizeEditField:function(){this.boundBlur=function(a){setTimeout(function(){if(!this.editField)return;this._editing&&!this._focused()&&!this.editField._ignoreBlur&&document.hasFocus()&&this._controls.editor&&this._boundSubmitHandler()}.bind(this),300)}.bindAsEventListener(this);var a=this.editField;a.observe("blur",this.boundBlur);var b=function(a){return Element.getStyle(this.element,a)}.bind(this);a.style.fontFamily=b("font-family"),a.style.fontWeight=b("font-weight"),a.style.fontSize=b("font-size"),a.style.lineHeight=b("line-height"),a.style.paddingTop=b("padding-top"),a.style.paddingBottom=b("padding-bottom"),a.style.paddingLeft=b("padding-left"),a.style.paddingRight=b("padding-right"),a.addClassName("text_input"),this.add_textarea_support()},disposeEditor:function(){this.editField&&this.editField.stopObserving("blur",this.boundBlur),this.maxkir_textarea&&this.maxkir_textarea.dispose()},leaveEditMode:function(){Ajax.InPlaceEditor.prototype.leaveEditMode.call(this),this.disposeEditor(),maxkir.EditTracker.stop_editing(this.editorFieldId)}},Ajax.InPlaceEditor),function(){"use strict";var root=this,timezoneJS;typeof exports!="undefined"?timezoneJS=exports:timezoneJS=root.timezoneJS={},timezoneJS.VERSION="0.4.4";var $=root.$||root.jQuery||root.Zepto,fleegix=root.fleegix,DAYS=timezoneJS.Days=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],MONTHS=timezoneJS.Months=["January","February","March","April","May","June","July","August","September","October","November","December"],SHORT_MONTHS={},SHORT_DAYS={},EXACT_DATE_TIME={},TZ_REGEXP=new RegExp("^[a-zA-Z]+/");for(var i=0;i<MONTHS.length;i++)SHORT_MONTHS[MONTHS[i].substr(0,3)]=i;for(i=0;i<DAYS.length;i++)SHORT_DAYS[DAYS[i].substr(0,3)]=i;var _arrIndexOf=Array.prototype.indexOf||function(a){if(this===null)throw new TypeError;var b=Object(this),c=b.length>>>0;if(c===0)return-1;var d=0;arguments.length>1&&(d=Number(arguments[1]),d!=d?d=0:d!==0&&d!==Infinity&&d!==-Infinity&&(d=(d>0||-1)*Math.floor(Math.abs(d))));if(d>=c)return-1;var e=d>=0?d:Math.max(c-Math.abs(d),0);for(;e<c;e++)if(e in b&&b[e]===a)return e;return-1},_fixWidth=function(a,b){if(typeof a!="number")throw"not a number: "+a;var c=a.toString();if(a.length>b)return a.substr(a.length-b,a.length);while(c.length<b)c="0"+c;return c},_transport=function(a){if(!!fleegix&&typeof fleegix.xhr!="undefined"||!!jQuery&&typeof jQuery.ajax!="undefined"){if(!a)return;if(!a.url)throw new Error("URL must be specified");return"async"in a||(a.async=!0),a.async?fleegix&&fleegix.xhr?fleegix.xhr.send({url:a.url,method:"get",handleSuccess:a.success,handleErr:a.error}):jQuery.ajax({url:a.url,dataType:"text",method:"GET",error:a.error,success:a.success}):fleegix&&fleegix.xhr?fleegix.xhr.doReq({url:a.url,async:!1}):jQuery.ajax({url:a.url,async:!1}).responseText}throw new Error("Please use the Fleegix.js XHR module, jQuery ajax, Zepto ajax, or define your own transport mechanism for downloading zone files.")};timezoneJS.Date=function(){var a=Array.prototype.slice.apply(arguments),b=null,c=null,d=[];Object.prototype.toString.call(a[0])==="[object Array]"&&(a=a[0]),typeof a[a.length-1]=="string"&&TZ_REGEXP.test(a[a.length-1])&&(c=a.pop());switch(a.length){case 0:b=new Date;break;case 1:b=new Date(a[0]);break;default:for(var e=0;e<7;e++)d[e]=a[e]||0;b=new Date(d[0],d[1],d[2],d[3],d[4],d[5],d[6])}this._useCache=!1,this._tzInfo={},this._day=0,this.year=0,this.month=0,this.date=0,this.hours=0,this.minutes=0,this.seconds=0,this.milliseconds=0,this.timezone=c||null,d.length?this.setFromDateObjProxy(b):this.setFromTimeProxy(b.getTime(),c)},timezoneJS.Date.prototype={getDate:function(){return this.date},getDay:function(){return this._day},getFullYear:function(){return this.year},getMonth:function(){return this.month},getYear:function(){return this.year-1900},getHours:function(){return this.hours},getMilliseconds:function(){return this.milliseconds},getMinutes:function(){return this.minutes},getSeconds:function(){return this.seconds},getUTCDate:function(){return this.getUTCDateProxy().getUTCDate()},getUTCDay:function(){return this.getUTCDateProxy().getUTCDay()},getUTCFullYear:function(){return this.getUTCDateProxy().getUTCFullYear()},getUTCHours:function(){return this.getUTCDateProxy().getUTCHours()},getUTCMilliseconds:function(){return this.getUTCDateProxy().getUTCMilliseconds()},getUTCMinutes:function(){return this.getUTCDateProxy().getUTCMinutes()},getUTCMonth:function(){return this.getUTCDateProxy().getUTCMonth()},getUTCSeconds:function(){return this.getUTCDateProxy().getUTCSeconds()},getTime:function(){return this._timeProxy+this.getTimezoneOffset()*60*1e3},getTimezone:function(){return this.timezone},getTimezoneOffset:function(){return this.getTimezoneInfo().tzOffset},getTimezoneAbbreviation:function(){return this.getTimezoneInfo().tzAbbr},getTimezoneInfo:function(){if(this._useCache)return this._tzInfo;var a;return this.timezone?a=this.timezone==="Etc/UTC"||this.timezone==="Etc/GMT"?{tzOffset:0,tzAbbr:"UTC"}:timezoneJS.timezone.getTzInfo(this._timeProxy,this.timezone):a={tzOffset:this.getLocalOffset(),tzAbbr:null},this._tzInfo=a,this._useCache=!0,a},getUTCDateProxy:function(){var a=new Date(this._timeProxy);return a.setUTCMinutes(a.getUTCMinutes()+this.getTimezoneOffset()),a},setDate:function(a){return this.setAttribute("date",a),this.getTime()},setFullYear:function(a,b,c){return c!==undefined&&this.setAttribute("date",1),this.setAttribute("year",a),b!==undefined&&this.setAttribute("month",b),c!==undefined&&this.setAttribute("date",c),this.getTime()},setMonth:function(a,b){return this.setAttribute("month",a),b!==undefined&&this.setAttribute("date",b),this.getTime()},setYear:function(a){return a=Number(a),0<=a&&a<=99&&(a+=1900),this.setUTCAttribute("year",a),this.getTime()},setHours:function(a,b,c,d){return this.setAttribute("hours",a),b!==undefined&&this.setAttribute("minutes",b),c!==undefined&&this.setAttribute("seconds",c),d!==undefined&&this.setAttribute("milliseconds",d),this.getTime()},setMinutes:function(a,b,c){return this.setAttribute("minutes",a),b!==undefined&&this.setAttribute("seconds",b),c!==undefined&&this.setAttribute("milliseconds",c),this.getTime()},setSeconds:function(a,b){return this.setAttribute("seconds",a),b!==undefined&&this.setAttribute("milliseconds",b),this.getTime()},setMilliseconds:function(a){return this.setAttribute("milliseconds",a),this.getTime()},setTime:function(a){if(isNaN(a))throw new Error("Units must be a number.");return this.setFromTimeProxy(a,this.timezone),this.getTime()},setUTCFullYear:function(a,b,c){return c!==undefined&&this.setUTCAttribute("date",1),this.setUTCAttribute("year",a),b!==undefined&&this.setUTCAttribute("month",b),c!==undefined&&this.setUTCAttribute("date",c),this.getTime()},setUTCMonth:function(a,b){return this.setUTCAttribute("month",a),b!==undefined&&this.setUTCAttribute("date",b),this.getTime()},setUTCDate:function(a){return this.setUTCAttribute("date",a),this.getTime()},setUTCHours:function(a,b,c,d){return this.setUTCAttribute("hours",a),b!==undefined&&this.setUTCAttribute("minutes",b),c!==undefined&&this.setUTCAttribute("seconds",c),d!==undefined&&this.setUTCAttribute("milliseconds",d),this.getTime()},setUTCMinutes:function(a,b,c){return this.setUTCAttribute("minutes",a),b!==undefined&&this.setUTCAttribute("seconds",b),c!==undefined&&this.setUTCAttribute("milliseconds",c),this.getTime()},setUTCSeconds:function(a,b){return this.setUTCAttribute("seconds",a),b!==undefined&&this.setUTCAttribute("milliseconds",b),this.getTime()},setUTCMilliseconds:function(a){return this.setUTCAttribute("milliseconds",a),this.getTime()},setFromDateObjProxy:function(a){this.year=a.getFullYear(),this.month=a.getMonth(),this.date=a.getDate(),this.hours=a.getHours(),this.minutes=a.getMinutes(),this.seconds=a.getSeconds(),this.milliseconds=a.getMilliseconds(),this._day=a.getDay(),this._dateProxy=a,this._timeProxy=Date.UTC(this.year,this.month,this.date,this.hours,this.minutes,this.seconds,this.milliseconds),this._useCache=!1},setFromTimeProxy:function(a,b){var c=new Date(a),d=b?timezoneJS.timezone.getTzInfo(a,b,!0).tzOffset:c.getTimezoneOffset();c.setTime(a+(c.getTimezoneOffset()-d)*6e4),this.setFromDateObjProxy(c)},setAttribute:function(a,b){if(isNaN(b))throw new Error("Units must be a number.");var c=this._dateProxy,d=a==="year"?"FullYear":a.substr(0,1).toUpperCase()+a.substr(1);c["set"+d](b),this.setFromDateObjProxy(c)},setUTCAttribute:function(a,b){if(isNaN(b))throw new Error("Units must be a number.");var c=a==="year"?"FullYear":a.substr(0,1).toUpperCase()+a.substr(1),d=this.getUTCDateProxy();d["setUTC"+c](b),d.setUTCMinutes(d.getUTCMinutes()-this.getTimezoneOffset()),this.setFromTimeProxy(d.getTime()+this.getTimezoneOffset()*6e4,this.timezone)},setTimezone:function(a){var b=this.getTimezoneInfo().tzOffset;this.timezone=a,this._useCache=!1,this.setUTCMinutes(this.getUTCMinutes()-this.getTimezoneInfo().tzOffset+b)},removeTimezone:function(){this.timezone=null,this._useCache=!1},valueOf:function(){return this.getTime()},clone:function(){return this.timezone?new timezoneJS.Date(this.getTime(),this.timezone):new timezoneJS.Date(this.getTime())},toGMTString:function(){return this.toString("EEE, dd MMM yyyy HH:mm:ss Z","Etc/GMT")},toLocaleString:function(){},toLocaleDateString:function(){},toLocaleTimeString:function(){},toSource:function(){},toISOString:function(){return this.toString("yyyy-MM-ddTHH:mm:ss.SSS","Etc/UTC")+"Z"},toJSON:function(){return this.toISOString()},toString:function(a,b){a||(a="yyyy-MM-dd HH:mm:ss");var c=a,d=b?timezoneJS.timezone.getTzInfo(this.getTime(),b):this.getTimezoneInfo(),e=this;b&&(e=this.clone(),e.setTimezone(b));var f=e.getHours();return c
.replace(/a+/g,function(){return"k"}).replace(/y+/g,function(a){return _fixWidth(e.getFullYear(),a.length)}).replace(/d+/g,function(a){return _fixWidth(e.getDate(),a.length)}).replace(/m+/g,function(a){return _fixWidth(e.getMinutes(),a.length)}).replace(/s+/g,function(a){return _fixWidth(e.getSeconds(),a.length)}).replace(/S+/g,function(a){return _fixWidth(e.getMilliseconds(),a.length)}).replace(/h+/g,function(a){return _fixWidth(f%12===0?12:f%12,a.length)}).replace(/M+/g,function(a){var b=e.getMonth(),c=a.length;return c>3?timezoneJS.Months[b]:c>2?timezoneJS.Months[b].substring(0,c):_fixWidth(b+1,c)}).replace(/k+/g,function(){return f>=12?(f>12&&(f-=12),"PM"):"AM"}).replace(/H+/g,function(a){return _fixWidth(f,a.length)}).replace(/E+/g,function(a){return DAYS[e.getDay()].substring(0,a.length)}).replace(/Z+/gi,function(){return d.tzAbbr})},toUTCString:function(){return this.toGMTString()},civilToJulianDayNumber:function(a,b,c){var d;b++,b>12&&(d=parseInt(b/12,10),b=b%12,a+=d),b<=2&&(a-=1,b+=12),d=Math.floor(a/100);var e=2-d+Math.floor(d/4),f=Math.floor(365.25*(a+4716))+Math.floor(30.6001*(b+1))+c+e-1524;return f},getLocalOffset:function(){return this._dateProxy.getTimezoneOffset()}},timezoneJS.timezone=new function(){function invalidTZError(a){throw new Error('Timezone "'+a+'" is either incorrect, or not loaded in the timezone registry.')}function builtInLoadZoneFile(a,b){var c=_this.zoneFileBasePath+"/"+a+".bin";return!b||!b.async?_this.parseZones(_this.transport({url:c,async:!1})):_this.transport({async:!0,url:c,success:function(a){return _this.parseZones(a)&&typeof b.callback=="function"&&b.callback()},error:function(){throw new Error('Error retrieving "'+c+'" zoneinfo files')}})}function getRegionForTimezone(a){var b=regionExceptions[a],c,d;if(b)return b;c=a.split("/")[0],d=regionMap[c];if(d)return d;var e=_this.zones[a];if(typeof e=="string")return getRegionForTimezone(e);if(!_this.loadedZones.backward)return _this.loadZoneFile("backward"),getRegionForTimezone(a);invalidTZError(a)}function parseTimeString(a){var b=/(\d+)(?::0*(\d*))?(?::0*(\d*))?([wsugz])?$/,c=a.match(b);return c[1]=parseInt(c[1],10),c[2]=c[2]?parseInt(c[2],10):0,c[3]=c[3]?parseInt(c[3],10):0,c.slice(1,5)}function processZone(a){if(!a[3])return;var b=parseInt(a[3],10),c=11,d=31;a[4]&&(c=SHORT_MONTHS[a[4].substr(0,3)],d=parseInt(a[5],10)||1);var e=a[6]?parseTimeString(a[6]):[0,0,0];return[b,c,d,e[0],e[1],e[2]]}function getZone(a,b){var c=typeof a=="number"?a:(new Date(a)).getTime(),d=b,e=_this.zones[d];while(typeof e=="string")d=e,e=_this.zones[d];if(!e){if(!_this.loadedZones.backward)return _this.loadZoneFile("backward"),getZone(a,b);invalidTZError(d)}if(e.length===0)throw new Error('No Zone found for "'+b+'" on '+a);for(var f=e.length-1;f>=0;f--){var g=e[f];if(g[3]&&c>g[3])break}return e[f+1]}function getBasicOffset(a){var b=parseTimeString(a),c=a.charAt(0)==="-"?-1:1;return b=c*((b[0]*60+b[1])*60+b[2])*1e3,b/60/1e3}function getAdjustedOffset(a,b){return-Math.ceil(b-a)}function getRule(a,b,c){var d=typeof a=="number"?new Date(a):a,e=b[1],f=b[0],g=e.match(/^([0-9]):([0-9][0-9])$/);if(g)return[-1e6,"max","-","Jan",1,[0,0,0],parseInt(g[1],10)*60+parseInt(g[2],10),"-"];var h=function(a,b,c){var d=0;if(b==="u"||b==="g"||b==="z")d=0;else if(b==="s")d=f;else if(b==="w"||!b)d=getAdjustedOffset(f,c[6]);else throw new Error("unknown type "+b);return d*=6e4,new Date(a.getTime()+d)},i=function(a,b){var c=a[0],d=a[1],e=d[5],f;EXACT_DATE_TIME[c]||(EXACT_DATE_TIME[c]={});if(EXACT_DATE_TIME[c][d])f=EXACT_DATE_TIME[c][d];else{if(!isNaN(d[4]))f=new Date(Date.UTC(c,SHORT_MONTHS[d[3]],d[4],e[0],e[1],e[2],0));else{var g,i;d[4].substr(0,4)==="last"?(f=new Date(Date.UTC(c,SHORT_MONTHS[d[3]]+1,1,e[0]-24,e[1],e[2],0)),g=SHORT_DAYS[d[4].substr(4,3)],i="<="):(f=new Date(Date.UTC(c,SHORT_MONTHS[d[3]],d[4].substr(5),e[0],e[1],e[2],0)),g=SHORT_DAYS[d[4].substr(0,3)],i=d[4].substr(3,2));var j=f.getUTCDay();i===">="?f.setUTCDate(f.getUTCDate()+(g-j+(g<j?7:0))):f.setUTCDate(f.getUTCDate()+(g-j-(g>j?7:0)))}EXACT_DATE_TIME[c][d]=f}return b&&(f=h(f,e[3],b)),f},j=function(a,b){var c=[];for(var d=0;b&&d<b.length;d++)b[d][0]<=a&&(b[d][1]>=a||b[d][0]===a&&b[d][1]==="only"||b[d][1]==="max")&&c.push([a,b[d]]);return c},k=function(a,b,d){var e,f;return a instanceof Date?d&&(a=h(a,c?"u":"w",d)):(e=a[0],f=a[1],a=!d&&EXACT_DATE_TIME[e]&&EXACT_DATE_TIME[e][f]?EXACT_DATE_TIME[e][f]:i(a,d)),b instanceof Date?d&&(b=h(b,c?"u":"w",d)):(e=b[0],f=b[1],b=!d&&EXACT_DATE_TIME[e]&&EXACT_DATE_TIME[e][f]?EXACT_DATE_TIME[e][f]:i(b,d)),a=Number(a),b=Number(b),a-b},l=d.getUTCFullYear(),m;m=j(l,_this.rules[e]),m.push(d),m.sort(k),_arrIndexOf.call(m,d)<2&&(m=m.concat(j(l-1,_this.rules[e])),m.sort(k));var n=_arrIndexOf.call(m,d);return n>1&&k(d,m[n-1],m[n-2][1])<0?m[n-2][1]:n>0&&n<m.length-1&&k(d,m[n+1],m[n-1][1])>0?m[n+1][1]:n===0?null:m[n-1][1]}function getAbbreviation(a,b){var c=a[2];if(c.indexOf("%s")>-1){var d;return b?d=b[7]==="-"?"":b[7]:d="S",c.replace("%s",d)}return c.indexOf("/")>-1?c.split("/",2)[b[6]?1:0]:c}var _this=this,regionMap={Etc:"etcetera",EST:"northamerica",MST:"northamerica",HST:"northamerica",EST5EDT:"northamerica",CST6CDT:"northamerica",MST7MDT:"northamerica",PST8PDT:"northamerica",America:"northamerica",Pacific:"australasia",Atlantic:"europe",Africa:"africa",Indian:"africa",Antarctica:"antarctica",Asia:"asia",Australia:"australasia",Europe:"europe",WET:"europe",CET:"europe",MET:"europe",EET:"europe"},regionExceptions={"Pacific/Honolulu":"northamerica","Atlantic/Bermuda":"northamerica","Atlantic/Cape_Verde":"africa","Atlantic/St_Helena":"africa","Indian/Kerguelen":"antarctica","Indian/Chagos":"asia","Indian/Maldives":"asia","Indian/Christmas":"australasia","Indian/Cocos":"australasia","America/Danmarkshavn":"europe","America/Scoresbysund":"europe","America/Godthab":"europe","America/Thule":"europe","Asia/Istanbul":"europe","Asia/Yekaterinburg":"europe","Asia/Omsk":"europe","Asia/Novosibirsk":"europe","Asia/Krasnoyarsk":"europe","Asia/Irkutsk":"europe","Asia/Yakutsk":"europe","Asia/Vladivostok":"europe","Asia/Sakhalin":"europe","Asia/Magadan":"europe","Asia/Kamchatka":"europe","Asia/Anadyr":"europe","Africa/Ceuta":"europe","America/Argentina/Buenos_Aires":"southamerica","America/Argentina/San_Luis":"southamerica","America/Argentina/Cordoba":"southamerica","America/Argentina/Tucuman":"southamerica","America/Argentina/La_Rioja":"southamerica","America/Argentina/San_Juan":"southamerica","America/Argentina/Jujuy":"southamerica","America/Argentina/Catamarca":"southamerica","America/Argentina/Mendoza":"southamerica","America/Argentina/Rio_Gallegos":"southamerica","America/Argentina/Ushuaia":"southamerica","America/Aruba":"southamerica","America/La_Paz":"southamerica","America/Noronha":"southamerica","America/Belem":"southamerica","America/Fortaleza":"southamerica","America/Recife":"southamerica","America/Araguaina":"southamerica","America/Maceio":"southamerica","America/Bahia":"southamerica","America/Sao_Paulo":"southamerica","America/Campo_Grande":"southamerica","America/Cuiaba":"southamerica","America/Porto_Velho":"southamerica","America/Boa_Vista":"southamerica","America/Manaus":"southamerica","America/Eirunepe":"southamerica","America/Rio_Branco":"southamerica","America/Santiago":"southamerica","Pacific/Easter":"southamerica","America/Bogota":"southamerica","America/Curacao":"southamerica","America/Guayaquil":"southamerica","Pacific/Galapagos":"southamerica","Atlantic/Stanley":"southamerica","America/Cayenne":"southamerica","America/Guyana":"southamerica","America/Asuncion":"southamerica","America/Lima":"southamerica","Atlantic/South_Georgia":"southamerica","America/Paramaribo":"southamerica","America/Port_of_Spain":"southamerica","America/Montevideo":"southamerica","America/Caracas":"southamerica"};this.zoneFileBasePath=null,this.zoneFiles=["africa","antarctica","asia","australasia","backward","etcetera","europe","northamerica","pacificnew","southamerica"],this.loadingSchemes={PRELOAD_ALL:"preloadAll",LAZY_LOAD:"lazyLoad",MANUAL_LOAD:"manualLoad"},this.loadingScheme=this.loadingSchemes.LAZY_LOAD,this.loadedZones={},this.zones={},this.rules={},this.init=function(a){var b={async:!0},c=this.loadingScheme===this.loadingSchemes.PRELOAD_ALL?this.zoneFiles:this.defaultZoneFile||"northamerica",d=0,e;for(var f in a)b[f]=a[f];if(typeof c=="string")return this.loadZoneFile(c,b);e=b.callback,b.callback=function(){d++,d===c.length&&typeof e=="function"&&e()};for(var g=0;g<c.length;g++)this.loadZoneFile(c[g],b)},this.loadZoneFile=function(a,b){if(typeof this.zoneFileBasePath=="undefined")throw new Error("Please define a base path to your zone file directory -- timezoneJS.timezone.zoneFileBasePath.");if(this.loadedZones[a])return;return this.loadedZones[a]=!0,builtInLoadZoneFile(a,b)},this.loadZoneJSONData=function(url,sync){var processData=function(data){data=eval("("+data+")");for(var z in data.zones)_this.zones[z]=data.zones[z];for(var r in data.rules)_this.rules[r]=data.rules[r]};return sync?processData(_this.transport({url:url,async:!1})):_this.transport({url:url,success:processData})},this.loadZoneDataFromObject=function(a){if(!a)return;for(var b in a.zones)_this.zones[b]=a.zones[b];for(var c in a.rules)_this.rules[c]=a.rules[c]},this.getAllZones=function(){var a=[];for(var b in this.zones)a.push(b);return a.sort()},this.parseZones=function(a){var b=a.split("\n"),c=[],d="",e,f=null,g=null;for(var h=0;h<b.length;h++){e=b[h],e.match(/^\s/)&&(e="Zone "+f+e),e=e.split("#")[0];if(e.length>3){c=e.split(/\s+/),d=c.shift();switch(d){case"Zone":f=c.shift(),_this.zones[f]||(_this.zones[f]=[]);if(c.length<3)break;c.splice(3,c.length,processZone(c)),c[3]&&(c[3]=Date.UTC.apply(null,c[3])),c[0]=-getBasicOffset(c[0]),_this.zones[f].push(c);break;case"Rule":g=c.shift(),_this.rules[g]||(_this.rules[g]=[]),c[0]=parseInt(c[0],10),c[1]=parseInt(c[1],10)||c[1],c[5]=parseTimeString(c[5]),c[6]=getBasicOffset(c[6]),_this.rules[g].push(c);break;case"Link":if(_this.zones[c[1]])throw new Error("Error with Link "+c[1]+". Cannot create link of a preexisted zone.");_this.zones[c[1]]=c[0]}}}return!0},this.transport=_transport,this.getTzInfo=function(a,b,c){if(this.loadingScheme===this.loadingSchemes.LAZY_LOAD){var d=getRegionForTimezone(b);if(!d)throw new Error("Not a valid timezone ID.");this.loadedZones[d]||this.loadZoneFile(d)}var e=getZone(a,b),f=e[0],g=getRule(a,e,c);g&&(f=getAdjustedOffset(f,g[6]));var h=getAbbreviation(e,g);return{tzOffset:f,tzAbbr:h}}}}.call(this),timezoneJS.timezone.zoneFileBasePath="/assets/tz",timezoneJS.timezone.transport=function(a){a.method="GET",a.success&&(a.onSuccess=function(b){a.success(b.responseText)});var b=null;return a.async===!1&&(a.asynchronous=!1,a.onSuccess=function(a){b=a.responseText}),new Ajax.Request(a.url,a),b},timezoneJS.timezone.init(),DateExtension(timezoneJS.Date),window.maxkir||(maxkir={}),maxkir.FF=/Firefox/i.test(navigator.userAgent),typeof document.defaultView=="undefined"&&(document.defaultView={},document.defaultView.getComputedStyle=function(a){return a.currentStyle}),maxkir.CursorPosition=function(a,b){this.element=a,this.padding=b;var c=this,d=function(){if(typeof a.selectionStart=="undefined"&&document.selection){var b=document.selection.createRange(),c=b.duplicate();a.type=="text"?(c.moveStart("character",-a.value.length),c.moveEnd("character",a.value.length)):c.moveToElementText(a),c.setEndPoint("EndToEnd",b);var d=c.text.length-b.text.length,e=d+b.text.length;return[d,e]}return[a.selectionStart,a.selectionEnd]};this.get_selection_range=function(){try{return d()}catch(a){return[0,0]}},this.get_string_metrics=function(c){return maxkir.CursorPosition.getTextMetrics(a,c,b)};var e=new maxkir.StringSplitter(function(a){var b=c.get_string_metrics(a);return b[0]});this.split_to_lines=function(){var b=a.scrollWidth;maxkir.FF&&(b-=4);var d=c.get_selection_range()[0];return e.splitString(a.value.substr(0,d),b)}},maxkir.CursorPosition.prototype.getCursorCoordinates=function(){var a=this.split_to_lines();return[a[a.length-1].length,a.length]},maxkir.CursorPosition.prototype.getPixelCoordinates=function(){var a=this.split_to_lines(),b=this.get_string_metrics(a[a.length-1]),c=b[0]-this.element.scrollLeft,d=b[1]*a.length-this.element.scrollTop+this.padding;return[c,d]},maxkir.CursorPosition.getTextMetrics=function(a,b,c){var d=a,e=function(a,b){var c=d.style[b];if(!c){var e=document.defaultView.getComputedStyle(d,null);c=e?e[b]:null}c&&(a.style[b]=c)},f="__widther",g=document.getElementById(f);return g||(g=document.createElement("div"),document.body.appendChild(g),g.id=f,g.style.position="absolute",g.style.left="-10000000px",g.style.visibility="hidden"),e(g,"fontSize"),e(g,"fontFamily"),e(g,"fontWeight"),e(g,"fontVariant"),e(g,"fontStyle"),e(g,"textTransform"),e(g,"lineHeight"),g.style.width="0",g.style.paddingLeft=c+"px",d.type&&(d.type.toUpperCase()=="TEXTAREA"||d.type.toUpperCase()=="INPUT")&&(b=b.replace(" ","&nbsp;").replace(/</g,"&lt;")),g.innerHTML=b,g.style.width="auto",[g.offsetWidth,g.offsetHeight]},window.maxkir||(maxkir={}),maxkir.StringSplitter=function(a){this.get_width=a},maxkir.StringSplitter.prototype.splitString=function(a,b){if(a.length==0)return[""];var c=-1,d=!1,e=this,f=function(c){var d=a.substr(c+1);return d.length>0?[a.substr(0,c+1)].concat(e.splitString(d,b)):[a.substr(0,c+1)]};for(var g=0;g<a.length;g++){if(a.charAt(g)==" "){d=this.get_width(a.substr(0,g))>b;if(d&&c>0)return f(c);if(d)return f(g);c=g}if(a.charAt(g)=="\n")return f(g)}return c>0&&this.get_width(a)>b?f(c):[a]},maxkir.FocusWatcher=function(a,b){this.options=b||{},this.elements=a,this.startWatching(),maxkir.FocusWatcher.watchMouse()},Object.extend(maxkir.FocusWatcher.prototype,{dispose:function(){this.handlers.each(function(a){a.stop()}),this.handlers=null,this.elements=null,this.options=null},startWatching:function(){this.handlers=[],this.elements.each(function(a){this.handlers.push(a.on("focus",this.focusHandler.bind(this))),this.handlers.push(a.on("blur",this.blurHandler.bind(this)))},this)},focusHandler:function(){this._focused=!0,this.options.onFocus&&this.options.onFocus()},blurHandler:function(){this._focused=!1;var a=function(){setTimeout(function(){if(maxkir.FocusWatcher.mouse_is_down){a();return}!this._focused&&this.options&&this.options.onBlur&&this.options.onBlur()}.bind(this),50)}.bind(this);a()}}),maxkir.FocusWatcher.watchMouse=function(){this.clicks_watched||(this.clicks_watched=!0,document.observe("mousedown",function(a){maxkir.FocusWatcher.mouse_is_down=!0}),document.observe("mouseup",function(a){maxkir.FocusWatcher.mouse_is_down=!1}))},maxkir.ui=maxkir.ui||{},maxkir.ui.TabsUL=function(a,b,c){this.containerId=a,this.tabs=b,this.tabs_map={},b.each(function(a){this.tabs_map[a.id]=a}.bind(this)),this.handlers=[],this.changeTo(c)},maxkir.extend(maxkir.ui.TabsUL,{addListener:function(a){this.handlers.push(a)},updateTabs:function(){this._uninstallHandlers(),$(this.containerId)&&($(this.containerId).innerHTML=this.getHTML(),this._installHandlers())},visible_tab:function(a){return this.tabs_map[a]},getHTML:function(){var a="";return this.tabs.each(function(b){this.visible_tab(b.id)&&(a+=this._tabHtml(b))},this),a},changeTo:function(a,b,c){return a==""||this.selected==a||!this.visible_tab(a)?!1:(this.selected&&$(this.selected+"_content")&&$(this.selected+"_content").hide(),this.selected=a,$(this.selected+"_content")&&($(this.selected+"_content").style.display="block"),this.handlers.each(function(d){d.call(this,a,this.tabs_map[a],b,c)},this),this.updateTabs(),!0)},set_tab_text:function(a,b){this.tabs_map[a].text=b,this.updateTabs()},remove_tab:function(a){delete this.tabs_map[a],this.updateTabs()},_tabHtml:function(a){var b=this.selected==a.id?"class='selected'":"";return"<li "+b+" id='tab_"+a.id+"'><a href='#"+a.id+"' id='tab_link_"+a.id+"' onclick='return false'>"+a.text+"</a></li>"},_uninstallHandlers:function(){this.tabs.each(function(a){var b=$("tab_link_"+a.id);b&&(b.onclick=null)},this)},_installHandlers:function(){this.tabs.each(function(a){this.visible_tab(a.id)&&this._installHandler(a)},this)},_installHandler:function(a){var b=$("tab_link_"+a.id),c=this;b&&(b.onclick=function(){return c.changeTo(a.id),!1})}});var Window=Class.create();Window.keepMultiModalWindow=!1,Window.hasEffectLib=typeof Effect!="undefined",Window.resizeEffectDuration=.4,Window.SHOW_ANIMATION_MSEC=500,Window.OVERLAY_OPACITY=.6,Window.prototype={initialize:function(){var a,b=0;arguments.length>0&&(typeof arguments[0]=="string"?(a=arguments[0],b=1):a=arguments[0]?arguments[0].id:null),a||(a="window_"+(new Date).getTime()),$(a)&&alert("Window "+a+" is already registered in the DOM! Make sure you use setDestroyOnClose() or destroyOnClose: true in the constructor"),this.options=Object.extend({className:"dialog",blurClassName:null,minWidth:100,minHeight:20,userData:null,showEffect:function(a){a.setOpacity(0),a.show(),maxkir.animate(Window.SHOW_ANIMATION_MSEC,function(b){a.setOpacity(b),b==1&&this.options.showEffectOptions&&this.options.showEffectOptions.afterFinish&&this.options.showEffectOptions.afterFinish()}.bind(this))}.bind(this),hideEffect:function(a){maxkir.animate(Window.SHOW_ANIMATION_MSEC,function(b){a.setOpacity(1-b),b==1&&a.hide()})},parent:document.body,title:"&nbsp;",onload:Prototype.emptyFunction,width:200,height:300,opacity:1,recenterAuto:!0,wiredDrag:!1,closeCallback:null,destroyOnClose:!1,gridX:1,gridY:1},arguments[b]||{}),this.options.blurClassName&&(this.options.focusClassName=this.options.className),typeof this.options.top=="undefined"&&typeof this.options.bottom=="undefined"&&(this.options.top=this._round(Math.random()*500,this.options.gridY)),typeof this.options.left=="undefined"&&typeof this.options.right=="undefined"&&(this.options.left=this._round(Math.random()*500,this.options.gridX)),this.options.parent!=document.body&&(this.options.parent=$(this.options.parent)),this.element=this._createWindow(a),this.element.win=this,this.eventMouseDown=this._initDrag.bindAsEventListener(this),this.eventMouseUp=this._endDrag.bindAsEventListener(this),this.eventMouseMove=this._updateDrag.bindAsEventListener(this),this.eventOnLoad=this._getWindowBorderSize.bindAsEventListener(this),this.eventMouseDownContent=this.toFront.bindAsEventListener(this),this.eventResize=this._recenter.bindAsEventListener(this),this.topbar=$(this.element.id+"_top"),this.content=$(this.element.id+"_content"),Event.observe(this.topbar,"mousedown",this.eventMouseDown),Event.observe(this.content,"mousedown",this.eventMouseDownContent),Event.observe(window,"load",this.eventOnLoad),Event.observe(window,"resize",this.eventResize),Event.observe(window,"scroll",this.eventResize),Event.observe(this.options.parent,"scroll",this.eventResize),this.useLeft=null,this.useTop=null,typeof this.options.left!="undefined"?(this.element.setStyle({left:parseFloat(this.options.left)+"px"}),this.useLeft=!0):(this.element.setStyle({right:parseFloat(this.options.right)+"px"}),this.useLeft=!1),typeof this.options.top!="undefined"?(this.element.setStyle({top:parseFloat(this.options.top)+"px"}),this.useTop=!0):(this.element.setStyle({bottom:parseFloat(this.options.bottom)+"px"}),this.useTop=!1),this.storedLocation=null,this.setOpacity(this.options.opacity),this.options.zIndex&&this.setZIndex(this.options.zIndex),this.options.destroyOnClose&&this.setDestroyOnClose(!0),this._getWindowBorderSize(),this.width=this.options.width,this.height=this.options.height,this.visible=!1,this.constraint=!1,this.constraintPad={top:0,left:0,bottom:0,right:0},this.width&&this.height&&this.setSize(this.options.width,this.options.height),this.setTitle(this.options.title),Windows.register(this)},destroy:function(){this._notify("onDestroy"),Event.stopObserving(this.topbar,"mousedown",this.eventMouseDown),Event.stopObserving(this.content,"mousedown",this.eventMouseDownContent),Event.stopObserving(window,"load",this.eventOnLoad),Event.stopObserving(window,"resize",this.eventResize),Event.stopObserving(window,"scroll",this.eventResize),Event.stopObserving(this.options.parent,"scroll",this.eventResize),Event.stopObserving(this.content,"load",this.options.onload);if(this._oldParent){var a=this.getContent(),b=null;for(var c=0;c<a.childNodes.length;c++){b=a.childNodes[c];if(b.nodeType==1)break;b=null}b&&this._oldParent.appendChild(b),this._oldParent=null}this.sizer&&Event.stopObserving(this.sizer,"mousedown",this.eventMouseDown),Element.remove(this.element),Windows.unregister(this)},setCloseCallback:function(a){this.options.closeCallback=a},getContent:function(){return this.content},setContent:function(a,b,c){var d=$(a);if(null==d)throw"Unable to find element '"+a+"' in DOM";this._oldParent=d.parentNode;var e=null,f=null;b&&(e=Element.getDimensions(d)),c&&(f=Position.cumulativeOffset(d));var g=this.getContent();this.setHTMLContent(""),g=this.getContent(),g.appendChild(d),d.show(),b&&this.setSize(e.width,e.height),c&&this.setLocation(f[1]-this.heightN,f[0]-this.widthW)},setHTMLContent:function(a){this.getContent().innerHTML=a},setAjaxContent:function(a,b,c,d){this.showFunction=c?"showCenter":"show",this.showModal=d||!1,b=b||{},this.onComplete=b.onComplete,this._onCompleteHandler||(this._onCompleteHandler=this._setAjaxContent.bind(this)),b.onComplete=this._onCompleteHandler,new Ajax.Request(a,b),b.onComplete=this.onComplete},_setAjaxContent:function(a){this.setHTMLContent(""),Element.update(this.getContent(),a.responseText),this.onComplete&&this.onComplete(a),this.onComplete=null,this[this.showFunction](this.showModal)},refresh:function(){this.options.url&&($(this.element.getAttribute("id")+"_content").src=this.options.url)},setCookie:function(a,b,c,d,e){a=a||this.element.id,this.cookie=[a,b,c,d,e];var f=WindowUtilities.getCookie(a);if(f){var g=f.split(","),h=g[0].split(":"),i=g[1].split(":"),j=parseFloat(g[2]),k=parseFloat(g[3]),l=g[4],m=g[5];this.setSize(j,k),l=="true"?this.doMinimize=!0:m=="true"&&(this.doMaximize=!0),this.useLeft=h[0]=="l",this.useTop=i[0]=="t",this.element.setStyle(this.useLeft?{left:h[1]}:{right:h[1]}),this.element.setStyle(this.useTop?{top:i[1]}:{bottom:i[1]})}},getId:function(){return this.element.id},setDestroyOnClose:function(){this.options.destroyOnClose=!0},setConstraint:function(a,b){this.constraint=a,this.constraintPad=Object.extend(this.constraintPad,b||{}),this.useTop&&this.useLeft&&this.setLocation(parseFloat(this.element.style.top),parseFloat(this.element.style.left))},_initDrag:function(a){if(Event.element(a)==this.sizer&&this.isMinimized())return;if(Event.element(a)!=this.sizer&&this.isMaximized())return;Prototype.Browser.IE&&this.heightN==0&&this._getWindowBorderSize(),this.pointer=[this._round(Event.pointerX(a),this.options.gridX),this._round(Event.pointerY(a),this.options.gridY)],this.options.wiredDrag?this.currentDrag=this._createWiredElement():this.currentDrag=this.element;if(Event.element(a)==this.sizer)this.doResize=!0,this.widthOrg=this.width,this.heightOrg=this.height,this.bottomOrg=parseFloat(this.element.getStyle("bottom")),this.rightOrg=parseFloat(this.element.getStyle("right")),this._notify("onStartResize");else{this.doResize=!1;var b=$(this.getId()+"_close");if(b&&Position.within(b,this.pointer[0],this.pointer[1])){this.currentDrag=null;return}this.toFront();if(!this.options.draggable)return;this._notify("onStartMove")}Event.observe(document,"mouseup",this.eventMouseUp,!1),Event.observe(document,"mousemove",this.eventMouseMove,!1),WindowUtilities.disableScreen("__invisible__","__invisible__",this.overlayOpacity),document.body.ondrag=function(){return!1},document.body.onselectstart=function(){return!1},this.currentDrag.show(),Event.stop(a)},_round:function(a,b){return b==1?a:a=Math.floor(a/b)*b},_updateDrag:function(a){var b=[this._round(Event.pointerX(a),this.options.gridX),this._round(Event.pointerY(a),this.options.gridY)],c=b[0]-this.pointer[0],d=b[1]-this.pointer[1];if(this.doResize){var e=this.widthOrg+c,f=this.heightOrg+d;c=this.width-this.widthOrg,d=this.height-this.heightOrg,this.useLeft?e=this._updateWidthConstraint(e):this.currentDrag.setStyle({right:this.rightOrg-c+"px"}),this.useTop?f=this._updateHeightConstraint(f):this.currentDrag.setStyle({bottom:this.bottomOrg-d+"px"}),this.setSize(e,f),this._notify("onResize")}else{this.pointer=b;if(this.useLeft){var g=parseFloat(this.currentDrag.getStyle("left"))+c,h=this._updateLeftConstraint(g);this.pointer[0]+=h-g,this.currentDrag.setStyle({left:h+"px"})}else this.currentDrag.setStyle({right:parseFloat(this.currentDrag.getStyle("right"))-c+"px"});if(this.useTop){var i=parseFloat(this.currentDrag.getStyle("top"))+d,j=this._updateTopConstraint(i);this.pointer[1]+=j-i,this.currentDrag.setStyle({top:j+"px"})}else this.currentDrag.setStyle({bottom:parseFloat(this.currentDrag.getStyle("bottom"))-d+"px"});this._notify("onMove")}this._removeStoreLocation(),Event.stop(a)},_endDrag:function(a){WindowUtilities.enableScreen("__invisible__"),this.doResize?this._notify("onEndResize"):this._notify("onEndMove"),Event.stopObserving(document,"mouseup",this.eventMouseUp,!1),Event.stopObserving(document,"mousemove",this.eventMouseMove,!1),Event.stop(a),this._hideWiredElement(),document.body.ondrag=null,document.body.onselectstart=null},_updateLeftConstraint:function(a){if(this.constraint&&this.useLeft&&this.useTop){var b=this.options.parent==document.body?WindowUtilities.getPageSize().windowWidth:this.options.parent.getDimensions().width;a<this.constraintPad.left&&(a=this.constraintPad.left),a+this.width+this.widthE+this.widthW>b-this.constraintPad.right&&(a=b-this.constraintPad.right-this.width-this.widthE-this.widthW)}return a},_updateTopConstraint:function(a){if(this.constraint&&this.useLeft&&this.useTop){var b=this.options.parent==document.body?WindowUtilities.getPageSize().windowHeight:this.options.parent.getDimensions().height,c=this.height+this.heightN+this.heightS;a<this.constraintPad.top&&(a=this.constraintPad.top),a+c>b-this.constraintPad.bottom&&(a=b-this.constraintPad.bottom-c)}return a},_updateWidthConstraint:function(a){if(this.constraint&&this.useLeft&&this.useTop){var b=this.options.parent==document.body?WindowUtilities.getPageSize().windowWidth:this.options.parent.getDimensions().width,c=parseFloat(this.element.getStyle("left"));c+a+this.widthE+this.widthW>b-this.constraintPad.right&&(a=b-this.constraintPad.right-c-this.widthE-this.widthW)}return a},_updateHeightConstraint:function(a){if(this.constraint&&this.useLeft&&this.useTop){var b=this.options.parent==document.body?WindowUtilities.getPageSize().windowHeight:this.options.parent.getDimensions().height,c=parseFloat(this.element.getStyle("top"));c+a+this.heightN+this.heightS>b-this.constraintPad.bottom&&(a=b-this.constraintPad.bottom-c-this.heightN-this.heightS)}return a},_createWindow:function(a){var b=this.options.className,c=document.createElement("div");c.setAttribute("id",a),c.className="dialog";var d;return d='<div id="'+a+'_content" class="dialog__content '+b+'_content"> </div>',c.innerHTML="<div id='"+a+"_top' class='"+b+"_title title_window'>"+this.options.title+"</div>"+d,Element.hide(c),this.options.parent.insertBefore(c,this.options.parent.firstChild),Event.observe($(a+"_content"),"load",this.options.onload),c},changeClassName:function(a){var b=this.options.className,c=this.getId();$A(["_close","_minimize","_maximize","_sizer","_content"]).each(function(d){this._toggleClassName($(c+d),b+d,a+d)}.bind(this)),this._toggleClassName($(c+"_top"),b+"_title",a+"_title"),$$("#"+c+" td").each(function(c){c.className=c.className.sub(b,a)}),this.options.className=a},_toggleClassName:function(a,b,c){a&&(a.removeClassName(b),a.addClassName(c))},setLocation:function(a,b){a=this._updateTopConstraint(a),b=this._updateLeftConstraint(b);var c=this.currentDrag||this.element;c.setStyle({top:a+"px"}),c.setStyle({left:b+"px"}),this.useLeft=!0,this.useTop=!0},initSmoothMove:function(){var a=this.element,b="top 0.3s ease";a.setStyle({transition:b}),a.setStyle({"-webkit-transition":b}),a.setStyle({"-moz-transition":b})},getLocation:function(){var a={};return this.useTop?a=Object.extend(a,{top:this.element.getStyle("top")}):a=Object.extend(a,{bottom:this.element.getStyle("bottom")}),this.useLeft?a=Object.extend(a,{left:this.element.getStyle("left")}):a=Object.extend(a,{right:this.element.getStyle("right")}),a},getSize:function(){return{width:this.width,height:this.height}},setSize:function(a,b,c){a=parseFloat(a),b=parseFloat(b),!this.minimized&&a<this.options.minWidth&&(a=this.options.minWidth),!this.minimized&&b<this.options.minHeight&&(b=this.options.minHeight),this.options.maxHeight&&b>this.options.maxHeight&&(b=this.options.maxHeight),this.options.maxWidth&&a>this.options.maxWidth&&(a=this.options.maxWidth);if(this.useTop&&this.useLeft&&Window.hasEffectLib&&Effect.ResizeWindow&&c)new Effect.ResizeWindow(this,null,null,a,b,{duration:Window.resizeEffectDuration});else{this.width=a,this.height=b;var d=this.currentDrag?this.currentDrag:this.element;d.setStyle({width:a+this.widthW+this.widthE+"px",height:b+this.heightN+this.heightS+"px"});if(!this.currentDrag||this.currentDrag==this.element){var e=$(this.element.id+"_content");e&&e.setStyle({height:b+"px",width:a+"px"})}}},updateHeight:function(){this.height=null,this.computeBounds()},updateWidth:function(){this.width=null,this.computeBounds()},toFront:function(){this.element.style.zIndex<Windows.maxZIndex&&this.setZIndex(Windows.maxZIndex+1)},getBounds:function(a){(!this.width||!this.height||!this.visible)&&this.computeBounds();var b=this.width,c=this.height;a||(b+=this.widthW+this.widthE,c+=this.heightN+this.heightS);var d=Object.extend(this.getLocation(),{width:b+"px",height:c+"px"});return d},computeBounds:function(){if(!this.width||!this.height){var a=WindowUtilities._computeSize(this.content.innerHTML,this.content.id,this.width,this.height,0,this.options.className);this.height?this.width=a[0]:this.width?this.height=a[1]:(this.width=a[0],this.height=a[1])}this.setSize(this.width,this.height),this.centered&&this._center(this.centerTop,this.centerLeft)},show:function(a){this.visible=!0;if(a){if(typeof this.overlayOpacity=="undefined"){var b=this;setTimeout(function(){b.show(a)},10);return}Windows.addModalWindow(this),this.modal=!0,this.setZIndex(Windows.maxZIndex+1),Windows.unsetOverflow(this)}else this.element.style.zIndex||this.setZIndex(Windows.maxZIndex+1);this.oldStyle&&this.getContent().setStyle({overflow:this.oldStyle}),this.computeBounds(),this._notify("onBeforeShow"),this.options.showEffect(this.element),Windows.focusedWindow=this,this._notify("onShow")},showCenter:function(a,b,c){this.centered=!0,this.centerTop=b,this.centerLeft=c,this.show(a)},isVisible:function(){return this.visible},_center:function(a,b){var c=WindowUtilities.getWindowScroll(this.options.parent),d=WindowUtilities.getPageSize(this.options.parent);typeof a=="undefined"&&(a=(d.windowHeight-(this.height+this.heightN+this.heightS))/2),a+=c.top,typeof b=="undefined"&&(b=(d.windowWidth-(this.width+this.widthW+this.widthE))/2),b+=c.left,this.setLocation(a,b),this.toFront()},_recenter:function(a){if(this.centered){var b=WindowUtilities.getPageSize(this.options.parent),c=WindowUtilities.getWindowScroll(this.options.parent);if(this.pageSize&&this.pageSize.windowWidth==b.windowWidth&&this.pageSize.windowHeight==b.windowHeight&&this.windowScroll.left==c.left&&this.windowScroll.top==c.top)return;this.pageSize=b,this.windowScroll=c,$("overlay_modal")&&$("overlay_modal").setStyle({height:b.pageHeight+"px"}),this.options.recenterAuto&&this._center(this.centerTop,this.centerLeft)}},hide:function(){this.visible=!1,this.modal&&(Windows.removeModalWindow(this),Windows.resetOverflow()),this.oldStyle=this.getContent().getStyle("overflow")||"auto",this.getContent().setStyle({overflow:"hidden"}),this.options.hideEffect(this.element,this.options.hideEffectOptions),this.doNotNotifyHide||this._notify("onHide")},close:function(){if(this.visible){if(this.options.closeCallback&&!this.options.closeCallback(this))return;if(this.options.destroyOnClose){var a=this.destroy.bind(this);this.options.hideEffect==Element.hide?a():setTimeout(a,Window.SHOW_ANIMATION_MSEC*1.1)}Windows.updateFocusedWindow(),this.doNotNotifyHide=!0,this.hide(),this.doNotNotifyHide=!1,this._notify("onClose")}},isMinimized:function(){return this.minimized},isMaximized:function(){return this.storedLocation!=null},setOpacity:function(a){Element.setOpacity&&Element.setOpacity(this.element,a)},setZIndex:function(a){this.element.setStyle({zIndex:a}),Windows.updateZindex(a,this)},setTitle:function(a){if(!a||a=="")a="&nbsp;";Element.update(this.element.id+"_top",a)},_getWindowBorderSize:function(a){this.widthW=this.widthE=this.heightS=this.heightN=0,this.heightN=this.topbar.offsetHeight;var b=document.createElement("div");b.className="overlay_"+this.options.className,document.body.appendChild(b);var c=
this;setTimeout(function(){c.overlayOpacity=$(b).getStyle("opacity"),b.parentNode.removeChild(b)},10),Prototype.Browser.WebKit&&Prototype.Browser.WebKitVersion<420&&this.setSize(this.width,this.height),this.doMaximize&&this.maximize(),this.doMinimize&&this.minimize()},_createWiredElement:function(){if(!this.wiredElement){Prototype.Browser.IE&&this._getWindowBorderSize();var a=document.createElement("div");a.className="wired_frame "+this.options.className+"_wired_frame",a.style.position="absolute",this.options.parent.insertBefore(a,this.options.parent.firstChild),this.wiredElement=$(a)}this.useLeft?this.wiredElement.setStyle({left:this.element.getStyle("left")}):this.wiredElement.setStyle({right:this.element.getStyle("right")}),this.useTop?this.wiredElement.setStyle({top:this.element.getStyle("top")}):this.wiredElement.setStyle({bottom:this.element.getStyle("bottom")});var b=this.element.getDimensions();return this.wiredElement.setStyle({width:b.width+"px",height:b.height+"px"}),this.wiredElement.setStyle({zIndex:Windows.maxZIndex+30}),this.wiredElement},_hideWiredElement:function(){if(!this.wiredElement||!this.currentDrag)return;this.currentDrag==this.element?this.currentDrag=null:(this.useLeft?this.element.setStyle({left:this.currentDrag.getStyle("left")}):this.element.setStyle({right:this.currentDrag.getStyle("right")}),this.useTop?this.element.setStyle({top:this.currentDrag.getStyle("top")}):this.element.setStyle({bottom:this.currentDrag.getStyle("bottom")}),this.currentDrag.hide(),this.currentDrag=null,this.doResize&&this.setSize(this.width,this.height))},_notify:function(a){this.options[a]?this.options[a](this):Windows.notify(a,this)}};var Windows={windows:[],modalWindows:[],observers:[],focusedWindow:null,maxZIndex:20,addObserver:function(a){this.removeObserver(a),this.observers.push(a)},removeObserver:function(a){this.observers=this.observers.reject(function(b){return b==a})},notify:function(a,b){this.observers.each(function(c){c[a]&&c[a](a,b)})},getWindow:function(a){return this.windows.detect(function(b){return b.getId()==a})},getFocusedWindow:function(){return this.focusedWindow},updateFocusedWindow:function(){this.focusedWindow=this.windows.length>=2?this.windows[this.windows.length-2]:null},register:function(a){this.windows.push(a)},addModalWindow:function(a){this.modalWindows.length==0?WindowUtilities.disableScreen(a.options.className,"overlay_modal",a.overlayOpacity,a.getId(),a.options.parent):(Window.keepMultiModalWindow?($("overlay_modal").style.zIndex=Windows.maxZIndex+1,Windows.maxZIndex+=1,WindowUtilities._hideSelect(this.modalWindows.last().getId())):this.modalWindows.last().element.hide(),WindowUtilities._showSelect(a.getId())),this.modalWindows.push(a)},removeModalWindow:function(a){this.modalWindows.pop(),this.modalWindows.length==0?WindowUtilities.enableScreen():Window.keepMultiModalWindow?(this.modalWindows.last().toFront(),WindowUtilities._showSelect(this.modalWindows.last().getId())):this.modalWindows.last().element.show()},register:function(a){this.windows.push(a)},unregister:function(a){this.windows=this.windows.reject(function(b){return b==a})},closeAll:function(){this.windows.each(function(a){Windows.close(a.getId())})},closeAllModalWindows:function(){WindowUtilities.enableScreen(),this.modalWindows.each(function(a){a&&a.close()})},minimize:function(a,b){var c=this.getWindow(a);c&&c.visible&&c.minimize(),Event.stop(b)},maximize:function(a,b){var c=this.getWindow(a);c&&c.visible&&c.maximize(),Event.stop(b)},close:function(a,b){var c=this.getWindow(a);c&&c.close(),b&&Event.stop(b)},blur:function(a){var b=this.getWindow(a);if(!b)return;b.options.blurClassName&&b.changeClassName(b.options.blurClassName),this.focusedWindow==b&&(this.focusedWindow=null),b._notify("onBlur")},focus:function(a){var b=this.getWindow(a);if(!b)return;this.focusedWindow&&this.blur(this.focusedWindow.getId()),b.options.focusClassName&&b.changeClassName(b.options.focusClassName),this.focusedWindow=b,b._notify("onFocus")},unsetOverflow:function(a){this.windows.each(function(a){a.oldOverflow=a.getContent().getStyle("overflow")||"auto",a.getContent().setStyle({overflow:"hidden"})}),a&&a.oldOverflow&&a.getContent().setStyle({overflow:a.oldOverflow})},resetOverflow:function(){this.windows.each(function(a){a.oldOverflow&&a.getContent().setStyle({overflow:a.oldOverflow})})},updateZindex:function(a,b){a>this.maxZIndex&&(this.maxZIndex=a,this.focusedWindow&&this.blur(this.focusedWindow.getId())),this.focusedWindow=b,this.focusedWindow&&this.focus(this.focusedWindow.getId())}},Dialog={dialogId:null,onCompleteFunc:null,callFunc:null,parameters:null,confirm:function(a,b){a=a||"",b=b||{};var c=typeof b.okLabel=="string"?b.okLabel:"Ok",d=b.cancelLabel?b.cancelLabel:"Cancel";b=Object.extend(b,b.windowParameters||{}),b.windowParameters=b.windowParameters||{},b.className=b.className||"alert";var e=b.okButtonClass?b.okButtonClass+" ":"",f=b.cancelButtonClass?b.cancelButtonClass+" ":"";e+=b.buttonClass?b.buttonClass+" ":"",f+=b.buttonClass?b.buttonClass+" ":"";var g="class ='"+e+" ok_button'",h="class ='"+f+" cancel_button'",i=c==""?"":"<button onclick='Dialog.okCallback()' "+g+" id='ok_button_dialog'>"+c+"</button>",j="<button onclick='Dialog.cancelCallback();return false;' "+h+">"+d+"</button>",a="      <div class='"+b.className+"_message'>"+a+"</div>        <div class='"+b.className+"_buttons'>          "+(b.rotateButtons?j+i:i+j)+"                  </div>";return b.dialog_help&&(a+="<div class='dialog_help'>"+b.dialog_help+"</div>"),this._openDialog(a,b)},alert:function(a,b){a=a||"",b=b||{};var c=b.okLabel?b.okLabel:"Ok";b=Object.extend(b,b.windowParameters||{}),b.windowParameters=b.windowParameters||{},b.className=b.className||"alert";var d="class ='"+(b.buttonClass?b.buttonClass+" ":"")+" ok_button'",a="      <div class='"+b.className+"_message'>"+a+"</div>        <div class='"+b.className+"_buttons'>          <input type='button' value='"+c+"' onclick='Dialog.okCallback()' "+d+"/>        </div>";return this._openDialog(a,b)},info:function(a,b){a=a||"",b=b||{},b=Object.extend(b,b.windowParameters||{}),b.windowParameters=b.windowParameters||{},b.className=b.className||"alert";var a="<div id='modal_dialog_message' class='"+b.className+"_message'>"+a+"</div>";return b.showProgress&&(a+="<div id='modal_dialog_progress' class='"+b.className+"_progress'>  </div>"),b.ok=null,b.cancel=null,this._openDialog(a,b)},_openDialog:function(a,b){var c=b.className;!b.height&&!b.width&&(b.width=WindowUtilities.getPageSize(document.body).pageWidth/2);if(b.id)this.dialogId=b.id;else{var d=new Date;this.dialogId="modal_dialog_"+d.getTime(),b.id=this.dialogId}if(!b.height||!b.width){var e=WindowUtilities._computeSize(a,this.dialogId,b.width,b.height,5,c);b.width=e[0],b.height=e[1]}b.effectOptions=b.effectOptions;var f=new Window(b);return f.getContent().innerHTML=a,f.showCenter(!0,b.top,b.left),f.setDestroyOnClose(),f.cancelCallback=b.onCancel||b.cancel,f.okCallback=b.onOk||b.ok,f},_focus_ok:function(){$("ok_button_dialog")&&$("ok_button_dialog").focus()},okCallback:function(){var a=Windows.focusedWindow;if(!a.okCallback||a.okCallback(a))$$("#"+a.getId()+" input").each(function(a){a.onclick=null}),a.close()},cancelCallback:function(){var a=Windows.focusedWindow;if(!a)return;$$("#"+a.getId()+" input").each(function(a){a.onclick=null}),a.close(),a.cancelCallback&&a.cancelCallback(a)}};if(Prototype.Browser.WebKit){var array=navigator.userAgent.match(new RegExp(/AppleWebKit\/([\d\.\+]*)/));Prototype.Browser.WebKitVersion=parseFloat(array[1])}var WindowUtilities={getWindowScroll:function(a){var b,c,d,e;a=a||document.body;if(a!=document.body)b=a.scrollTop,c=a.scrollLeft,d=a.scrollWidth,e=a.scrollHeight;else{var f=document.viewport.getScrollOffsets();c=f.left,b=f.top,d=document.viewport.getWidth(),e=document.viewport.getHeight()}return{top:b,left:c,width:d,height:e}},getPageSize:function(a){a=a||document.body;var b,c,d,e;if(a!=document.body)b=a.getWidth(),c=a.getHeight(),e=a.scrollWidth,d=a.scrollHeight;else{b=document.viewport.getWidth(),c=document.viewport.getHeight();var f=document.documentElement;d=Math.max(c,document.body.offsetHeight,document.body.scrollHeight,f.offsetHeight,f.scrollHeight),e=Math.max(b,document.body.offsetWidth,document.body.scrollWidth,f.offsetWidth,f.scrollWidth)}return{pageWidth:e,pageHeight:d,windowWidth:b,windowHeight:c}},disableScreen:function(a,b,c,d,e){WindowUtilities.initLightbox(b,a,function(){this._disableScreen(a,b,c,d)}.bind(this),e||document.body)},_disableScreen:function(a,b,c,d){var e=$(b),f=WindowUtilities.getPageSize(e.parentNode);d&&Prototype.Browser.IE&&(WindowUtilities._hideSelect(),WindowUtilities._showSelect(d)),e.style.height=f.pageHeight+"px",e.style.display="none",b=="overlay_modal"?maxkir.animate(Window.SHOW_ANIMATION_MSEC,function(a){e.setOpacity(a*Window.OVERLAY_OPACITY),e.show()}):e.style.display="block"},enableScreen:function(a){a=a||"overlay_modal";var b=$(a);b&&(a=="overlay_modal"?maxkir.animate(Window.SHOW_ANIMATION_MSEC,function(c){b.setOpacity((1-c)*Window.OVERLAY_OPACITY),c==1&&$(a)&&$(a).remove()}):(b.style.display="none",b.parentNode.removeChild(b)),a!="__invisible__"&&WindowUtilities._showSelect())},_hideSelect:function(a){Prototype.Browser.IE&&(a=a==null?"":"#"+a+" ",$$(a+"select").each(function(a){WindowUtilities.isDefined(a.oldVisibility)||(a.oldVisibility=a.style.visibility?a.style.visibility:"visible",a.style.visibility="hidden")}))},_showSelect:function(a){Prototype.Browser.IE&&(a=a==null?"":"#"+a+" ",$$(a+"select").each(function(a){if(WindowUtilities.isDefined(a.oldVisibility)){try{a.style.visibility=a.oldVisibility}catch(b){a.style.visibility="visible"}a.oldVisibility=null}else a.style.visibility&&(a.style.visibility="visible")}))},isDefined:function(a){return typeof a!="undefined"&&a!=null},initLightbox:function(a,b,c,d){if($(a))Element.setStyle(a,{zIndex:Windows.maxZIndex+1}),Windows.maxZIndex++,c();else{var e=document.createElement("div");e.setAttribute("id",a),e.className="overlay_"+b,e.style.display="none",e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.zIndex=Windows.maxZIndex+1,Windows.maxZIndex++,e.style.width="100%",d.insertBefore(e,d.firstChild),Prototype.Browser.WebKit&&a=="overlay_modal"?setTimeout(function(){c()},10):c()}},setCookie:function(a,b){document.cookie=b[0]+"="+escape(a)+(b[1]?"; expires="+b[1].toGMTString():"")+(b[2]?"; path="+b[2]:"")+(b[3]?"; domain="+b[3]:"")+(b[4]?"; secure":"")},getCookie:function(a){var b=document.cookie,c=a+"=",d=b.indexOf("; "+c);if(d==-1){d=b.indexOf(c);if(d!=0)return null}else d+=2;var e=document.cookie.indexOf(";",d);return e==-1&&(e=b.length),unescape(b.substring(d+c.length,e))},_computeSize:function(a,b,c,d,e,f){var g=document.body,h=document.createElement("div");h.setAttribute("id",b),h.className="dialog__content "+f+"_content",d?h.style.height=d+"px":c&&(h.style.width=c+"px"),h.style.position="absolute",h.style.top="0",h.style.left="0",h.style.overflow="visible",h.style.display="none",h.innerHTML=a,g.insertBefore(h,g.firstChild);var i=[$(h).getDimensions().width+e,$(h).getDimensions().height+e];return g.removeChild(h),i}};maxkir.ui=maxkir.ui||{},maxkir.ui.Dialog={confirm:function(a,b,c,d,e,f,g,h){b="<div class='dialog_title'>"+a+"</div><div class='dialog_content'>"+b+"</div>",f=f||Prototype.emptyFunction;var i=Dialog.confirm(b,Object.extend({isDialogParam:!0,className:"alert",onOk:c,okLabel:d,width:window.innerWidth<550?window.innerWidth-30:550,zIndex:110,dialog_help:e,okButtonClass:"uibut",cancelButtonClass:"newbut",onClose:g,showEffectOptions:{afterFinish:function(a){Dialog._focus_ok(),f(i)}}},h||{}));return i},bindClip2Dialog:function(){var a=maxkir.Clipboard();a.glue("ok_button_dialog");var b=Dialog.cancelCallback;return Dialog.cancelCallback=function(){a.destroy(),Dialog.cancelCallback=b,Dialog.cancelCallback()},a.addEventListener("onComplete",Dialog.cancelCallback),a},hasDialog:function(){var a=!1;return Windows.windows.forEach(function(b){a=a||b.modal||b.options.isDialogParam}),a},hideDialogs:function(){Dialog.cancelCallback(),Windows.closeAllModalWindows()}},maxkir.onDom(function(){document.addEventListener("keyup",function(a){if(a.defaultPrevented)return;var b=a.key||a.keyCode;(b==="Escape"||b==="Esc"||b===27)&&maxkir.ui.Dialog.hasDialog()&&(maxkir.info("Hide dialogs on Escape"),maxkir.ui.Dialog.hideDialogs(),a.preventDefault())})}),maxkir.ui=maxkir.ui||{},maxkir.ui.Popups={hideAll:function(a){Windows.windows.each(function(b){(a||!b.options.floating)&&b.close()})},noHideOnClick:function(a){var b=a;while(b){if(b.no_hide_on_click)return!0;b=b.parentNode}return!1},hideLast:function(){var a=Windows.windows;a.length>0&&(a[a.length-1].closed_with_esc=!0,a[a.length-1].close())},popupCount:function(){return Windows.windows.length},clickedInsidePopup:function(a){a.pageX=Event.pointerX(a),a.pageY=Event.pointerY(a);for(var b=0;b<Windows.windows.length;b++){var c=Windows.windows[b].getContent(),d=maxkir.getPageOffset(c);if(d.x<=a.pageX&&a.pageX<=d.x+c.offsetWidth&&d.y<=a.pageY&&a.pageY<=d.y+c.offsetHeight)return!0}return!1},singlePopup:function(){return this.popupCount()!=1?null:Windows.windows[0]},hasDialog:function(){var a=!1;return Windows.windows.forEach(function(b){a=a||b.modal||b.options.isDialogParam}),a},hideDialogs:function(){Dialog.cancelCallback(),Windows.closeAllModalWindows()}},maxkir.ui.Popup=function(a,b,c){this.opt=Object.extend({opensOnHover:!1,removeOtherPopups:!1,anchor:"right",x_shift:0,y_shift:0},c||{}),this.opt.removeOtherPopups&&maxkir.ui.Popups.hideAll(!1);var d={className:"cl",width:b>0?b:null,zIndex:Windows.maxZIndex+1,title:"",showEffect:Element.show,hideEffect:Element.hide,draggable:!1,wiredDrag:!1,destroyOnClose:!0,recenterAuto:!1};$(a)||(this.centered=!0,d.recenterAuto=!0),d.height=null,d.onBeforeShow=function(b){if($(a)){var c=this.calc_location(a,b.getSize().width);this.setLocation(c.top,c.left)}}.bind(this),Object.extend(d,this.opt),Window.call(this,d),this.element.no_hide_on_click=!0,$(a)&&a!=document.body&&($(a).no_hide_on_click=!0)},maxkir.extend(maxkir.ui.Popup,{calc_location:function(a,b){var c=maxkir.getPageOffset(a),d=Element.getDimensions(a),e;return this.opt.anchor=="right"?e=c[0]+d.width-b:this.opt.anchor=="center"&&b>0?e=c[0]+(d.width-b)/2:e=c[0],e+=this.opt.x_shift,e<0&&(e=0),{top:c[1]+d.height+1+this.opt.y_shift,left:e}},keep_on_escape:function(){return!1},close:function(){if(maxkir.keep_popup)return;this.runDispose(),this.element&&(this.element.stopObserving(),this.element.update()),Window.prototype.close.call(this),maxkir.info("Popup closed")},updateHeight:function(){Window.prototype.updateHeight.call(this),maxkir.footer_height()>0&&(this.element.style.height=this.element.offsetHeight+maxkir.footer_height()+"px")},show:function(){Window.prototype.show.call(this),this.updateHeight();var a=WindowUtilities.getWindowScroll(),b=maxkir.getPageOffset(this.element);a.top>b.top&&this.element.setStyle({top:a.top+5+"px"});var c=b.left-a.left;c+this.element.offsetWidth>a.width&&this.element.setStyle({left:a.left+a.width-this.element.offsetWidth-20+"px"})},addEventHandler:function(a,b,c,d){var e=this.getContent().down(a);if(!e){maxkir.warn("Cannot find selector "+a);return}var f=e.on(b,c,d);this.addDisposerOnClose(function(){f.stop()})},addDisposerOnClose:function(a){this.disposers=this.disposers||[],this.disposers.push(a)},runDispose:function(){if(this.disposers){var a=this.disposers;delete this.disposers;for(var b=a.length-1;b>=0;b--)try{a[b].call(this)}catch(c){maxkir.error(c)}}}},Window),maxkir.ui.create_popup=function(a,b){var c={};return Object.extend(c,maxkir.ui.TogglePopup),a&&Object.extend(c,maxkir.ui.PopupSelectionSupport),Object.extend(c,b),c},maxkir.ui.TogglePopup={popup_width:500,toggle_popup:function(a,b,c){this.toggle(a,{checklist_id:b,align_to_right:c})},toggle:function(a,b){this.is_visible()?this.hide_popup():this.show_popup(a,b)},is_visible:function(){return this.win&&this.win.isVisible()},hide_popup:function(){this.win&&(this.win.close(),this.win=null)},show_popup:function(a,b){b=b||{};if(this.isSameParametersInvocation(b)){this.hide_popup();return}b.checklist_id&&(this.checklist_id=b.checklist_id),this.win=new maxkir.ui.Popup(a,this.popup_width,Object.extend({removeOtherPopups:!0,anchor:b.align_to_right?"right":"left",parent:document.body,x_shift:b.x_shift||0},b)),this.win.addDisposerOnClose(function(){this.anchor_element=null,this.options=null,this.win=null}.bind(this)),this.options=b,this.anchor_element=a,this.showWindow()},fix_horizontal_position:function(){if(!this.win)return;var a=this.win.element,b=maxkir.getPageOffset(a).left,c=document.viewport.getScrollOffsets().left,d=b+a.getWidth()-(c+document.viewport.getWidth()),e=b;d>0&&(e-=d),e<c&&(e=c),this.win.setLocation(this.win.getLocation().top,e)},setWidth:function(a){this.win.setSize(a,this.win.getSize().height);var b=this.win.calc_location(this.anchor_element,a);this.win.setLocation(b.top,b.left)},repositionForTextarea:function(a){var b=maxkir.getPageOffset(a),c=(new maxkir.CursorPosition(a,5)).getPixelCoordinates();this.win.setLocation(b.top+c[1],b.left+c[0]),this.fix_horizontal_position()},isSameParametersInvocation:function(a){return this.is_visible()&&$H(a).inspect()==$H(this.options).inspect()},showWindow:function(){maxkir.run_after(this.win,"show",function(){maxkir.debug("Events before onShow: "+Object.keys(Event.cache).length),this.onShow()}.bind(this)),maxkir.run_before(this.win,"close",function(){this.is_visible()&&this.onHide(),maxkir.debug("Events after  onHide: "+Object.keys(Event.cache).length)}.bind(this)),setTimeout(function(){this.win&&this.win.getContent()&&this.win.getContent().innerHTML.trim()==""&&this.win.setHTMLContent("<span class='pleaseWait'>Please wait ...</span>")}.bind(this),400),this.refresh(),this.win.show(),this.win&&this.win.updateHeight()},scrollToShow:function(a){setTimeout(function(){this.is_visible()&&maxkir.scrollTo(this.win.content,0,this.win.content.getHeight(),a||!0)}.bind(this),30)},onHide:function(){},onShow:function(){},refresh:function(){},_end:null},maxkir.ui.PopupSelectionSupport={tree_model:null,tree_nav:null,open:function(a){var b=$(this.tree_nav.get_selection());b&&this.doOpen&&this.doOpen(b,a)},doOpen:function(a){a.identify();var b=a.down("input");b?b.click():maxkir.click_link(a)},ul_element:function(){return this.win.getContent().down("ul")},init_data_links:function(){var that=this,a_tags=this.win.getContent().getElementsByTagName("a"),click_handler=function(a_tag){return function(){var orig=a_tag.getAttribute("data-action");return $(a_tag).up("li.disabled")||(eval(orig),that.hide_popup()),!1}};for(var i=0;i<a_tags.length;i++){var a_tag=a_tags[i],data_action=a_tag.getAttribute("data-action");data_action&&(a_tag.onclick=click_handler(a_tag))}var view_update=this.update_item_availability_on_focus.bind(this);maxkir.TaskFocus.add_listener(view_update),this.win.addDisposerOnClose(function(){maxkir.TaskFocus.remove_listener(view_update);for(var a=0;a<a_tags.length;a++)a_tags[a].onclick=null}),this.update_item_availability_on_focus()},update_item_availability_on_focus:function(){var a=document.querySelectorAll(".disable_if_focused"),b=maxkir.TaskFocus&&maxkir.TaskFocus.is_active();for(var c=0;c<a.length;c++)b?a[c].classList.add("disabled"):a[c].classList.remove("disabled")},setupSelection:function(){maxkir.run_after(this.win,"show",function(){this.win&&this.doSetupKeyboard()}.bind(this)),maxkir.run_before(this.win,"close",function(){this.doDisposeKeyboard()}.bind(this))},select_node:function(a){this.tree_nav&&this.tree_nav.set_selection(a)},doSetupKeyboard:function(){var a=this.ul_element();if(!a){maxkir.debug("Cannot setup keyboard - no UL element found");return}this.tree_model=new maxkir.TreeModel(a.identify(),"separator"),this.tree_nav=new maxkir.TreeNavigation(this.tree_model),maxkir.info("Installed tree for "+a.id+" and make it scrollable"),a.addClassName("scrollable");var b=this;this.click_handler=a.on("click","li",function(a,c){var d=Event.element(a);!a.stopped&&d.tagName!=="INPUT"&&(d.tagName!=="A"||b.activate_by_click_on_a)&&(b.tree_nav.set_selection(c.id),b.open(a),Event.stop(a))}),this._identify_lis(),this.install_kbd(),this.selectFirstItemIfPossible(),this.tree_nav.onSetSelection=function(a){this.onSelection(a.length>0?a[0]:null)}.bind(this),this.skipDoubleScroll()||(this.double_scroll_support=maxkir.double_scroll(a),this.double_scroll_support.start())},_identify_lis:function(){var a=this.ul_element().childElements();for(var b=0;b<a.length;b++)a[b].identify()},doDisposeKeyboard:function(){this.double_scroll_support&&this.double_scroll_support.stop(),this.dispose_kbd(),this.click_handler&&this.click_handler.stop();if(!this.is_visible())return;var a=this.ul_element();if(!a)return;this.tree_nav&&this.tree_nav.hide_selection(),delete this.tree_nav,delete this.tree_model,maxkir.info("Removed tree for "+a.id)},skipDoubleScroll:function(){return!1},selectFirstItemIfPossible:function(){this.tree_model&&this.tree_model.getFirstNode()&&(this.tree_nav.set_selection(this.tree_model.getFirstNode()),this.onSelection(this.tree_nav.get_selection()))},onSelection:function(a){},home:function(){this.move_selection("selectFirstInTree")},end:function(){this.move_selection("selectLastInTree")},up:function(){this.move_selection("key_up")},down:function(){this.move_selection("key_down")},left:function(a){maxkir.debug("left")},right:function(a){maxkir.debug("right")},move_selection:function(a){(function(){if(!this.tree_nav)return;var b=this.tree_nav[a](this.tree_nav.get_selection());maxkir.debug("next: "+b),this.update_scroll()}).bind(this).defer()},update_scroll:function(){var a=$(this.tree_nav.get_selection());if(a){if(!$(a).up("#"+this.ul_element().id))return;maxkir.scrollTo(a,30,a.offsetHeight,!0)}},activate_by_space:function(){return!0},isEnabledKeyboard:function(){return!0},install_kbd:function(){var a=this;this.kbd_manager=maxkir.kbd.forCondition(a.is_visible.bind(a),"Popup visible");var b=this.kbd_manager.forCondition(a.isEnabledKeyboard.bind(a),"Popup keyboard enabled");b.addShortcut("home",a.home.bind(a)).addShortcut("end",a.end.bind(a)).addShortcut("up",a.up.bind(a)).addShortcut("down",a.down.bind(a)).addShortcut("right",a.right.bind(a),!0).addShortcut("left",a.left.bind(a),!0).addShortcut("k",function(b){Event.element(b).tagName!="INPUT"&&(a.up(),Event.stop(b))},!0).addShortcut("j",function(b){Event.element(b).tagName!="INPUT"&&(a.down(),Event.stop(b))},!0).addShortcut("enter|shift+enter",a.open.bindAsEventListener(a)),b.addShortcut("space",function(b){a.activate_by_space()&&(a.open(b),Event.stop(b))},!0),maxkir.debug("Installed keyboard navigation for popup")},dispose_kbd:function(){this.kbd_manager&&this.kbd_manager.dispose_manager()}},maxkir.ui.SecondPopupSupport={doSetupKeyboard:function(){var a=this.moreActionsUL();a.select("li").each(function(a){a.identify()});var b=this.tree_model.getNodes,c=this.tree_model.getParent;this.tree_model.getNodes=function(c,d){var e=b.call(this,c,d);return c==this.getRoot()&&this._processUlChildren(e,a,d,{listAddOn:!0}),e}.bind(this.tree_model),this.tree_model.getParent=function(a){return $(a).up(".menuPopupAddon")?this.getRoot():c.call(this,a)}.bind(this.tree_model)},moreActionsUL:function(){return this.win.getContent().down(".menuPopupAddon")},onRebuildList:function(){this._identify_lis(),this.moreActionsUL().select("li").each(function(a){if(!this.list_filter)return;!a.down("a")||this.list_filter.accept(null,a.down("a").innerHTML)||a.hasClassName("specialItem")?a.show():a.hide()}.bind(this))},_f:null},maxkir.ui.ExpandPopup=maxkir.ui.create_popup(!0,{popup_width:320,shown:!1,refresh:function(){var a=this.win;this.popupContent||(this.popupContent=$("expandPopupData").innerHTML,$("expandPopupData").innerHTML=""),a.getContent().update(this.popupContent),this.setupSelection()},onShow:function(){var a=$("expand_to_level");typeof this.new_level!="undefined"&&(a.value=this.new_level),a.observe("keydown",function(a){a.keyCode==Event.KEY_RETURN&&(this.new_level=$F("expand_to_level"),maxkir.ChecklistNodeToggle.collapse_all(),maxkir.ChecklistNodeToggle.expand_all(this.new_level),this.hide_popup(),maxkir.user.set_user_prefs("def_expand_level",this.new_level),Event.stop(a))}.bindAsEventListener(this)),maxkir.CommentsAll.updateNotesLink()},click_notes:function(){maxkir.CommentsAll.toggle(),this.hide_popup()},onHide:function(){$("expand_to_level").stopObserving()},doOpen:function(a){maxkir.click_link($(a))},onSelection:function(a){a=="expand_to_level_li"?$("expand_to_level").activate():$("expand_to_level").blur()}}),maxkir.ui.SearchDueOptionsPopup=maxkir.ui.create_popup(!0,{popup_width:300,refresh:function(){var a=this.win;this.popupContent||(this.popupContent=$("searchDueOptionsPopupData").innerHTML),$("searchDueOptionsPopupData").innerHTML="",a.getContent().update(this.popupContent),$("hide_completed")&&($("hide_completed").checked=maxkir.SearchHideCompleted.is_hide()),$("show_not_mine")&&($("show_not_mine").checked=maxkir.user.get_boolean_pref("show_not_mine")),$("include_archived_lists")&&($("include_archived_lists").checked=!maxkir.user.get_boolean_pref("skip_archived_due")),this.fix_details_view(),this.setupSelection()},fix_details_view:function(){$("show_details").checked=maxkir.DetailsMode.on(),$("show_context")&&($("show_context").checked=maxkir.ShowContextOption.on()),$("open_new_tab")&&($("open_new_tab").checked=maxkir.OpenNewTabOption.on()),$("group_by_list")&&($("group_by_list").checked=maxkir.GroupByListOption.on())}}),maxkir.ui.HelpPopup=maxkir.ui.create_popup(!0,{popup_width:900,refresh:function(){var a=this.win;a.setAjaxContent("/auth/cheatsheet",{method:"get",onComplete:function(){this.options.to_focus&&setTimeout(function(){this.select_node(this.options.to_focus)}.bind(this),100)}.bind(this)}),this.setupSelection()},onShow:function(){this.should_update_position=!0;var a=$$(".rightColumn")[0];a&&(this.double_scroll2=maxkir.double_scroll(a),this.double_scroll2.start())},skipDoubleScroll:function(){return!0},onHide:function(){this.double_scroll2&&this.double_scroll2.stop()},doOpen:function(){},onSelection:function(a){var b=this.ul_element();if(!b)return;var c=function(a){var b=a.substr("item_".length);return $(b)};for(var d=0;d<b.childNodes.length;d++)b.childNodes[d].nodeType==1&&c($(b.childNodes[d]).id).hide();c(a).show(),this.should_update_position&&(this.should_update_position=!1,this.win.updateHeight(),maxkir.make_centered(this.win.element))},f_:null}),maxkir.ui.ProfilePopup=maxkir.ui.create_popup(!0,{popup_width:160,refresh:function(){this.setContent(),this.setupSelection()},setContent:function(){this.win.setHTMLContent($("_profileMenuData").innerHTML)},doOpen:function(a,b){maxkir.click_link(a,b&&b.shiftKey),this.hide_popup()},f_:null}),maxkir.ui.SearchHelpPopup=maxkir.ui.create_popup(!1,{popup_width:350,refresh:function(){this.setContent()},setContent:function(){var a=this.win,b=$("searchHelpPopup").innerHTML;$("searchHelpPopup").innerHTML="",a.setHTMLContent(b),maxkir.run_before(a,"close",function(){var b=a.getContent().innerHTML;a.getContent().innerHTML="",b&&($("searchHelpPopup").innerHTML=b)})},f_:null}),maxkir.ui.CompactModePopup=maxkir.ui.create_popup(!1,{popup_width:260,refresh:function(){this.setContent()},setContent:function(){var a=this.win;this._template||(this._template=$("compactModePopup").innerHTML,$("compactModePopup").innerHTML="");var b=encodeURIComponent(this.getBaseUrl()+"?from_public=true");a.setHTMLContent(this._template.replace(/##URL##/g,this.getBaseUrl()).replace(/##INVITE_URL##/g,b).replace(/##HOME##/g,this.getHomeUrl()))},onShow:function(){this._click_handler=this.win.getContent().on("click",".compactModePopup__li",function(a){maxkir.click_link(a.target.up(".compactModePopup__li")),Event.stop(a)}),maxkir.isMobile&&$$(".compactModePopup__li--desktop").invoke("hide")},onHide:function(){this._click_handler&&this._click_handler.stop()},getBaseUrl:function(){var a=document.location.href;return a.indexOf("?")>0?a.split(/\?/)[0]:a},getHomeUrl:function(){var a=document.location;return a.protocol+"//"+a.host},f_:null}),maxkir.ui.create_sort_popup=function(a){var b=new Template('<li class="sortListItem" title="#{title}"><i class="#{icon_class}"></i><a href="#" data-sortid="#{sortId}">#{name}</a></li>');return maxkir.ui.create_popup(!0,{popup_width:200,refresh:function(){this.setContent(),this.setupSelection(),this.activate_by_click_on_a=!0},setContent:function(){var c=this.win,d="<p class='intro inMenu'>"+I18N("sort.dialog_title")+"</p> "+"<ul class='menuPopupList sortPopupList'>",e=a.getSettings(),f=a.getCurrentId();for(var g=0;g<e.length;g++)f&&(e[g].icon_class=f==e[g].sortId?"icon-ok-circle":"icon-circle-blank"),d+=b.evaluate(e[g]);c.setHTMLContent(d+"</ul>")},doOpen:function(b,c){var d=b.down("a");if(d){var e=a.getSettings();for(var f=0;f<e.length;f++){var g=e[f];if($(d).getAttribute("data-sortid")==g.sortId){this.setCurrentItem(d),typeof g.switchTo=="function"&&(Event.stop(c),g.switchTo(this,c,g.sortId));break}}}},setCurrentItem:function(a){var b=a.up("ul").select("i");for(var c=0;c<b.length;c++)b[c].className="icon-circle-blank";a.previous().className="icon-ok-circle"},f_:null})},maxkir.ui.BaseListPopup=maxkir.ui.create_popup(!0,{popup_width:270,getListModel:function(){return alert("to be implemented!"),null},activate_by_space:function(){return!1},refresh:function(){this._setContent(),this.setupSelection(),this._installKeyboardFilter()},onRebuildList:function(){this.win.updateHeight(),this.tree_nav&&!this.tree_nav.selection_visible()&&this.selectFirstItemIfPossible()},popupFilter:function(){var a=this.win?this.win.getContent().down(".popupFilter"):null;return a?a:$("popupFilter")},getContentTemplate:function(){return'<div class="popupFlt"><input class="popupFilter" placeholder="'+I18N("lists_filter_placeholder")+'"/><i class="popupFlt__icon far fa-search"></i></div>'+'<ul class="menuPopupList" id="clParent"></ul>'},onEnterWithoutMatch:function(a,b){},getMaxItems:function(){return 200},_setContent:function(){var a=this.win,b=this.getContentTemplate();a.setHTMLContent(b),this.updateListModel()},updateListModel:function(){this.list_model&&this.list_model.dispose(),this.list_model=this.getListModel("clParent"),this.list_model.set_max_items(this.getMaxItems()),this.list_filter&&this.list_model.set_filter(this.list_filter);var a={onRebuildList:this.onRebuildList.bind(this)};this.list_model.add_listener(a),this.list_model.rebuild_list()},onHide:function(){this.list_model&&this.list_model.dispose()},createListFilter:function(){return new maxkir.ui.ListFilter(this.popupFilter().identify())},_installKeyboardFilter:function(){setTimeout(function(){if(!this.win)return;this.list_filter=this.createListFilter(),this.list_model.set_filter(this.list_filter);var a=this.popupFilter().on("keydown",function(a){if(!a.stopped&&a.keyCode===Event.KEY_RETURN&&this.no_match()){var b=$F(this.popupFilter()).trim();b!==""&&this.onEnterWithoutMatch(a,b)}}.bind(this));maxkir.run_before(this.win,"close",function(){this.list_filter.dispose(),a.stop(),this.list_filter=null}.bind(this))}.bind(this),50)},no_match:function(){return this.empty_ul(this.ul_element())},empty_ul:function(a){var b=a.select("li");for(var c=0;c<b.length;c++)if(maxkir.visible(b[c]))return!1;return!0},f_:null}),maxkir.HoverPopups=function(a){var b="hoverPopup",c=".hoverPopup",d="data-popup-id";return Element.retrieve(a,b,function(){var e,f={},g,h=new maxkir.TimeoutAction(250,400,function(){g||this.stop(),e=new maxkir.ui.Popup(g,"auto",{removeOtherPopups:!1,anchor:"right",className:"cl2",y_shift:7});var a=f[g.getAttribute(d)],b=a.buildContent(g);b&&(e.setHTMLContent("<div class='upHandle'></div><div class='tooltip'>"+b+"</div>"),e.show());var c=e.element.on("mouseover",this.bound_starting),h=e.element.on("mouseout",this.bound_stopping);e.addDisposerOnClose(function(){c.stop(),h.stop()})},function(){e&&(e.close(),e=null)}),i=function(a,b){var c=b.getAttribute(d);f[c]?(g!=b&&(h.bound_stop(),maxkir.debug("Hide popup for ",b)),g=b,h.bound_starting(),maxkir.debug("Start showing popup for ",b)):maxkir.info("Popup element without valid content provider",b)},j=[];return{initialize:function(){j.push(a.on("mouseover",c,i)),j.push(a.on("touchstart",c,i)),j.push(a.on("mouseout",c,h.bound_stopping)),j.push(h)},dispose:function(){j.forEach(function(a){a.stop()}),f=null,j=null,a.getStorage().unset(b)},addPopupProvider:function(a,b){f[a]=b}}}())},maxkir.onDom(function(){var a=maxkir.HoverPopups(document.body);a.initialize(),a.addPopupProvider("textPopup",{buildContent:function(a){var b=a.getAttribute("data-text-key");return I18N(b)}}),a.addPopupProvider("undoTextPopup",{buildContent:function(a){var b=I18N("undo_popup_help_text"),c=navigator.appVersion.indexOf("Mac")>=0?"&#x2318;Z":"Ctrl+Z";return b
.replace(/%s/,c)}})}),maxkir.onDom(function(){$("checklistsPopupLink")&&$("checklistsPopupLink").on("click",function(a){maxkir.ui.ChecklistPopup.invoke(),Event.stop(a)}),maxkir.kbd.addShortcut("esc",function(e){with(maxkir.ui.Popups){if(popupCount()==0)return;if(singlePopup()&&singlePopup().keep_on_escape&&singlePopup().keep_on_escape())return;hasDialog()?hideDialogs():hideLast(),Event.stop(e)}},!0),document.observe("mousedown",function(a){if(maxkir.ui.Popups.hasDialog()||maxkir.ui.Popups.popupCount()==0)return;if(maxkir.ui.Popups.clickedInsidePopup(a))return;var b=Event.element(a);if(b.tagName.toLowerCase()=="a")return;if(maxkir.ui.Popups.noHideOnClick(b))return;maxkir.ui.Popups.hideAll()}.bindAsEventListener(maxkir.ui.Popups))}),maxkir.ui=maxkir.ui||{},maxkir.ui.ListFilter=function(a){this.existing_input_id=a,this.prepared_value="",this.activate_field();var b=this;this.accepters=[{prepare:function(a){b.prepared_value=a.toLowerCase()},accept:function(a,c){return a&&a.text?a.text.toLowerCase().include(b.prepared_value):c.stripTags().toLowerCase().include(b.prepared_value)}}],this.listeners=[]},maxkir.extend(maxkir.ui.ListFilter,{set_update_listener:function(a){this.listeners=[a],this._prepare_accepters()},add_accepter:function(a){this.accepters.unshift(a),this.input&&(this.old_value=this.input.value)},clear_filter:function(){this.input&&(this.input.value="",this.update_list())},accept:function(a,b){this.prepare_for_filtering();for(var c=0;c<this.accepters.length;c++)if(!this.accepters[c].accept(a,b))return!1;return!0},dispose:function(){if(!this.input)return;this.listeners=[],this._input_listener.stop(),this.input=null},filter_field:function(){return $(this.existing_input_id)},activate_field:function(){this.input=this.filter_field();if(!this.input)return;this.old_value=this.input.value,this._input_listener=this.input.on("keydown",this.input_listener.bindAsEventListener(this)),this.input.focus()},input_listener:function(){setTimeout(this.update_list.bind(this),20)},update_list:function(a){this.change_detected()&&this.notify_listeners()},prepare_for_filtering:function(){this.change_detected()&&(this._prepare_accepters(),this.old_value=this.input.value)},_prepare_accepters:function(){var a=this.input.value;for(var b=0;b<this.accepters.length;b++)a=this.accepters[b].prepare(a)},change_detected:function(){return this.input&&this.input.value!==this.old_value},notify_listeners:function(){var a="";this.input&&(a=this.input.value);for(var b=0;b<this.listeners.length;b++)this.listeners[b](a)}}),maxkir.ui.ListBuilder=function(a){this.ul_id=a,this._data=[],this._listeners=new maxkir.Listeners,this.max_item_count=10},maxkir.extend(maxkir.ui.ListBuilder,{dispose:function(){maxkir.debug("ListBuilder disposed"),this._data=[],this._listeners=null},set_items:function(a){this._data=a},rebuild_list:function(){if(!this.ul())return;return new Promise(function(a,b){this.build_html(function(b){this.ul().innerHTML=b,this.filter_list(),a()}.bind(this))}.bind(this))},filter_list:function(){if(!this.ul())return;var a=0;this.ul().childElements().each(function(b){var c=a>=this.max_item_count||!this.filter_accepts(this.items_data_map[b.getAttribute("data-list-id")],b.innerHTML);c||a++,b.classList[c?"add":"remove"]("hiddenListItem")}.bind(this)),this.notify_on_rebuild()},add_listener:function(a){this._listeners.add_listener(a),a.stop=function(){this._listeners&&this._listeners.remove_listener(a),delete a.stop}.bind(this)},set_filter:function(a){this.filter=a,this.filter.set_update_listener&&this.filter.set_update_listener(this.filter_list.bind(this))},set_max_items:function(a){this.max_item_count=a},ul:function(){return $(this.ul_id)},build_html:function(a){this.get_data(function(b){var c="",d=this.create_list_prefix();this.filter_accepts(null,d)&&(c+=d),this.items_data_map={};for(var e=0;e<b.length;e++){var f=b[e],g=f.id;typeof g=="undefined"&&(g=this.ul_id+"_"+e),this.items_data_map[g]=f;var h=this.create_li(g,f);h&&(c+=h)}var i=this.create_list_suffix();this.filter_accepts(null,i)&&(c+=i),a(c)}.bind(this))},notify_on_rebuild:function(){this._listeners.notify_listener("onRebuildList")},get_data:function(a){return a(this._data)},create_list_prefix:function(){return""},create_li:function(a,b){return"<li id='"+a+"' data-list-id='"+a+"' >"+b.text+"</li>"},create_list_suffix:function(){return""},filter_accepts:function(a,b){return!this.filter||this.filter.accept(a,b)},f:null}),maxkir.ui.floating_footer=function(a){return{initialize:function(b){if($(a)){var c=this;$(a).down(".closeFloatingFooter").stopObserving(),$(a).down(".closeFloatingFooter").on("click",function(a){Event.stop(a),c.hide(),b&&b()})}},show:function(){$(a)&&($(a).show(),$(a).removeClassName("floatingFooterHidden"))},hide:function(b){$(a)&&(b&&($(a).hide(),setTimeout(function(){$(a).show()},2e3)),$(a).addClassName("floatingFooterHidden"))}}},maxkir.ProSupport={ask_for_pro:function(a){if($("goProFeature")){$("goProFeature").down(".pageFooter__message").innerHTML=a;var b=maxkir.ui.floating_footer("goProFeature");b.initialize(),b.show()}},ask_pro_dialog:function(a,b){var c=a;maxkir.can_try_trial?maxkir.ui.Dialog.confirm(c,"<div class='proDialog'>"+I18N("trial_description_text")+"</div>",function(){Dialog.cancelCallback(),maxkir.user.goTrial(b)},I18N("start_free_trial"),"",null,null,{cancelLabel:I18N("not_now")}):maxkir.ui.Dialog.confirm(c,"",function(){return document.location.href="/auth/profile#pro",!0},I18N("go_pro"),"<p>"+I18N("request_trial")+"</p>",null,null,{cancelLabel:I18N("not_now")})}},maxkir.URL=maxkir.URL||"",maxkir.user={_users:[],init_users:function(a){var b=a;this.user_map={};for(var c=0;c<b.length;c++)b[c]=Object.extend(b[c],maxkir.user_methods),this.user_map[b[c].id]=b[c];this._users=b},set_user_prefs:function(a,b,c){var d=!0;maxkir.UserPrefs&&(maxkir.UserPrefs[a]!=b?(maxkir.UserPrefs[a]=b,maxkir.no_user&&maxkir.set_flag("cl_user_"+a,b)):d=c),c=c||{};if(d){if(c.onFailure){new maxkir.AjaxRequest(maxkir.URL+"/auth/user_prefs",Object.extend({parameters:"user_prefs["+a+"]="+encodeURIComponent(b)},c||{}));return}new maxkir.AjaxCommand(maxkir.URL+"/auth/user_prefs",Object.extend({parameters:"user_prefs["+a+"]="+encodeURIComponent(b)},c||{}))}},set_prefs_with_message:function(a,b){maxkir.user.set_user_prefs(a,b,{onSuccess:function(){new maxkir.ui.Message("The setting was updated")}})},get_boolean_pref:function(a){if(maxkir.no_user)return maxkir.get_flag("cl_user_"+a);var b=maxkir.UserPrefs[a];return b&&b!=="false"},is_pref_set:function(a){return"undefined"!=typeof maxkir.UserPrefs[a]},get_user_prefs:function(a,b){new maxkir.AjaxRequest(maxkir.URL+"/auth/user_prefs/"+a,Object.extend({method:"get"},b||{}))},user_by:function(a){return this.user_map?this.user_map[a]:null},user_by_name:function(a){var b=this.checklist_users();for(var c=0;c<b.length;c++){var d=b[c];if(d.username===a||d.short_name()===a)return d}return null},checklist_users:function(a){if(!a)return this._users;var b=[];return this._users.forEach(function(c){(!c.my_checklist_ids||c.my_checklist_ids.indexOf(a)>=0)&&b.push(c)}),b},gravatar_url:function(a){var b=document.location.protocol=="https:",c="http"+(b?"s://secure.":"://")+"gravatar.com/avatar/",d=document.location.host.indexOf("localhost")>=0?"checkvist.com":document.location.host;return c+a.email_md5+".png?d="+((b?"https://":"http://")+d+"/assets/default_user_pic.png")},GRAVATAR_IMG:new Template("<i style='background: url(#{gravatar_url}&s=#{size2}) no-repeat;background-size: #{size}px;width:#{size}px;height:#{size}px;display:inline-block;' class='gravatarI'>&nbsp;</i>"),gravatar_img:function(a,b){return b=b||18,this.GRAVATAR_IMG.evaluate({size:b,size2:b*2,gravatar_url:this.gravatar_url(a)})},goTrial:function(a){if(maxkir.temporary){maxkir.TemporaryUser.show_dialog(!1,!0);return}a||(a=document.location.reload.bind(document.location)),new maxkir.AjaxCommand(maxkir.URL+"/subscriptions.js",{method:"post",onSuccess:function(){maxkir.is_pro=!0,$$(".profileMenu__upgradeMessage").invoke("hide"),new maxkir.ui.Message(I18N("trial_activated_msg"),{onHide:a})},onFailure:function(){new maxkir.ui.Message("Sorry, cannot start Checkvist PRO trial")}})},is_recent_user:function(a){return this._is_recent_user(a)&&(maxkir.Lists.count()<=1||!maxkir.is_author)},_is_recent_user:function(a){a=a||3e5;var b=maxkir.user.user_by(maxkir.current_user_id);return b&&(maxkir.temporary||(new Date).getTime()-b.when_created_msec()<a)},verify_email:function(){new maxkir.AjaxRequest("/email_verifications",{onSuccess:function(){new maxkir.ui.Message(I18N("please_check_inbox"))}})},set_darcula:function(a){var b=function(){new maxkir.AjaxRequest("/theme",{method:"PUT",parameters:"private_theme="+!!a,onComplete:function(){document.location.reload()}})};maxkir.TemporaryUser&&maxkir.temporary?maxkir.TemporaryUser.on_pro_usage("dark UI theme").then(b):maxkir.is_pro?b():($("dark_mode")&&($("dark_mode").checked=!1),maxkir.ProSupport.ask_pro_dialog(I18N("darcula_is_pro"),b))}},maxkir.user_methods={short_name:function(){return maxkir.CommonRender.user_short_name(this.username)},when_created_msec:function(){return Date.parse(this.created_at)}},maxkir.FreshUpdatesPopup=maxkir.ui.create_popup(!1,{popup_width:400,show:function(){var a=document.querySelector(".topbar__profileLink");a&&this.show_popup(a,{align_to_right:!0})},refresh:function(){this.win.setHTMLContent($("freshUpdates").innerHTML)},onShow:function(){var a=this;this.win.getContent().on("click",".freshUpdates__close",function(){a.hide_popup()}),this.done_as_new()},init_fresh_updates:function(a,b){var c=document.querySelector(".profileMenu__freshUpdates"),d=document.querySelectorAll(".freshUpdates__article").length,e=Array.prototype.slice.call(document.querySelectorAll(".topbar__freshUpdatesCounter"));a?(b&&(b=Math.min(d,b),e.forEach(function(a){a.innerHTML=b>0?b:"",a.show()})),c&&c.classList.add("profileMenu__freshUpdates--fresh")):(e.forEach(function(a){a.hide()}),c&&c.classList.remove("profileMenu__freshUpdates--fresh"))},done_as_new:function(){maxkir.user.set_user_prefs("fresh_updates_ver",maxkir.VER),this.init_fresh_updates(!1)}}),Element.observe(window,"load",function(){if(!maxkir.user||!maxkir.user.get_user_prefs||!$("freshUpdates"))return;if(!maxkir.current_user_id||maxkir.temporary)return;maxkir.user.get_user_prefs("fresh_updates_ver",{onSuccess:function(a){var b=a.responseText;if(maxkir.temporary)return;var c=(!b||parseInt(b)<maxkir.VER)&&!maxkir.user.is_recent_user(18e5);$("freshUpdates")&&(b?b=maxkir.VER-b:b=1,maxkir.FreshUpdatesPopup.init_fresh_updates(c,b))}})}),maxkir.show_accept_terms_dialog=function(){var a=maxkir.screen();a[0]-=50,a[1]-=50;var b="<iframe style='border: none;' src='/auth/terms.html?iframe=true' width="+a[0]+" height="+a[1]+">";Dialog.confirm(b,{isDialogParam:!0,width:a[0],zIndex:11e3})},maxkir.show_accept_terms_dialog_if_needed=function(){if(maxkir.temporary)return;if(maxkir.UserPrefs.terms_accepted)return;maxkir.show_accept_terms_dialog()},maxkir.onRelogin=function(){if(maxkir._relogin_shown)return;maxkir._relogin_shown=!0,maxkir.ui.Dialog.confirm(I18N("js_relogin_title"),"<div style='text-align:center'>"+I18N("js_relogin_text")+"</div>",function(){var a=maxkir.user.user_by(maxkir.current_user_id),b=a?a.email:"";document.location.href="/auth/login?email="+encodeURIComponent(b)},I18N("js_relogin_button"),null,function(){},function(){maxkir._relogin_shown=!1})},function(a){var b=function(b){b._repaint_handlers=new a.Listeners,b.on_repaint=function(){this._repaint_handlers.notify_listener("on_repaint")},b.add_on_repaint=function(a){this._repaint_handlers.add_listener(a)}};a.TreeModel=function(c,d){this._root=c,this._skip_class=d,a.TreeProvider&&a.TreeProvider.reset(),b(this)},a.extend(a.TreeModel,{_root:null,getRoot:function(){return this._root},setRoot:function(b){a.debug("set tree root to "+b),this._root=b},is_visible:function(){var b=a.$(this._root);while(b&&b.tagName!="BODY"){if(a.getStyle(b,"display")=="none")return!1;b=b.parentNode}return b},isLeaf:function(a){return 0===this.getNodes(a,!0).length},getFirstNode:function(){var a=this.getNodes(this._root);return a.length>0?a[0]:null},getNodes:function(b,c){var d=[],e={},f=a.$(b);if(f)if(f.tagName==="UL")this._processUlChildren(d,f,c,e);else if(f.tagName==="LI"){var g=f.childNodes;for(var h=0;h<g.length;h++)g[h].tagName==="UL"&&this._processUlChildren(d,g[h],c,e)}return d},getParent:function(b){if(b==null||b==this._root)return null;var c=a.$(b);if(!c||!c.parentNode)return null;if(c.tagName=="LI"){var d=c.parentNode;return d.id==this._root?d.id:d.parentNode.id}return b==this._root?null:c.parentNode.id},getParents:function(a){if(a==null)return[];var b=[],c=this.getParent(a);while(c!=null&&c!=this.getRoot())b.push(c),c=this.getParent(c);return b.reverse(),c==this.getRoot()?b:null},getLevel:function(a){var b=this.getParents(a);return b?b.length:-1},getTopParent:function(b){var c=this.getParents(b);if(c){if(c.length>0)return c[0];if(a.$(b))return a.$(b).id}return null},foreach:function(a,b,c,d){b||(b=this.getRoot());var e=this.getNodes(b,!d);for(var f=0;f<e.length;f++)!1!==a.call(this,e[f],f,b)&&this.foreach(a,e[f],!1,d);c&&a.call(this,b,0)},get_visible_nodes:function(){var a=[];return this.foreach(function(b){a.push(b)},null,!1,!0),a},print:function(){var b="<pre>";b+=this._printChildren(this._root,0),b+="</pre>",a.$("treeDebug").innerHTML=b},_fast_visible:function(b,c){if(!b)return!1;if(b.id==this._root)return!0;var d=c[b.id];if(d===!0||d===!1)return d;if(b.className&&b.className.indexOf("hidden")>=0)return b.id&&(c[b.id]=!1),!1;var e=a._treat_visible_by_default||a.visible(b);return b.id&&(c[b.id]=e),e},_processUlChildren:function(a,b,c,d){if(!c&&!this._fast_visible(b,d))return;var e=b.childNodes;for(var f=0;f<e.length;f++){var g=e[f];this._include_node(g,c,d)&&a.push(g.id)}},_include_node:function(a,b,c){if(a.id&&a.tagName=="LI"){var d=a.className;if(!b&&!this._fast_visible(a,c))return!1;if(!this._skip_class||d.indexOf(this._skip_class)<0)return!0}return!1},_printChildren:function(a,b){var c="",d=this.getNodes(a);for(var e=0;e<d.length;e++){for(var f=0;f<b;f++)c+="    ";c+=d[e]+"\n",c+=this._printChildren(d[e],b+1)}return c}})}(window.maxkir),function(a){a.TreeNavigation=function(a,b,c,d){c||(c="selected"),this._tree=a,this._sel_name=b,this._selected_class=c,this._selected_class_focus=c+"_focus",this._support_multiple=d,this._cycle=!0,this._positions=[],this._position_idx=-1,this._selected=[],this.restore_selection()},a.extend(a.TreeNavigation,{_tree:null,tree_model:function(){return this._tree},disable_cycling:function(){this._cycle=!1},selectFirstInTree:function(){var a=this._tree.getFirstNode();a&&this.set_selection(a)},selectLastInTree:function(){var a=this._tree.getNodes(this._tree.getRoot());if(a.length===0){this.set_selection(this._tree.getRoot());return}for(;;){var b=a[a.length-1];a=this._tree.getNodes(b);if(a.length===0){this.set_selection(b);return}}},is_first_node:function(a){return this._tree.getFirstNode()===a},is_last_node:function(a){var b=this,c=function(a){var d=a[a.length-1],e=b._tree.getNodes(d);return e.length>0?c(e):d},d=this._tree.getNodes(this._tree.getRoot());return d.length>0?a===c(d):!0},_visible:function(b){return a.visible(b)&&!a.hasClassName(b,"hiddenInit")},fix_selection:function(b,c){var d=this.get_selection();a.$(d)&&d!==c?this._visible(d)?this.fix_existing_selection():this._fix_selection_for_element_in_dom(d,!b,c):this._set_selection_from_anchor(b,c)},_set_selection_from_anchor:function(b,c){var d=this.nodeFromPosition(this._tree_position);a.$(d)&&this._fix_selection_for_element_in_dom(d,!b,c)},_expand_parents:function(b){if(a.NodeToggle){var c=this._tree.getParents(b);c&&c.forEach(function(b){a.NodeToggle.expandNode(b)})}},_fix_selection_for_element_in_dom:function(a,b,c){var d=function(a){return this._visible(a)&&a!==c}.bind(this);d(a)?this.set_selection(a):(b&&this._expand_parents(a),this._do_without_cycle(function(){var b=!1,c=!1;while(a&&!d(a)&&!b){var e=null;c||(e=this.getNext(a,!1,!0));if(e==null||e===a)c=!0,e=this.getPrev(a,!0,!0);if(e===a){var f=this._tree.getFirstNode();d(f)?this.set_selection(f):this.set_selection(null),b=!0}else a=e}}),d(a)&&this.set_selection(a))},fix_existing_selection:function(){this.set_selection(this.get_all_selection())},key_down:function(a){window.curr_message&&window.curr_message.hide();var b;return a&&(b=this.getNext(a,!0)),b?this.set_selection(b):this.selectFirstInTree(),a!=this.get_selection()},key_up:function(a){window.curr_message&&window.curr_message.hide();var b;return a&&(b=this.getPrev(a,!0)),b?this.set_selection(b):this.selectLastInTree(),a!=this.get_selection()},key_left:function(b){if(!a.NodeToggle)return;if(this._tree.isLeaf(b)||a.NodeToggle.isCollapsed(b)){var c=this._tree.getParent(b);c&&c!==this._tree.getRoot()&&this.set_selection(c)}else a.NodeToggle.collapseNode(b)},key_right:function(b){if(!a.NodeToggle)return;this._tree.isLeaf(b)||!a.NodeToggle.isCollapsed(b)?this.key_down(b):a.NodeToggle.expandNode(b)},get_position:function(a){if(!a)return null;var b=this._tree.getParent(a);if(!b)return null;var c=this._tree.getNodes(b,!0),d=c.indexOf(a);return d<0&&(d=null),[b,d]},nodeFromPosition:function(a){if(!a)return null;var b=a[0];if(!this._visible(b))return null;var c=a[1];if(c!==null){var d=this._tree.getNodes(b,!0);return c<d.length?d[c]:d.length?this._find_last_child_deep(d[d.length-1]):b}return b},_find_last_child_deep:function(a){var b=this._tree.getNodes(a,!0);return b.length?this._find_last_child_deep(b[b.length-1]):a},has_history:function(a){return a>0?this._position_idx<this._positions.length-1:this._position_idx>0},go_back:function(){return this._go_history("go back",-1)},go_forward:function(){return this._go_history("go forward",1)},_go_history:function(b,c){a.debug(b+" from "+this.get_selection()),this.save_selection_position();var d=this.get_all_selection(),e=this._position_idx;while(this.has_history(c)&&!this._set_selection_from_history(c,d));return e===this._position_idx?!1:this._visible(this.get_selection())?!0:(a.debug("Cannot "+b+" - found selection is not visible: "+this.get_selection()),this._set_selection_keep_history(d),this._position_idx=e,!1)},_set_selection_keep_history:function(a){this._keep_history=!0,this.set_selection(a),this._expand_parents(this.get_selection()),this._keep_history=!1},_set_selection_from_history:function(a,b){this._position_idx+=a;var c=this._positions[this._position_idx-a],d=this._positions[this._position_idx],e=d[0];if(e&&!this._same(b,e))return this._set_selection_keep_history(e),this._visible(this.get_selection())&&!this._same(b,this.get_all_selection());this._tree_position=d[1],this._keep_history=!0;var f=this.nodeFromPosition(this._tree_position);return!e&&f&&this.set_selection(f),this.fix_selection(!1,c[0]?c[0][0]:null),this._keep_history=!1,!0},_same:function(a,b){return JSON.stringify(a)===JSON.stringify(b)},reset_history:function(){this._positions=[],this._position_idx=-1,this._tree_position=this.get_position(null),this._selected=[]},set_selection:function(b,c){var d=this._sel();if(!d.length&&(!b||0===b.length))return Promise.resolve();this.hide_selection(),this._selected=Array.isArray(b)?b:b?[b]:[],this._selected.length&&(this._do_without_cycle(function(){this._tree_position=this.get_position(this._selected[0])}),this._update_selection_history()),!this._support_multiple&&this._selected.length>1&&(this._selected=[this._selected[this._selected.length-1]]),this.remember_selection();var e=!c||this._has_selection_class();return e&&this.show_selection(),this._sel().length?a.debug("Select in tree "+this._tree.getRoot()+": "+this._sel().toString()):a.debug("Clear tree selection for "+this._tree.getRoot()),this.onSetSelection(this._sel(),d,e)},_do_without_cycle:function(a){var b=this._cycle;try{this._cycle=!1,a.bind(this)()}finally{this._cycle=b}},save_selection_position:function(){this._save_selection_timeout&&this._update_selection_history(!0)},_update_selection_history:function(b){var c=function(){return[this._selected,this._tree_position]}.bind(this);this._save_selection_timeout&&(clearTimeout(this._save_selection_timeout),this._save_selection_timeout=null);var d=c();if(!this._keep_history){var e=function(){var a=c();this._same(d,a)&&this._write_new_position(d)}.bind(this);a.is_testing()||b?e():this._save_selection_timeout=setTimeout(e,500)}},_write_new_position:function(b){var c=this._position_idx>=0?this._positions[this._position_idx]:[];if(this._same(c,b))return;if(!b[0]&&!b[1])return;this._position_idx++,this._positions.splice(this._position_idx),this._positions.push(b),a.debug("Saved selection state",JSON.stringify(this._positions[this._position_idx])),this._cleanup_duplicate_positions();for(var d=this._positions.length-2;d>=0;d--){var e=this._positions[d];if(e.length>0&&this._same(e[0],b[0])){e[0]=null;break}}},_cleanup_duplicate_positions:function(){var a=new Map;for(var b=this._positions.length-1;b>=0;b--)a.set(JSON.stringify(this._positions[b]),this._positions[b]);this._positions=[],a.forEach(function(a,b,c){this._positions.push(a)},this),this._positions.reverse(),this._position_idx=this._positions.length-1},_sel:function(){this._selected=this._selected||[];if(this._frozen_selected){var a=[].concat(this._frozen_selected);return a=a.filter(function(a){return-1==this._selected.indexOf(a)},this),a.concat(this._selected)}return this._selected},freeze_selection:function(){if(!this._support_multiple)return;this._frozen_selected=this._sel(),this._selected=[]},unfreeze_selection:function(){if(!this._support_multiple)return;this._selected=this._sel(),this._frozen_selected=null},add_selection:function(a){var b=[].concat(this._selected);a.forEach(function(a){b.indexOf(a)==-1&&b.push(a)}),this.set_selection(b)},remove_selection:function(a){for(var b=0;b<a.length;b++)if(this.is_frozen(a[b])){var c=this._frozen_selected.indexOf(a[b]);this._frozen_selected.splice(c,1)}var d=this._sel().filter(function(b){return-1==a.indexOf(b)});this.set_selection(d)},is_selected:function(a){return this._sel().indexOf(a)>=0},extend_selection_down:function(a){var b=this.get_all_selection();if(b.length==0)return;var c=b[b.length-1],d=this.getNext(b[b.length-1],a);this._process_add_or_remove(d,c)},extend_selection_up:function(a){var b=this.get_all_selection();if(b.length==0)return;var c=b[b.length-1],d=this.getPrev(c,a);this._process_add_or_remove(d,c)},_process_add_or_remove:function(a,b){a&&(this.is_selected(a)&&!this.is_frozen(a)?this.remove_selection([b]):this.add_selection([a]))},extend_selection_to:function(a){if(this._selected.length==0){this.set_selection(a);return}if(this._tree.getTopParent(a)&&$(a))if($(this.get_selection()).compareDocumentPosition($(a))&Node.DOCUMENT_POSITION_FOLLOWING)while(!this.is_selected(a))this.extend_selection_down(!0);else while(!this.is_selected(a))this.extend_selection_up(!0)},is_frozen:function(a){return this._frozen_selected&&this._frozen_selected.indexOf(a)>=0},hide_selection:function(b){if(b){var c=a.$(this.node2select(b));return typeof c=="object"&&a.hasClassName(c,this._selected_class)?(a.removeClassName(c,this._selected_class),a.removeClassName(c,this._selected_class_focus),this.onHideSelection(b),!0):!1}var d=!1,e=this._sel();for(var f=0;f<e.length;f++)d=this.hide_selection(e[f])||d;return d},show_selection:function(){var b=this.get_selection();if(b){var c=a.$(this.node2select(b));a.addClassName(c,this._selected_class_focus)}this._sel().forEach(function(b){var c=a.$(this.node2select(b));a.addClassName(c,this._selected_class),this.onShowSelection(b)},this)},selection_visible:function(a){return this._has_selection_class(!a)},_has_selection_class:function(b){return this._sel().some(function(c){var d=a.$(this.node2select(c)),e=!b||a.visible(c);return d&&a.hasClassName(d,this._selected_class)&&e},this)},onSetSelection:function(a,b,c){return Promise.resolve()},onHideSelection:function(a){},onShowSelection:function(a){},node2select:function(a){return a},get_selection:function(){var a=this.get_all_selection();return a.length>0?a[a.length-1]:null},get_single_selection:function(){var a=this.get_all_selection();return a.length==1?a[0]:null},get_all_selection:function(){return this._sel()},getNext:function(a,b,c){var d=this._tree.getParent(a);if(d!=null){var e=this._tree.getNodes(d,c),f=this._findIdx(e,a);if(f==e.length)return null;if(b){var g=this._tree.getNodes(a,c);if(g.length>0)return g[0]}if(f<e.length-1)return e[f+1];var h=this._getNextDeep(d,e,b,c);return h?h:a}return this._tree.getFirstNode()},getSiblings:function(a){var b=this._tree.getParent(a);return b?this._tree.getNodes(b):[]},getNextSibling:function(a){var b=this.getSiblings(a),c=this._findIdx(b,a);return c==b.length?null:c<b.length-1?b[c+1]:null},getPrevSibling:function(a){var b=this.getSiblings(a),c=this._findIdx(b,a);return c==b.length?null:c>0?b[c-1]:null},get_all_selection_ordered:function(){return this.selection_visible(!0)?this.get_all_selection().sort(function(b,c){return b===c?0:a.$(b).compareDocumentPosition(a.$(c))&Node.DOCUMENT_POSITION_FOLLOWING?-1:1}):[]},is_last_child:function(b){var c=this._tree.getParent(b);if(!c)return!0;var d=this._tree.getNodes(c);return d.length<2?!0:b===d[d.length-1]||a.$(d[d.length-1]).deleted},_getNextDeep:function(a,b,c,d){var e=this._tree.getParent(a);if(e==null)return this._cycle?b[0]:null;if(!c)return b[b.length-1];var f=this._tree.getNodes(e,d),g=this._findIdx(f,a);return f.length-1!=g?f[g+1]:this._getNextDeep(e,f,c,d)},getPrev:function(a,b,c){var d=this._tree.getParent(a);if(d!=null){var e=this._tree.getNodes(d,c),f=this._findIdx(e,a);return f==e.length?null:f>0?this._findPrevTree(e[f-1],b,c):this._tree.getParent(d)==null?this._cycle?this._findPrevTree(e[e.length-1],b,c):a:b?d:a}var g=this._tree.getNodes(this._tree.getRoot(),c);return this._findPrevTree(g[g.length-1],b,c)},_findPrevTree:function(a,b,c){if(!b)return a;var d=this._tree.getNodes(a,c);while(d.length>0)a=d[d.length-1],d=this._tree.getNodes(a,c);return a},_findIdx:function(a,b){var c=0;for(;c<a.length;c++)if(b==a[c])break;return c},restore_selection:function(){if(!this._sel_name||!window.sessionStorage)return;try{this.set_selection(JSON.parse(sessionStorage.getItem(this._sel_name)||localStorage.getItem(this._sel_name)))}catch(a){}},remember_selection:function(){if(!this._sel_name||!window.sessionStorage)return;sessionStorage.setItem(this._sel_name,JSON.stringify(this._sel())),localStorage.setItem(this._sel_name,JSON.stringify(this._sel()))}})}(window.maxkir),maxkir.Listeners=function(){this._listeners=[]},maxkir.extend(maxkir.Listeners,{add_listener:function(a){"use strict",a&&(this.remove_listener(a),this._listeners.push(a))},remove_listener:function(a){"use strict",a&&(this._listeners=this._listeners.filter(function(b){return b!==a}))},notify_listener:function(a,b,c,d){"use strict",this._listeners.forEach(function(e){typeof e[a]=="function"&&e[a](b,c,d)})},dispose:function(){this._listeners=[]}}),maxkir.FindFilterProvider=function(a,b,c,d,e){var f=function(){return a.$(b)},g={_txt_lines:[],parse_line:function(a,b){return this._parse_text(a)},accept_item:function(a){var b=this.extract_text_lines(a),c="";for(var d=0;d<b.length;d++)if(!this.should_hide_by_text(b[d][0])){var e=b[d][1];c.length?c.indexOf(e)===-1&&(c+="|"+e):c=e}return c?c:null},get_active:function(){return this._txt_lines.length>0},_parse_text:function(a){var b=a.split(/\s+/),c=[];for(var d=b.length;d-->0;){var e=b[d];e.length>0&&c.push(e.toLowerCase())}return this._txt_lines=c,c},should_hide_by_text:function(b){var c=a.CommonRender;c&&(b=c.stripTags(c.format_for_rendering(b,!1)));var d=this._txt_lines;for(var e=d.length;e-->0;)if(b.toLowerCase().indexOf(d[e])<0)return!0;return!1},extract_text_lines:function(a){return[[a.content,"text"]]}};return{_filters:[],_filter_line:null,_unmatched:{},_direct_match:{},_hidden:{},_expanded_nodes:{},_listeners:new a.Listeners,TextFilter:g,findInput:function(){return f()},show:function(b,c,d){a.$("what")&&a.Search&&!c&&a.Search.activate();var e=f();if(!a.visible(e)&&!d)return;if(a.Print&&a.Print.is_shown()&&!d)return;if(d)e.value=b;else if(b.length>0){var g=e.value.indexOf(b),h=e.value.charAt(g+b.length);while(g>=0&&h!=" "&&h.length>0)g=e.value.indexOf(b,g+b.length+1),h=e.value.charAt(g+b.length);g<0?(e.value!=""&&(e.value+=" "),e.value+=b):(e.value=e.value.substr(0,g)+e.value.substr(g+b.length),e.value.charAt(g)==" "&&(e.value=e.value.substr(0,g)+e.value.substr(g+1)),e.value=e.value.trim())}this.activate(c),b.length>0&&this.doFilter()},clear_search_field:function(){if(!f())return;f().value="",this.refresh_filter()},refresh_filter:function(){this.doFilter(!0);var a=this.tree_nav();a&&a.fix_selection(!0)},add_listener:function(a){this._listeners.add_listener(a)},remove_listener:function(a){this._listeners.remove_listener(a)},dispose:function(){this._listeners.dispose(),this._filters=[]},get_result:function(a){return{hidden:this.is_hidden(a),matched:this._direct_match[a],has_match:function(a){return this.matched&&this.matched.indexOf(a)>=0}}},get_matches:function(){return Object.keys(this._direct_match)},mark_shown:function(b){a.debug("mark_shown: "+b),delete this._hidden[b]},is_hidden:function(a){var b=!!this._hidden[a];return b},is_active:function(){return this._active},is_filtered:function(){return this._is_filtered},is_filtered_by_text:function(){var a=f();return a&&a.value.trim().length>0},can_filter:function(){return this.tree_model()!=null},tree_model:function(){var a=c.tree_model();return a?a:this.tree_nav()?this.tree_nav().tree_model():null},tree_nav:function(){return c.tree_nav()},highlight_text:function(b){var c=this.text_lines();return c.length==0?b:a.highlight_text(b,c)},text_lines:function(){return g._txt_lines||[]},add_filter:function(a){this._filters.push(a),this._filter_line=null},remove_filter:function(a){this._filters=this._filters.filter(function(b){return b!==a}),this._filter_line=null},createDelayedFilter:function(){var b=a.delay_action(this.doFilter.bind(this),300);return b.start.bind(b)},doFilter:function(b,c){if(this._filter_line===this.val()){a.debug("Filter text didn't change");if(!b)return;a.info("Filtering forced")}else a.info("Filtering text change from '"+this._filter_line+"' to '"+this.val()+"'");this._filter_line=this.val(),this.parse_input(),this.do_filter_task_tree(b,c)},clear_cache:function(){this._filter_line=null},_log_time:function(b){b?a.debug("Perf: "+b+": "+((new Date).getTime()-this._time)+"ms, whole time: "+((new Date).getTime()-this._time_init)):this._time_init=(new Date).getTime(),this._time=(new Date).getTime()},reset_filter_caches:function(){this._is_filtered=!1,this._direct_match={},this._unmatched={},this._hidden={},this._active_filters_cache=null,this._tree_model=this.tree_model()},do_filter_task_tree:function(b,c){var d=this.tree_model();if(!d){a.warn("No tree model in filter");return}var e=this,f=this._filter_line;this._log_time(),a.debug(">>> DO_FILTER_TASK_TREE"),this._is_filtered=!1,d.foreach(function(a){var b=e.should_hide(a);b&&(e._unmatched[a]=!0,e._is_filtered=!0)}),this._log_time("Should_hide"),a.debug("Hidden nodes: "+Object.keys(e._unmatched)),a.debug("Direct matches: "+Object.keys(e._direct_match));for(var g in this._unmatched)this._unmatched.hasOwnProperty(g)&&(this._hidden[g]=this._unmatched[g]);e.run_if_unchanged(f,b,function(){this._collapse_previously_expanded(),this._log_time("_collapse_previously_expanded");if(this.is_filtered()){a.debug("expand_and_show_parents");var g={};d.foreach(function(a){e._direct_match[a]&&e.expand_and_show_parents(a,d,g)}),this._log_time("expand_and_show_parents")}this.run_if_unchanged(f,b,function(){a.debug("update_tree_all, skip CSS: "+c),this.update_tree_all(c),this._log_time("update_tree_all");var b=this.tree_nav();b&&b.get_all_selection().every(function(a){return this.is_hidden(a)},this)&&(this.first_to_select?b.set_selection(this.first_to_select.id):b.selectFirstInTree()),this.update_search_field(),a.FilterState&&a.FilterState.updateFilter(e._filter_line),this._log_time("Done filtering")})})},_collapse_previously_expanded:function(){"use strict";var b=this.tree_nav();if(!b)return;a.debug("collapse_previously_expanded: "+Object.keys(this._expanded_nodes));for(var c in this._expanded_nodes){var d=this.task_data(c);d&&!e.is_collapsed(d)&&e.do_collapse(d)}this._expanded_nodes={}},run_if_unchanged:function(b,c,d){if(c){d.apply(this);return}var e=this;setTimeout(function(){b==e.val()?d.apply(e):a.debug("Filtering interrupted: '"+b+"' is not '"+e.val()+"'")},20)},_expand:function(b){var c=this.task_data(b);c&&(a.debug("expand "+b),e.is_collapsed(c)&&(this._expanded_nodes[b]=!0,e.do_expand(c)))},expand_and_show_parents:function(b,c,d){if(d[b])return;a.debug("expand_and_show_parents "+b);var e=c.getParent(b);while(e){if(d[e])return;d[e]=!0,this._expand(e,!0),this.mark_visible(e),e=c.getParent
(e)}},mark_visible:function(b){a.debug("show "+b),delete this._hidden[b]},update_tree_all:function(b){var c=this.tree_model(),d=c.getRoot(),e=this;this.cssClasses={},this.first_to_select=null,c.foreach(function(f,g,h){e.cssClasses[f]="";var i=a.$(f);e._unmatched[f]?(b||a.addClassName(i,"dimmed"),e.cssClasses[f]+="dimmed"):(b||a.removeClassName(i,"dimmed"),e.first_to_select?i&&i.compareDocumentPosition(e.first_to_select)&Node.DOCUMENT_POSITION_FOLLOWING&&(e.first_to_select=i):e.first_to_select=i),e.has_matched_ancestor(d,h,c)&&e.mark_visible(f),e.is_hidden(f)?(b||a.addClassName(i,"hiddenByFilter"),e.cssClasses[f]+=" hiddenByFilter",e._listeners.notify_listener("node_hidden",f)):(b||a.removeClassName(i,"hiddenByFilter"),e._listeners.notify_listener("node_shown",f))}),this._listeners.notify_listener("filter_done")},cssClass4:function(a){return this.cssClasses?this.cssClasses[a]||"":""},has_matched_ancestor:function(a,b,c){while(b){if(b==a)return!1;if(!this._unmatched[b])return!0;b=c.getParent(b)}return!1},update_search_field:function(){this.is_filtered_by_text()?a.addClassName(f(),"filtered"):a.removeClassName(f(),"filtered")},filters:function(){return this._filters.slice().concat([g])},active_filters:function(){if(this._active_filters_cache)return this._active_filters_cache;var a=[],b=this.filters(),c=b.length;for(var d=0;d<c;d++){var e=b[d];e.get_active()&&(typeof e.get_subfilters=="function"?a=a.concat(e.get_subfilters()):a.push(e))}return this._active_filters_cache=a,a},parse_input:function(){this.reset_filter_caches(),this.parse_input_line(this.val())},val:function(){return f()?f().value.trim():""},parse_input_line:function(a){var b=a,c=this.filters();for(var d=0;d<c.length;d++){var e=c[d];e.parse_line&&(a=e.parse_line(a,b))}return a},task_data:function(a){return d.from_node_id(a,this._tree_model)},should_hide:function(a){var b=this.task_data(a);return b?this._should_hide(a):!1},_should_hide:function(a){var b=this.active_filters().slice(),c,d,e=this,f=function(b,f,g){var h=[],i=b.length;for(var j=0;j<i;j++){var k=b[j].accept_item(f,e._tree_model.isLeaf(g));k?g===a&&(c=c?c+"|"+k:k):(b[j].get_active()==="strict_filter"&&(d=!0),h.push(b[j]))}return h},g=a;while(g&&b.length>0){var h=this.task_data(g);if(!h)break;b=f(b,h,g);if(d)return!0;g=this._tree_model.getParent(g)}return c&&b.length===0&&(this._direct_match[a]=c),b.length>0},activate:function(b){this._active=!0;var c=f().value.length;a.set_selection(f(),c,c),f().focus(),this.tree_nav()&&!b&&(this.tree_nav().hide_selection(),this.tree_nav().unfreeze_selection(),this.tree_nav().unfreeze_selection()),this.mark_focused(),this.completer&&this.completer.trigger_activation()},passivate:function(){this._active=!1;if(!f())return;this.mark_unfocused(),f().blur(),setTimeout(function(){this.completer&&!this._active&&this.completer.hide()}.bind(this),250);var a=this.tree_nav();a&&!a.selection_visible()&&a.fix_selection(!0);if(!this.can_filter()){var b=this;setTimeout(function(){b._active||b.clear_search_field()},1e3)}},mark_focused:function(){a.addClassName(f(),"focused"),this._listeners.notify_listener("focus_changed",!0)},mark_unfocused:function(){a.removeClassName(f(),"focused"),this._listeners.notify_listener("focus_changed",!1)},_f:null}},maxkir.FindFilterProvider.TagFilter={TAG:/\s?(?:#|tag:\s*)(\S+)\s?/g,parse_line:function(a){return this._parse_tags(a)},accept_item:function(a){return this._matches(a)?"tag":null},get_active:function(){return this.tags.length>0},get_subfilters:function(){var a=[];for(var b=0;b<this.tags.length;b++){var c={};c.accept_item=this.accept_item,c._matches=this._matches,c.get_active=this.get_active,c.tags=[this.tags[b]],a.push(c)}return a},_parse_tags:function(a){var b=[];return a=a.replace(this.TAG,function(a,c){return b.push(c),""}),this.tags=b,a},_matches:function(a){var b=[];return this.tags.forEach(function(c){(!a.tags||!a.tags.hasOwnProperty(c))&&b.push(c)}),b.length==0}},maxkir.FindFilterProvider.DueFilter={DUE:/(?:due:\s*|\^)(asap|overdue|now|any|none|(this |current |next )?week|(this |current |next )?month|[\w- \/\\]+\d{2}|today|tomorrow)\b/i,parse_line:function(a,b){return this.has_scope=b.match(maxkir.FindFilterProvider.StatusFilter.SCOPE),this._parse_due(a)},accept_item:function(a,b){return a.status&&!this.has_scope?null:!this.should_hide_by_due||!this.should_hide_by_due(a,b)?"due":null},get_active:function(){return this.should_hide_by_due!=null},_matches:function(a,b){return this.d==="none"&&!b?!1:maxkir.dates.within(this.d,a.due)},_parse_due:function(a){return this.should_hide_by_due=null,a.replace(this.DUE,function(a,b){return this.d=b.toLowerCase(),this.should_hide_by_due=function(a,b){return!this._matches(a,b)}.bind(this),""}.bind(this))}},maxkir.FindFilterProvider.StatusFilter={SCOPE:/in:\s*(closed|all|open)\b/i,parse_line:function(a,b){return this.has_due=b.match(maxkir.FindFilterProvider.DueFilter.DUE),this._parse_status(a)},accept_item:function(a){return this.should_hide_by_status!=null&&this.should_hide_by_status(a)?null:this.has_due&&this.should_hide_by_status==null&&a.status?null:"status"},get_active:function(){return this.should_hide_by_status!=null},_parse_status:function(a){return this.should_hide_by_status=null,a.replace(this.SCOPE,function(a,b){return b=="closed"?this.should_hide_by_status=function(a){return!a.status}:b=="open"?this.should_hide_by_status=function(a){return a.status>0}:this.should_hide_by_status=function(){return!1},""}.bind(this))}},maxkir.FindFilterProvider.ChangedFilter={CHANGED:/(?:changed:\s*)(\d+(h|d|w)\w*|today|yesterday|(this |current |previous |last )?week|(this |current |previous |last )?month)\b/g,parse_line:function(a,b){return this._parse_changed(a)},accept_item:function(a){return this._should_hide_by_change_date(a.updated_at)?null:"changed"},get_active:function(){return this.should_hide_by_updated_at!=null?"strict_filter":null},_parse_changed:function(a){return this.should_hide_by_updated_at=null,a.replace(this.CHANGED,function(a,b){return this.should_hide_by_updated_at=function(a){return!maxkir.dates.within(b,a)},""}.bind(this))},_should_hide_by_change_date:function(a){if(!this.should_hide_by_updated_at)return!1;var b=a>0?new Date(a):Date.parse(a);return!b||isNaN(b)?!0:this.should_hide_by_updated_at(b)}},maxkir.FindFilterProvider.NotAttachmentFilter={ATTACHMENT_NOTE:/\bhas:\s?(attachment|note)\b/ig,parse_line:function(a,b){return this._parse_attachment_and_note(a)},accept_item:function(a){return this.withNotes&&!this._should_hide_by_note(a)?"has_note":this.withAttachments&&!this._should_hide_by_attachment(a)?"has_attachment":null},get_active:function(){return this.withAttachments||this.withNotes},_parse_attachment_and_note:function(a){var b=!1,c=!1;return a=a.replace(this.ATTACHMENT_NOTE,function(a,d){return d=="attachment"?b=!0:c=!0,""}),this.withAttachments=b,this.withNotes=c,a},_should_hide_by_attachment:function(a){return this.withAttachments?a.details&&a.details.uploads_count>0?!1:a.uploads&&a.uploads.length>0?!1:!0:!1},_should_hide_by_note:function(a){return this.withNotes?a.comments_count>0?!1:a.notes&&a.notes.length>0?!1:!0:!1}},maxkir.placeholder=function(){var a=arguments[0],b=localStorage.getItem("ph_"+a)||0;return b++,b>=arguments.length&&(b=1),localStorage.setItem("ph_"+a,b),arguments[b]},maxkir.stats={value:function(a){return this._values||(this._values=JSON.parse(sessionStorage.getItem("maxkir.stats")||"{}")),this._values[a]||0},inc_value:function(a){var b=this.value(a);this._values[a]=b+1,sessionStorage.setItem("maxkir.stats",JSON.stringify(this._values))},reset:function(){sessionStorage.setItem("maxkir.stats","{}"),this._values={}}},maxkir.mailchimp_subscribe=function(a){var b=document.createElement("form");b.action="https://checkvist.us20.list-manage.com/subscribe/post?u=34d099cfe3b7069f0d13bac71&amp;id=7e1f4d4f27",b.method="POST",b.target="_blank",b.style.display="none";var c=document.createElement("input");c.name="EMAIL",c.type="hidden",c.value=a;var d=document.createElement("input");d.name="b_34d099cfe3b7069f0d13bac71_7e1f4d4f27",d.type="hidden",d.value="";var e=document.createElement("input");e.name="subscribe",e.type="hidden",e.value="Subscribe",b.appendChild(c),b.appendChild(d),b.appendChild(e),document.body.appendChild(b),b.submit()},maxkir.ui=maxkir.ui||{},maxkir.List=function(a){return a._initialized||(a._initialized=1,Object.extend(a,{markdown:function(){return this.options&2},set_markdown:function(a,b){this.options=(this.options||0)|2,b&&new maxkir.AjaxCommand("/checklists/"+this.id+".js",{method:"put",parameters:"checklist[markdown]="+!!a,evalScripts:!0,onSuccess:function(){maxkir.checklist.refresh()}})},progress_counter:function(){return this.options&4},set_progress_counter:function(a,b){this.options=(this.options||0)|4,b&&new maxkir.AjaxCommand("/checklists/"+this.id+".js",{method:"put",parameters:"checklist[progress_count]="+!!a,evalScripts:!0,onComplete:function(){maxkir.ProgressCounter&&maxkir.ProgressCounter.show_for_list()}})}})),a},maxkir.Lists={add_lists_data:function(a,b){if(!this.list_data_map||b)this.list_data_map={},this.list_sequence=[];for(var c=0;c<a.length;c++){var d=a[c],e=this.list_data_map[d.id];this.list_data_map[d.id]=maxkir.List(d),e||this.list_sequence.push(d.id)}this.sort_lists_by_user_updated_at()},sort_lists_by_user_updated_at:function(){var a=this.list_data_map;this.list_sequence.sort(function(b,c){var d=a[b].user_updated_at,e=a[c].user_updated_at;return d&&e?Date.parse(e)-Date.parse(d):e?1:d?-1:(d=a[b].updated_at,e=a[c].updated_at,Date.parse(e)-Date.parse(d))})},data:function(a){return this.list_data_map?this.list_data_map[a]:null},count:function(){return this.list_sequence?this.list_sequence.length:0},data_from_id:function(a){var b=/^checklist.*_(\d+)$/;if(a&&b.test(a)){var c=a.match(b)[1];return this.data(c)}return null},get_list_data:function(a){if(!this.list_sequence)return[];var b=[];for(var c=0;c<this.list_sequence.length;c++){var d=this.list_sequence[c];!!this.data(d).archived==!!a&&b.push(this.data(d))}return b},process_list_data:function(a){if(this.all_data_loaded){a(this.get_list_data());return}var b=function(b){this.mark_data_loaded(),this.add_lists_data(b,!0),a(this.get_list_data())}.bind(this),c=this._get_cached();c&&b(c);var d=this;new maxkir.AjaxRequest("/checklists.json",{method:"get",parameters:"skip_stats=true",onSuccess:function(a){b(a.responseJSON),d._store2local_cache(a.responseJSON),setTimeout(function(){d.all_data_loaded=!1},1e3)},onFailure:function(){a([])}})},mark_data_loaded:function(){this.all_data_loaded=!0},_store2local_cache:function(a){localStorage.setItem("_cached_lists",JSON.stringify(a))},_get_cached:function(){var a=localStorage.getItem("_cached_lists");return a?JSON.parse(a):null},create_update_list:function(a,b){if(this.list_data_map){var c=this.data(a);c?c.name=b:(this.list_data_map[a]=maxkir.List({id:a,name:b}),this.list_sequence.unshift(a))}},make_public:function(a,b){return new Promise(function(c,d){new maxkir.AjaxCommand("/checklists/"+a+".js",{method:"put",parameters:"checklist[public]="+!!b,evalScripts:!0,onSuccess:c,onComplete:d})})},remove_list:function(a){this.list_data_map&&(delete this.list_data_map[a],this.list_sequence=this.list_sequence.without(a))},get_share_suffixes:function(){return this.share_suffixes},share_suffixes:{}},maxkir.ListTagAccepter=function(){this.tags=[]},maxkir.extend(maxkir.ListTagAccepter,{prepare:function(a){return maxkir.FindFilterProvider.TagFilter.parse_line(a)},accept:function(a,b){var c=maxkir.FindFilterProvider.TagFilter;return a&&c.tags&&c.tags.length>0?c.accept_item(a):!0}}),maxkir.ui.TaskListBuilder=function(a,b){maxkir.ui.ListBuilder.call(this,a),this.set_items(b),this._tasks={},b.forEach(function(a){this._tasks[a.id]=a},this)},maxkir.extend(maxkir.ui.TaskListBuilder,{create_li:function(a,b){if(b.status)return null;var c=maxkir.CommonRender.format_for_breadcrumbs(b.content);return c?"<li class='checklistsList__li' id='popup_task_"+b.id+"' class='task'><a href='javascript://;'>"+c+"</a><i class='checklistsList__deeper icon-chevron-sign-right' title=\"Select a target within the list\"></i></li>":null},get_data:function(a){a(this._data)}},maxkir.ui.ListBuilder),maxkir.ui.BaseChecklistPopup=Object.extend({},maxkir.ui.BaseListPopup),Object.extend(maxkir.ui.BaseChecklistPopup,{popup_width:maxkir.widget_mode()?280:450,getListModel:function(a){return new maxkir.ui.ChecklistListBuilder(a)},onShow:function(a){maxkir.ui.BaseListPopup.onShow.call(this,a),$("clParent").addClassName("checklistsList")},createListFilter:function(){maxkir.DataCompleter&&(this.completer=maxkir.DataCompleter.create_completer(this.popupFilter(),{existing_tags_map:{},list_content_editing:!0}));var a=new maxkir.ui.ListFilter(this.popupFilter().identify());return a.add_accepter(new maxkir.ListTagAccepter),a},onHide:function(){maxkir.ui.BaseListPopup.onHide.call(this),maxkir.DataCompleter.uninstall(this.popupFilter())},onRebuildList:function(){this.addCreateNewList(),maxkir.ui.BaseListPopup.onRebuildList.call(this),this.selectFirstItemIfPossible()},addCreateNewList:function(){var a=this.win.getContent().down(".checklistsPopupHeader");a&&(this.no_match()?this.old_header_value||(this.old_header_value=a.innerHTML,a.innerHTML=I18N("move_dialog_create_list"),a.addClassName("highlight")):this.old_header_value&&(a.innerHTML=this.old_header_value,a.removeClassName("highlight"),this.old_header_value=null))}}),maxkir.ui.ChecklistListBuilder=function(a){maxkir.ui.ListBuilder.call(this,a),$(a).store("list_builder",this)},maxkir.extend(maxkir.ui.ChecklistListBuilder,{dispose:function(){maxkir.ui.ListBuilder.prototype.dispose.call(this),$(this.ul_id)&&$(this.ul_id).store("list_builder")},create_list_prefix:function(){var a="";return maxkir.Lists.get_list_data()||(a+="<li class='loading'>Loading lists ...</li>"),a},create_li:function(a,b){if(b.archived)return null;var c="$(this).up('ul').retrieve('list_builder').appendSearchTerm('#' + this.innerHTML);",d=maxkir.TagRenderer.renderTagMap(b.tags,c,!0);return d!==""&&(d='<div class="checklistsList__tag_set">'+d+"</div>"),'<li class="checklistsList__li" id="popup_checklist_'+a+'" target="_self" data-list-id="'+a+'" '+(b.read_only?" class='readOnly' ":"")+"><div>"+d+'<a href="/checklists/'+b.id+'" target="_self" >'+b.name+'</a></div><i class="checklistsList__deeper  icon-chevron-sign-right" title="Select a target within the list"></i></li>'},get_data:function(a){var b=this;maxkir.Lists.all_data_loaded?(a(b.copy_name_to_text()),b.filter_list()):maxkir.Lists.process_list_data(function(c){a(b.copy_name_to_text()),b.filter_list()})},copy_name_to_text:function(){var a=maxkir.Lists.get_list_data();for(var b=0;b<a.length;b++)a[b].text=a[b].name;return a},appendSearchTerm:function(a){var b=this.filter&&this.filter.filter_field();if(!b){maxkir.info("Cannot appendSearchTerm - no filter");return}var c=b.value;c!=""&&!/ $/.test(c)&&(b.value+=" "),b.value+=a,this.filter_list(),b.focus()}},maxkir.ui.ListBuilder),maxkir.ui.ChecklistPopup=Object.extend({},maxkir.ui.BaseChecklistPopup),Object.extend(maxkir.ui.ChecklistPopup,maxkir.ui.SecondPopupSupport),Object.extend(maxkir.ui.ChecklistPopup,{popup_options:function(){return maxkir.widget_mode()?{anchor:"right",removeOtherPopups:!0,x_shift:15}:{anchor:"left",removeOtherPopups:!0}},getContentTemplate:function(){return(new Template($("listPopupTemplate").innerHTML)).evaluate({lists:maxkir.ui.BaseChecklistPopup.getContentTemplate()})},doSetupKeyboard:function(){maxkir.ui.BaseChecklistPopup.doSetupKeyboard.call(this),maxkir.ui.SecondPopupSupport.doSetupKeyboard.call(this)},moreActionsUL:function(){return this.win.getContent().down(".menuPopupAddon")},onRebuildList:function(){maxkir.ui.SecondPopupSupport.onRebuildList.call(this),maxkir.ui.BaseChecklistPopup.onRebuildList.call(this)},no_match:function(){return this.empty_ul(this.ul_element())&&this.empty_ul(this.moreActionsUL())},invoke:function(){if(!maxkir.current_user_id)return;if(this.is_visible()){this.hide_popup();return}this.win=new maxkir.ui.Popup(this.anchor_element(),this.popup_width,this.popup_options()),this.showWindow()},onEnterWithoutMatch:function(a,b){Event.stop(a),maxkir.add_checklist.do_add()},anchor_element:function(){return $("checklistsPopupLink")},doOpen:function(a,b){maxkir.click_link($(a),b&&b.shiftKey),this.hide_popup()}}),maxkir.DataCompleter=function(){var a=function(a,b,c,d){if(!maxkir.Tags)return[];var e=maxkir.Tags.data,f=[],g=function(b){return!Object.isUndefined(a[e[b].tag])},h=Object.keys(maxkir.Tags.data);h=h.sort(maxkir.TagSortFunction(!0,!1));for(var i=0;i<h.length;i++){var j=h[i];if(e.hasOwnProperty(j)&&!g(j)){var k=e[j].tag;if(maxkir.ProgressCounter&&maxkir.ProgressCounter.time_tag(k))continue;var l=(b?"":"#")+k;f.push(l);if(c){var m="tag:"+k;m.startsWith(d)&&d.length>4?f.push(m):f.push("tag: "+k)}}}return f},b=function(){if(!maxkir.Tags)return[];var a=[],b=maxkir.Lists.get_list_data(),c={};for(var d=0;d<b.length;d++)b[d].tags&&Object.extend(c,b[d].tags);for(var e in c)if(c.hasOwnProperty(e)){var f=maxkir.Tags.find(e);f&&a.push("#"+f.tag)}return a.sort(),a},c=function(a,b){var c=[];if(!maxkir.user)return c;var d=maxkir.user.checklist_users(b);for(var e=0;e<d.length;e++){var f=d[e],g=f.short_name();c.push(a+g+"<span class='informal'> &lt"+f.email+"></span>")}return c},d=function(a){var b=Date.MD[a.getMonth()]+" "+a.getDate();return"<span class='informal due_hint'>"+b+"</span>"},e=function(a,b){a>6&&(a-=7);var c=new Date;for(;;){c.setDate(c.getDate()+1);if(a==c.getDay()){b--;if(b==0)return d(c)}}},f=function(a){var b=["overdue","now","any","none","today","tomorrow","asap","current week","next week","current month","next month"];for(var c=0;c<b.length;c++)b[c]=a+b[c];return b},g=function(a){var b=["asap"];b.push("today"+d(new Date));var c=new Date;c.setDate(c.getDate()+1),b.push("tomorrow"+d(c));var f=["sunday","monday","tuesday","wednesday","thursday","friday","saturday","sunday","monday","tuesday","wednesday","thursday","friday","saturday"],g=c.getDay();for(var h=g;h<g+7;h++)b.push(f[h]+e(h,1));for(h=g;h<g+7;h++)b.push("next "+f[h]+e(h,2));for(var i=0;i<b.length;i++)b[i]=a+b[i];return b},h=function(a,b){var c=a.value.substr(0,b[0]),d=/(\n|^)#*$/;return c.match(d)?!0:!1};return{create_completer:function(d,e){maxkir.info("Create completer on "+$(d).identify()),e=e||{};var i=e.existing_tags_map||{},j=e.skip_hash_in_tag_name,k=e.task_content_editing,l=e.with_search_items,m=e.with_search_items,n=e.task_content_editing&&maxkir.is_pro&&!maxkir.temporary,o=e.task_content_editing,p=o&&m,q=e.checklist_id,r=e.list_content_editing;n=n||m;var s,t=Object.extend({partialSearch:!0,partialChars:3,separator:" ",choices:12,onShow:function(a,b){b.style.position="absolute";var c=maxkir.getPageOffset(a),d=0,e;if(maxkir.CursorPosition){var f=new maxkir.CursorPosition(a,5);e=f.getPixelCoordinates();if(s.getToken()){d=0;var g=maxkir.get_selection_range(a),h=s.getTokenBounds(),i=a.value.substring(h[0],g[0]);d=f.get_string_metrics(i)[0]-5}}else e=[0,a.getHeight()];b.setStyle({left:c.left+e[0]-10-d+"px",top:c.top+e[1]+"px"}),Effect.Appear(b,{duration:.15})}},e||{});return o&&maxkir.UserPrefs.parse_due_without_prefix!="true"&&(t.partialSearch=!1),$("tagSuggestionBox").no_hide_on_click=!0,$("tagSuggestionBox").setStyle({zIndex:Math.max(100,Windows.maxZIndex)}),s=new maxkir.ui.Autocompleter(d,"tagSuggestionBox",[],t),s.addHandler({getCustomTokenBounds:function(a,b){var c=a.value;j&&(c=c.replace(/#/," "));var d=c.substr(0,b[0]),e=c.substr(b[0]),f=/((\b(in|due|tag|changed|color|priority):\s?)(next|current|previous|this)?\s)?[^\s ,\.\(\)]*$/,g=/^[^\s ,\.\(\)]*/,h=f.exec(d),i=g.exec(e);return h&&i?[b[0]-h[0].length,b[0]+i[0].length]:[b[0],b[0]]},createItems:function(d,e,s){if(!this._array||this._old_token!=e){this._old_token=e,this._array=r?b():a(i,j,l,e),n&&(this._array=this._array.concat(c("@",q)),p&&(this._array=this._array.concat(c("assignee: ",q))));var t=/due:\w/.test(e);o&&(this._array=this._array.concat(g("^")),p&&(t?this._array=this._array.concat(g("due:")):this._array=this._array.concat(g("due: ")))),m&&(t?this._array=this._array.concat(f("due:")):this._array=this._array.concat(f("due: ")),this._array=this._array.concat(f("^")),this._array=this._array.concat(["in: all","in: open","in: closed","changed: 1h","changed: today","changed: yesterday","changed: current week","changed: previous week","changed: current month","has: attachment","has: note","color: any","color: 1","color: 2","color: 3","color: 4","color: 5","color: 6","color: 7","color: 8","color: 9","color: none","priority: any","priority: 1","priority: 2","priority: 3","priority: 4","priority: 5","priority: 6","priority: 7","priority: 8","priority: 9","priority: none"]))}return s[0]!==s[1]?[]:d&&k&&h(d,s)?[]:this._array}}),s.create_li_tag=function(a){var b=["color: ","priority: "];for(var c=0;c<b.length;c++){var d=b[c];if(a.startsWith(d)){var e=a.substr(d.length),f=maxkir.Task.Colorer.toCode(e);return"<li class='color_"+f+" priorityColored priority_"+e+"'>"}}return"<li>"},d.completer_active=function(){return s.active},d.completer_focused=function(){return s.hasFocus},d.store("completer",s),s},get_completer:function(a){return a.retrieve("completer")},uninstall:function(a){a.completer_active=null;var b=this.get_completer(a);b&&(maxkir.info("Dispose completer on "+a.id),b.hide(),b.dispose(),a.store("completer",null))},_end:!1}}(),maxkir.TagSortFunction=function(a,b){var c={};maxkir.Task.foreach(function(a){var b=a.tags;if(b)for(var d in b)b.hasOwnProperty(d)&&(c[d]=(c[d]||0)+1)});var d=function(a,c){var d=maxkir.Tags.data[a],e=maxkir.Tags.data[c];return d.tag.toUpperCase().localeCompare(e.tag.toUpperCase())*(b?1:-1)},e=function(a,d){var e=maxkir.Tags.data[a],f=maxkir.Tags.data[d],g=c[e.tag]||0,h=c[f.tag]||0;return g!==h?(g-h)*(b?1:-1):(e.usage_count||(e.usage_count=0),f.usage_count||(f.usage_count=0),e.usage_count===f.usage_count?e.tag.toUpperCase().localeCompare(f.tag.toUpperCase()):(e.usage_count-f.usage_count)*(b?1:-1))};return a?e:d},maxkir.TreeProvider={tree_model:function(){return this.__tree_model||this.update_model(),this.__tree_model},tree_nav:function(){return this.__tree_nav||this.update_model(),this.__tree_nav},update_model:function(){maxkir.info("Update cached tree"),this.__tree_model=this._tree_model(),this.__tree_nav=this._tree_nav()},reset:function(){this.__tree_model=null,this.__tree_nav=null},_tree_model:function(){var a=this.return_if_visible(maxkir.tree_model);if(a==null){var b=$$(".listSection");for(var c=0;c<b.length&&a==null;c++)b[c].list_index&&(a=this.return_if_visible(b[c].list_index.tree_model()))}return a},_tree_nav:function(){return maxkir.tree_nav&&this.return_if_visible(maxkir.tree_nav._tree)?maxkir.tree_nav:null},return_if_visible:function(a){return a&&a.is_visible()?a:null}},maxkir.initFindFilter=function(a){maxkir.FindFilter&&maxkir.FindFilter.uninstall();var b={is_collapsed:function(a){return a.collapsed},do_expand:function(a){a.collapsed=!1,maxkir.ChecklistNodeToggle&&maxkir.ChecklistNodeToggle.without_server(function(){maxkir.ChecklistNodeToggle.expandNode("task_"+a.id,!0)})},do_collapse:function(a){a.collapsed=!0,maxkir.ChecklistNodeToggle&&maxkir.ChecklistNodeToggle.without_server(function(){maxkir.ChecklistNodeToggle.collapseNode("task_"+a.id)})}};maxkir.FindFilter=maxkir.FindFilterProvider(maxkir,"findInput",a,{from_node_id:function(a,b){var c=maxkir.Task.data(maxkir.Task.id(a));if(!c){var d=maxkir.Lists.data_from_id(a),e=function(a){var b=$$("#"+a+" span.node_text")[0];if(!b)return"";var c=b.innerHTML;return c=c.replace(/<[^>]+>/g,""),c};if(d||a!=b.getRoot())c={content:d?d.name:e(a),status:0,tags:d&&d.tags?d.tags:[],details:{}}}return c},from_parent_id:function(a){return maxkir.Task&&maxkir.Task.data(a)}},b);var c=maxkir.FindFilter.doFilter;maxkir.FindFilter.doFilter=function(){maxkir.checklist&&maxkir.checklist.HideCompleted&&maxkir.checklist.HideCompleted.update_visibility_all(),c.apply(this,arguments)};var d=maxkir.FindFilter.update_search_field;Object.extend(maxkir.FindFilter,{searchAll:function(a){document.location.href="/search?what="+encodeURIComponent(a.trim())},update_search_field:function(){d.call(this);var a=$("ffContainer");if(!a)return;this.is_filtered_by_text()?a.addClassName("ffContainer--filtered"):a.removeClassName("ffContainer--filtered")},doAllSearch:function(){this.findInput().value.length>0&&this.searchAll(this.findInput().value)},uninstall:function(){maxkir.debug("Uninstalling FindFilter");var a=$("findInput");if(!a)return;a.stopObserving(),this.kbd&&this.kbd.dispose(),this.dispose()},init_placeholder:function(){var a="";maxkir.widget_mode()?a=I18N("filter_field_placeholder1"):a=window.I18N?I18N("filter_field_placeholder2"):"",$("findInput")&&!maxkir.widget_mode()&&($("findInput").placeholder=a)},show_refresh_hint_if_needed:function(a){var b=maxkir.get_flag("_rfWasUsed");if(b)return;var c=this;if(this.is_filtered_by_text()){this.parse_input_line(this.val());var d=a.some(function(a){return c.should_hide("task_"+a)});d&&new maxkir.ui.Message(I18N("filter_refresh_note"))}},install:function(){maxkir.debug("Installing FindFilter");var a=this,b=a.findInput();if(!b)return;b.observe("focus",a.activate.bindAsEventListener(a)),b.observe("blur",a.passivate.bindAsEventListener(a)),$("ffContainer")&&$("ffContainer").down(".ffContainer__filtered").on("click",this.clear_search_field.bind(this)),maxkir.DataCompleter&&(a.completer=maxkir.DataCompleter.create_completer(b,{afterUpdateElement:a.createDelayedFilter(),with_search_items:!0})),this.kbd=new maxkir.KbdManager(b,a.createDelayedFilter()),this.kbd.forCondition(function(){return a.is_active()?$("findInput").completer_active?!$("findInput").completer_active():!0:!1},"FF field actions").addShortcut("ctrl+enter|enter enter",function(b){a.doAllSearch()}).addShortcut("down",function(b){a.passivate();var c=maxkir.TreeProvider.tree_nav();c&&(c.selectFirstInTree(),Event.stop(b))},!0).addShortcut("up",function(b){a.passivate()},!0).addShortcut("tab",function(b){a.tree_nav().set_selection("none")},!0).addShortcut("esc",function(b){a.passivate(),a.is_filtered()||a.clear_search_field()})}}),maxkir.FindFilter.ColorFilter={COLOR:/(?:color|priority):\s?(\d|any|none)\b/ig,parse_line:function(a,b){return this._parse_color(a)},accept_item:function(a,b){return this._should_hide_by_color(a,b)?null:"priority"},get_active:function(){return this._match_none()?"strict_filter":this.colors.length>0},_parse_color:function(a){var b=[];return a=a.replace(this.COLOR,function(a,c){return c==="any"?b=[1,2,3,4,5,6,7,8,9]:c==="none"?b.push(0):b.push(parseInt(c)),""}),this.colors=b,a},_should_hide_by_color:function(a,b){return this._match_none()?this._has_color(a):this.colors.length===0?!1:-1===this.colors.indexOf(maxkir.Task.priority(a))},_match_none:function(){return this.colors.length===1&&this.colors[0]===0},_has_color:function(a){return maxkir.Task.priority(a)>0}},maxkir.FindFilter.AssigneeFilter={parse_line:function(a,b){return this._parse_assignee(a)},accept_item:function(a){return this._should_hide_by_assignee(a)?null:"assignee"},get_active:function(){return this.assignee_ids.length>0},_parse_assignee:function(a){var b=/(?:assignee:\s*|@)(\S+)(\s+|$)/ig,c=[];return a=a.replace(b,function(a,b){var d=maxkir.user.user_by_name(b);return d?(c.push(d.id),""):a}),this.assignee_ids=c,a},_should_hide_by_assignee:function(a){if(this.assignee_ids.length==0)return!1;if(a.assignee_ids&&a.assignee_ids.length>0)for(var b=0;b<this.assignee_ids.length;b++)if(a.assignee_ids.include(this.assignee_ids[b]))return!1;return!0}},maxkir.FindFilter.add_filter(maxkir.FindFilterProvider.TagFilter),maxkir.FindFilter.add_filter(maxkir.FindFilterProvider.DueFilter),maxkir.FindFilter.add_filter(maxkir.FindFilterProvider.StatusFilter),maxkir.FindFilter.add_filter(maxkir.FindFilterProvider.ChangedFilter),maxkir.FindFilter.add_filter(maxkir.FindFilterProvider.NotAttachmentFilter),maxkir.FindFilter.add_filter(maxkir.FindFilter.ColorFilter),maxkir.FindFilter.add_filter(maxkir.FindFilter.AssigneeFilter),maxkir.FindFilter.TextFilter.extract_text_lines=function(a){var b=[[a.content,"text"]];if(a.comments_count>0){var c=maxkir.notes(a.id).comments_cache();if(c)for(var d=0;d<c.length;d++)b.push([c[d].comment,"notes"])}return b},maxkir.FindFilter.install()},maxkir.onDom(function(){maxkir.initFindFilter(maxkir.TreeProvider),maxkir.FindFilter.init_placeholder()}),maxkir.FindFilterHiddenMatches={show_indicator:function(a){a?$("ffContainer").classList.add("ffContainer--hiddenMatch"):$("ffContainer").classList.remove("ffContainer--hiddenMatch")},is_hide_completed:function(){return maxkir.checklist&&maxkir.checklist.HideCompleted&&maxkir.checklist.HideCompleted.is_hide()},update_icon:function(){this.show_indicator(this.hiddenMatchesCount>0&&this.is_hide_completed())},install:function(){var a=this;this.hiddenMatchesCount=0,maxkir.HoverPopups(document.body).addPopupProvider("hiddenMatchesFilter",{buildContent:function(b){return a.hiddenMatchesCount>1?I18N("js_hidden_matches").replace("%{count}",a.hiddenMatchesCount):I18N("js_one_hidden_match")}}),maxkir.tree_model.add_on_repaint({on_repaint:function(){setTimeout(function(){a.update_icon()},10)}}),maxkir.FindFilter.add_listener({filter_done:function(){a.hiddenMatchesCount=0,maxkir.FindFilter.get_matches().forEach(function(b){var c=maxkir.Task.id_str(b),d=maxkir.Task.data(c);d&&d.status&&a.hiddenMatchesCount++}),a.update_icon()}})}},maxkir.ListPageTreeModel={tree_nav:function(){return maxkir.TreeProvider.tree_nav()},tree_model:function(){return{getRoot:function(){return null},getParent:function(a){if(!a)return null;var b=maxkir.Task.data(maxkir.Task.id(a));return b&&b.parent_id?"task_"+b.parent_id:null},isLeaf:function(a){var b=maxkir.Task.data(maxkir.Task.id(a));return b&&(!b.tasks||b.tasks.length===0)},foreach:function(a){var b=0;maxkir.Task.foreach(function(c){c.deleted||a.call(this,"task_"+c.id,b++,c.parent_id?"task_"+c.parent_id:null)})}}}},maxkir.FilterState={activateOnPageLoad:function(a,b,c,d){this._key=a;var e=this.valueObject();d||(b=b||e.fltr||"");var f;b!=""&&(maxkir.FindFilter.show(b,!1,!0),maxkir.FindFilter.passivate(),f="The list is filtered, clear the filter to see the whole list"),d||(c=c||e.fcs||""),c&&!maxkir.TaskData[c]&&(c=null,maxkir.TaskFocus.remove_focus()),maxkir.TaskFocus&&c&&document.querySelector(".focusBreadcrumbs")&&(maxkir.ChecklistNodeToggle.without_server(function(){f=this.focus_and_select(c,f)}.bind(this)),e.show_parents&&maxkir.Breadcrumbs.show_parents());var g="_filter_message"+this.key(),h=maxkir.get_flag(g);f&&(h||new maxkir.ui.Message(f),maxkir.set_flag(g,!0,604800))},focus_and_select:function(a,b){return document.location.search.indexOf("nofocus=true")<0?(maxkir.checklist.HideCompleted.is_hidden(a)&&maxkir.checklist.HideCompleted.toggle_hide(!0),maxkir.TaskFocus.add_focus(a),b=b?"The list is focused and filtered, clear the filter and un-focus to see the whole list":"The list is focused, un-focus to see the whole list"):maxkir.Task.show(a),b},updateFilter:function(a){this.valueObject().fltr=(a||"").trim(),this.saveFilters()},updateFocusedTask:function(a,b){var c=this.valueObject();c.fcs=a,c.show_parents=b,this.saveFilters()},valueObject:function(){var a=this.getFilters(),b=a[this.key()];return b||(b={},a[this.key()]=b),b},key:function(){return this._key||maxkir.checklist_id||"0"},getFilters:function(){this.filters={};try{this.filters=sessionStorage.getItem("filters2")?sessionStorage.getItem("filters2").evalJSON():localStorage.getItem("filters2").evalJSON()||{}}catch(a){}return this.filters},saveFilters:function(){localStorage.setItem("filters2",Object.toJSON(this.filters)),sessionStorage.setItem("filters2",Object.toJSON(this.filters)),maxkir.info("Save filter "+Object.toJSON(this.filters))},_f:null},maxkir.cmd=maxkir.cmd||{},maxkir.cmd.has_focused_filter=function(){return maxkir.FindFilter&&maxkir.FindFilter.is_active()},maxkir.cmd.find_filter=function(){maxkir.FindFilter&&(maxkir.FindFilter.show(""),maxkir.FindFilter.findInput().select())},maxkir.cmd.reset_filter=function(){return maxkir.FindFilter&&maxkir.FindFilter.is_filtered_by_text()?(maxkir.FindFilter.clear_search_field(),!0):!1},maxkir.cmd.refresh_filter=function(){maxkir.FindFilter&&maxkir.FindFilter.is_filtered()&&maxkir.FindFilter.refresh_filter()},maxkir.cmd.link_copy=function(){var a=maxkir.cmd.task_id();if(a){var b="/checklists/"+maxkir.Task.checklist_id(a)+"/tasks/"+a;maxkir.set_flag("last_task_copy",b,60);var c=maxkir.copy_text(document.location.protocol+"//"+document.location.host+b);c&&new maxkir.ui.Message(I18N("item_copied_to_clipboard"))}},maxkir.cmd.view_sort=function(a){if(maxkir.read_only)return;var b=$$(".toolBar__sortLink");if(!a)for(var c=0;c<b.length;c++)if(maxkir.visible(b[c])){a=b[c];break}maxkir.visible($$(".tagsSortPopup")[0])?maxkir.ui.TagsSortPopup
.toggle_popup(a,null,!0):maxkir.visible($$(".indexSortPopup")[0])?maxkir.ui.IndexSortPopup.toggle_popup(a,null,!0):maxkir.ui.ListSortPopup&&maxkir.cmd.with_task_selection_anchor(function(b){if(maxkir.selection.error_multiple())return;var c=a&&!b;maxkir.ui.ListSortPopup.toggle_popup(b||a,maxkir.checklist_id,c)})},maxkir.onDom(function(){var a=function(a){var b=Event.element(a);return!maxkir.is_text_input(b)},b=function(){return maxkir.TreeProvider.tree_nav()?maxkir.TreeProvider.tree_nav().selection_visible()?!0:!1:!1},c=function(a){window.nav_tabs?window.nav_tabs.changeTo(a):document.location.href="/checklists#"+a};maxkir.kbd.forCondition(a,"Global keyboard actions").addShortcut("l l|shift+l shift+l",function(a){maxkir.ui.ChecklistPopup.invoke()},!0).addShortcut("o o",function(a){maxkir.ui.OptionsPopup?maxkir.ui.OptionsPopup.toggle_popup($("viewOptionsLink"),maxkir.checklist_id,!0):maxkir.ui.SearchDueOptionsPopup&&maxkir.ui.SearchDueOptionsPopup.toggle($("viewOptionsLink"),{align_to_right:!0})},!0).addShortcut("s s",function(){maxkir.cmd.view_sort()}).addShortcut("s d",function(a){maxkir.cmd.toggle_show_details()}).addShortcut("s c",function(a){maxkir.cmd.toggle_show_context()}).addShortcut("o m",function(){maxkir.ZenMode&&maxkir.ZenMode.toggle()}).addShortcut("h c",function(a){maxkir.cmd.toggle_hide_completed(!0);var b=maxkir.TreeProvider.tree_nav();b&&(b.fix_selection(),b.fix_scrolling&&b.fix_scrolling_big()),Event.stop(a)},!0).addShortcut("d d",function(a){b()||(Event.stop(a),c("due"))},!0).addShortcut("t t",function(a){b()||(Event.stop(a),$("tag_lists_button")?$("tag_lists_button").click():c("tags"))},!0).addShortcut("l c|t c",function(){maxkir.cmd.link_copy()}).addShortcut("h h|g h",function(a){c("main")}).addShortcut("g t",function(a){c("tags")}).addShortcut("g d",function(a){c("due")}).addShortcut("/|f f",function(){maxkir.cmd.find_filter()}).addShortcut("c f",function(a,b){maxkir.cmd.reset_filter()}).addShortcut("r f",function(a,b){maxkir.cmd.refresh_filter(),maxkir.set_flag("_rfWasUsed","true")}).addShortcut("esc",function(a,b){!maxkir.checklist.installKeyboard&&maxkir.cmd.reset_filter()&&Event.stop(a)},!0).addShortcut("shift+?",function(a){maxkir.ui.HelpPopup.show_popup(document.body),Event.stop(a)},!0),window.focus&&window.focus()}),maxkir.Sidebar={is_shown:function(){return!maxkir.user.get_boolean_pref("hide_sidebar"+maxkir.Sidebar._key)},install:function(a){maxkir.Sidebar._key=a||"",this.is_available()&&($("closeSidebar").observe("click",function(a){maxkir.Sidebar.hide(),Event.stop(a)}),maxkir.Sidebar.show_sidebar(maxkir.Sidebar.is_shown(),!0,!0),setTimeout(function(){$$(".main_div")[0].addClassName("withSidebarAnimate")},100)),this.update_topbar_icon()},is_available:function(){var a=$("closeSidebar");if(a){var b=a.up(".ajax_loaded_section");return!b||maxkir.visible(b)}return!1},update_topbar_icon:function(){var a=$("show_hints");a&&(this.is_available()?a.show():a.hide())},show_sidebar:function(a,b,c){a?this.show(!1,c):this.hide(b,c)},sidebar:function(){return $(document.querySelector(".sidenotes"))},setShowHints:function(a){var b=$("show_hints");if(b){b.setAttribute("data-show",a?"true":"false");var c=b.down(".fa-keyboard");c&&(a?(c.classList.remove("fal"),c.classList.add("fas")):(c.classList.add("fal"),c.classList.remove("fas")))}},hide:function(a,b){this.setShowHints(!1);var c=this.sidebar();c&&(c.addClassName("hidden"),this._update_container(!1)),b||maxkir.user.set_user_prefs("hide_sidebar"+maxkir.Sidebar._key,"true"),maxkir.progress.hide_progress()},show:function(a,b){this.setShowHints(!0),this._update_container(!0);var c=this.sidebar();c&&c.removeClassName("hidden"),b||maxkir.user.set_user_prefs("hide_sidebar"+maxkir.Sidebar._key,"false")},_update_container:function(a){$$(".main_div")[0][a?"addClassName":"removeClassName"]("withSidebar")}},maxkir.Undo={show_undo:function(a,b){b?this.realUndo=b:this.realUndo=function(){new maxkir.AjaxCommand("/checklists/undo",{onComplete:function(a){a.request.success()&&maxkir.FindFilter&&maxkir.FindFilter.is_filtered_by_text()&&setTimeout(function(){maxkir.FindFilter.refresh_filter()},200)}})},maxkir.Undo._timeout&&maxkir.Undo._timeout.stop();var c=maxkir.HighlightElements?maxkir.HighlightElements.getHighlighted():[];maxkir.Undo._timeout=new maxkir.TimeoutAction(0,c.length?3e4:7e3,function(){var b=" <a href='#' class='undo' id='undo_link' onclick='maxkir.Undo.runUndo(); return false;'>Undo</a>";a.indexOf("#UNDO#")>=0?a=a.gsub("#UNDO#",b):a+=b;var c=$("undoNotice");c.show(),c.innerHTML="<span class='hoverPopup infoMessage infoMessage--undo' data-popup-id='undoTextPopup'>"+a+"</span>",c.setStyle({marginLeft:"-"+c.getWidth()/2+"px"}),$$("#undoNotice a").each(function(a){a.on("mouseover",function(a){Event.stop(a)})}),this.stopping()},function(){delete maxkir.Undo._timeout,maxkir.Undo.hide_undo(),maxkir.HighlightElements&&maxkir.HighlightElements.sameHighlighted(c)&&maxkir.HighlightElements.removeHighlighting()}),maxkir.Undo._timeout.activate()},hide_undo:function(){return maxkir.visible($("undoNotice"))?($("undoNotice").hide(),$("undoNotice").update($("undoNotice").innerHTML),!0):!1},runUndo:function(){$("undo_link")&&($("undoNotice").show(),$("undo_link").innerHTML="Undoing...",this.hide_undo(),this.realUndo())},refresh:function(){maxkir.checklist_id?maxkir.checklist.refresh(maxkir.Undo.runAfterRefresh.bind(this)):document.location.reload()},runAfterRefresh:function(){this._afterUndo&&(eval(this._afterUndo),delete this._afterUndo),maxkir.Undo.hide_undo(),maxkir.refresher&&maxkir.refresher.ping_server()},restoreSelectionAfterUndo:function(a){this.runAfterUndo("if ($('"+a+"')) {maxkir.tree_nav.set_selection('"+a+"');}maxkir.tree_nav.fix_selection();")},runAfterUndo:function(a){this._afterUndo=a}},maxkir.TagManage=maxkir.ui.create_popup(!1,{popup_width:300,refresh:function(){if(!this.popupContent||$("manageTagPopupData").innerHTML!="")this.popupContent=new Template($("manageTagPopupData").innerHTML),$("manageTagPopupData").innerHTML="";this.set_content()},set_content:function(){this.win.setHTMLContent(this.popupContent.evaluate({tag_id:this.data().id,tag:maxkir.TagRenderer.getHtml(this.data(),this.data().private,"return false;"),colors_updaters:this.color_chooser_tags()}))},setPrivate:function(a,b){if(!a||b){var c=this.data();c.private=a,this.update_tag_view(),this.update_server_data_and_view(b)}else new maxkir.AjaxCommand("/tags/"+this.data().id,{method:"put",parameters:"tag[private]="+a})},onShow:function(){var a=this.win;if(!maxkir.is_pro)return;maxkir.TemporaryUser&&maxkir.TemporaryUser.on_pro_usage("advanced tagging"),this.update_tag_view(),this.update_color_selector_view(),$("visibility_link").observe("click",function(a){this.setPrivate(!this.data().private),Event.stop(a)}.bindAsEventListener(this)),a.getContent().observe("keydown",maxkir.TagManage.kbd_color_selector.bind(this)),$("rename_tag").observe("focus",function(){this._rename_active=!0}.bind(this)),$("rename_tag").observe("blur",function(){this._rename_active=!1}.bind(this)),$("rename_tag").observe("keydown",function(a){if($("rename_tag").completer_active())return;a.keyCode==Event.KEY_RETURN&&$("rename_tag").value!=""&&(this.renameTag($("rename_tag").value),Event.stop(a))}.bindAsEventListener(this));var b={};b[this.data().tag]=!0,maxkir.DataCompleter.create_completer($("rename_tag"),{skip_hash_in_tag_name:!0,existing_tags_map:b})},kbd_color_selector:function(a){if(maxkir.modifiers(a)!=0||this._rename_active)return;var b=65;a.keyCode>=b&&a.keyCode<b+20&&(maxkir.TagManage.setColor(a.keyCode-b),Event.stop(a))},setColor:function(a){var b=this.data();return a!=b.color?(b.color=a,this.update_tag_view(),this.update_server_data_and_view(),this.update_color_selector_view(),!0):!1},update_color_selector_view:function(){var a=this.data();$$("#colors_block a").each(function(b){b.getAttribute("tabindex")!="1"&&(b.setAttribute("tabindex","1"),b.observe("keydown",function(a){a.keyCode==32&&(maxkir.click_link(b),Event.stop(a))})),b.removeClassName("currentColor"),b.hasClassName("tagClass_"+a.color)&&(b.addClassName("currentColor"),b.focus())})},renameTag:function(a,b){var c="new_tag_name="+encodeURIComponent(a)+"&checklist_id="+maxkir.checklist_id;b&&(c+="&force=true"),maxkir.progress.show_progress(),new maxkir.AjaxCommand("/tags/"+this.data().id+"/rename",{parameters:c})},onHide:function(){if(!maxkir.is_pro)return;maxkir.DataCompleter.uninstall($("rename_tag")),$$("#colors_block a").invoke("stopObserving"),$("visibility_link").stopObserving(),$("rename_tag").stopObserving(),this.win.getContent().stopObserving("keydown"),maxkir.progress.hide_progress()},update_tag_view:function(){maxkir.TagRenderer.updateView($$(".tag.tag_"+this.data().tag),this.data()),this.update_handle_if_needed(),this.fix_visibility_link()},update_handle_if_needed:function(){var a=$(this.options.handle);if(a){var b=a.classNames();b.each(function(b){b.startsWith("tagClass")&&a.removeClassName(b)}),a.addClassName("tagClass_"+this.data().color)}},fix_visibility_link:function(){$("visibility_link").innerHTML="Make this tag "+(this.data().private?"public":"private")},data:function(){return maxkir.Tags.findOrCreate(this.options.tag)},update_server_data_and_view:function(a){var b=this.data();new maxkir.AjaxCommand("/tags/"+this.data().id,{method:"put",parameters:"tag[private]="+b.private+"&tag[color]="+b.color+(a?"&force=true":""),onSuccess:function(){this.update_all_tags_view()}.bind(this)})},update_all_tags_view:function(){maxkir.TagRenderer.updateAllViews(this.data()),this.fix_visibility_link()},color_chooser_tags:function(){var a="";for(var b=0;b<20;b++){var c="";b==this.data().color&&(c="currentColor"),a+="<a href='#' class='tagClass_"+b+" "+c+"' id='color_item_"+b+"' "+"onclick='maxkir.TagManage.setColor("+b+"); return false;'>"+String.fromCharCode("a".charCodeAt(0)+b)+"</a>"}return a},_f:null}),maxkir.ui=maxkir.ui||{},maxkir.ui.Accordion=function(a,b){this.container=a,this.options=b||{},a.style.overflowY="hidden",this.install_collapse_expand_handlers()},maxkir.extend(maxkir.ui.Accordion,{install_collapse_expand_handlers:function(){this.sections().forEach(function(a){a.addClassName("accordion__section-collapsed")}),this.click_handler=this.container.on("click",".accordion__sectionLink",function(a,b){var c=$(b.parentElement).hasClassName("accordion__section-expanded");this.show_form(b,!c),Event.stop(a)}.bind(this));var a=this.container.select(".accordion__sectionLink")[0];this.show_form(a,!0,!0)},show_form:function(a,b,c){if(!a)return;var d=this,e=$(a.parentElement);b?(this.curr_open_link&&this.show_form(this.curr_open_link,!1,!0),this.curr_open_link=a,e.addClassName("accordion__section-expanded"),e.removeClassName("accordion__section-collapsed"),this._update_overflow(e)):(this.curr_open_link=null,e.removeClassName("accordion__section-expanded"),e.addClassName("accordion__section-collapsed")),this.options.onChange&&d.options.onChange.call(d,a,b)},sections:function(){return this.container.select(".accordion__section")},_update_overflow:function(a){this.double_scr&&(this.double_scr.stop(),this.double_scr=null);var b=a.scrollHeight>=400;a.style.overflowY=b?"auto":"hidden",a.style.overflowX="hidden",b&&(this.double_scr=maxkir.double_scroll(a),this.double_scr.start())},dispose:function(){this.click_handler&&this.click_handler.stop(),this.double_scr&&this.double_scr.stop()}}),maxkir.double_scroll=function(a){var b=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},c,d=function(d){if(!c)return;var e=a;d.wheelDelta&&d.wheelDelta>0||d.detail&&d.detail<0?e.scrollTop==0&&b(d):e.scrollTop+e.getHeight()>=e.scrollHeight&&b(d)},e=[];return{start:function(){e.push(a.on("mouseover",function(){c=!0})),e.push(a.on("mouseout",function(){c=!1})),window.addEventListener&&window.addEventListener("DOMMouseScroll",d,!1),window.onmousewheel=document.onmousewheel=d},stop:function(){for(var a=0;a<e.length;a++)e[a].stop();window.removeEventListener&&window.removeEventListener("DOMMouseScroll",d,!1),window.onmousewheel=document.onmousewheel=null}}},maxkir.Share=maxkir.ui.create_popup(!1,{popup_width:595,refresh:function(){var a=maxkir.temporary?400:595;a!=maxkir.Share.popup_width&&(maxkir.Share.popup_width=a,this.setWidth(a));var b=this.checklist_id.length?this.checklist_id.join(","):this.checklist_id;this.accordion&&this.accordion.dispose(),this.win.getContent().innerHTML.length<10&&this.win.setHTMLContent("..."),maxkir.AjaxUpdater(this.win.getContent(),"/checklists/"+b+"/share",{evalScripts:!0,method:"get",parameters:(this.options.invite?"invite=true":"")+(this.options.tab==="public_link"?"&public_link=1":"")+"&assign_task_id="+(this.options.assign_task_id||""),onComplete:function(a){"use strict",this.win.updateHeight()}.bind(this)})},refresh_link_section:function(){return new Promise(function(a,b){maxkir.AjaxRequest("/checklists/"+this.checklist_id+"/share",{evalScripts:!1,method:"get",onFailure:b,onSuccess:function(b){var c=function(){var a=document.createElement("div");a.innerHTML=b.responseText;var c=a.querySelector(".shareByLink .accordion__content"),d=a.querySelector(".shareEmbed .accordion__content");document.querySelector(".shareByLink .accordion__content").innerHTML=c.innerHTML,document.querySelector(".shareEmbed .accordion__content").innerHTML=d.innerHTML,maxkir.Share.update_view_share_by_link(),maxkir.Share.win.updateHeight()};c(),a()}.bind(this)})}.bind(this))},_on_send:function(a){maxkir.Share.prepare_permalink_fields(),$("sendInvitationButton").value="Adding ...",new maxkir.AjaxRequest(a.action,{parameters:$(a).serialize(),onComplete:function(){$F(a.assign_task_id)>0?(maxkir.checklist.refresh_tree(),this.hide_popup()):(this.refresh(),this.refresh_share_texts())}.bind(this)})},prepare_permalink_fields:function(){$("filterForPermalink").value=this._filter(),$("focusedTaskId").value=this._focused()},_filter:function(){return $("findInput")?$("findInput").value.trim():""},_focused:function(){return maxkir.TaskFocus?maxkir.TaskFocus.focusedTaskId():""},create_invite_link:function(){return this._create_invite_link("").then(function(){return maxkir.Share.refresh_share_texts(),maxkir.Share.refresh_link_section()})},_create_invite_link:function(a){return new Promise(function(b,c){var d=$("expirationHours")?$F("expirationHours"):0,e=$("linkPassword")?"&linkPassword="+$F("linkPassword"):"",f=$("as_reader2")?$F("as_reader2"):!0;new maxkir.AjaxRequest("/checklists/"+this.checklist_id+"/share/create_link",{method:"POST",parameters:"expirationHours="+d+"&as_reader="+f+a+e,onSuccess:function(a){b()},onFailure:c})}.bind(this))},save_public_view:function(){this.update_view_share_by_link(),this.has_share_link()&&this.create_invite_link().then(function(){new maxkir.ui.Message(I18N("share_link_updated"))})},update_public_view_filter:function(){setTimeout(function(){var a;$("createPermalink2").checked?(a="&createPermalink=true&filterForPermalink="+this._filter()+"&focusedTaskId="+this._focused(),maxkir.Share.filter_key_from_link=maxkir.Share.get_filter_key()):(a="&createPermalink=true&filterForPermalink=&focusedTaskId=",maxkir.Share.filter_key_from_link=""),this._create_invite_link(a).then(function(){new maxkir.ui.Message(I18N("share_link_updated"))})}.bind(this),10)},render_recapture:function(){if(window.grecaptcha&&$$(".grecaptcha-badge").length==0){var a=$("sendInvitationButton");window.grecaptcha.render(a,{sitekey:a.getAttribute("data-sitekey")})}},on_load:function(a,b,c){var d=this.win,e=this;this.is_old_public=b;var f=function(){d.updateHeight(),setTimeout(function(){d.updateHeight()},40)},g=new maxkir.ui.Accordion(d.getContent(),{onChange:function(a,b){b&&a.id=="inviteLink"&&$("emails")&&($("emails").activate(),e.render_recapture()),f()}});this.accordion=g;var h=d.getContent().down("p.error");if(h){var i=h.up(".accordion__section");g.show_form(i.previous(),!0,!0)}else a?g.show_form(document.querySelector(".shareByEmail .accordion__sectionLink"),!0,!0):c&&g.show_form(document.querySelector(".shareByLink .accordion__sectionLink"),!0,!0);maxkir.run_before(d,"close",function(){g.dispose()}),this.publishing_form_setup(),this.update_view_share_by_email(),this.update_view_share_by_link()},publishing_form_setup:function(){var a=$("publishForm");if(!a)return;a.on("click",".publishButton",function(a,b){var c=$(b).value;$(b).value="Un-Publishing...",$(b).disable(),maxkir.Lists.make_public(this.checklist_id,!this.is_old_public).then(function(){this.is_old_public=!this.is_old_public,this.refresh_link_section(),this.refresh_share_texts()}.bind(this))}.bind(this))},refresh_share_texts:function(){maxkir.checklist_id&&maxkir.checklist.refresh_topbar(),this._refresh_checklist_table_items()},remove_share:function(a,b){maxkir.confirm(a,"Unshare?","maxkir.Share._do_delete_share(this, "+b+")")},install_role_editor:function(a){var b=$("role_"+a);if(!b)return;var c=this,d=b.down("select");if(!d)return;d.on("change",function(){d.options[d.selectedIndex].defaultSelected?b.down(".saveRole").hide():b.down(".saveRole").show()}),b.down(".saveRole").on("click",function(){c.toggle_access(a,d.options[d.selectedIndex].value)})},toggle_access:function(a,b){new maxkir.AjaxRequest("/checklists/"+this.checklist_id+"/share/"+a,{parameters:"role="+b,method:"put",onSuccess:function(){maxkir.Share.refresh(),new maxkir.ui.Message("Access rights were changed, the user was notified")}})},_refresh_checklist_table_items:function(){$$("li.list_item span.shared").each(function(a){var b=a.up("li.list_item").getAttribute("data-list_id");b==this.checklist_id&&new maxkir.AjaxUpdater(a,"/checklists/"+this.checklist_id,{parameters:"partial=cl_shared",method:"get",evalScripts:!1})}.bind(this))},delete_invitation:function(a,b){maxkir.confirm(a,I18N("share_delete_inv_confirm"),"maxkir.Share._do_delete_invitation(this, "+b+")")},delete_share_link:function(a,b){this._do_delete_share_link(b)},_do_delete_share_link:function(a){this.delete_invitation_on_server(a).then(function(){maxkir.Share.refresh_share_texts(),maxkir.Share.refresh_link_section()})},delete_invitation_on_server:function(a){var b=this;return new Promise(function(c,d){new maxkir.AjaxRequest("/checklists/"+b.checklist_id+"/share/remove_invitation",{parameters:"invitation_id="+a,method:"post",onSuccess:function(){c()},onFailure:function(){d()}})})},_do_delete_invitation:function(a,b){Element.remove(a.parentNode.parentNode),this.delete_invitation_on_server(b).then(function(){maxkir.Share.refresh()})},_do_delete_share:function(a,b){new maxkir.AjaxRequest("/checklists/"+this.checklist_id+"/share/"+b,{method:"delete",onSuccess:function(){b==maxkir.current_user_id?document.location.href="/checklists":(this.refresh_share_texts(),maxkir.Share.hide_popup(),maxkir.Undo.show_undo("You have just un-shared the list"))}.bind(this)}),Element.remove(a.parentNode.parentNode.parentNode)},append_emails:function(a){if(!a)return;var b=$("emails");$A(a).each(function(a){var c=new RegExp("(^|\\s|,)"+a+"($|\\s|,)","i");c.test(b.value)||(b.value==""?b.value=a:(b.value.trim().endsWith(",")||(b.value+=", "),b.value+=a))})},has_share_link:function(){return document.querySelector(".shareByLink__deleteLink")},update_view_share_by_link:function(){this._update_share_by_link_title();var a=$("as_reader2");if(!a)return;a.selectedIndex===0?document.querySelector(".shareByLink__roleDescription").innerHTML=I18N("share_can_edit_desc"):document.querySelector(".shareByLink__roleDescription").innerHTML=I18N("share_can_view_desc");var b=document.querySelectorAll(".shareByLink__keepFilter"),c=maxkir.Share.filter_key_from_link,d=$("createPermalink2").checked,e=maxkir.checklist_id&&this.get_filter_key()!==c;maxkir.info("Filtering keys: '"+c+"' '"+this.get_filter_key()+"'");for(var f=0;f<b.length;f++)b[f].style.display=d||e?"block":"none";var g=document.querySelector(".shareByLink__updateFilter");g&&(g.style.display=d&&e&&this.get_filter_key()?"inline-block":"none"),$("expirationHours").onkeypress=maxkir.Share.onkeypress_SubmitOnEnter,$("linkPassword").onkeypress=maxkir.Share.onkeypress_SubmitOnEnter,$("linkPassword").onclick=maxkir.Share.onclick_LinkPassword},onkeypress_SubmitOnEnter:function(a){a.keyCode===Event.KEY_RETURN&&maxkir.Share.save_public_view()},onclick_LinkPassword:function(a){a.offsetX>a.target.offsetWidth-25&&(a.target.type=a.target.type==="text"?"password":"text",Event.stop(a))},update_view_share_by_email:function(){var a=maxkir.checklist_id&&this.get_filter_key()!=="",b=document.querySelectorAll(".shareByEmail__keepFilter");for(var c=0;c<b.length;c++)b[c].style.display=a?"block":"none"},_update_share_by_link_title:function(){var a=document.querySelector(".shareByLink__titleText");a&&(a.innerHTML=this.has_share_link()||this.is_old_public?I18N("share_list_by_link_shared"):I18N("share_list_by_link"))},get_filter_key:function(){var a=(maxkir.FindFilter?maxkir.FindFilter.val():"")+"_"+(maxkir.TaskFocus?maxkir.TaskFocus.focusedTaskId():"");return a==="_"?"":a},show_expiration_block:function(){maxkir.is_pro?($$(".shareByLink__expireTitle")[0].hide(),$$(".shareByLink__expireParams")[0].style.display="block",$("expirationHours").focus()):maxkir.ProSupport.ask_pro_dialog(I18N("share_expire_pro"),function(){sessionStorage.setItem("_shareAfterReload","true"),document.location.reload()})},show_password_block:function(){maxkir.is_pro?($$(".shareByLink__passwordTitle")[0].hide(),$$(".shareByLink__passwordParams")[0].style.display="block",$("linkPassword").focus()):maxkir.ProSupport.ask_pro_dialog(I18N("share_password_pro"),function(){sessionStorage.setItem("_shareAfterReload","true"),document.location.reload()})},copy_share_link:function(){var a=document.querySelector(".shareByLink__holder");a&&a.href&&maxkir.copy_text(a.href)&&new maxkir.ui.Message("Copied to clipboard!")}}),maxkir.ChooseExistingUsers=function(a,b){var c=this,d=function(a){var d=[];c.table&&(c.table.select("input[name=user_email]").each(function(a){a.checked&&d.push(a.value)}),b(d)),a.close()},e=maxkir.ui.Dialog.confirm("Select People","<div class='chooseDialogContent'>Loading ...</div>",d,"Done","",function(){$("user_filter")&&$("user_filter").focus(),maxkir.AjaxUpdater(e.getContent().down(".chooseDialogContent"),"/checklists/"+a+"/share/share_candidates.html",{method:"get",onComplete:function(){e.updateHeight(),e._recenter(),c.init_table()}})},function(){c.stopHandler&&(c.stopHandler(),c.win=null,maxkir.info("Disposed"))});this.win=e},maxkir.extend(maxkir.ChooseExistingUsers,{init_table:function(){this.table=this.win.getContent().down(".shareUserTable");if(!this.table)return;var a=this,b=this.table.on("click","td",function(a,b){if(Event.element(a).tagName=="INPUT"||!b.up(".shareUserTable"))return;b.up("tr").down("input[type=checkbox]").click()}),c,d=this.win.getContent().down("#user_filter").on("keydown",function(b){clearTimeout(c),c=setTimeout(a.update_table_from_filter.bind(a),300)}),e=this.win.getContent().on("change","input",function(){a.update_total_counter()}),f=maxkir.double_scroll($$(".shareTableWrapper")[0]);f.start(),this.stopHandler=function(){f.stop(),e.stop(),d.stop(),b.stop()},$("user_filter").focus()},update_table_from_filter:function(){var a=$F("user_filter");this.table.select("td.name").each(function(b){var c=b.innerHTML.stripTags().indexOf(a)!=-1;c?b.up("tr").removeClassName("hidden"):b.up("tr").addClassName("hidden")});var b=null;this.table.select("tr").each(function(a){a.hasClassName("userSectionHeader")?(b=a,b.addClassName("hidden")):b!=null&&!a.hasClassName("hidden")&&b.removeClassName("hidden")})},update_total_counter:function(){setTimeout(function(){var a=this.table.select("input.userEmail:checked").length;$$(".totalSelectedCounter")[0].update(a>0?"You've selected <strong>"+a+"</strong> people":"")}.bind(this),25)}}),maxkir.ChooseExistingUsers.toggle_select=function(a,b){setTimeout(function(){var c=a.checked,d=a.up("table");d.select(b).each(function(a){if(maxkir.visible(a)||!c)a.checked=c})},20)},maxkir.ShareTopbar={topbar_button:function(){return document.querySelector(".topbar__shareButton")},update_topbar:function(a){$$(".sharreLink").invoke("remove");var b=this.topbar_button();b||document.querySelector(".topbar_afterNav").insertAdjacentHTML("afterend",this._share_button(a))},toggle_share:function(a){a=a||window.event;var b={checklist_id:maxkir.checklist_id,align_to_right:!0},c=$(a.target);c.up(".topbar__publicIcon")&&(b.tab="public_link"),maxkir.Share.toggle(c,b)},_users:function(a){return a.count<=1?"":'<span class="topbar__shareIcon" title="'+I18N("js_shared_privately_title")+'" '+'><i class="fas fa-users"></i>'+'<span class="topbar_shareCounter">'+a.count+"</span></span>"},_public_icon:function(a){return a?'<span class="topbar__shareIcon topbar__publicIcon" title="'+I18N("js_shared_publicly_title")+'" '+'><i class="fal fa-link"></i></span>':""},_share_button:function(a){var b="uibut",c="";if(a.count>1||a.public)b="newbut",c="d";return'<a class="topbar__button sharreLink '+b+'" href="#" '+'onclick="maxkir.ShareTopbar.toggle_share(event); return false;" '+">"+this._users(a)+this._public_icon(a.public)+I18N("js_share_button")+c+"</a>"}},maxkir.JoinListDialogForLoggedInReader=function(a){maxkir.ui.Dialog.confirm(I18N("js_join_dialog_title"),I18N("js_join_dialog_content"),function(){document.location.href=a},I18N("js_join_dialog_join"),I18N("js_join_dialog_help"),null,null,null)},maxkir.ui=maxkir.ui||{},maxkir.ui.InputHints=function(a,b){this.editField=$(a);if(!this.editField)throw new Error("Cannot find element "+a);this.options=Object.extend({},b||{}),this.start()},maxkir.extend(maxkir.ui.InputHints,{start:function(){this.editField.addClassName("withHelpIcon"),this.editField.style.paddingRight="";var a=document.createElement("i");a.className="icon-ellipsis-horizontal editHelp",a.title="Show smart syntax hints",document.body.appendChild(a),this._updateIconPosition(a);var b=this.editField.offsetWidth,c=this.editField.offsetHeight;this.positionUpdater=setInterval(function(){if(b!=this.editField.offsetWidth||c!=this.editField.offsetHeight)b=this.editField.offsetWidth,c=this.editField.offsetHeight,this._updateIconPosition(a)}.bind(this),200);var d=this;a.on("mousedown",function(a){if(!d.editField)return;d.editField._ignoreBlur=!0;var b=d.editField.on("focus",function(){d.editField._ignoreBlur=!1,b.stop()});d.toggle_popup(),Event.stop(a)}),this.icon=a,maxkir.debug("InputHints started")},_updateIconPosition:function(a){a.style.top=maxkir.getPageOffset(this.editField).top+6+"px",a.style.left=maxkir.getPageOffset(this.editField).left+this.editField.offsetWidth-20+"px"},toggle_popup:function(){maxkir.ui.InputHintsPopup.toggle(this.icon,{editField:this.editField})},dispose:function(){clearInterval(this.positionUpdater),maxkir.ui.InputHintsPopup.hide_popup(),this.icon&&(this.icon.stopObserving(),this.icon.parentNode&&this.icon.remove()),this.editField&&(this.editField.removeClassName("withHelpIcon"),this.editField=null,maxkir.debug("InputHints disposed"))}}),maxkir.ui.InputHintsPopup=maxkir.ui.create_popup(!0,{popup_width:250,refresh:function(){this.setContent(),this.setupSelection()},setContent:function(){var a=this.win,b=$("inputHintsPopupData").innerHTML;$("inputHintsPopupData").innerHTML="",a.setHTMLContent(b),maxkir.run_before(a,"close",function(){var b=a.getContent().innerHTML;a.getContent().innerHTML="",b&&($("inputHintsPopupData").innerHTML=b)}),this.win=a},doOpen:function(a,b){var c=a.getAttribute("data-code");if(!c){maxkir.click_link($(a),b);return}this.insert_mark(a),Event.stop(b),this.hide_popup()},insert_mark:function(a){var b=a.getAttribute("data-code");if(a.hasClassName("disabled"))switch(b){case"@":maxkir.ProSupport.ask_for_pro("You need a PRO account to assign tasks");return;case"img:":maxkir.ProSupport.ask_for_pro("You need a PRO account to attach files");return;default:maxkir.ProSupport.ask_for_pro("You need a PRO account to use this");return}b=="newline"&&(b="  \n");var c=this.options.editField,d=maxkir.get_selection_range(c);c.value=c.value.substr(0,d[1])+" "+b+c.value.substr(d[1]);var e=d[1]+1+b.length;maxkir.set_selection(c,e,e);var f=c.retrieve("completer");f&&setTimeout(function(){f.trigger_activation()},50)},onShow:function(){this.options.editField.blur(),this.scrollToShow(),this.click_handler=this.ul_element().on("click","li.inputHint",function(a,b){this.insert_mark(b),Event.stop(a),this.hide_popup()}.bind(this))},onHide:function(){var a=this.options.editField;this.options.editField=null,setTimeout(function(){a&&!maxkir.cmd.popup_visible()&&a.focus()},50),this.click_handler&&(this.click_handler.stop(),this.click_handler=null)},f_:null}),maxkir.TreeAddOn=function(a,b){maxkir._treat_visible_by_default=!0,window.addEventListener("beforeunload",function(){var b=a.get_selection();b&&maxkir.cmd.task_id_from_child(b)&&a.key_left(b)}),a.fix_scrolling=function(b){var c=$(this.get_selection());if(!c||!a.selection_visible())return;c=c.down(".selectedTask")||c,maxkir.scrollTo(c,b,Math.min(c?c.offsetHeight:0,200)),a.is_first_node(this.get_selection())&&$(this.get_selection()).up(".dialog")==null&&!maxkir.temporary&&window.scrollTo(0,0)},a.fix_scrolling_big=function(){this.fix_scrolling(document.viewport.getHeight()/3)};var c=function(){$$(".withActionMenu").forEach(function(a){a.removeClassName("withActionMenu")});var b=$(a.get_selection());if(b&&a.selection_visible()){var c=h(b);if(!c)return;setTimeout(function(){b.classList.contains("selectedTask_focus")&&c.classList.add("withActionMenu")},500)}},d=function(){var b=document.querySelector(".verticalGuide"),c=document.querySelectorAll(".toolbarDiv");if(b)if(a.tree_model().getFirstNode()){b.style.visibility="visible";for(var d=0;d<c.length;d++){var e=c[d];if(maxkir.visible(e)){b.style.top=""+(e.getBoundingClientRect().bottom-b.parentNode.getBoundingClientRect().top)+"px";break}}}else b.style.visibility="hidden"},e=function(){var b=document.querySelector(".verticalGuide__selected");if(!b)return;var c=document.querySelector(".selectedFrame");c&&a.selection_visible()?(b.style.height=c.offsetHeight+"px",b.style.top=c.getBoundingClientRect().top-c.up(".topLevel").getBoundingClientRect().top+"px"):b.style.height=0},f=maxkir.delay_action(function(){if(!maxkir.FindFilter||!maxkir.FindFilter.is_active())a.keep_scrolling_once?a.keep_scrolling_once=!1:a.fix_scrolling();c(),d(),e()},10);a.refresh_global_ui=function(){f.start()};var g=maxkir.TaskFocus;g&&g.add_listener(a.refresh_global_ui),a.onSetSelection=function(a,b){$(this.selectedFrame)&&$(this.selectedFrame).removeClassName("selectedFrame"),this.selectedFrame=null;if(a.length>0){var c=this.tree_model().getParents(a[0]),d=g&&g.is_active()?1:0;this.selectedFrame=c&&c.length>d?c[d]:a[0];if($(this.selectedFrame)){var e=$(this.selectedFrame).down();e&&Element.hasClassName(e,"frame")&&$(this.selectedFrame).addClassName("selectedFrame")}}this.currentTasks=this.currentTasks||[],this.currentTasks.forEach(function(a){$(a).removeClassName("currentTask")}),this.currentTask=[],a.forEach(function(a){if($(a)){var b=$(a).hasClassName("task")?a:$(a).up("li.task");$(b)&&($(b).addClassName("currentTask"),this.currentTask.push(b))}},this),this.refresh_global_ui()}.bind(a);var h=function(a){var b=$(a);return b?b.querySelector(".coreDiv"):null};a.onHideSelection=function(a){var b=h(a);if(!b)return;b.classList.remove("selectedTask"),f.start()},a.onShowSelection=function(a){var b=h(a);if(!b)return;b.classList.add("selectedTask"),f.start()};var i=function(b){var c;return function(){return c&&c.stop(),c=b($(a._tree.getRoot())),c}},j=function(b){return b.on("click","li",function(b,c){var d=c.up("li.comment")||c.up("li.task"),e=c.id||d&&d.id;if(e&&!maxkir.EditTracker.is_editing()){var f=maxkir.MAC?b.metaKey:b.ctrlKey;if(f)a.is_selected(e)?a.remove_selection([e]):a.add_selection([e]);else if(b.shiftKey)a.extend_selection_to(e);else{var g=Event.element(b);g.hasClassName("act")&&a.is_selected(e)?maxkir.cmd.view_actions(g,!0):(a.unfreeze_selection(),a.set_selection(e));var h=$(e)?$(e).down(".coreDiv"):null;h&&h.addClassName("withActionMenu")}}})},k=function(c){return maxkir.run_after(b,"onExpand",a.refresh_global_ui),maxkir.run_after(b,"onCollapse",a.refresh_global_ui),b.install_via_selector(c,".nodeImage",function(a,b){b||maxkir.notes(maxkir.Task.id(a)).hide_notes()})},l=function(a){return a.on("click",".userContent a",function(a,b){a.isLeftClick()&&(a.target.beingDragged||maxkir.click_link(b),Event.stop(a))})};a.install_basic_behaviour=i(function(a){var b=j(a),c=k(a),d=l(a);return maxkir.Comments.install_comments(),f.start(),{stop:function(){maxkir.Comments.uninstall_comments(),b.stop(),c.stop(),d.stop()}}}),a.install_checkbox_handler=i(function(a){return a.on("click",".checkMark",function(a,b){setTimeout(function(){maxkir.cmd.complete_reopen_task()},50)})}),maxkir.InstallTreeFiltering(a)},maxkir.TreeKbdInterface={collapse_all:function(){},expand_all:function(){
},expand_branch:function(a){},collapse_branch:function(a){},expandNode:function(a){},collapseNode:function(a){},isCollapsed:function(a){},f_:null},maxkir.TreeKbdNavigationInstall=function(a,b,c){var d=function(a,b){return a.length===b.length&&a.every(function(a,c){return b[c]===a})},e=function(){var a=b.tree_model().get_visible_nodes(),c=maxkir.FindFilter;c&&c.is_filtered()&&(a=a.filter(function(a){return c.get_result(a).matched})),d(b.get_all_selection().sort(),a.sort())&&(a=b.tree_model().get_visible_nodes());var e=b.get_selection();b.set_selection(a),b.freeze_selection(),e&&c.get_result(e).matched&&b.set_selection(e)},f=function(){var a="js_history_prefix";return maxkir.TaskFocus&&maxkir.TaskFocus.is_active()&&(a+="_focus"),maxkir.FindFilter&&maxkir.FindFilter.is_filtered_by_text()&&(a+="_filter"),maxkir.checklist.HideCompleted&&maxkir.checklist.HideCompleted.is_hide()&&(a+="_hc"),"<div class='humanizedMessage__sub'>🤔 "+I18N(a)+"</div>"},g=function(a){var b=maxkir.TreeProvider.tree_nav();!b.go_back()&&b.has_history(-1)?new maxkir.ui.Message(I18N("js_cant_go_back")+f()):Event.stop(a)},h=function(a){var b=maxkir.TreeProvider.tree_nav();!b.go_forward()&&b.has_history(1)?new maxkir.ui.Message(I18N("js_cant_go_forward")+f()):Event.stop(a)};a.addShortcut("g left",function(a){g(a)},!0).addShortcut("g right",function(a){h(a)},!0).addShortcut("left",function(a){maxkir.key_monitor.pressed("g")?g(a):b.selection_visible()&&!a.altKey&&(maxkir.cmd.key_left(b.get_selection(),b,c),Event.stop(a))},!0).addShortcut("right",function(a){maxkir.key_monitor.pressed("g")?h(a):b.selection_visible()&&!a.altKey&&(maxkir.cmd.key_right(b.get_selection(),b,c),Event.stop(a))},!0).addShortcut("up|k",function(a){maxkir.cmd.key_up(b.get_selection(),b)&&Event.stop(a)},!0).addShortcut("down|j",function(a){maxkir.cmd.key_down(b.get_selection(),b)&&Event.stop(a)},!0).addShortcut("s t",function(){var a=b.get_selection();b.is_frozen(a)?(b.remove_selection([a]),b.add_selection([a])):b.freeze_selection()}).addShortcut("shift+down|shift+j",function(a){b.extend_selection_down(!0)}).addShortcut("shift+up|shift+k",function(a){b.extend_selection_up(!0)}).addShortcut("ctrl+a|meta+a",function(a){e()}).addShortcut("home",function(a){b.selectFirstInTree()}).addShortcut("end",function(a){b.selectLastInTree()}).addShortcut("pageup",function(a){var c=b.get_selection();for(var d=0;d<25;d++){if(b.is_first_node(c))break;c=b.getPrev(c,!0)}b.set_selection(c)}).addShortcut("pagedown",function(a){var c=b.get_selection();for(var d=0;d<25;d++){if(b.is_last_node(c))break;c=b.getNext(c,!0)}b.set_selection(c)}).addShortcut("ctrl+shift+left",function(a){c.collapse_all()}).addShortcut("ctrl+shift+right",function(a){c.expand_all()}).addShortcut("ctrl+alt+.|num_plus",function(a){var d=b.get_all_selection();d.forEach(function(a){c.expand_branch(a)})}).addShortcut("ctrl+alt+,|num_minus",function(a){var d=b.get_all_selection();d.forEach(function(a){c.collapse_branch(a)})})},maxkir.TreeCommandInterface={on_gg:function(){},on_ct:function(){},on_ca:function(){},on_cd:function(){},on_cn:function(){},on_sn:function(){},on_td:function(){},on_yd:function(){},on_tm:function(){},on_as:function(){},on_dd:function(){},on_dr:function(){},on_note:function(){},on_file:function(){},on_space:function(){},on_shift_space:function(){},on_delete:function(){},on_ee_f2:function(){},f_:null},maxkir.TreeTaskCommandsInstall=function(a){var b=0,c=maxkir.delay_action(function(){maxkir.key_monitor.pressed("g")||(maxkir.debug("g is up",b),b==1&&(b=0,maxkir.cmd.visit_first_link()),b=0)},300),d=Object.extend(maxkir.TreeCommandInterface,{on_gg:function(){b++,maxkir.debug("gg",b),c.start()},on_ct:function(){maxkir.cmd.delete_tags()},on_tt:function(){maxkir.cmd.view_tags("")},on_ca:function(){maxkir.cmd.set_assignee("")},on_ae:function(){maxkir.cmd.assign_user()},on_cd:function(){maxkir.cmd.set_due(null)},on_td:function(){maxkir.cmd.set_due("today")},on_yd:function(){maxkir.cmd.set_due("yesterday")},on_tm:function(){maxkir.cmd.set_due("tomorrow")},on_as:function(){maxkir.cmd.set_due("asap")},on_dd:function(){maxkir.cmd.view_add_due()},on_dr:function(){maxkir.cmd.view_add_due_repeat()},on_mh:function(){maxkir.cmd.toggle_markdown_header(!0)},on_bold:function(){var a=maxkir.cmd.list();a&&a.markdown()?maxkir.cmd.toggle_markup("**","**",!0):maxkir.cmd.toggle_markup("<b>","</b>",!0)},on_italic:function(){var a=maxkir.cmd.list();a&&a.markdown()?maxkir.cmd.toggle_markup("*","*",!0):maxkir.cmd.toggle_markup("<em>","</em>",!0)},on_note:function(){maxkir.cmd.view_add_note()},on_cn:function(){maxkir.cmd.clear_notes()},on_sn:function(){maxkir.CommentsAll.toggle()},on_file:function(){maxkir.cmd.attach_file()},on_space:function(a){maxkir.cmd.complete_reopen_task()&&a&&Event.stop(a)},on_shift_space:function(){maxkir.cmd.invalidate_task()},on_delete:function(a){maxkir.cmd.delete_selected(a)},on_ee_f2:function(){maxkir.cmd.edit_task_or_note()},on_enter:function(a){var b=maxkir.cmd.can_run(!maxkir.Task.writable_or_assignee(maxkir.cmd.task_id_from_child()),!1);if(!maxkir.add_task||!b){maxkir.cmd.add_task_or_note(a);return}var c=maxkir.cmd.task_id(),d=maxkir.TaskFocus&&c&&maxkir.TaskFocus.focusedTaskId()==c,e=maxkir.Task.renderer(c);d&&e&&!e.collapsed()?(maxkir.cmd.add_subtask(),Event.stop(a)):maxkir.cmd.add_task_or_note(a)},_f:null}),e=function(a){setTimeout(function(){var b=maxkir.get_selection_range(document.activeElement);b&&(maxkir.set_selection_range(document.activeElement,[b[a],b[a]]),console.warn(b,maxkir.get_selection_range(document.activeElement)))},30)};a.addShortcut("g g|shift+G shift+G|ctrl+G ctrl+G",function(){d.on_gg()}).addShortcut("c t",function(){d.on_ct()}).addShortcut("t t",function(){d.on_tt()}).addShortcut("c a",function(){d.on_ca()}).addShortcut("c n",function(){d.on_cn()}).addShortcut("s n",function(){d.on_sn()}).addShortcut("c d",function(){d.on_cd()}).addShortcut("t d",function(){d.on_td()}).addShortcut("y d",function(){d.on_yd()}).addShortcut("t m",function(){d.on_tm()}).addShortcut("d d",function(){d.on_dd()}).addShortcut("d r",function(){d.on_dr()}).addShortcut("m h",function(){d.on_mh()}).addShortcut(maxkir.meta_or_ctrl()+"b|b b",function(){d.on_bold()}).addShortcut(maxkir.meta_or_ctrl()+"i|i i",function(){d.on_italic()}).addShortcut("a e",function(){d.on_ae()}).addShortcut("a s",function(){d.on_as()}).addShortcut("n n|n o t e",function(){d.on_note()}).addShortcut("a t|f i l e",function(){d.on_file()}).addShortcut("space",function(a){d.on_space(a)},!0).addShortcut("shift+space",function(){d.on_shift_space()}).addShortcut("f2|e e",function(){d.on_ee_f2()}).addShortcut("e a",function(){d.on_ee_f2(),e(1)}).addShortcut("e i",function(){d.on_ee_f2(),e(0)}).addShortcut("shift+backspace|delete",function(a){d.on_delete(a)},!0).addShortcut("enter",function(a){d.on_enter(a)},!0)},maxkir.TreeTaskColorsInstall=function(a){a.addShortcut("0|num_0",function(){maxkir.cmd.paint_color(0)}).addShortcut("1|num_1",function(){maxkir.cmd.paint_color(1)}).addShortcut("2|num_2",function(){maxkir.cmd.paint_color(2)}).addShortcut("3|num_3",function(){maxkir.cmd.paint_color(3)}).addShortcut("4|num_4|shift+1|shift+num_1",function(){maxkir.cmd.paint_color(4)}).addShortcut("5|num_5|shift+2|shift+num_2",function(){maxkir.cmd.paint_color(5)}).addShortcut("6|num_6|shift+3|shift+num_3",function(){maxkir.cmd.paint_color(6)}).addShortcut("7|num_7",function(){maxkir.cmd.paint_color(7)}).addShortcut("8|num_8",function(){maxkir.cmd.paint_color(8)}).addShortcut("9|num_9",function(){maxkir.cmd.paint_color(9)})},maxkir.InstallTreeFiltering=function(a){if(!maxkir.FindFilter||maxkir.FindFilter._tree_filter_installed)return;maxkir.FindFilter._tree_filter_installed=!0,maxkir.FindFilter.add_listener({node_shown:function(a){"use strict";var b=a.match(/^checklist_(.+[^\d])(\d+)/);if(b){var c=parseInt(b[2]),d=maxkir.Lists.data(c),e=new maxkir.ChecklistRenderer(d,[],b[1]);e.updateListText();return}var f=maxkir.Task.id(a);f&&(this._to_update||(this._to_update=[]),this._to_update.push(f))},filter_done:function(){this._to_update||(this._to_update=[]);var b=[],c=[];for(var d=0;d<this._to_update.length;d++){var e=this._to_update[d];maxkir.inViewport(document.getElementById("task_"+e))?b.push(e):c.push(e)}this._to_update=[],this._do_rerender(b),a.refresh_global_ui&&a.refresh_global_ui(),setTimeout(function(){maxkir.info("Updating UI "+c.length+" items after filter"),this._do_rerender(c),maxkir.info("Done updating UI "+c.length+" items after filter")}.bind(this),20)},_do_rerender:function(a){maxkir.info("Rerender "+a.length+" items"),a.forEach(function(a){var b=maxkir.Task.renderer(a);b&&b.updateOnFilter()})}})},maxkir.notes=function(a){var b=maxkir.Comments._cache[a];return b||(b=new maxkir.Comments(a),maxkir.Comments._cache[a]=b),b},maxkir.notes.visible=function(a){var b=maxkir.Comments._cache[a];return b&&b.is_visible()},maxkir.Comments=function(a){this.task_id=a,this.checklist_id=maxkir.Task.checklist_id(a),this.model=new maxkir.TaskNotesFiles(this.task_id),maxkir.CommentEditorsData[a]={}},maxkir.Comments._cache={},maxkir.Comments.install_comments=function(){var a=$(maxkir.TreeProvider.tree_model().getRoot()),b=$(a).on("click","a.notesFragment",function(a,b){var c=b.id.startsWith("cc")?b.id.substring("cc".length):null;c&&maxkir.notes(c).toggleComments(a)}),c=$(a).on("dblclick","a.notesFragment",function(a){Event.stop(a)});$(a).uninstall_comments=function(){b.stop(),c.stop(),maxkir.CommentEditorsData={},maxkir.Comments._cache={},delete $(a).uninstall_comments}},maxkir.Comments.uninstall_comments=function(){var a=$(maxkir.TreeProvider.tree_model().getRoot());a.uninstall_comments&&a.uninstall_comments()},maxkir.extend(maxkir.Comments,{note_link:function(){return $("cc"+this.task_id)},toggleComments:function(a){this[this.is_visible()?"hide_notes":"show_notes"](),Event.stop(a)},is_visible:function(){return maxkir.CommentsAll.is_visible(this.task_id)},hide_notes:function(a){return this.is_visible()?(maxkir.CommentsAll.mark_shown(this.task_id,!1),a||maxkir.NotesState.on_collapse(this.task_id),this.element&&(this.remove_attachments(),this.hide_add(),this.dispose_editors(),maxkir.remove_element(this.element),this.element=null),$("task_"+this.task_id)&&(this.update_task_line(),!a&&/^(note|upload)/.test(maxkir.tree_nav.get_selection())&&maxkir.tree_nav.set_selection("task_"+this.task_id)),maxkir.CommentsAll.mark_shown(!1),!0):!1},remove_attachments:function(){var a=this.element.up();if(a){var b=a.down("ul.attachments");maxkir.remove_element(b)}},extract_dom_fragment:function(){if(this.element){var a=document.createDocumentFragment(),b=this.element.up().down("ul.attachments");return b&&a.appendChild(b),a.appendChild(this.element),a}return null},show_existing:function(){return this.has_content()?(this.show_notes().finally(),!0):!1},show_notes:function(a,b){if(!maxkir.Task.writable_or_assignee(this.task_id)&&!this.has_content())return Promise.reject();if(this.is_visible()&&!b)return a&&a(),Promise.resolve();maxkir.CommentsAll.mark_shown(this.task_id,!0),maxkir.NotesState.on_expand(this.task_id);if(!this.element){var c=document.createElement("ul");c.className="comments",this.element=c,$("core_"+this.task_id)&&($("core_"+this.task_id).insert({after:c}),c.on("dblclick","div.coreNote",function(a){maxkir.cmd.edit_task_or_note()}.bind(this)))}return $("core_"+this.task_id)?(this.update_task_line(),this.render_comments().then(a||function(){})):Promise.reject()},update_task_line:function(){this.model.update_line()},has_content:function(){return this.model.has_content()},set_counter_visible:function(a){if(!this.note_link())return;a=a&&(this.has_content()||this.is_visible()),a?this.note_link().removeClassName("hidden"):this.note_link().addClassName("hidden")},create_comment:function(a){if(this._adding)return;return this._adding=!0,this.add_button()&&(this.add_button().value="Adding ...",this.add_button().disable()),new maxkir.AjaxCommand(a.action,{evalScripts:!0,method:"post",parameters:Form.serialize(a),onSuccess:function(){this.reset_comments_cache(),maxkir.Comments.enable_notifications(),this.show_notes_and_select("li.comment:last")}.bind(this),onComplete:function(){this._adding=!1}.bind(this)}),!1},show_notes_and_select:function(a,b){this.show_notes(function(){var c=$("task_"+this.task_id).down(a);c&&c.id&&maxkir.tree_nav.set_selection(c.id),b&&b()}.bind(this),!0)},clear_notes:function(){var a=this.task_id;new maxkir.AjaxCommand(this.comments_path(),{method:"delete",onComplete:function(b){b.request.success()?(maxkir.Comments.enable_notifications(),this.hide_notes(),maxkir.Task.updateTask(a)):maxkir.error("Could not delete notes")}.bind(this)})},delete_comment:function(a){this.reset_comments_cache(),maxkir.Comments.delete_helper(this.task_id,this.comments_path()+"/"+a)},edit_comment:function(a){if(!this.is_editable(a)){new maxkir.ui.Message("You can edit only your own notes");return}maxkir.CommentEditorsData[this.task_id][a]&&(this.reset_comments_cache(),this.hide_add(),maxkir.tree_nav.hide_selection(),maxkir.CommentEditorsData[this.task_id][a].enterEditMode())},dispose_editors:function(){for(var a in maxkir.CommentEditorsData[this.task_id])maxkir.CommentEditorsData[this.task_id][a].dispose();maxkir.CommentEditorsData[this.task_id]={}},render_comments:function(){return this.editable_comments_map={},this.load_comments().then(function(){this.update_task_line(),this.render_comments_from_cache(),this.toggleAdd(!this.has_content())}.bind(this))},load_comments:function(){const a=this;return this._comments_cache?Promise.resolve(this._comments_cache):new Promise(function(b,c){new maxkir.AjaxRequest(a.comments_path()+".json",{method:"get",onComplete:function(d){if(d.request.success())try{a.update_comments_cache(d.responseJSON),b(a._comments_cache)}catch(e){c(e)}else c(new Error("Loading comments problem for "+a.comments_path()))}})})},comments_path:function(){return"/checklists/"+this.checklist_id+"/tasks/"+this.task_id+"/comments"},is_adding:function(){return this._editing},reset_comments_cache:function(){this._comments_cache=null},update_comments_cache:function(a){this._comments_cache=a;var b=maxkir.Task.data(this.task_id);b&&(b.comments_count=this._comments_cache.length)},comments_cache:function(){return this._comments_cache},render_comments_from_cache:function(){var a;if(this.element&&maxkir.CommentsRenderer){var b="";for(a=0;a<this._comments_cache.length;a++)b+=maxkir.CommentsRenderer.render(this._comments_cache[a]);maxkir.Task.writable_or_assignee(this.task_id)&&(b+=maxkir.CommentsRenderer.render_add({task_id:this.task_id,action:this.comments_path()})),this.element.innerHTML=b,maxkir.CommentsRenderer.post_render_comment_add(this.task_id);for(a=0;a<this._comments_cache.length;a++)maxkir.CommentsRenderer.post_render_comment(this._comments_cache[a],!a)}},is_editable:function(a){return this.editable_comments_map[a]},hide_add:function(){this.toggleAdd(!1)},add_button:function(){return $("add_note_submit_"+this.task_id)},show_add_note:function(){this.show_notes(function(){this.show_add()}.bind(this))},show_add:function(){if(!maxkir.Task.writable_or_assignee(this.task_id))return;this.add_button()&&(this.add_button().value="Add Note",this.add_button().enable()),this.toggleAdd(!0)},cancel_add:function(){this.has_content()?this.hide_add():this.hide_notes()},toggleAdd:function(a){maxkir.Task.writable_or_assignee(this.task_id)||(a=!1),this._editing=a,$("add_comment_"+this.task_id)&&$("add_comment_"+this.task_id).classList[a?"remove":"add"]("hiddenComment");if(a){if(!maxkir.EditTracker.is_editing()){maxkir.EditTracker.start_editing("add_comment_"+this.task_id);var b=this.cancel_add.bind(this),c=$("add_comment_text_"+this.task_id);c&&(this.maxkir_textarea||(this.shortcuts=maxkir.ui.EditorShortcuts(c,this.checklist_id),this.maxkir_textarea=new maxkir.ui.Textarea(c,{max_width:null,onCancel:function(a){b(),Event.stop(a)},onSubmit:function(){c.value.blank()?b():maxkir.notes(this.task_id).create_comment(c.form)}.bind(this),onEscUndo:function(a){this.show_notes(function(){this.show_add(),$("add_comment_text_"+this.task_id).value=a}.bind(this))}.bind(this)})),this.maxkir_textarea.start(),this.maxkir_textarea.prepare_submit_and_cancel())}}else maxkir.EditTracker.stop_editing("add_comment_"+this.task_id),this.maxkir_textarea&&(this.shortcuts.dispose(),delete this.shortcuts,this.maxkir_textarea.dispose(),delete this.maxkir_textarea);this.set_counter_visible(!0)},create_comment_editor:function(a){this.editable_comments_map[a]=!0;var b=this,c,d=new maxkir.ui.InplaceEditor("commentText"+a,"/checklists/"+this.checklist_id+"/tasks/"+this.task_id+"/comments/"+a,{paramName:"comment[comment]",fieldPostCreation:"focus",no_dblclick:!0,onEscUndo:function(c){this.esc_undo(maxkir.CommentEditorsData[b.task_id][a],c)},onEnterEditMode:function(a){setTimeout(function(){c=maxkir.ui.EditorShortcuts(a.editField,b.checklist_id),maxkir.set_selection_textarea(a.editField,0,a.editField.value.length)},20)},onLeaveEditMode:function(a){c&&(c.dispose(),c=null)}},{method:"PUT",onSuccess:maxkir.Comments.enable_notifications});return d.getText=function(){return this.element.to_edit},d.updateOnSaving=function(a,b){a.innerHTML=maxkir.format_for_rendering(b)},d.updateOnComplete=function(a){var b=last_updated_note;a.to_edit=b,a.innerHTML=maxkir.format_for_rendering(b,this.checklist_id)}.bind(this),d.leaveEditMode=function(){var a=d._editing;maxkir.ui.InplaceEditor.prototype.leaveEditMode.call(this),a&&!maxkir.EditTracker.is_editing()&&maxkir.tree_nav.show_selection()},maxkir.CommentEditorsData[this.task_id][a]=d,d}}),maxkir.CommentsAll={_visible:{},reset:function(){this._visible={}},toggle:function(){this.expand_all(!this.has_shown())},has_shown:function(){for(var a in this._visible)if(this._visible.hasOwnProperty(a))return!0;return!1},is_visible:function(a){return this._visible[a]},mark_shown:function(a,b){b?this._visible[a]=!0:delete this._visible[a]},expand_all:function(a){maxkir.Task.foreach(function(b){var c=maxkir.notes(b.id);c.has_content&&c.task_id&&c.has_content()&&c[a?"show_notes":"hide_notes"]()}),this.updateNotesLink()},updateNotesLink:function(){var a=$("toggle_notes");if(!a)return;this.has_shown()?(a.innerHTML=a.innerHTML.gsub("Show","Hide"),a.title=a.title.gsub("Show","Hide")):(a.innerHTML=a.innerHTML.gsub("Hide","Show"),a.title=a.title.gsub("Hide","Show"))}},maxkir.CommentEditorsData={},maxkir.Comments.enable_notifications=function(){maxkir.Notifications&&maxkir.Notifications.enable()},maxkir.Comments.highlight_comment=function(a,b,c){c&&maxkir.tree_nav.set_selection("task_"+a),maxkir.notes(a).show_notes(function(){c?(maxkir.scrollTo2("note"+b,100,$("note"+b).offsetHeight+100,!1),maxkir.highlight_frame("note"+b)):(maxkir.ChecklistNodeToggle.expand(a),maxkir.HighlightElements.addHighlighting("note"+b),$("note"+b)&&$("note"+b).addClassName("highlight"))})},maxkir.Comments.delete_helper=function(a,b){maxkir.CommandProcessor.flushDelayedQueue();var c=maxkir.tree_nav.get_all_selection();new maxkir.AjaxCommand(b,{method:"delete",onComplete:function(b){if(b.request.success()){maxkir.Comments.enable_notifications();var d=maxkir.notes(a);d.has_content()?c.forEach(function(a){$(a)&&$(a).remove()}):d.hide_notes(),maxkir.Task.updateTask(a),maxkir.tree_nav.fix_selection()}else maxkir.error("Could not delete: "+b.responseText)}.bind(this)})},maxkir.NotesState={_expanded:{},reset:function(){this._expanded={},maxkir.Comments._cache={}},skip_remember_state:function(a){this._noop=!0,a(),this._noop=!1},on_expand:function(a){if(this._noop)return;if(!a)throw new Error("No task_id");this._expanded[a]=!0},on_collapse:function(a){if(this._noop)return;if(!a)throw new Error("No task_id");delete this._expanded[a]},restore_state:function(a){var b=0;for(var c in this._expanded)this._expanded.hasOwnProperty(c)&&(b++,delete this._expanded[c],maxkir.notes(c).show_notes(function(){b--,b==0&&a()}));b==0&&a()}},maxkir.onDom(function(){var a=document.location.href,b=a.match(/#note(\d+)_(\d+)/);b&&b.length==3&&maxkir.with_element("task_"+b[1],function(){setTimeout(function(){maxkir.Comments.highlight_comment(b[1],b[2],!0)},100)})}),maxkir.CommentsRenderer={eval_template:function(a){return this._template||(this._template=new Template($("_comment_template").innerHTML)),this._template.evaluate(a)},render:function(a){var b=maxkir.format_for_rendering(a.comment,maxkir.Task.checklist_id(a.task_id));return maxkir.Search&&(b=maxkir.Search.highlight_text(b)),maxkir.FindFilter&&(b=maxkir.FindFilter.highlight_text(b)),this.eval_template({id:a.id,time:maxkir.format_time(a.updated_at,!0),comment:b,comment_user:maxkir.escapeHtml(maxkir.CommonRender.user_short_name(a.username)),user_gravatar:maxkir.user.gravatar_img(a)})},render_add:function(a){return(new Template($("_comment_template_add").innerHTML)).evaluate(a)},post_render_comment:function(a,b){a.user_id==maxkir.current_user_id&&($("commentText"+a.id).to_edit=a.comment,maxkir.notes(a.task_id).create_comment_editor(a.id));if(b&&maxkir.Task.from_email(a.task_id)){var c=$("note"+a.id).select(".authorPic")[0];c.title=I18N("email_body_tooltip"),c.innerHTML='<i class="icon-comment-alt"></i>';var d=$("note"+a.id).select(".noteNameDate")[0];d.innerHTML=I18N("emailed_in")+" "+maxkir.format_time(a.updated_at,!0)}},post_render_comment_add:function(a){this.update_uploads_list(a)},update_uploads_list:function(a){var b=$("task_"+a),c=b.down(" > ul.attachments"),d=maxkir.TaskData[a].uploads;if(!d||d.length==0)maxkir.remove_element(c);else{var e=maxkir.UploadsRenderer.render_uploads(a,d);if(c)c.update(e.innerHTML);else{var f=b.down(" > ul.comments");f.insert({before:e}),f.addClassName("commentsBeforeAttachments"),c=e}maxkir.UploadsRenderer.init_uploads_under(c)}}},maxkir.CommentsLoader={preload_all_comments:function(){var a=[];return maxkir.checklist_id?a.push(this.preload_list_comments(maxkir.checklist_id)):maxkir.Task.foreach(function(b){b.comments_count>0&&a.push(maxkir.notes(b.id).load_comments())}),Promise.all(a)},preload_list_comments:function(a){return this.load_list_comments(a).then(function(a){var b=[],c=0;for(var d=0;d<a.length;d++){var e=a[d];e.task_id!==c&&(this.set_comments_cache(c,b),c=e.task_id,b=[]),b.push(e)}this.set_comments_cache(c,b)}.bind(this))},set_comments_cache:function(a,b){a&&maxkir.notes(a).update_comments_cache(b)},load_list_comments:function(a){return new Promise(function(b,c){new maxkir.AjaxRequest("/checklists/"+a+"/comments.json",{method:"get",onComplete:function(a){a.request.success()?b(a.responseJSON):c()}})})}},maxkir.NodeToggler=function(a){var b=function(){return a?a:maxkir.tree_model};return{install_via_selector:function(a,b,c){maxkir.debug("Installing collapse/expand handler on "+a.id+" with CSS selector "+b);var d=function(a){var b=!this.isCollapsed(a);b?(this.collapseNode(a),typeof c=="function"&&c(a,!1)):(this.expandNode(a),typeof c=="function"&&c(a,!0))}.bind(this);return a.on("click",b,function(a,b){var c=b.id.substr("handle_".length);d(c),Event.stop(a)})},dispose:function(){},restoreTreeState:function(a,b){this._state=a,this._state.restoreTreeState(b)},expandNode:function(a){if(this.isCollapsed(a)){var b=this.handle(a);if(b){b.classList.remove("node_collapsed");var c=document.getElementById(a);c.classList.replace("node_collapsed","node_expanded");var d=c.querySelector(this.ulSelector());return d&&d.classList.remove("hidden"),this._state&&this._state.setStateExpanded(a,!0),this.onExpand(a),!0}}},ulSelector:function(){return"ul"},collapseNode:function(a){if(this.isCollapsed(a))return;var b=this.handle(a);if(b){b.classList.add("node_collapsed");var c=document.getElementById(a);c.classList.replace("node_expanded","node_collapsed");var d=c.querySelector(this.ulSelector());return d&&d.classList.add("hidden"),this._state&&this._state.setStateExpanded(a,!1),this.onCollapse(a),!0}},onExpand:function(a){},onCollapse:function(a){},isCollapsed:function(a){var b=this.handle(a);return b&&b.classList.contains("node_collapsed")},handle:function(a){return document.getElementById("handle_"+a)},collapse_all:function(){this._affected_node_ids=[],this.collapse_deep(b().getRoot())},expand_all:function(a){if(typeof a=="undefined"||isNaN(parseInt(a)))a=1e3;this._affected_node_ids=[],this.expand_deep(b().getRoot(),a)},collapse_branch:function(a){this._affected_node_ids=[],this.collapse_deep(a),this.collapseNode(a)},expand_branch:function(a){this._affected_node_ids=[],this.expandNode(a),this.expand_deep(a)},expand_deep:function(a,c){if(c==0)return;c=c-1,this.expandNode(a)&&this._affected_node_ids.push(a);var d=b().getNodes(a);for(var e=0;e<d.length;e++)this.expand_deep(d[e],c)},collapse_deep:function(a){var c=b().getNodes(a,!0);for(var d=0;d<c.length;d++)this.collapse_deep(c[d]);a!==b().getRoot()&&this.collapseNode(a)&&this._affected_node_ids.push(a)}}},maxkir.NodeToggle=maxkir.NodeToggler(),maxkir.TreeState=function(a){this.tree_name=a,this.expandedNodes=this.loadState(this.tree_name+"expanded"),this.collapsedNodes=this.loadState(this.tree_name+"collapsed")},Object.extend(maxkir.TreeState.prototype,{restoreTreeState:function(a){a.foreach(function(b){a.isLeaf(b)||(this.expandedNodes[b]?maxkir.NodeToggle.expandNode(b):this.collapsedNodes[b]&&maxkir.NodeToggle.collapseNode(b))}.bind(this))},setStateExpanded:function(a,b){b?this.expandedNodes[a]||(this.expandedNodes[a]=!0,delete this.collapsedNodes[a],this.saveAll()):this.collapsedNodes[a]||(this.collapsedNodes[a]=!0,delete this.expandedNodes[a],this.saveAll())},saveAll:function(){this.save(this.tree_name+"expanded",this.expandedNodes),this.save(this.tree_name+"collapsed",this.collapsedNodes)},save:function(a,b){var c=$H(b).keys().join(",");localStorage.setItem(a,c)},loadState:function(a){var b={},c=localStorage.getItem(a);return c&&$A(c.split(",")).each(function(a){b[a]=!0}),b}}),maxkir.CompleterUtil={getCustomTokenBoundsViaRegexp:function(a,b,c,d){var e=a.value.substr(0,b[0]),f=c.exec(e);if(f){var g=a.value.substr(b[0]),h=d.exec(g);return[b[0]-f[0].length,b[0]+(h?h[0].length:0)]}return null},getCustomTokenBoundsViaRegexp2:function(a,b,c){var d=b[0],e=this.getAllTokensBounds(a,c);for(var f=0;f<e.length;f++){var g=e[f];if(g[0]<=d&&g[1]>d)return g}return null},getAllTokensBounds:function(a,b){var c=[];b.lastIndex=0;var d;while((d=b.exec(a))!=null)c.push([d.index,d.index+d[0].length]);return c},f_:null},maxkir.UploadCompleter={IMG_REG_OLD:/()\[?(?:\b|^)img: ?([^\s\]]*)]?/g,IMG_REG_NEW:/!\[([^\]]*)]?\(?([^)]*)\)?/g,getCustomTokenBounds:function(a,b){var c;return c=maxkir.CompleterUtil.getCustomTokenBoundsViaRegexp2(a.value,b,this.IMG_REG_OLD),c!=null?c:(c=maxkir.CompleterUtil.getCustomTokenBoundsViaRegexp2(a.value,b,this.IMG_REG_NEW),c!=null?c:null)},matches:function(a){return this.IMG_REG_OLD.lastIndex=0,this.IMG_REG_NEW.lastIndex=0,this.IMG_REG_OLD.exec(a)||this.IMG_REG_NEW.exec(a)},createFilteredItemsString:function(a,b,c,d){var e=this.matches(b);maxkir.debug("Uploads: createFilteredItemsString for token '"+b+"', match: "+e+", selection: "+c);var f=function(){var b=[];if(e){var f=a.up("li"),g=maxkir.Task.id(f?f.id:"");this.saved_task_id=g;var h=maxkir.Task.data(g),i=h&&h.uploads||[],j=a.value.substring(d.getTokenBounds()[0],c[0]),k=this.matches(j),l=k&&k[2].trim()||"";maxkir.debug("File prefix: '"+l+"' for token "+j);for(var n=0;n<i.length;n++)if(maxkir.UploadShared.is_img(i[n])&&i[n].the_file_name.indexOf(l)>=0){var o=e[1];b.push("<li>"+this.createImageText(i[n],o)+"</li>")}else maxkir.debug("No file match: "+l);maxkir.is_pro&&b.push("<li id='upload_file_item'>Upload a file</li>")}return maxkir.debug("Upload items:"),maxkir.debug(b),b.join("")}.bind(this);return d.active||e?f():""},createImageText:function(a,b){return"!["+b+"]("+a.the_file_name+")"},updateElement:function(a){if(!a)return;if(a.id=="upload_file_item"){var b=this.saved_task_id;if(!b&&maxkir.add_task.is_adding()){var c=new maxkir.InplaceCompletionFileUploader(0,$("add_task").up("li"),[],maxkir.get_selection_range($("task_content")));maxkir.add_task.create_task(!1,function(a){c.set_task_id(a)})}else{var d=maxkir.Task._editors[b];d&&new maxkir.InplaceCompletionFileUploader(b,$("core_"+b),this.get_existing_uploads(b),maxkir.get_selection_range(d.editField))}return!0}},get_existing_uploads:function(a){var b={},c=maxkir.Task.data(a).uploads||[];for(var d=0;d<c.length;d++)b[c[d].uuid]=c[d];return b}},maxkir.InplaceCompletionFileUploader=function(a,b,c,d){this.task_id=a,this.existing_upload_uuids=c,this.previous_position=d,this.uploader=maxkir.Uploads.init_upload_with_img_completion(a,b,this.after_upload_hook.bind(this))},Object.extend(maxkir.InplaceCompletionFileUploader.prototype,{set_task_id:function(a){this.task_id=a,this.uploader._handler._options.action=maxkir.Uploads.upload_action_str(a),this.uploader._options.task_id=a,maxkir.info("Uploader task id is set to "+a)},after_upload_hook:function(){maxkir.notes(this.task_id).hide_notes(),setTimeout(function(){maxkir.Task.edit_task(this.task_id);var a=maxkir.Task._editors[this.task_id];maxkir.set_selection_textarea(a.editField,this.previous_position[0],0);var b=this.text_to_insert();if(b!=""){this.img_is_at_the_line_start(a.editField.value.substr(0,this.previous_position[0]))||(b="\n"+b);var c=maxkir.DataCompleter.get_completer(a.editField);c.replaceTokenWith(b)}}.bind(this),300)},text_to_insert:function(){var a=maxkir.Task.data(this.task_id).uploads||[],b="";for(var c=0;c<a.length;c++)maxkir.UploadShared.is_img(a[c])&&!this.existing_upload_uuids[a[c].uuid]&&(b+=maxkir.UploadCompleter.createImageText(a[c],"")+"\n");return b},img_is_at_the_line_start:function(a){return/(^|\n)\s*!\[/.test(a)}}),maxkir.ListCompleter={getCustomTokenBounds:function(a,b){return maxkir.CompleterUtil.getCustomTokenBoundsViaRegexp(a,b,/\[list:[^\]]*$/,/^.*\]/)},onUpdateChoices:function(a,b,c,d){var e=a.value.substr(0,c[0]);/(lst:|\[list:|\[list:.*\|)$/.exec(e)&&this.invoke(a)},invoke:function(a){(new maxkir.ui.LinkListTo(a)).invoke()},_f:null},maxkir.ui.LinkListTo=function(a){this.input=a,this.doOpen=function(a){var b=a.id.substr("popup_checklist_".length);this._processOpen(b)}.bind(this),this.checklist_id=maxkir.checklist_id},Object.extend(maxkir.ui.LinkListTo.prototype,maxkir.ui.BaseChecklistPopup),Object.extend(maxkir.ui.LinkListTo.prototype,{LIST_TEMPLATE:new Template("[list: #{name}|#{id}]"),invoke:function(){this.show_popup(this.input)},onRebuildList:function(){$$("#clParent li a").invoke("stopObserving"),this.updateListForCompletion(),maxkir.ui.BaseListPopup.onRebuildList.call(this),this.tree_nav&&(this.no_match()?this.popupFilter().addClassName("highlight"):this.popupFilter().removeClassName("highlight"))},onShow:function(){this.input._ignoreBlur=!0,this.repositionForTextarea(this.input),this.updateListForCompletion(),this.popupFilter().placeholder=this.popupFilter().title,this.popupFilter().setStyle({marginTop:"10px"}),this.ul_element().setStyle({maxHeight:"150px"}),this.focusWatcher=new maxkir.FocusWatcher([this.popupFilter()],{onBlur:function(){maxkir.info("no focus in lst: pupup, hiding"),this.hide_popup()}.bind(this)}),this.scrollToShow()},updateListForCompletion:function(){this.win.getContent().select("li.specialItem,#popup_checklist_"+this.checklist_id).each(function(a){a.remove()}),$$("#clParent li").each(function(a){var b=a.id.substr("popup_checklist_".length);b>0&&(a.down("a").onclick=function(){return this._processOpen(b),!1}.bind(this),this.win.addDisposerOnClose(function(){a.down("a").onclick=null,a.down("a").stopObserving()}))},this)},_processOpen:function(a){if(a>0){var b=maxkir.DataCompleter.get_completer(this.input),c=maxkir.Lists.data(a);b.replaceTokenWith(this.LIST_TEMPLATE.evaluate(c))}this.hide_popup()},onHide:function(){this.focusWatcher.dispose(),maxkir.ui.BaseChecklistPopup.onHide.call(this),this.input._ignoreBlur=!1,this.input.focus(),$$("#clParent li a").invoke("stopObserving")},onEnterWithoutMatch:function(a,b){Event.stop(a)},_f:null}),maxkir.LinkCompleter={getCustomTokenBounds:function(a,b){return maxkir.CompleterUtil.getCustomTokenBoundsViaRegexp(a,b,/\[link:[^\]]*$/,/^.*\]/)},onUpdateChoices:function(a,b,c,d){var e=a.value.substr(0,c[0]),f=/(lnk:|\[link:)$/.exec(e);f&&this.invoke(a,f)},invoke:function(a,b){maxkir.ui.LinkTo.invoke_on_match(a,b)},f_:null},maxkir.ui.LinkTo=maxkir.ui.create_popup(!1,{popup_width:400,LINK_TEMPLATE:new Template("[link: #{text}|#{url}]"),invoke_on_match:function(a,b){var c=a.value.substr(b.index),d=(new RegExp(maxkir.CommonRender.LNKREG.source)).exec(c);d&&d.index==0?this.invoke(a,d[2].trim(),d[3].trim(),"Edit link",[b.index,b.index+d[0].length]):this.invoke(a,"","","Add link",[b.index,b.index+b[0].length])},invoke:function(a,b,c,d,e){c||(c=maxkir.get_flag("last_task_copy")||""),this.show_popup(a,{popup_title:d,link_text:b,link_url:c,range_to_replace:e})},refresh:function(){this.win.setHTMLContent((new Template($("_linkToPopup").innerHTML)).evaluate
(this.options))},onShow:function(){this.anchor_element._ignoreBlur=!0,this.repositionForTextarea(this.anchor_element),this.options.link_url||this.win.getContent().down(".removeLink").hide(),this.initFocusWatcher(),this.scrollToShow()},initFocusWatcher:function(){var a=this.win.getContent().select(".linkPopupInput");a=a.concat(this.win.getContent().select(".submit")),a[0].activate()},onRemoveLink:function(){var a=$F("linkText").trim();return this.updateTextAndClose(a),!1},onDone:function(){var a=$F("linkText").trim(),b=$F("linkUrl").trim(),c=!1;a==""&&(new maxkir.ui.Message("Link text should not be empty"),c=!0);if(b=="")return this.onRemoveLink(),!1;!b.startsWith("/")&&b.indexOf("://")<0&&(b="http://"+b);if(!c){var d=this.LINK_TEMPLATE.evaluate({text:a,url:b});b===maxkir.get_flag("last_task_copy")&&maxkir.set_flag("last_task_copy",null),this.updateTextAndClose(d)}return!1},updateTextAndClose:function(a){maxkir.replace_range(this.anchor_element,this.options.range_to_replace,a),maxkir.set_selection_range(this.anchor_element,[this.options.range_to_replace[0],this.options.range_to_replace[0]+a.length]),this.hide_popup()},onHide:function(){this.anchor_element._ignoreBlur=!1,this.anchor_element.focus()}}),maxkir.AbstractOption=function(a,b){this._key=a,this._cssClass=b,this._on=localStorage.getItem("option_"+a)||!1},maxkir.extend(maxkir.AbstractOption,{on:function(){return this._on},toggle:function(){this._on=!this._on,this.set_value(this._on,!0)},set_value:function(a,b){a=!!a,this._on=a,this.repaintTree(this._on),b&&this.save_state(this.on())},restore_state:function(){this.repaintTree(this.on())},save_state:function(){this.on()?localStorage.setItem("option_"+this._key,this.on()):localStorage.removeItem("option_"+this._key)},repaintTree:function(a){if(typeof a=="undefined"){this.set_value(this._on);return}var b=$("tasks_block");b&&b[this.on()?"addClassName":"removeClassName"](this._cssClass)}}),maxkir.ShowContextOption=new maxkir.AbstractOption("show_context","showContextUnder"),maxkir.OpenNewTabOption=new maxkir.AbstractOption("open_new_tab","openNewTab"),maxkir.OpenNewTabOption.repaintTree=function(a){maxkir.AbstractOption.prototype.repaintTree.apply(this,arguments),maxkir.DueList&&maxkir.DueList.rerender()},maxkir.GroupByListOption=new maxkir.AbstractOption("group_by_list","groupedByList"),maxkir.GroupByListOption.repaintTree=function(a){maxkir.AbstractOption.prototype.repaintTree.apply(this,arguments),maxkir.DueList&&maxkir.DueList.rerender()},maxkir.GroupByListOption.on=function(){return maxkir.DueList?maxkir.AbstractOption.prototype.on.apply(this,arguments):!0},maxkir.DetailsMode=new maxkir.AbstractOption("dtl","showDetails"),Object.extend(maxkir.DetailsMode,{show_details:function(a,b){this.set_value(a,b)},install_kbd:function(){if(navigator.appVersion.indexOf("Win")>=0)return;var a=this;document.observe("keydown",function(b){b.keyCode==17&&!a.on()?a.startShowDetails():a.interruptShowDetails()}),document.observe("keyup",function(b){b.keyCode==17&&!a.on()&&a.repaintTree(!1),a.interruptShowDetails()}),Event.observe(window,"blur",function(){a.on()||a.repaintTree(!1),a.interruptShowDetails()})},startShowDetails:function(){this.interruptShowDetails(),this._timeout=setTimeout(function(){this._timeout=null,this.repaintTree(!0)}.bind(this),2e3)},interruptShowDetails:function(){this._timeout&&(clearTimeout(this._timeout),this._timeout=null)}}),maxkir.init_due_search_options=function(){maxkir.DetailsMode.restore_state(),maxkir.DetailsMode.install_kbd(),maxkir.ShowContextOption.restore_state(),maxkir.GroupByListOption.restore_state()},maxkir.BaseHideCompleted={is_hide:function(){return this._hide_completed},set_hide:function(a){this._hide_completed=a;var b=document.querySelector(".toolBar_hideCompleted");b&&(b.style.display=a?"":"none")},toggle_hide:function(){this.set_hide(!this.is_hide())},is_hidden:function(a){var b=maxkir.Task.data(a);return this.is_hide()&&b&&b.status},update_visibility:function(a){var b=$("task_"+a);if(!b)return;this.is_hidden(a)?b.addClassName("hidden"):b.removeClassName("hidden")},f:null},maxkir.Tags=function(){var a=function(a,b,c){var d=null;b!==null&&(d=maxkir.Tags.parse_line(b)),a.forEach(function e(b){var e=maxkir.Task.data(b);if(!e)return;if(d){if(a.length===1||d.length===0)e.tags={};d.each(function(a){var b=maxkir.Tags.findOrCreate(a);e.tags[b.tag]=!!b["private"]})}c&&delete e.tags[c],maxkir.Task.updateTask(b),maxkir.ProgressCounter.on_task_updated(e)})},b={},c=0;return{data:{},find:function(a){if(a>0)return this.data[a];for(var c in this.data)if(a==this.data[c].tag)return this.data[c];for(c in b)if(a==b[c].tag||a==c)return b[c];return null},findOrCreate:function(a){var d=this.find(a);if(d!=null)return d;var e="fake_tag_id"+c++;return b[e]={id:e,color:0,tag:a,"private":!1},b[e]},parse_line:function(a){var b=a.split(/[#\s]+/);return b.remove(""),$A(b)},set_tags:function(b,c){this._update_task_bulk(b,"tags="+encodeURIComponent(c),function(){a(b,c,null)})},delete_tag_usages:function(b,c){this._update_task_bulk(b,"delete_tag="+encodeURIComponent(c),function(){a(b,null,c)})},_update_task_bulk:function(a,b,c){if(!a.length)return;c(),new maxkir.AjaxCommand("/checklists/"+maxkir.Task.checklist_id(a[0])+"/tasks/"+a[0]+"/tags.js",{parameters:b+"&task_ids="+a.join(","),onSuccess:function(){maxkir.Notifications&&maxkir.Notifications.enable(),maxkir.ProgressCounter.on_task_updated(maxkir.Task.data(a[0])),maxkir.FindFilter.show_refresh_hint_if_needed(a)}})},set_list_tags:function(a,b){var c="";a.each(function(a){c+="checklists_set[]="+a+"&"}),new maxkir.AjaxCommand("/checklists/tags.js",{parameters:c+"tag_line="+encodeURIComponent(b),onComplete:function(){var b=$$(".listSection");b.each(function(a){maxkir.visible(a)&&a.list_index&&a.list_index.show_list()}),a.each(function(a){maxkir.ChecklistRenderer.updateListNode(a)})}})},delete_tag:function(a,b){var c=maxkir.checklist_id?"checklist_id="+maxkir.checklist_id+"&":"";c+=b?"force=true":"",new maxkir.AjaxCommand("/tags/"+a,{parameters:c,method:"delete",onComplete:function(){maxkir.TagManage.hide_popup(),a=="all_unused"&&this.full_reload_page()}.bind(this)})},full_reload_page:function(){maxkir.Tags.data={},maxkir.TagManage.hide_popup(),maxkir.checklist&&maxkir.checklist_id&&maxkir.checklist.refresh(),$$(".ajax_loaded_section").each(function(a){maxkir.visible(a)?maxkir.ajax_reload_block(a.identify()):$(a).loaded=!1})},_end:!1}}(),maxkir.TagList={_show_public:!0,_show_private:!0,_filter:"",show:function(){if(!this._sort_func){if(maxkir.UserPrefs&&maxkir.UserPrefs.tag_sorting){var a=maxkir.UserPrefs.tag_sorting.split("_");this.resort(a[0]=="true",a[1]=="true");return}this._sort_func=maxkir.TagSortFunction(!0,!1)}this.show_list(this._sort_func),$("tag_name_filter").focus()},change_visibility:function(a,b,c,d){this._show_private=c,this._show_public=b,this._show_time=d,this.show(),maxkir.TagList.switch_tab(["view_all","view_public","view_private","view_time"],a)},resort:function(a,b){this._sort_func=maxkir.TagSortFunction(a,b),maxkir.user.set_user_prefs("tag_sorting",!!a+"_"+!!b),this.show()},switch_tab:function(a,b){$A(a).each(function(a){$(a).removeClassName("selected")}),$(b).addClassName("selected")},show_list:function(a){var b=Object.keys(maxkir.Tags.data);b.sort(a),this._has_visible_tag=!1,this._no_data=!0,this._unused=!1,$("tags_container").update(this.build_html(this.select_data_to_show(b))),this._unused=!0;var c=this.select_data_to_show(b);$("unused")[c.size()>0?"show":"hide"](),$("delete_all_unused")[c.size()>1?"show":"hide"](),$("unused_container").update(this.build_html(c)),this.show_no_pro_block_if_needed()},show_no_pro_block_if_needed:function(){$("tagsPrivateNoPro").hide(),$("tagsPrivateEmpty").hide(),$("tagsTimeEmpty").hide(),$("tagsAllFilteredOut").hide();var a=this._show_public&&this._show_private;!maxkir.is_pro&&this._show_private&&!a?$("tagsPrivateNoPro").show():this._show_time&&!a?this._no_data&&$("tagsTimeEmpty").show():this._no_data&&$("tagsPrivateEmpty").show(),!this._no_data&&!this._has_visible_tag&&$("tagsAllFilteredOut").show()},select_data_to_show:function(a){var b=[],c=function(a){(this._filter==""||a.tag.toUpperCase().indexOf(this._filter.toUpperCase())==0)&&a.usage_count>0^this._unused&&(b.push(a),this._has_visible_tag=!0),this._no_data=!1}.bind(this);for(var d=0;d<a.length;d++){var e=maxkir.Tags.data[a[d]],f=maxkir.ProgressCounter.time_tag(e.tag);f?this._show_time&&c(e):(e.private&&this._show_private||!e.private&&this._show_public)&&c(e)}return b},build_html:function(a){var b="<tbody><tr>",c=/widget=true/.test(document.location.href)?2:3,d=a.length,e=5;while(e*c<d)e++;var f=0;maxkir.TagRenderer.title_text=function(){return"Click to see tag usages"};while(f<a.length){b+="<td>";for(var g=0;g<e;g++){if(f>=a.length)break;var h=a[f],i="maxkir.TagManage.show_popup($(this.parentNode).down('.tag'), {x_shift: -20, tag: '"+h.tag+"', handle: this})",j="document.location.href='"+this.search_url(h.tag)+"';",k="tagClass_"+h.color;b+="<div class='oneTagInList'><span class='handle "+k+"' onclick=\""+i+"\">&nbsp;</span><span class='tBlock'>"+maxkir.TagRenderer.getHtml(h,h.private,j,!0)+this.usage_count(h.usage_count,h.tag,h.id)+"</span></div>",f++}b+="</td>"}return b+="</tr></tbody>",b},usage_count:function(a,b,c){return a>0?"<a class='usageCount' title='Click to see usages' href='"+this.search_url(b)+"'> x "+a+" </a>":"<a class='deleteTag' title='Delete unused tag' onclick=\"maxkir.confirm(this, 'Delete?', 'maxkir.Tags.delete_tag("+c+")'); return false;\">X</a>"},search_url:function(a){return"/search?what="+encodeURIComponent("#"+a)},delete_all_unused:function(a){maxkir.confirm(a,"Delete all unused tags?",'maxkir.Tags.delete_tag("all_unused")')},update_name_filter:function(){setTimeout(function(){this._filter=$("tag_name_filter").value.trim(),this.show()}.bind(this),10)}},maxkir.ui.TagsSortPopup=maxkir.ui.create_sort_popup({getCurrentId:function(a){var b=(maxkir.UserPrefs.tag_sorting||"").split("_");return b[0]=="false"&&b[1]=="true"?"az":b[0]=="false"&&b[1]=="false"?"za":"mostPopular"},getSettings:function(){return[{sortId:"mostPopular",name:I18N("sort.most_popular"),switchTo:function(a,b,c){maxkir.TagList.resort(!0,!1)}},{sortId:"az",name:I18N("sort.az"),switchTo:function(a,b,c){maxkir.TagList.resort(!1,!0)}},{sortId:"za",name:I18N("sort.za"),switchTo:function(a,b,c){maxkir.TagList.resort(!1,!1)}}]}}),maxkir.ui.TTagsPopup=maxkir.ui.create_popup(!0,{popup_width:280,refresh:function(){this.popupContent||(this.popupContent=new Template($("tagsPopupData").innerHTML),$("tagsPopupData").innerHTML=""),this.set_content(),this.setupSelection()},set_content:function(){var a="",b="",c="";for(var d in this.options.tags)this.options.tags.hasOwnProperty(d)&&(f=maxkir.Tags.find(d),f&&(b+=f.tag+" ",a+="#"+f.tag+" ",c+=this.tag_to_manage_li(f.tag)));var e='"'+b.trim()+'"';a==""&&(a="#",e="tag");var f=this.options.tag;f&&(a="#"+f,e='"'+f+'"',c=this.tag_to_manage_li(this.options.tag)),this.win.setHTMLContent(this.popupContent.evaluate({filter_by_text:e,filter_by:a,tags_to_edit:b,manage_items:c}))},MANAGE_TAG:new Template("<li><a href='#' onclick=\"maxkir.TagManage.show_popup(#{anchor}, {tag: '#{tag_name}'}); return false;\">#{tag_text_name}</a></li>\n"),tag_to_manage_li:function(a){var b=this.anchor_element;while(b&&b.innerHTML!=a)b=$(b.nextSibling);var c=function(a){return"$('"+a.identify()+"')"};return this.MANAGE_TAG.evaluate({tag_name:a,tag_text_name:""+I18N("tags.menu_item3")+' "'+a+'"',anchor:b!=null?c(b):this.anchor_element!=null?c(this.anchor_element):"null"})},completer_active:function(){return $("tag_input")&&$("tag_input").completer_active()},onShow:function(){this.setup_popup(),this.win.keep_on_escape=function(){return this.completer_active()}.bind(this),this.scrollToShow()},onHide:function(){this.win.keep_on_escape=null,this.dispose_popup()},setup_popup:function(){this.orig_value=$("tag_input").value,maxkir.DataCompleter.create_completer($("tag_input"),{skip_hash_in_tag_name:!0,existing_tags_map:this.options.tags});var a=$("tag_input").value.length;maxkir.set_selection($("tag_input"),a,a),setTimeout(function(){$("tag_input").focus()},100)},dispose_popup:function(){maxkir.DataCompleter.uninstall($("tag_input"))},onSelection:function(a){a=="tag_input_li"?$("tag_input").focus():($("tag_input").blur(),$("tag_input").value=this.orig_value)},doOpen:function(a){$(a).down("a")&&(maxkir.click_link($(a)),this.hide_popup());if($(a).down("input")){var b=$("tag_input").value;this.options.set_tags_call?(maxkir.debug("set_tags_call: "+b),this.options.set_tags_call(b)):alert("No set tags action specified: "+b),this.hide_popup()}},activate_by_space:function(){return!1},isEnabledKeyboard:function(){return!this.completer_active()}}),maxkir.invoke_list_tags_popup=function(a){var b={tags:{}},c=[];return a.each(function(a){var d=maxkir.Lists.data_from_id(a);d&&(c.push(d.id),d.tags&&Object.extend(b.tags,d.tags))}),c.length>0?(b.set_tags_call=function(a){maxkir.Tags.set_list_tags(c,a),maxkir.hide_bottom_bar&&maxkir.hide_bottom_bar()},maxkir.ui.TTagsPopup.show_popup(null,b),!0):!1},maxkir.ui.DeleteTagPopup=Object.extend({},maxkir.ui.BaseListPopup),Object.extend(maxkir.ui.DeleteTagPopup,{_setContent:function(a){maxkir.ui.BaseListPopup._setContent.call(this,a),$("clParent").addClassName("deleteTagList"),$("clParent").up(".dialog").addClassName("deleteTagDialog")},getListModel:function(a){var b=new maxkir.ui.ListBuilder(a),c=this._used_tags(),d=[];d.push({id:0,text:I18N("tags.clear_all_tags")});for(var e=0;e<c.length;e++){var f=c[e];d.push({id:f,text:"<b>"+maxkir.escapeHtml(f)+"</b>"})}return b.create_li=function(a,b){if(a===0)return"<li id='all_tags'>"+b.text+"</li>";var c=maxkir.TagRenderer.renderTagsByNames([a],{},"return true;",!1);return"<li id='tag tag_"+a+"' data-tag='"+a+"' >"+c+"</li>"},b.set_items(d),b},_used_tags:function(){var a=this.options.task_ids,b={};for(var c=0;c<a.length;c++){var d=maxkir.Task.data(a[c]);d&&d.tags&&Object.extend(b,d.tags)}return maxkir.TagRenderer.sort_tags(Object.keys(b))},onShow:function(){if(this._used_tags().length<2){this._used_tags().length===1&&maxkir.Tags.set_tags(this.options.task_ids,""),this.hide_popup();return}this.scrollToShow(),this.popupFilter().title="",this.popupFilter().placeholder=this.popupFilter().title},activate_by_space:function(){return!0},doOpen:function(a){if(a.id==="all_tags")maxkir.Tags.set_tags(this.options.task_ids,"");else{var b=a.getAttribute("data-tag");b&&maxkir.Tags.delete_tag_usages(this.options.task_ids,b)}this.hide_popup()}}),maxkir.TagRenderer={TAG:new Template("<span class=\"#{classes}\" title='#{title}' onclick=\"#{on_click}; Event.stop(event); return false;\" style='cursor:pointer;'>#{tag}</span>"),renderTagMap:function(a,b,c){var d=this._get_sorted_keys(a);return this.renderTagsByNames(d,a,b,c)},renderTagsByNames:function(a,b,c,d){var e="";b=b||{};for(var f=0;f<a.length;f++){var g=a[f],h=maxkir.Tags.findOrCreate(g);e+=maxkir.TagRenderer.getHtml(h,b[g],c,d)}return e},_get_sorted_keys:function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return this.sort_tags(b)},sort_tags:function(a){return a.sort(function(a,b){return a.toLowerCase().localeCompare(b.toLowerCase())})},getHtml:function(a,b,c,d){var e=a.tag;c||(c="maxkir.FindFilter.show('#"+e+"', true)"),d=d||localStorage.getItem("cv.no-tag-hash"),maxkir.ProgressCounter&&maxkir.ProgressCounter.time_tag(e)&&(d=!0,e="<i class='icon-time'></i> "+e);var f=this.TAG;return f.evaluate({classes:this.getClasses(a,b),tag:d?e:"#"+e,title:this.title_text(b),on_click:c})},updateView:function(a,b){if(!a||!a.length)return;for(var c=0;c<a.length;c++){var d=$(a[c]);d.className=this.getClasses(b,b.private),d.title=this.title_text(b.private)}},updateAllViews:function(a){this.updateView($$(".tag.tag_"+a.tag),a)},title_text:function(a){var b=a?"This tag is visible only to you":"";return b==""?b="Click to filter by tag":b+=", click to filter by tag",b},getClasses:function(a,b){var c="afterTask tag tag_"+a.tag;return b&&(c+=" privateTag"),c+=" tagClass_"+a.color,c}},maxkir.AssigneeRenderer={TEMPLATE:new Template('<a href="#" class="afterTask assignee"  title="Assigned to #{username}, click to filter by user" onclick="maxkir.FindFilter.show(\'@#{short_name_attr}\', true); return false;">@#{short_name}</a> '),getHtml:function(a){return this.TEMPLATE.evaluate({username:this.escape2Html(a.username),short_name:a.short_name(),short_name_attr:this.escape2Html(a.short_name()).replace(/'/g,"\\'")})},escape2Html:function(a){return a.escapeHTML().replace(/"/g,"&quot;")}},function(a){if(typeof exports=="object"&&typeof module!="undefined")module.exports=a();else if(typeof define=="function"&&define.amd)define([],a);else{var b;typeof window!="undefined"?b=window:typeof global!="undefined"?b=global:typeof self!="undefined"?b=self:b=this,b.Remarkable=a()}}(function(){var a,b,c;return function d(a,b,c){function e(g,h){if(!b[g]){if(!a[g]){var j=typeof require=="function"&&require;if(!h&&j)return j(g,!0);if(f)return f(g,!0);var k=new Error("Cannot find module '"+g+"'");throw k.code="MODULE_NOT_FOUND",k}var l=b[g]={exports:{}};a[g][0].call(l.exports,function(b){var c=a[g][1][b];return e(c?c:b)},l,l.exports,d,a,b,c)}return b[g].exports}var f=typeof require=="function"&&require;for(var g=0;g<c.length;g++)e(c[g]);return e}({1:[function(a,b,c){"use strict",b.exports={Aacute:"Á",aacute:"á",Abreve:"Ă",abreve:"ă",ac:"∾",acd:"∿",acE:"∾̳",Acirc:"Â",acirc:"â",acute:"´",Acy:"А",acy:"а",AElig:"Æ",aelig:"æ",af:"⁡",Afr:"𝔄",afr:"𝔞",Agrave:"À",agrave:"à",alefsym:"ℵ",aleph:"ℵ",Alpha:"Α",alpha:"α",Amacr:"Ā",amacr:"ā",amalg:"⨿",AMP:"&",amp:"&",And:"⩓",and:"∧",andand:"⩕",andd:"⩜",andslope:"⩘",andv:"⩚",ang:"∠",ange:"⦤",angle:"∠",angmsd:"∡",angmsdaa:"⦨",angmsdab:"⦩",angmsdac:"⦪",angmsdad:"⦫",angmsdae:"⦬",angmsdaf:"⦭",angmsdag:"⦮",angmsdah:"⦯",angrt:"∟",angrtvb:"⊾",angrtvbd:"⦝",angsph:"∢",angst:"Å",angzarr:"⍼",Aogon:"Ą",aogon:"ą",Aopf:"𝔸",aopf:"𝕒",ap:"≈",apacir:"⩯",apE:"⩰",ape:"≊",apid:"≋",apos:"'",ApplyFunction:"⁡",approx:"≈",approxeq:"≊",Aring:"Å",aring:"å",Ascr:"𝒜",ascr:"𝒶",Assign:"≔",ast:"*",asymp:"≈",asympeq:"≍",Atilde:"Ã",atilde:"ã",Auml:"Ä",auml:"ä",awconint:"∳",awint:"⨑",backcong:"≌",backepsilon:"϶",backprime:"‵",backsim:"∽",backsimeq:"⋍",Backslash:"∖",Barv:"⫧",barvee:"⊽",Barwed:"⌆",barwed:"⌅",barwedge:"⌅",bbrk:"⎵",bbrktbrk:"⎶",bcong:"≌",Bcy:"Б",bcy:"б",bdquo:"„",becaus:"∵",Because:"∵",because:"∵",bemptyv:"⦰",bepsi:"϶",bernou:"ℬ",Bernoullis:"ℬ",Beta:"Β",beta:"β",beth:"ℶ",between:"≬",Bfr:"𝔅",bfr:"𝔟",bigcap:"⋂",bigcirc:"◯",bigcup:"⋃",bigodot:"⨀",bigoplus:"⨁",bigotimes:"⨂",bigsqcup:"⨆",bigstar:"★",bigtriangledown:"▽",bigtriangleup:"△",biguplus:"⨄",bigvee:"⋁",bigwedge:"⋀",bkarow:"⤍",blacklozenge:"⧫",blacksquare:"▪",blacktriangle:"▴",blacktriangledown:"▾",blacktriangleleft:"◂",blacktriangleright:"▸",blank:"␣",blk12:"▒",blk14:"░",blk34:"▓",block:"█",bne:"=⃥",bnequiv:"≡⃥",bNot:"⫭",bnot:"⌐",Bopf:"𝔹",bopf:"𝕓",bot:"⊥",bottom:"⊥",bowtie:"⋈",boxbox:"⧉",boxDL:"╗",boxDl:"╖",boxdL:"╕",boxdl:"┐",boxDR:"╔",boxDr:"╓",boxdR:"╒",boxdr:"┌",boxH:"═",boxh:"─",boxHD:"╦",boxHd:"╤",boxhD:"╥",boxhd:"┬",boxHU:"╩",boxHu:"╧",boxhU:"╨",boxhu:"┴",boxminus:"⊟",boxplus:"⊞",boxtimes:"⊠",boxUL:"╝",boxUl:"╜",boxuL:"╛",boxul:"┘",boxUR:"╚",boxUr:"╙",boxuR:"╘",boxur:"└",boxV:"║",boxv:"│",boxVH:"╬",boxVh:"╫",boxvH:"╪",boxvh:"┼",boxVL:"╣",boxVl:"╢",boxvL:"╡",boxvl:"┤",boxVR:"╠",boxVr:"╟",boxvR:"╞",boxvr:"├",bprime:"‵",Breve:"˘",breve:"˘",brvbar:"¦",Bscr:"ℬ",bscr:"𝒷",bsemi:"⁏",bsim:"∽",bsime:"⋍",bsol:"\\",bsolb:"⧅",bsolhsub:"⟈",bull:"•",bullet:"•",bump:"≎",bumpE:"⪮",bumpe:"≏",Bumpeq:"≎",bumpeq:"≏",Cacute:"Ć",cacute:"ć",Cap:"⋒",cap:"∩",capand:"⩄",capbrcup:"⩉",capcap:"⩋",capcup:"⩇",capdot:"⩀",CapitalDifferentialD:"ⅅ",caps:"∩︀",caret:"⁁",caron:"ˇ",Cayleys:"ℭ",ccaps:"⩍",Ccaron:"Č",ccaron:"č",Ccedil:"Ç",ccedil:"ç",Ccirc:"Ĉ",ccirc:"ĉ",Cconint:"∰",ccups:"⩌",ccupssm:"⩐",Cdot:"Ċ",cdot:"ċ",cedil:"¸",Cedilla:"¸",cemptyv:"⦲",cent:"¢",CenterDot:"·",centerdot:"·",Cfr:"ℭ",cfr:"𝔠",CHcy:"Ч",chcy:"ч",check:"✓",checkmark:"✓",Chi:"Χ",chi:"χ",cir:"○",circ:"ˆ",circeq:"≗",circlearrowleft:"↺",circlearrowright:"↻",circledast:"⊛",circledcirc:"⊚",circleddash:"⊝",CircleDot:"⊙",circledR:"®",circledS:"Ⓢ",CircleMinus:"⊖",CirclePlus:"⊕",CircleTimes:"⊗",cirE:"⧃",cire:"≗",cirfnint:"⨐",cirmid:"⫯",cirscir:"⧂",ClockwiseContourIntegral:"∲",CloseCurlyDoubleQuote:"”",CloseCurlyQuote:"’",clubs:"♣",clubsuit:"♣",Colon:"∷",colon:":",Colone:"⩴",colone:"≔",coloneq:"≔",comma:",",commat:"@",comp:"∁",compfn:"∘",complement:"∁",complexes:"ℂ",cong:"≅",congdot:"⩭",Congruent:"≡",Conint:"∯",conint:"∮",ContourIntegral:"∮",Copf:"ℂ",copf:"𝕔",coprod:"∐",Coproduct:"∐",COPY:"©",copy:"©",copysr:"℗",CounterClockwiseContourIntegral:"∳",crarr:"↵",Cross:"⨯",cross:"✗",Cscr:"𝒞",cscr:"𝒸",csub:"⫏",csube:"⫑",csup:"⫐",csupe:"⫒",ctdot:"⋯",cudarrl:"⤸",cudarrr:"⤵",cuepr:"⋞",cuesc:"⋟",cularr:"↶",cularrp:"⤽",Cup:"⋓",cup:"∪",cupbrcap:"⩈",CupCap:"≍",cupcap:"⩆",cupcup:"⩊",cupdot:"⊍",cupor:"⩅",cups:"∪︀",curarr:"↷",curarrm:"⤼",curlyeqprec:"⋞",curlyeqsucc:"⋟",curlyvee:"⋎",curlywedge:"⋏",curren:"¤",curvearrowleft:"↶",curvearrowright:"↷",cuvee:"⋎",cuwed:"⋏",cwconint:"∲",cwint:"∱",cylcty:"⌭",Dagger:"‡",dagger:"†",daleth:"ℸ",Darr:"↡",dArr:"⇓",darr:"↓",dash:"‐",Dashv:"⫤",dashv:"⊣",dbkarow:"⤏",dblac:"˝",Dcaron:"Ď",dcaron:"ď",Dcy:"Д",dcy:"д",DD:"ⅅ",dd:"ⅆ",ddagger:"‡",ddarr:"⇊",DDotrahd:"⤑",ddotseq:"⩷",deg:"°",Del:"∇",Delta:"Δ",delta:"δ",demptyv:"⦱",dfisht:"⥿",Dfr:"𝔇",dfr:"𝔡",dHar:"⥥",dharl:"⇃",dharr:"⇂",DiacriticalAcute:"´",DiacriticalDot:"˙",DiacriticalDoubleAcute:"˝",DiacriticalGrave:"`",DiacriticalTilde:"˜",diam:"⋄",Diamond:"⋄",diamond:"⋄",diamondsuit:"♦",diams:"♦",die:"¨",DifferentialD:"ⅆ",digamma:"ϝ",disin:"⋲",div:"÷",divide:"÷",divideontimes:"⋇",divonx:"⋇",DJcy:"Ђ",djcy:"ђ",dlcorn:"⌞",dlcrop:"⌍",dollar:"$",Dopf:"𝔻",dopf:"𝕕",Dot:"¨",dot:"˙",DotDot:"⃜",doteq:"≐",doteqdot:"≑",DotEqual:"≐",dotminus:"∸",dotplus:"∔",dotsquare:"⊡",doublebarwedge:"⌆",DoubleContourIntegral:"∯",DoubleDot:"¨",DoubleDownArrow:"⇓",DoubleLeftArrow:"⇐",DoubleLeftRightArrow:"⇔",DoubleLeftTee:"⫤",DoubleLongLeftArrow:"⟸",DoubleLongLeftRightArrow:"⟺",DoubleLongRightArrow:"⟹",DoubleRightArrow:"⇒",DoubleRightTee:"⊨",DoubleUpArrow:"⇑",DoubleUpDownArrow:"⇕",DoubleVerticalBar:"∥",DownArrow:"↓",Downarrow:"⇓",downarrow:"↓",DownArrowBar:"⤓",DownArrowUpArrow:"⇵",DownBreve:"̑",downdownarrows:"⇊",downharpoonleft:"⇃",downharpoonright:"⇂",DownLeftRightVector:"⥐",DownLeftTeeVector:"⥞",DownLeftVector:"↽",DownLeftVectorBar:"⥖",DownRightTeeVector:"⥟",DownRightVector:"⇁",DownRightVectorBar:"⥗",DownTee:"⊤",DownTeeArrow:"↧",drbkarow:"⤐",drcorn:"⌟",drcrop:"⌌",Dscr:"𝒟",dscr:"𝒹",DScy:"Ѕ",dscy:"ѕ",dsol:"⧶",Dstrok:"Đ",dstrok:"đ",dtdot:"⋱",dtri:"▿",dtrif:"▾",duarr:"⇵",duhar:"⥯",dwangle:"⦦",DZcy:"Џ",dzcy:"џ",dzigrarr:"⟿",Eacute:"É",eacute:"é",easter:"⩮",Ecaron:"Ě",ecaron:"ě",ecir:"≖",Ecirc:"Ê",ecirc:"ê",ecolon:"≕",Ecy:"Э",ecy:"э",eDDot:"⩷",Edot:"Ė",eDot:"≑",edot:"ė",ee:"ⅇ",efDot:"≒",Efr:"𝔈",efr:"𝔢",eg:"⪚",Egrave:"È",egrave:"è",egs:"⪖",egsdot:"⪘",el:"⪙",Element:"∈",elinters:"⏧",ell:"ℓ",els:"⪕",elsdot:"⪗",Emacr:"Ē",emacr:"ē",empty:"∅",emptyset:"∅",EmptySmallSquare:"◻",emptyv:"∅",EmptyVerySmallSquare:"▫",emsp:" ",emsp13:" ",emsp14:" ",ENG:"Ŋ",eng:"ŋ",ensp:" ",Eogon:"Ę",eogon:"ę",Eopf:"𝔼",eopf:"𝕖",epar:"⋕",eparsl:"⧣",eplus:"⩱",epsi:"ε",Epsilon:"Ε",epsilon:"ε",epsiv:"ϵ",eqcirc:"≖",eqcolon:"≕",eqsim:"≂",eqslantgtr:"⪖",eqslantless:"⪕",Equal:"⩵",equals:"=",EqualTilde:"≂",equest:"≟",Equilibrium:"⇌",equiv:"≡",equivDD:"⩸",eqvparsl:"⧥",erarr:"⥱",erDot:"≓",Escr:"ℰ",escr:"ℯ",esdot:"≐",Esim:"⩳",esim:"≂",Eta:"Η",eta:"η",ETH:"Ð",eth:"ð",Euml:"Ë",euml:"ë",euro:"€",excl:"!",exist:"∃",Exists:"∃",expectation:"ℰ",ExponentialE:"ⅇ",exponentiale:"ⅇ",fallingdotseq:"≒",Fcy:"Ф",fcy:"ф",female:"♀",ffilig:"ﬃ",fflig:"ﬀ",ffllig:"ﬄ",Ffr:"𝔉",ffr:"𝔣",filig:"ﬁ",FilledSmallSquare:"◼",FilledVerySmallSquare:"▪",fjlig:"fj",flat:"♭",fllig:"ﬂ",fltns:"▱",fnof:"ƒ",Fopf:"𝔽",fopf:"𝕗",ForAll:"∀",forall:"∀",fork:"⋔",forkv:"⫙",Fouriertrf:"ℱ",fpartint:"⨍",frac12:"½",frac13:"⅓",frac14:"¼",frac15:"⅕",frac16:"⅙",frac18:"⅛",frac23:"⅔",frac25:"⅖",frac34:"¾",frac35:"⅗",frac38:"⅜",frac45:"⅘",frac56:"⅚",frac58:"⅝",frac78:"⅞",frasl:"⁄",frown:"⌢",Fscr:"ℱ",fscr:"𝒻",gacute:"ǵ",Gamma:"Γ",gamma:"γ",Gammad:"Ϝ",gammad:"ϝ",gap:"⪆",Gbreve:"Ğ",gbreve:"ğ",Gcedil:"Ģ",Gcirc:"Ĝ",gcirc:"ĝ",Gcy:"Г",gcy:"г",Gdot:"Ġ",gdot:"ġ",gE:"≧",ge:"≥",gEl:"⪌",gel:"⋛",geq:"≥",geqq:"≧",geqslant:"⩾",ges:"⩾",gescc:"⪩",gesdot:"⪀",gesdoto:"⪂",gesdotol:"⪄",gesl:"⋛︀",gesles:"⪔",Gfr:"𝔊",gfr:"𝔤",Gg:"⋙",gg:"≫",ggg:"⋙",gimel:"ℷ",GJcy:"Ѓ",gjcy:"ѓ",gl:"≷",gla:"⪥",glE:"⪒",glj:"⪤",gnap:"⪊",gnapprox:"⪊",gnE:"≩",gne:"⪈",gneq:"⪈",gneqq:"≩",gnsim:"⋧",Gopf:"𝔾",gopf:"𝕘",grave:"`",GreaterEqual:"≥",GreaterEqualLess:"⋛",GreaterFullEqual:"≧",GreaterGreater:"⪢",GreaterLess:"≷",GreaterSlantEqual:"⩾",GreaterTilde:"≳",Gscr:"𝒢",gscr:"ℊ",gsim:"≳",gsime:"⪎",gsiml:"⪐",GT:">",Gt:"≫",gt:">",gtcc:"⪧",gtcir:"⩺",gtdot:"⋗",gtlPar:"⦕",gtquest:"⩼",gtrapprox:"⪆",gtrarr:"⥸",gtrdot:"⋗",gtreqless:"⋛",gtreqqless:"⪌",gtrless:"≷",gtrsim:"≳",gvertneqq:"≩︀",gvnE:"≩︀",Hacek:"ˇ",hairsp:" ",half:"½",hamilt:"ℋ",HARDcy:"Ъ",hardcy:"ъ",hArr:"⇔",harr:"↔",harrcir:"⥈",harrw:"↭",Hat:"^",hbar:"ℏ",Hcirc:"Ĥ",hcirc:"ĥ",hearts:"♥",heartsuit:"♥",hellip:"…",hercon:"⊹",Hfr:"ℌ",hfr:"𝔥",HilbertSpace:"ℋ",hksearow:"⤥",hkswarow:"⤦",hoarr:"⇿",homtht:"∻",hookleftarrow:"↩",hookrightarrow:"↪",Hopf:"ℍ",hopf:"𝕙",horbar:"―",HorizontalLine:"─",Hscr:"ℋ",hscr:"𝒽",hslash:"ℏ",Hstrok:"Ħ",hstrok:"ħ",HumpDownHump:"≎",HumpEqual:"≏",hybull:"⁃",hyphen:"‐",Iacute:"Í",iacute:"í",ic:"⁣",Icirc:"Î",icirc:"î",Icy:"И",icy:"и",Idot:"İ",IEcy:"Е",iecy:"е",iexcl:"¡",iff:"⇔",Ifr:"ℑ",ifr:"𝔦",Igrave:"Ì",igrave:"ì",ii:"ⅈ",iiiint:"⨌",iiint:"∭",iinfin:"⧜",iiota:"℩",IJlig:"Ĳ",ijlig:"ĳ",Im:"ℑ",Imacr:"Ī",imacr:"ī",image:"ℑ",ImaginaryI:"ⅈ",imagline:"ℐ",imagpart:"ℑ",imath:"ı",imof:"⊷",imped:"Ƶ",Implies:"⇒","in":"∈",incare:"℅",infin:"∞",infintie:"⧝",inodot:"ı",Int:"∬","int":"∫",intcal:"⊺",integers:"ℤ",Integral:"∫",intercal:"⊺",Intersection:"⋂",intlarhk:"⨗",intprod:"⨼",InvisibleComma:"⁣",InvisibleTimes:"⁢",IOcy:"Ё",iocy:"ё",Iogon:"Į",iogon:"į",Iopf:"𝕀",iopf:"𝕚",Iota:"Ι",iota:"ι",iprod:"⨼",iquest:"¿",Iscr:"ℐ",iscr:"𝒾",isin:"∈",isindot:"⋵",isinE:"⋹",isins:"⋴",isinsv:"⋳",isinv:"∈",it:"⁢",Itilde:"Ĩ",itilde:"ĩ",Iukcy:"І",iukcy:"і",Iuml:"Ï",iuml:"ï",Jcirc:"Ĵ",jcirc:"ĵ",Jcy:"Й",jcy:"й",Jfr:"𝔍",jfr:"𝔧",jmath:"ȷ",Jopf:"𝕁",jopf:"𝕛",Jscr:"𝒥",jscr:"𝒿",Jsercy:"Ј",jsercy:"ј",Jukcy:"Є",jukcy:"є",Kappa:"Κ",kappa:"κ",kappav:"ϰ",Kcedil:"Ķ",kcedil:"ķ",Kcy:"К",kcy:"к",Kfr:"𝔎",kfr:"𝔨",kgreen:"ĸ",KHcy:"Х",khcy:"х",KJcy:"Ќ",kjcy:"ќ",Kopf:"𝕂",kopf:"𝕜",Kscr:"𝒦",kscr:"𝓀",lAarr:"⇚",Lacute:"Ĺ",lacute:"ĺ",laemptyv:"⦴",lagran:"ℒ",Lambda:"Λ",lambda:"λ",Lang:"⟪",lang:"⟨",langd:"⦑",langle:"⟨",lap:"⪅",Laplacetrf:"ℒ",laquo:"«",Larr:"↞",lArr:"⇐",larr:"←",larrb:"⇤",larrbfs:"⤟",larrfs:"⤝",larrhk:"↩",larrlp:"↫",larrpl:"⤹",larrsim:"⥳",larrtl:"↢",lat:"⪫",lAtail:"⤛",latail:"⤙",late:"⪭",lates:"⪭︀",lBarr:"⤎",lbarr:"⤌",lbbrk:"❲",lbrace:"{",lbrack:"[",lbrke:"⦋",lbrksld:"⦏",lbrkslu:"⦍",Lcaron:"Ľ",lcaron:"ľ",Lcedil:"Ļ",lcedil:"ļ",lceil:"⌈",lcub:"{",Lcy:"Л",lcy:"л",ldca:"⤶",ldquo:"“",ldquor:"„",ldrdhar:"⥧",ldrushar:"⥋",ldsh:"↲",lE:"≦",le:"≤",LeftAngleBracket:"⟨",LeftArrow:"←",Leftarrow:"⇐",leftarrow:"←",LeftArrowBar:"⇤",LeftArrowRightArrow:"⇆",leftarrowtail:"↢",LeftCeiling:"⌈",LeftDoubleBracket:"⟦",LeftDownTeeVector:"⥡",LeftDownVector:"⇃",LeftDownVectorBar:"⥙",LeftFloor:"⌊",leftharpoondown:"↽",leftharpoonup:"↼",leftleftarrows:"⇇",LeftRightArrow:"↔",Leftrightarrow:"⇔",leftrightarrow:"↔",leftrightarrows:"⇆",leftrightharpoons:"⇋",leftrightsquigarrow:"↭",LeftRightVector:"⥎",LeftTee:"⊣",LeftTeeArrow:"↤",LeftTeeVector:"⥚",leftthreetimes:"⋋",LeftTriangle:"⊲",LeftTriangleBar:"⧏",LeftTriangleEqual:"⊴",LeftUpDownVector:"⥑",LeftUpTeeVector:"⥠",LeftUpVector:"↿",LeftUpVectorBar:"⥘",LeftVector:"↼",LeftVectorBar:"⥒",lEg:"⪋",leg:"⋚",leq:"≤",leqq:"≦",leqslant:"⩽",les:"⩽",lescc:"⪨",lesdot:"⩿",lesdoto:"⪁",lesdotor:"⪃",lesg:"⋚︀",lesges:"⪓",lessapprox:"⪅",lessdot:"⋖",lesseqgtr:"⋚",lesseqqgtr:"⪋",LessEqualGreater:"⋚",LessFullEqual:"≦",LessGreater:"≶",lessgtr:"≶",LessLess:"⪡",lesssim:"≲",LessSlantEqual:"⩽",LessTilde:"≲",lfisht:"⥼",lfloor:"⌊",Lfr:"𝔏",lfr:"𝔩",lg:"≶",lgE:"⪑",lHar:"⥢",lhard:"↽",lharu:"↼",lharul:"⥪",lhblk:"▄",LJcy:"Љ",ljcy:"љ",Ll:"⋘",ll:"≪",llarr:"⇇",llcorner:"⌞",Lleftarrow:"⇚",llhard:"⥫",lltri:"◺",Lmidot:"Ŀ",lmidot:"ŀ",lmoust:"⎰",lmoustache:"⎰",lnap:"⪉",lnapprox:"⪉",lnE:"≨",lne:"⪇",lneq:"⪇",lneqq:"≨",lnsim:"⋦",loang:"⟬",loarr:"⇽",lobrk:"⟦",LongLeftArrow:"⟵",Longleftarrow:"⟸",longleftarrow:"⟵",LongLeftRightArrow:"⟷",Longleftrightarrow:"⟺",longleftrightarrow:"⟷",longmapsto:"⟼",LongRightArrow:"⟶",Longrightarrow:"⟹",longrightarrow:"⟶",looparrowleft:"↫",looparrowright:"↬",lopar:"⦅",Lopf:"𝕃",lopf:"𝕝",loplus:"⨭",lotimes:"⨴",lowast:"∗",lowbar:"_",LowerLeftArrow:"↙",LowerRightArrow:"↘",loz:"◊",lozenge:"◊",lozf:"⧫",lpar:"(",lparlt:"⦓",lrarr:"⇆",lrcorner:"⌟",lrhar:"⇋",lrhard:"⥭",lrm:"‎",lrtri:"⊿",lsaquo:"‹",Lscr:"ℒ",lscr:"𝓁",Lsh:"↰",lsh:"↰",lsim:"≲",lsime:"⪍",lsimg:"⪏",lsqb:"[",lsquo:"‘",lsquor:"‚",Lstrok:"Ł",lstrok:"ł",LT:"<",Lt:"≪",lt:"<",ltcc:"⪦",ltcir:"⩹",ltdot:"⋖",lthree:"⋋",ltimes:"⋉",ltlarr:"⥶",ltquest:"⩻",ltri:"◃",ltrie:"⊴",ltrif:"◂",ltrPar:"⦖",lurdshar:"⥊",luruhar:"⥦",lvertneqq:"≨︀",lvnE:"≨︀",macr:"¯",male:"♂",malt:"✠",maltese:"✠",Map:"⤅",map:"↦",mapsto:"↦",mapstodown:"↧",mapstoleft:"↤",mapstoup:"↥",marker:"▮",mcomma:"⨩",Mcy:"М",mcy:"м",mdash:"—",mDDot:"∺",measuredangle:"∡",MediumSpace:" ",Mellintrf:"ℳ",Mfr:"𝔐",mfr:"𝔪",mho:"℧",micro:"µ",mid:"∣",midast:"*",midcir:"⫰",middot:"·",minus:"−",minusb:"⊟",minusd:"∸",minusdu:"⨪",MinusPlus:"∓",mlcp:"⫛",mldr:"…",mnplus:"∓",models:"⊧",Mopf:"𝕄",mopf:"𝕞",mp:"∓",Mscr:"ℳ",mscr:"𝓂",mstpos:"∾",Mu:"Μ",mu:"μ",multimap:"⊸",mumap:"⊸",nabla:"∇",Nacute:"Ń",nacute:"ń",nang:"∠⃒",nap:"≉",napE:"⩰̸",napid:"≋̸",napos:"ŉ",napprox:"≉",natur:"♮",natural:"♮",naturals:"ℕ",nbsp:" ",nbump:"≎̸",nbumpe:"≏̸",ncap:"⩃",Ncaron:"Ň",ncaron:"ň",Ncedil:"Ņ",ncedil:"ņ",ncong:"≇",ncongdot:"⩭̸",ncup:"⩂",Ncy:"Н",ncy:"н",ndash:"–",ne:"≠",nearhk:"⤤",neArr:"⇗",nearr:"↗",nearrow:"↗",nedot:"≐̸",NegativeMediumSpace:"​",NegativeThickSpace:"​",NegativeThinSpace:"​",NegativeVeryThinSpace:"​",nequiv:"≢",nesear:"⤨",nesim:"≂̸",NestedGreaterGreater:"≫",NestedLessLess:"≪",NewLine:"\n",nexist:"∄",nexists:"∄",Nfr:"𝔑",nfr:"𝔫",ngE:"≧̸",nge:"≱",ngeq:"≱",ngeqq:"≧̸",ngeqslant:"⩾̸",nges:"⩾̸",nGg:"⋙̸",ngsim:"≵",nGt:"≫⃒",ngt:"≯",ngtr:"≯",nGtv:"≫̸",nhArr:"⇎",nharr:"↮",nhpar:"⫲",ni:"∋",nis:"⋼",nisd:"⋺",niv:"∋",NJcy:"Њ",njcy:"њ",nlArr:"⇍",nlarr:"↚",nldr:"‥",nlE:"≦̸",nle:"≰",nLeftarrow:"⇍",nleftarrow:"↚",nLeftrightarrow:"⇎",nleftrightarrow:"↮",nleq:"≰",nleqq:"≦̸",nleqslant:"⩽̸",nles:"⩽̸",nless:"≮",nLl:"⋘̸",nlsim:"≴",nLt:"≪⃒",nlt:"≮",nltri:"⋪",nltrie:"⋬",nLtv:"≪̸",nmid:"∤",NoBreak:"⁠",NonBreakingSpace:" ",Nopf:"ℕ",nopf:"𝕟",Not:"⫬",not:"¬",NotCongruent:"≢",NotCupCap:"≭",NotDoubleVerticalBar:"∦",NotElement:"∉",NotEqual:"≠",NotEqualTilde:"≂̸",NotExists:"∄",NotGreater:"≯",NotGreaterEqual:"≱",NotGreaterFullEqual:"≧̸",NotGreaterGreater:"≫̸",NotGreaterLess:"≹",NotGreaterSlantEqual:"⩾̸",NotGreaterTilde:"≵",NotHumpDownHump:"≎̸",NotHumpEqual:"≏̸",notin:"∉",notindot:"⋵̸",notinE:"⋹̸",notinva:"∉",notinvb:"⋷",notinvc:"⋶",NotLeftTriangle:"⋪",NotLeftTriangleBar:"⧏̸",NotLeftTriangleEqual:"⋬",NotLess:"≮",NotLessEqual:"≰",NotLessGreater:"≸",NotLessLess:"≪̸",NotLessSlantEqual:"⩽̸",NotLessTilde:"≴",NotNestedGreaterGreater:"⪢̸",NotNestedLessLess:"⪡̸",notni:"∌",notniva:"∌",notnivb:"⋾",notnivc:"⋽",NotPrecedes:"⊀",NotPrecedesEqual:"⪯̸",NotPrecedesSlantEqual:"⋠",NotReverseElement:"∌",NotRightTriangle:"⋫",NotRightTriangleBar:"⧐̸",NotRightTriangleEqual:"⋭",NotSquareSubset:"⊏̸",NotSquareSubsetEqual:"⋢",NotSquareSuperset:"⊐̸",NotSquareSupersetEqual:"⋣",NotSubset:"⊂⃒",NotSubsetEqual:"⊈",NotSucceeds:"⊁",NotSucceedsEqual:"⪰̸",NotSucceedsSlantEqual:"⋡",NotSucceedsTilde:"≿̸",NotSuperset:"⊃⃒",NotSupersetEqual:"⊉",NotTilde:"≁",NotTildeEqual:"≄",NotTildeFullEqual:"≇",NotTildeTilde:"≉",NotVerticalBar:"∤",npar:"∦",nparallel:"∦",nparsl:"⫽⃥",npart:"∂̸",npolint:"⨔",npr:"⊀",nprcue:"⋠",npre:"⪯̸",nprec:"⊀",npreceq:"⪯̸",nrArr:"⇏",nrarr:"↛",nrarrc:"⤳̸",nrarrw:"↝̸",nRightarrow:"⇏",nrightarrow:"↛",nrtri:"⋫",nrtrie:"⋭",nsc:"⊁",nsccue:"⋡",nsce:"⪰̸",Nscr:"𝒩",nscr:"𝓃",nshortmid:"∤",nshortparallel:"∦",nsim:"≁",nsime:"≄",nsimeq:"≄",nsmid:"∤",nspar:"∦",nsqsube:"⋢",nsqsupe:"⋣",nsub:"⊄",nsubE:"⫅̸",nsube:"⊈",nsubset:"⊂⃒",nsubseteq:"⊈",nsubseteqq:"⫅̸",nsucc:"⊁",nsucceq:"⪰̸",nsup:"⊅",nsupE:"⫆̸",nsupe:"⊉",nsupset:"⊃⃒",nsupseteq:"⊉",nsupseteqq:"⫆̸",ntgl:"≹",Ntilde:"Ñ",ntilde:"ñ",ntlg:"≸",ntriangleleft:"⋪",ntrianglelefteq:"⋬",ntriangleright:"⋫",ntrianglerighteq:"⋭",Nu:"Ν",nu:"ν",num:"#",numero:"№",numsp:" ",nvap:"≍⃒",nVDash:"⊯",nVdash:"⊮",nvDash:"⊭",nvdash:"⊬",nvge:"≥⃒",nvgt:">⃒",nvHarr:"⤄",nvinfin:"⧞",nvlArr:"⤂",nvle:"≤⃒",nvlt:"<⃒",nvltrie:"⊴⃒",nvrArr:"⤃",nvrtrie:"⊵⃒",nvsim:"∼⃒",nwarhk:"⤣",nwArr
:"⇖",nwarr:"↖",nwarrow:"↖",nwnear:"⤧",Oacute:"Ó",oacute:"ó",oast:"⊛",ocir:"⊚",Ocirc:"Ô",ocirc:"ô",Ocy:"О",ocy:"о",odash:"⊝",Odblac:"Ő",odblac:"ő",odiv:"⨸",odot:"⊙",odsold:"⦼",OElig:"Œ",oelig:"œ",ofcir:"⦿",Ofr:"𝔒",ofr:"𝔬",ogon:"˛",Ograve:"Ò",ograve:"ò",ogt:"⧁",ohbar:"⦵",ohm:"Ω",oint:"∮",olarr:"↺",olcir:"⦾",olcross:"⦻",oline:"‾",olt:"⧀",Omacr:"Ō",omacr:"ō",Omega:"Ω",omega:"ω",Omicron:"Ο",omicron:"ο",omid:"⦶",ominus:"⊖",Oopf:"𝕆",oopf:"𝕠",opar:"⦷",OpenCurlyDoubleQuote:"“",OpenCurlyQuote:"‘",operp:"⦹",oplus:"⊕",Or:"⩔",or:"∨",orarr:"↻",ord:"⩝",order:"ℴ",orderof:"ℴ",ordf:"ª",ordm:"º",origof:"⊶",oror:"⩖",orslope:"⩗",orv:"⩛",oS:"Ⓢ",Oscr:"𝒪",oscr:"ℴ",Oslash:"Ø",oslash:"ø",osol:"⊘",Otilde:"Õ",otilde:"õ",Otimes:"⨷",otimes:"⊗",otimesas:"⨶",Ouml:"Ö",ouml:"ö",ovbar:"⌽",OverBar:"‾",OverBrace:"⏞",OverBracket:"⎴",OverParenthesis:"⏜",par:"∥",para:"¶",parallel:"∥",parsim:"⫳",parsl:"⫽",part:"∂",PartialD:"∂",Pcy:"П",pcy:"п",percnt:"%",period:".",permil:"‰",perp:"⊥",pertenk:"‱",Pfr:"𝔓",pfr:"𝔭",Phi:"Φ",phi:"φ",phiv:"ϕ",phmmat:"ℳ",phone:"☎",Pi:"Π",pi:"π",pitchfork:"⋔",piv:"ϖ",planck:"ℏ",planckh:"ℎ",plankv:"ℏ",plus:"+",plusacir:"⨣",plusb:"⊞",pluscir:"⨢",plusdo:"∔",plusdu:"⨥",pluse:"⩲",PlusMinus:"±",plusmn:"±",plussim:"⨦",plustwo:"⨧",pm:"±",Poincareplane:"ℌ",pointint:"⨕",Popf:"ℙ",popf:"𝕡",pound:"£",Pr:"⪻",pr:"≺",prap:"⪷",prcue:"≼",prE:"⪳",pre:"⪯",prec:"≺",precapprox:"⪷",preccurlyeq:"≼",Precedes:"≺",PrecedesEqual:"⪯",PrecedesSlantEqual:"≼",PrecedesTilde:"≾",preceq:"⪯",precnapprox:"⪹",precneqq:"⪵",precnsim:"⋨",precsim:"≾",Prime:"″",prime:"′",primes:"ℙ",prnap:"⪹",prnE:"⪵",prnsim:"⋨",prod:"∏",Product:"∏",profalar:"⌮",profline:"⌒",profsurf:"⌓",prop:"∝",Proportion:"∷",Proportional:"∝",propto:"∝",prsim:"≾",prurel:"⊰",Pscr:"𝒫",pscr:"𝓅",Psi:"Ψ",psi:"ψ",puncsp:" ",Qfr:"𝔔",qfr:"𝔮",qint:"⨌",Qopf:"ℚ",qopf:"𝕢",qprime:"⁗",Qscr:"𝒬",qscr:"𝓆",quaternions:"ℍ",quatint:"⨖",quest:"?",questeq:"≟",QUOT:'"',quot:'"',rAarr:"⇛",race:"∽̱",Racute:"Ŕ",racute:"ŕ",radic:"√",raemptyv:"⦳",Rang:"⟫",rang:"⟩",rangd:"⦒",range:"⦥",rangle:"⟩",raquo:"»",Rarr:"↠",rArr:"⇒",rarr:"→",rarrap:"⥵",rarrb:"⇥",rarrbfs:"⤠",rarrc:"⤳",rarrfs:"⤞",rarrhk:"↪",rarrlp:"↬",rarrpl:"⥅",rarrsim:"⥴",Rarrtl:"⤖",rarrtl:"↣",rarrw:"↝",rAtail:"⤜",ratail:"⤚",ratio:"∶",rationals:"ℚ",RBarr:"⤐",rBarr:"⤏",rbarr:"⤍",rbbrk:"❳",rbrace:"}",rbrack:"]",rbrke:"⦌",rbrksld:"⦎",rbrkslu:"⦐",Rcaron:"Ř",rcaron:"ř",Rcedil:"Ŗ",rcedil:"ŗ",rceil:"⌉",rcub:"}",Rcy:"Р",rcy:"р",rdca:"⤷",rdldhar:"⥩",rdquo:"”",rdquor:"”",rdsh:"↳",Re:"ℜ",real:"ℜ",realine:"ℛ",realpart:"ℜ",reals:"ℝ",rect:"▭",REG:"®",reg:"®",ReverseElement:"∋",ReverseEquilibrium:"⇋",ReverseUpEquilibrium:"⥯",rfisht:"⥽",rfloor:"⌋",Rfr:"ℜ",rfr:"𝔯",rHar:"⥤",rhard:"⇁",rharu:"⇀",rharul:"⥬",Rho:"Ρ",rho:"ρ",rhov:"ϱ",RightAngleBracket:"⟩",RightArrow:"→",Rightarrow:"⇒",rightarrow:"→",RightArrowBar:"⇥",RightArrowLeftArrow:"⇄",rightarrowtail:"↣",RightCeiling:"⌉",RightDoubleBracket:"⟧",RightDownTeeVector:"⥝",RightDownVector:"⇂",RightDownVectorBar:"⥕",RightFloor:"⌋",rightharpoondown:"⇁",rightharpoonup:"⇀",rightleftarrows:"⇄",rightleftharpoons:"⇌",rightrightarrows:"⇉",rightsquigarrow:"↝",RightTee:"⊢",RightTeeArrow:"↦",RightTeeVector:"⥛",rightthreetimes:"⋌",RightTriangle:"⊳",RightTriangleBar:"⧐",RightTriangleEqual:"⊵",RightUpDownVector:"⥏",RightUpTeeVector:"⥜",RightUpVector:"↾",RightUpVectorBar:"⥔",RightVector:"⇀",RightVectorBar:"⥓",ring:"˚",risingdotseq:"≓",rlarr:"⇄",rlhar:"⇌",rlm:"‏",rmoust:"⎱",rmoustache:"⎱",rnmid:"⫮",roang:"⟭",roarr:"⇾",robrk:"⟧",ropar:"⦆",Ropf:"ℝ",ropf:"𝕣",roplus:"⨮",rotimes:"⨵",RoundImplies:"⥰",rpar:")",rpargt:"⦔",rppolint:"⨒",rrarr:"⇉",Rrightarrow:"⇛",rsaquo:"›",Rscr:"ℛ",rscr:"𝓇",Rsh:"↱",rsh:"↱",rsqb:"]",rsquo:"’",rsquor:"’",rthree:"⋌",rtimes:"⋊",rtri:"▹",rtrie:"⊵",rtrif:"▸",rtriltri:"⧎",RuleDelayed:"⧴",ruluhar:"⥨",rx:"℞",Sacute:"Ś",sacute:"ś",sbquo:"‚",Sc:"⪼",sc:"≻",scap:"⪸",Scaron:"Š",scaron:"š",sccue:"≽",scE:"⪴",sce:"⪰",Scedil:"Ş",scedil:"ş",Scirc:"Ŝ",scirc:"ŝ",scnap:"⪺",scnE:"⪶",scnsim:"⋩",scpolint:"⨓",scsim:"≿",Scy:"С",scy:"с",sdot:"⋅",sdotb:"⊡",sdote:"⩦",searhk:"⤥",seArr:"⇘",searr:"↘",searrow:"↘",sect:"§",semi:";",seswar:"⤩",setminus:"∖",setmn:"∖",sext:"✶",Sfr:"𝔖",sfr:"𝔰",sfrown:"⌢",sharp:"♯",SHCHcy:"Щ",shchcy:"щ",SHcy:"Ш",shcy:"ш",ShortDownArrow:"↓",ShortLeftArrow:"←",shortmid:"∣",shortparallel:"∥",ShortRightArrow:"→",ShortUpArrow:"↑",shy:"­",Sigma:"Σ",sigma:"σ",sigmaf:"ς",sigmav:"ς",sim:"∼",simdot:"⩪",sime:"≃",simeq:"≃",simg:"⪞",simgE:"⪠",siml:"⪝",simlE:"⪟",simne:"≆",simplus:"⨤",simrarr:"⥲",slarr:"←",SmallCircle:"∘",smallsetminus:"∖",smashp:"⨳",smeparsl:"⧤",smid:"∣",smile:"⌣",smt:"⪪",smte:"⪬",smtes:"⪬︀",SOFTcy:"Ь",softcy:"ь",sol:"/",solb:"⧄",solbar:"⌿",Sopf:"𝕊",sopf:"𝕤",spades:"♠",spadesuit:"♠",spar:"∥",sqcap:"⊓",sqcaps:"⊓︀",sqcup:"⊔",sqcups:"⊔︀",Sqrt:"√",sqsub:"⊏",sqsube:"⊑",sqsubset:"⊏",sqsubseteq:"⊑",sqsup:"⊐",sqsupe:"⊒",sqsupset:"⊐",sqsupseteq:"⊒",squ:"□",Square:"□",square:"□",SquareIntersection:"⊓",SquareSubset:"⊏",SquareSubsetEqual:"⊑",SquareSuperset:"⊐",SquareSupersetEqual:"⊒",SquareUnion:"⊔",squarf:"▪",squf:"▪",srarr:"→",Sscr:"𝒮",sscr:"𝓈",ssetmn:"∖",ssmile:"⌣",sstarf:"⋆",Star:"⋆",star:"☆",starf:"★",straightepsilon:"ϵ",straightphi:"ϕ",strns:"¯",Sub:"⋐",sub:"⊂",subdot:"⪽",subE:"⫅",sube:"⊆",subedot:"⫃",submult:"⫁",subnE:"⫋",subne:"⊊",subplus:"⪿",subrarr:"⥹",Subset:"⋐",subset:"⊂",subseteq:"⊆",subseteqq:"⫅",SubsetEqual:"⊆",subsetneq:"⊊",subsetneqq:"⫋",subsim:"⫇",subsub:"⫕",subsup:"⫓",succ:"≻",succapprox:"⪸",succcurlyeq:"≽",Succeeds:"≻",SucceedsEqual:"⪰",SucceedsSlantEqual:"≽",SucceedsTilde:"≿",succeq:"⪰",succnapprox:"⪺",succneqq:"⪶",succnsim:"⋩",succsim:"≿",SuchThat:"∋",Sum:"∑",sum:"∑",sung:"♪",Sup:"⋑",sup:"⊃",sup1:"¹",sup2:"²",sup3:"³",supdot:"⪾",supdsub:"⫘",supE:"⫆",supe:"⊇",supedot:"⫄",Superset:"⊃",SupersetEqual:"⊇",suphsol:"⟉",suphsub:"⫗",suplarr:"⥻",supmult:"⫂",supnE:"⫌",supne:"⊋",supplus:"⫀",Supset:"⋑",supset:"⊃",supseteq:"⊇",supseteqq:"⫆",supsetneq:"⊋",supsetneqq:"⫌",supsim:"⫈",supsub:"⫔",supsup:"⫖",swarhk:"⤦",swArr:"⇙",swarr:"↙",swarrow:"↙",swnwar:"⤪",szlig:"ß",Tab:"\t",target:"⌖",Tau:"Τ",tau:"τ",tbrk:"⎴",Tcaron:"Ť",tcaron:"ť",Tcedil:"Ţ",tcedil:"ţ",Tcy:"Т",tcy:"т",tdot:"⃛",telrec:"⌕",Tfr:"𝔗",tfr:"𝔱",there4:"∴",Therefore:"∴",therefore:"∴",Theta:"Θ",theta:"θ",thetasym:"ϑ",thetav:"ϑ",thickapprox:"≈",thicksim:"∼",ThickSpace:"  ",thinsp:" ",ThinSpace:" ",thkap:"≈",thksim:"∼",THORN:"Þ",thorn:"þ",Tilde:"∼",tilde:"˜",TildeEqual:"≃",TildeFullEqual:"≅",TildeTilde:"≈",times:"×",timesb:"⊠",timesbar:"⨱",timesd:"⨰",tint:"∭",toea:"⤨",top:"⊤",topbot:"⌶",topcir:"⫱",Topf:"𝕋",topf:"𝕥",topfork:"⫚",tosa:"⤩",tprime:"‴",TRADE:"™",trade:"™",triangle:"▵",triangledown:"▿",triangleleft:"◃",trianglelefteq:"⊴",triangleq:"≜",triangleright:"▹",trianglerighteq:"⊵",tridot:"◬",trie:"≜",triminus:"⨺",TripleDot:"⃛",triplus:"⨹",trisb:"⧍",tritime:"⨻",trpezium:"⏢",Tscr:"𝒯",tscr:"𝓉",TScy:"Ц",tscy:"ц",TSHcy:"Ћ",tshcy:"ћ",Tstrok:"Ŧ",tstrok:"ŧ",twixt:"≬",twoheadleftarrow:"↞",twoheadrightarrow:"↠",Uacute:"Ú",uacute:"ú",Uarr:"↟",uArr:"⇑",uarr:"↑",Uarrocir:"⥉",Ubrcy:"Ў",ubrcy:"ў",Ubreve:"Ŭ",ubreve:"ŭ",Ucirc:"Û",ucirc:"û",Ucy:"У",ucy:"у",udarr:"⇅",Udblac:"Ű",udblac:"ű",udhar:"⥮",ufisht:"⥾",Ufr:"𝔘",ufr:"𝔲",Ugrave:"Ù",ugrave:"ù",uHar:"⥣",uharl:"↿",uharr:"↾",uhblk:"▀",ulcorn:"⌜",ulcorner:"⌜",ulcrop:"⌏",ultri:"◸",Umacr:"Ū",umacr:"ū",uml:"¨",UnderBar:"_",UnderBrace:"⏟",UnderBracket:"⎵",UnderParenthesis:"⏝",Union:"⋃",UnionPlus:"⊎",Uogon:"Ų",uogon:"ų",Uopf:"𝕌",uopf:"𝕦",UpArrow:"↑",Uparrow:"⇑",uparrow:"↑",UpArrowBar:"⤒",UpArrowDownArrow:"⇅",UpDownArrow:"↕",Updownarrow:"⇕",updownarrow:"↕",UpEquilibrium:"⥮",upharpoonleft:"↿",upharpoonright:"↾",uplus:"⊎",UpperLeftArrow:"↖",UpperRightArrow:"↗",Upsi:"ϒ",upsi:"υ",upsih:"ϒ",Upsilon:"Υ",upsilon:"υ",UpTee:"⊥",UpTeeArrow:"↥",upuparrows:"⇈",urcorn:"⌝",urcorner:"⌝",urcrop:"⌎",Uring:"Ů",uring:"ů",urtri:"◹",Uscr:"𝒰",uscr:"𝓊",utdot:"⋰",Utilde:"Ũ",utilde:"ũ",utri:"▵",utrif:"▴",uuarr:"⇈",Uuml:"Ü",uuml:"ü",uwangle:"⦧",vangrt:"⦜",varepsilon:"ϵ",varkappa:"ϰ",varnothing:"∅",varphi:"ϕ",varpi:"ϖ",varpropto:"∝",vArr:"⇕",varr:"↕",varrho:"ϱ",varsigma:"ς",varsubsetneq:"⊊︀",varsubsetneqq:"⫋︀",varsupsetneq:"⊋︀",varsupsetneqq:"⫌︀",vartheta:"ϑ",vartriangleleft:"⊲",vartriangleright:"⊳",Vbar:"⫫",vBar:"⫨",vBarv:"⫩",Vcy:"В",vcy:"в",VDash:"⊫",Vdash:"⊩",vDash:"⊨",vdash:"⊢",Vdashl:"⫦",Vee:"⋁",vee:"∨",veebar:"⊻",veeeq:"≚",vellip:"⋮",Verbar:"‖",verbar:"|",Vert:"‖",vert:"|",VerticalBar:"∣",VerticalLine:"|",VerticalSeparator:"❘",VerticalTilde:"≀",VeryThinSpace:" ",Vfr:"𝔙",vfr:"𝔳",vltri:"⊲",vnsub:"⊂⃒",vnsup:"⊃⃒",Vopf:"𝕍",vopf:"𝕧",vprop:"∝",vrtri:"⊳",Vscr:"𝒱",vscr:"𝓋",vsubnE:"⫋︀",vsubne:"⊊︀",vsupnE:"⫌︀",vsupne:"⊋︀",Vvdash:"⊪",vzigzag:"⦚",Wcirc:"Ŵ",wcirc:"ŵ",wedbar:"⩟",Wedge:"⋀",wedge:"∧",wedgeq:"≙",weierp:"℘",Wfr:"𝔚",wfr:"𝔴",Wopf:"𝕎",wopf:"𝕨",wp:"℘",wr:"≀",wreath:"≀",Wscr:"𝒲",wscr:"𝓌",xcap:"⋂",xcirc:"◯",xcup:"⋃",xdtri:"▽",Xfr:"𝔛",xfr:"𝔵",xhArr:"⟺",xharr:"⟷",Xi:"Ξ",xi:"ξ",xlArr:"⟸",xlarr:"⟵",xmap:"⟼",xnis:"⋻",xodot:"⨀",Xopf:"𝕏",xopf:"𝕩",xoplus:"⨁",xotime:"⨂",xrArr:"⟹",xrarr:"⟶",Xscr:"𝒳",xscr:"𝓍",xsqcup:"⨆",xuplus:"⨄",xutri:"△",xvee:"⋁",xwedge:"⋀",Yacute:"Ý",yacute:"ý",YAcy:"Я",yacy:"я",Ycirc:"Ŷ",ycirc:"ŷ",Ycy:"Ы",ycy:"ы",yen:"¥",Yfr:"𝔜",yfr:"𝔶",YIcy:"Ї",yicy:"ї",Yopf:"𝕐",yopf:"𝕪",Yscr:"𝒴",yscr:"𝓎",YUcy:"Ю",yucy:"ю",Yuml:"Ÿ",yuml:"ÿ",Zacute:"Ź",zacute:"ź",Zcaron:"Ž",zcaron:"ž",Zcy:"З",zcy:"з",Zdot:"Ż",zdot:"ż",zeetrf:"ℨ",ZeroWidthSpace:"​",Zeta:"Ζ",zeta:"ζ",Zfr:"ℨ",zfr:"𝔷",ZHcy:"Ж",zhcy:"ж",zigrarr:"⇝",Zopf:"ℤ",zopf:"𝕫",Zscr:"𝒵",zscr:"𝓏",zwj:"‍",zwnj:"‌"}},{}],2:[function(a,b,c){"use strict";var d={};["article","aside","button","blockquote","body","canvas","caption","col","colgroup","dd","div","dl","dt","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","header","hgroup","hr","iframe","li","map","object","ol","output","p","pre","progress","script","section","style","table","tbody","td","textarea","tfoot","th","tr","thead","ul","video"].forEach(function(a){d[a]=!0}),b.exports=d},{}],3:[function(a,b,c){function d(a,b){return a=a.source,b=b||"",function c(d,e){return d?(e=e.source||e,a=a.replace(d,e),c):new RegExp(a,b)}}"use strict";var e=/[a-zA-Z_:][a-zA-Z0-9:._-]*/,f=/[^"'=<>`\x00-\x20]+/,g=/'[^']*'/,h=/"[^"]*"/,i=d(/(?:unquoted|single_quoted|double_quoted)/)("unquoted",f)("single_quoted",g)("double_quoted",h)(),j=d(/(?:\s+attr_name(?:\s*=\s*attr_value)?)/)("attr_name",e)("attr_value",i)(),k=d(/<[A-Za-z][A-Za-z0-9]*attribute*\s*\/?>/)("attribute",j)(),l=/<\/[A-Za-z][A-Za-z0-9]*\s*>/,m=/<!--([^-]+|[-][^-]+)*-->/,n=/<[?].*?[?]>/,o=/<![A-Z]+\s+[^>]*>/,p=/<!\[CDATA\[([^\]]+|\][^\]]|\]\][^>])*\]\]>/,q=d(/^(?:open_tag|close_tag|comment|processing|declaration|cdata)/)("open_tag",k)("close_tag",l)("comment",m)("processing",n)("declaration",o)("cdata",p)();b.exports.HTML_TAG_RE=q},{}],4:[function(a,b,c){"use strict",b.exports=["coap","doi","javascript","aaa","aaas","about","acap","cap","cid","crid","data","dav","dict","dns","file","ftp","geo","go","gopher","h323","http","https","iax","icap","im","imap","info","ipp","iris","iris.beep","iris.xpc","iris.xpcs","iris.lwz","ldap","mailto","mid","msrp","msrps","mtqp","mupdate","news","nfs","ni","nih","nntp","opaquelocktoken","pop","pres","rtsp","service","session","shttp","sieve","sip","sips","sms","snmp","soap.beep","soap.beeps","tag","tel","telnet","tftp","thismessage","tn3270","tip","tv","urn","vemmi","ws","wss","xcon","xcon-userid","xmlrpc.beep","xmlrpc.beeps","xmpp","z39.50r","z39.50s","adiumxtra","afp","afs","aim","apt","attachment","aw","beshare","bitcoin","bolo","callto","chrome","chrome-extension","com-eventbrite-attendee","content","cvs","dlna-playsingle","dlna-playcontainer","dtn","dvb","ed2k","facetime","feed","finger","fish","gg","git","gizmoproject","gtalk","hcp","icon","ipn","irc","irc6","ircs","itms","jar","jms","keyparc","lastfm","ldaps","magnet","maps","market","message","mms","ms-help","msnim","mumble","mvn","notes","oid","palm","paparazzi","platform","proxy","psyc","query","res","resource","rmi","rsync","rtmp","secondlife","sftp","sgn","skype","smb","soldat","spotify","ssh","steam","svn","teamspeak","things","udp","unreal","ut2004","ventrilo","view-source","webcal","wtai","wyciwyg","xfire","xri","ymsgr"]},{}],5:[function(a,b,c){function d(a){return Object.prototype.toString.call(a)}function e(a){return d(a)==="[object String]"}function g(a,b){return a?f.call(a,b):!1}function h(a){var b=[].slice.call(arguments,1);return b.forEach(function(b){if(!b)return;if(typeof b!="object")throw new TypeError(b+"must be object");Object.keys(b).forEach(function(c){a[c]=b[c]})}),a}function j(a){return a.indexOf("\\")<0?a:a.replace(i,"$1")}function k(a){return a>=55296&&a<=57343?!1:a>=64976&&a<=65007?!1:(a&65535)===65535||(a&65535)===65534?!1:a>=0&&a<=8?!1:a===11?!1:a>=14&&a<=31?!1:a>=127&&a<=159?!1:a>1114111?!1:!0}function l(a){if(a>65535){a-=65536;var b=55296+(a>>10),c=56320+(a&1023);return String.fromCharCode(b,c)}return String.fromCharCode(a)}function p(a,b){var c=0;if(g(o,b))return o[b];if(b.charCodeAt(0)===35&&n.test(b)){c=b[1].toLowerCase()==="x"?parseInt(b.slice(2),16):parseInt(b.slice(1),10);if(k(c))return l(c)}return a}function q(a){return a.indexOf("&")<0?a:a.replace(m,p)}function u(a){return t[a]}function v(a){return r.test(a)?a.replace(s,u):a}"use strict";var f=Object.prototype.hasOwnProperty,i=/\\([\\!"#$%&'()*+,.\/:;<=>?@[\]^_`{|}~-])/g,m=/&([a-z#][a-z0-9]{1,31});/gi,n=/^#((?:x[a-f0-9]{1,8}|[0-9]{1,8}))/i,o=a("./entities"),r=/[&<>"]/,s=/[&<>"]/g,t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"};c.assign=h,c.isString=e,c.has=g,c.unescapeMd=j,c.isValidEntityCode=k,c.fromCodePoint=l,c.replaceEntities=q,c.escapeHtml=v},{"./entities":1}],6:[function(a,b,c){"use strict",b.exports={options:{html:!0,xhtmlOut:!0,breaks:!1,langPrefix:"language-",linkify:!1,linkTarget:"",typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["block","inline","references","abbr2"]},block:{rules:["blockquote","code","fences","heading","hr","htmlblock","lheading","list","paragraph"]},inline:{rules:["autolink","backticks","emphasis","entity","escape","htmltag","links","newline","text"]}}}},{}],7:[function(a,b,c){"use strict",b.exports={options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,linkTarget:"",typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{rules:["block","inline","references","replacements","linkify","smartquotes","references","abbr2","footnote_tail"]},block:{rules:["blockquote","code","fences","footnote","heading","hr","htmlblock","lheading","list","paragraph","table"]},inline:{rules:["autolink","backticks","del","emphasis","entity","escape","footnote_ref","htmltag","links","newline","text"]}}}},{}],8:[function(a,b,c){"use strict",b.exports={options:{html:!1,xhtmlOut:!1,breaks:!1,langPrefix:"language-",linkify:!1,linkTarget:"",typographer:!1,quotes:"“”‘’",highlight:null,maxNesting:20},components:{core:{},block:{},inline:{}}}},{}],9:[function(a,b,c){"use strict";var d=a("../common/utils").replaceEntities;b.exports=function(a){var b=d(a);try{b=decodeURI(b)}catch(c){}return encodeURI(b)}},{"../common/utils":5}],10:[function(a,b,c){"use strict",b.exports=function(a){return a.trim().replace(/\s+/g," ").toUpperCase()}},{}],11:[function(a,b,c){"use strict";var d=a("./normalize_link"),e=a("../common/utils").unescapeMd;b.exports=function f(a,b){var c,f,g,h=b,i=a.posMax;if(a.src.charCodeAt(b)===60){b++;while(b<i){c=a.src.charCodeAt(b);if(c===10)return!1;if(c===62)return g=d(e(a.src.slice(h+1,b))),a.parser.validateLink(g)?(a.pos=b+1,a.linkContent=g,!0):!1;if(c===92&&b+1<i){b+=2;continue}b++}return!1}f=0;while(b<i){c=a.src.charCodeAt(b);if(c===32)break;if(c>8&&c<14)break;if(c===92&&b+1<i){b+=2;continue}if(c===40){f++;if(f>1)break}if(c===41){f--;if(f<0)break}b++}return h===b?!1:(g=e(a.src.slice(h,b)),a.parser.validateLink(g)?(a.linkContent=g,a.pos=b,!0):!1)}},{"../common/utils":5,"./normalize_link":9}],12:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f=-1,g=a.posMax,h=a.pos,i=a.isInLabel;if(a.isInLabel)return-1;if(a.labelUnmatchedScopes)return a.labelUnmatchedScopes--,-1;a.pos=b+1,a.isInLabel=!0,c=1;while(a.pos<g){e=a.src.charCodeAt(a.pos);if(e===91)c++;else if(e===93){c--;if(c===0){d=!0;break}}a.parser.skipToken(a)}return d?(f=a.pos,a.labelUnmatchedScopes=0):a.labelUnmatchedScopes=c-1,a.pos=h,a.isInLabel=i,f}},{}],13:[function(a,b,c){"use strict";var d=a("../common/utils").unescapeMd;b.exports=function e(a,b){var c,e=b,f=a.posMax,g=a.src.charCodeAt(b);if(g!==34&&g!==39&&g!==40)return!1;b++,g===40&&(g=41);while(b<f){c=a.src.charCodeAt(b);if(c===g)return a.pos=b+1,a.linkContent=d(a.src.slice(e+1,b)),!0;if(c===92&&b+1<f){b+=2;continue}b++}return!1}},{"../common/utils":5}],14:[function(a,b,c){function k(a,b,c){this.src=b,this.env=c,this.options=a.options,this.tokens=[],this.inlineMode=!1,this.inline=a.inline,this.block=a.block,this.renderer=a.renderer,this.typographer=a.typographer}function l(a,b){typeof a!="string"&&(b=a,a="default"),this.inline=new h,this.block=new g,this.core=new f,this.renderer=new e,this.ruler=new i,this.options={},this.configure(j[a]),this.set(b||{})}"use strict";var d=a("./common/utils").assign,e=a("./renderer"),f=a("./parser_core"),g=a("./parser_block"),h=a("./parser_inline"),i=a("./ruler"),j={"default":a("./configs/default"),full:a("./configs/full"),commonmark:a("./configs/commonmark")};l.prototype.set=function(a){d(this.options,a)},l.prototype.configure=function(a){var b=this;if(!a)throw new Error("Wrong `remarkable` preset, check name/content");a.options&&b.set(a.options),a.components&&Object.keys(a.components).forEach(function(c){a.components[c].rules&&b[c].ruler.enable(a.components[c].rules,!0)})},l.prototype.use=function(a,b){return a(this,b),this},l.prototype.parse=function(a,b){var c=new k(this,a,b);return this.core.process(c),c.tokens},l.prototype.render=function(a,b){return b=b||{},this.renderer.render(this.parse(a,b),this.options,b)},l.prototype.parseInline=function(a,b){var c=new k(this,a,b);return c.inlineMode=!0,this.core.process(c),c.tokens},l.prototype.renderInline=function(a,b){return b=b||{},this.renderer.render(this.parseInline(a,b),this.options,b)},b.exports=l,b.exports.utils=a("./common/utils")},{"./common/utils":5,"./configs/commonmark":6,"./configs/default":7,"./configs/full":8,"./parser_block":15,"./parser_core":16,"./parser_inline":17,"./renderer":18,"./ruler":19}],15:[function(a,b,c){function g(){this.ruler=new d;for(var a=0;a<f.length;a++)this.ruler.push(f[a][0],f[a][1],{alt:(f[a][2]||[]).slice()})}"use strict";var d=a("./ruler"),e=a("./rules_block/state_block"),f=[["code",a("./rules_block/code")],["fences",a("./rules_block/fences"),["paragraph","blockquote","list"]],["blockquote",a("./rules_block/blockquote"),["paragraph","blockquote","list"]],["hr",a("./rules_block/hr"),["paragraph","blockquote","list"]],["list",a("./rules_block/list"),["paragraph","blockquote"]],["footnote",a("./rules_block/footnote"),["paragraph"]],["heading",a("./rules_block/heading"),["paragraph","blockquote"]],["lheading",a("./rules_block/lheading")],["htmlblock",a("./rules_block/htmlblock"),["paragraph","blockquote"]],["table",a("./rules_block/table"),["paragraph"]],["deflist",a("./rules_block/deflist"),["paragraph"]],["paragraph",a("./rules_block/paragraph")]];g.prototype.tokenize=function(a,b,c){var d=this.ruler.getRules(""),e=d.length,f=b,g=!1,h,i;while(f<c){a.line=f=a.skipEmptyLines(f);if(f>=c)break;if(a.tShift[f]<a.blkIndent)break;for(i=0;i<e;i++){h=d[i](a,f,c,!1);if(h)break}a.tight=!g,a.isEmpty(a.line-1)&&(g=!0),f=a.line;if(f<c&&a.isEmpty(f)){g=!0,f++;if(f<c&&a.parentType==="list"&&a.isEmpty(f))break;a.line=f}}};var h=/[\n\t]/g,i=/\r[\n\u0085]|[\u2424\u2028\u0085]/g,j=/\u00a0/g;g.prototype.parse=function(a,b,c,d){var f,g=0,k=0;if(!a)return[];a=a.replace(j," "),a=a.replace(i,"\n"),a.indexOf("\t")>=0&&(a=a.replace(h,function(b,c){var d;return a.charCodeAt(c)===10?(g=c+1,k=0,b):(d="    ".slice((c-g-k)%4),k=c-g+1,d)})),f=new e(a,this,b,c,d),this.tokenize(f,f.line,f.lineMax)},b.exports=g},{"./ruler":19,"./rules_block/blockquote":21,"./rules_block/code":22,"./rules_block/deflist":23,"./rules_block/fences":24,"./rules_block/footnote":25,"./rules_block/heading":26,"./rules_block/hr":27,"./rules_block/htmlblock":28,"./rules_block/lheading":29,"./rules_block/list":30,"./rules_block/paragraph":31,"./rules_block/state_block":32,"./rules_block/table":33}],16:[function(a,b,c){function f(){this.options={},this.ruler=new d;for(var a=0;a<e.length;a++)this.ruler.push(e[a][0],e[a][1])}"use strict";var d=a("./ruler"),e=[["block",a("./rules_core/block")],["abbr",a("./rules_core/abbr")],["references",a("./rules_core/references")],["inline",a("./rules_core/inline")],["footnote_tail",a("./rules_core/footnote_tail")],["abbr2",a("./rules_core/abbr2")],["replacements",a("./rules_core/replacements")],["smartquotes",a("./rules_core/smartquotes")],["linkify",a("./rules_core/linkify")]];f.prototype.process=function(a){var b,c,d;d=this.ruler.getRules("");for(b=0,c=d.length;b<c;b++)d[b](a)},b.exports=f},{"./ruler":19,"./rules_core/abbr":34,"./rules_core/abbr2":35,"./rules_core/block":36,"./rules_core/footnote_tail":37,"./rules_core/inline":38,"./rules_core/linkify":39,"./rules_core/references":40,"./rules_core/replacements":41,"./rules_core/smartquotes":42}],17:[function(a,b,c){function h(){this.ruler=new d;for(var a=0;a<g.length;a++)this.ruler.push(g[a][0],g[a][1]);this.validateLink=i}function i(a){var b=["vbscript","javascript","file","data"],c=a.trim().toLowerCase();return c=f.replaceEntities(c),c.indexOf(":")!==-1&&b.indexOf(c.split(":")[0])!==-1?!1:!0}"use strict";var d=a("./ruler"),e=a("./rules_inline/state_inline"),f=a("./common/utils"),g=[["text",a("./rules_inline/text")],["newline",a("./rules_inline/newline")],["escape",a("./rules_inline/escape")],["backticks",a("./rules_inline/backticks")],["del",a("./rules_inline/del")],["ins",a("./rules_inline/ins")],["mark",a("./rules_inline/mark")],["emphasis",a("./rules_inline/emphasis")],["sub",a("./rules_inline/sub")],["sup",a("./rules_inline/sup")],["links",a("./rules_inline/links")],["footnote_inline",a("./rules_inline/footnote_inline")],["footnote_ref",a("./rules_inline/footnote_ref")],["autolink",a("./rules_inline/autolink")],["htmltag",a("./rules_inline/htmltag")],["entity",a("./rules_inline/entity")]];h.prototype.skipToken=function(a){var b=this.ruler.getRules(""),c=b.length,d=a.pos,e,f;if((f=a.cacheGet(d))>0){a.pos=f;return}for(e=0;e<c;e++)if(b[e](a,!0)){a.cacheSet(d,a.pos);return}a.pos++,a.cacheSet(d,a.pos)},h.prototype.tokenize=function(a){var b=this.ruler.getRules(""),c=b.length,d=a.posMax,e,f;while(a.pos<d){for(f=0;f<c;f++){e=b[f](a,!1);if(e)break}if(e){if(a.pos>=d)break;continue}a.pending+=a.src[a.pos++]}a.pending&&a.pushPending()},h.prototype.parse=function(a,b,c,d){var f=new e(a,this,b,c,d);this.tokenize(f)},b.exports=h},{"./common/utils":5,"./ruler":19,"./rules_inline/autolink":43,"./rules_inline/backticks":44,"./rules_inline/del":45,"./rules_inline/emphasis":46,"./rules_inline/entity":47,"./rules_inline/escape":48,"./rules_inline/footnote_inline":49,"./rules_inline/footnote_ref":50,"./rules_inline/htmltag":51,"./rules_inline/ins":52,"./rules_inline/links":53,"./rules_inline/mark":54,"./rules_inline/newline":55,"./rules_inline/state_inline":56,"./rules_inline/sub":57,"./rules_inline/sup":58,"./rules_inline/text":59}],18:[function(a,b,c){function f(){this.rules=d.assign({},e),this.getBreak=e.getBreak}"use strict";var d=a("./common/utils"),e=a("./rules");b.exports=f,f.prototype.renderInline=function(a,b,c){var d=this.rules,e=a.length,f=0,g="";while(e--)g+=d[a[f].type](a,f++,b,c,this);return g},f.prototype.render=function(a,b,c){var d=this.rules,e=a.length,f=-1,g="";while(++f<e)a[f].type==="inline"?g+=this.renderInline(a[f].children,b,c):g+=d[a[f].type](a,f,b,c,this);return g}},{"./common/utils":5,"./rules":20}],19:[function(a,b,c){function d(){this.__rules__=[],this.__cache__=null}"use strict",d.prototype.__find__=function(a){var b=this.__rules__.length,c=-1;while(b--)if(this.__rules__[++c].name===a)return c;return-1},d.prototype.__compile__=function(){var a=this,b=[""];a.__rules__.forEach(function(a){if(!a.enabled)return;a.alt.forEach(function(a){b.indexOf(a)<0&&b.push(a)})}),a.__cache__={},b.forEach(function(b){a.__cache__[b]=[],a.__rules__.forEach(function(c){if(!c.enabled)return;if(b&&c.alt.indexOf(b)<0)return;a.__cache__[b].push(c.fn)})})},d.prototype.at=function(a,b,c){var d=this.__find__(a),e=c||{};if(d===-1)throw new Error("Parser rule not found: "+a);this.__rules__[d].fn=b,this.__rules__[d].alt=e.alt||[],this.__cache__=null},d.prototype.before=function(a,b,c,d){var e=this.__find__(a),f=d||{};if(e===-1)throw new Error("Parser rule not found: "+a);this.__rules__.splice(e,0,{name:b,enabled:!0,fn:c,alt:f.alt||[]}),this.__cache__=null},d.prototype.after=function(a,b,c,d){var e=this.__find__(a),f=d||{};if(e===-1)throw new Error("Parser rule not found: "+a);this.__rules__.splice(e+1,0,{name:b,enabled:!0,fn:c,alt:f.alt||[]}),this.__cache__=null},d.prototype.push=function(a,b,c){var d=c||{};this.__rules__.push({name:a,enabled:!0,fn:b,alt:d.alt||[]}),this.__cache__=null},d.prototype.enable=function(a,b){a=Array.isArray(a)?a:[a],b&&this.__rules__.forEach(function(a){a.enabled=!1}),a.forEach(function(a){var b=this.__find__(a);if(b<0)throw new Error("Rules manager: invalid rule name "+a);this.__rules__[b].enabled=!0},this),this.__cache__=null},d.prototype.disable=function(a){a=Array.isArray(a)?a:[a],a.forEach(function(a){var b=this.__find__(a);if(b<0)throw new Error("Rules manager: invalid rule name "+a);this.__rules__[b].enabled=!1},this),this.__cache__=null},d.prototype.getRules=function(a){return this.__cache__===null&&this.__compile__(),this.__cache__[a]||[]},b.exports=d},{}],20:[function(a,b,c){function i(a,b){return++b>=a.length-2?b:a[b].type==="paragraph_open"&&a[b].tight&&a[b+1].type==="inline"&&a[b+1].content.length===0&&a[b+2].type==="paragraph_close"&&a[b+2].tight?i(a,b+2):b}"use strict";var d=a("./common/utils").has,e=a("./common/utils").unescapeMd,f=a("./common/utils").replaceEntities,g=a("./common/utils").escapeHtml,h={};h.blockquote_open=function(){return"<blockquote>\n"},h.blockquote_close=function(a,b){return"</blockquote>"+j(a,b)},h.code=function(a,b){return a[b].block?"<pre><code>"+g(a[b].content)+"</code></pre>"+j(a,b):"<code>"+g(a[b].content)+"</code>"},h.fence=function(a,b,c,h,i){var k=a[b],l="",m=c.langPrefix,n="",o,p,q;if(k.params){o=k.params.split(/\s+/g),p=o.join(" ");if(d(i.rules.fence_custom,o[0]))return i.rules.fence_custom[o[0]](a,b,c,h,i);n=g(f(e(p))),l=' class="'+m+n+'"'}return c.highlight?q=c.highlight.apply(c.highlight,[k.content].concat(o))||g(k.content):q=g(k.content),"<pre><code"+l+">"+q+"</code></pre>"+j(a,b)},h.fence_custom={},h.heading_open=function(a,b){return"<h"+a[b].hLevel+">"},h.heading_close=function(a,b){return"</h"+a[b].hLevel+">\n"},h.hr=function(a,b,c){return(c.xhtmlOut?"<hr />":"<hr>")+j(a,b)},h.bullet_list_open=function(){return"<ul>\n"},h.bullet_list_close=function(a,b){return"</ul>"+j(a,b)},h.list_item_open=function(){return"<li>"},h.list_item_close=function(){return"</li>\n"},h.ordered_list_open=function(a,b){var c=a[b],d=c.order>1?' start="'+c.order+'"':"";return"<ol"+d+">\n"},h.ordered_list_close=function(a,b){return"</ol>"+j(a,b)},h.paragraph_open=function(a,b){return a[b].tight?"":"<p>"},h.paragraph_close=function(a,b){var c=!(a[b].tight&&b&&a[b-1].type==="inline"&&!a[b-1].content);return(a[b].tight?"":"</p>")+(c?j(a,b):"")},h.link_open=function(a,b,c){var d=a[b].title?' title="'+g(f(a[b].title))+'"':"",e=c.linkTarget?' target="'+c.linkTarget+'"':"";return'<a href="'+g(a[b].href)+'"'+d+e+">"},h.link_close=function(){return"</a>"},h.image=function(a,b,c){var d=' src="'+g(a[b].src)+'"',h=a[b].title?' title="'+g(f(a[b].title))+'"':"",i=' alt="'+(a[b].alt?g(f(e(a[b].alt))):"")+'"',j=c.xhtmlOut?" /":"";return"<img"+d+i+h+j+">"},h.table_open=function(){return"<table>\n"},h.table_close=function(){return"</table>\n"},h.thead_open=function(){return"<thead>\n"},h.thead_close=function(){return"</thead>\n"},h.tbody_open=function(){return"<tbody>\n"},h.tbody_close=function(){return"</tbody>\n"},h.tr_open=function(){return"<tr>"},h.tr_close=function(){return"</tr>\n"},h.th_open=function(a,b){var c=a[b];return"<th"+(c.align?' style="text-align:'+c.align+'"':"")+">"},h.th_close=function(){return"</th>"},h.td_open=function(a,b){var c=a[b];return"<td"+(c.align?' style="text-align:'+c.align+'"':"")+">"},h.td_close=function(){return"</td>"},h.strong_open=function(){return"<strong>"},h.strong_close=function(){return"</strong>"},h.em_open=function(){return"<em>"},h.em_close=function(){return"</em>"},h.del_open=function(){return"<del>"},h.del_close=function(){return"</del>"},h.ins_open=function(){return"<ins>"},h.ins_close=function(){return"</ins>"},h.mark_open=function(){return"<mark>"},h.mark_close=function(){return"</mark>"},h.sub=function(a,b){return"<sub>"+g(a[b].content)+"</sub>"},h.sup=function(a,b){return"<sup>"+g(a[b].content)+"</sup>"},h.hardbreak=function(a,b,c){return c.xhtmlOut?"<br />\n":"<br>\n"},h.softbreak=function(a,b,c){return c.breaks?c.xhtmlOut?"<br />\n":"<br>\n":"\n"},h.text=function(a,b){return g(a[b].content)},h.htmlblock=function(a,b){return a[b].content},h.htmltag=function(a,b){return a[b].content},h.abbr_open=function(a,b){return'<abbr title="'+g(f(a[b].title))+'">'},h.abbr_close=function(){return"</abbr>"},h.footnote_ref=function(a,b){var c=Number(a[b].id+1).toString(),d="fnref"+c;return a[b].subId>0&&(d+=":"+a[b].subId),'<sup class="footnote-ref"><a href="#fn'+c+'" id="'+d+'">['+c+"]</a></sup>"},h.footnote_block_open=function(a,b,c){var d=c.xhtmlOut?'<hr class="footnotes-sep" />\n':'<hr class="footnotes-sep">\n';return d+'<section class="footnotes">\n<ol class="footnotes-list">\n'},h.footnote_block_close=function(){return"</ol>\n</section>\n"},h.footnote_open=function(a,b){var c=Number(a[b].id+1).toString();return'<li id="fn'+c+'"  class="footnote-item">'},h.footnote_close=function(){return"</li>\n"},h.footnote_anchor=function(a,b){var c=Number(a[b].id+1).toString(),d="fnref"+c;return a[b].subId>0&&(d+=":"+a[b].subId),' <a href="#'+d+'" class="footnote-backref">↩</a>'},h.dl_open=function(){return"<dl>\n"},h.dt_open=function(){return"<dt>"},h.dd_open=function(){return"<dd>"},h.dl_close=function(){return"</dl>\n"},h.dt_close=function(){return"</dt>\n"},h.dd_close=function(){return"</dd>\n"};var j=h.getBreak=function(a,b){return b=i(a,b),b<a.length&&a[b].type==="list_item_close"?"":"\n"};b.exports=h},{"./common/utils":5}],21:[function(a,b,c){"use strict",b.exports=function d(a,b,c,d){var e,f,g,h,i,j,k,l,m,n,o,p=a.bMarks[b]+a.tShift[b],q=a.eMarks[b];if(p>q)return!1;if(a.src.charCodeAt(p++)!==62)return!1;if(a.level>=a.options.maxNesting)return!1;if(d)return!0;a.src.charCodeAt(p)===32&&p++,i=a.blkIndent,a.blkIndent=0,h=[a.bMarks[b]],a.bMarks[b]=p,p=p<q?a.skipSpaces(p):p,f=p>=q,g=[a.tShift[b]],a.tShift[b]=p-a.bMarks[b],l=a.parser.ruler.getRules("blockquote");for(e=b+1;e<c;e++){p=a.bMarks[e]+a.tShift[e],q=a.eMarks[e];if(p>=q)break;if(a.src.charCodeAt(p++)===62){a.src.charCodeAt(p)===32&&p++,h.push(a.bMarks[e]),a.bMarks[e]=p,p=p<q?a.skipSpaces(p):p,f=p>=q,g.push(a.tShift[e]),a.tShift[e]=p-a.bMarks[e];continue}if(f)break;o=!1;for(m=0,n=l.length;m<n;m++)if(l[m](a,e,c,!0)){o=!0;break}if(o)break;h.push(a.bMarks[e]),g.push(a.tShift[e]),a.tShift[e]=-1337}j=a.parentType,a.parentType="blockquote",a.tokens.push({type:"blockquote_open",lines:k=[b,0],level:a.level++}),a.parser.tokenize(a,b,e),a.tokens.push({type:"blockquote_close",level:--a.level}),a.parentType=j,k[1]=a.line;for(m=0;m<g.length;m++)a.bMarks[m+b]=h[m],a.tShift[m+b]=g[m];return a.blkIndent=i,!0}},{}],22:[function(a,b,c){"use strict",b.exports=function d(a,b,c){var d,e;if(a.tShift[b]-a.blkIndent<4)return!1;e=d=b+1;while(d<c){if(a.isEmpty(d)){d++;continue}if(a.tShift[d]-a.blkIndent>=4){d++,e=d;continue}break}return a.line=d,a.tokens.push({type:"code",content:a.getLines(b,e,4+a.blkIndent,!0),block:!0,lines:[b,a.line],level:a.level}),!0}},{}],23:[function(a,b,c){function d(a,b){var c,d,e=a.bMarks[b]+a.tShift[b],f=a.eMarks[b];return e>=f?-1:(d=a.src.charCodeAt(e++),d!==126&&d!==58?-1:(c=a.skipSpaces(e),e===c?-1:c>=f?-1:c))}function e(a,b){var c,d,e=a.level+2;for(c=b+2,d=a.tokens.length-2;c<d;c++)a.tokens[c].level===e&&a.tokens[c].type==="paragraph_open"&&(a.tokens[c+2].tight=!0,a.tokens[c].tight=!0,c+=2)}"use strict",b.exports=function f(a,b,c,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t;if(f)return a.ddIndent<0?!1:d(a,b)>=0;m=b+1;if(a.isEmpty(m)&&++m>c)return!1;if(a.tShift[m]<a.blkIndent)return!1;g=d(a,m);if(g<0)return!1;if(a.level>=a.options.maxNesting)return!1;l=a.tokens.length,a.tokens.push({type:"dl_open",lines:k=[b,0],level:a.level++}),i=b,h=m;u:for(;;){t=!0,s=!1,a.tokens.push({type:"dt_open",lines:[i,i],level:a.level++}),a.tokens.push({type:"inline"
,content:a.getLines(i,i+1,a.blkIndent,!1).trim(),level:a.level+1,lines:[i,i],children:[]}),a.tokens.push({type:"dt_close",level:--a.level});for(;;){a.tokens.push({type:"dd_open",lines:j=[m,0],level:a.level++}),r=a.tight,o=a.ddIndent,n=a.blkIndent,q=a.tShift[h],p=a.parentType,a.blkIndent=a.ddIndent=a.tShift[h]+2,a.tShift[h]=g-a.bMarks[h],a.tight=!0,a.parentType="deflist",a.parser.tokenize(a,h,c,!0);if(!a.tight||s)t=!1;s=a.line-h>1&&a.isEmpty(a.line-1),a.tShift[h]=q,a.tight=r,a.parentType=p,a.blkIndent=n,a.ddIndent=o,a.tokens.push({type:"dd_close",level:--a.level}),j[1]=m=a.line;if(m>=c)break u;if(a.tShift[m]<a.blkIndent)break u;g=d(a,m);if(g<0)break;h=m}if(m>=c)break;i=m;if(a.isEmpty(i))break;if(a.tShift[i]<a.blkIndent)break;h=i+1;if(h>=c)break;a.isEmpty(h)&&h++;if(h>=c)break;if(a.tShift[h]<a.blkIndent)break;g=d(a,h);if(g<0)break}return a.tokens.push({type:"dl_close",level:--a.level}),k[1]=m,a.line=m,t&&e(a,l),!0}},{}],24:[function(a,b,c){"use strict",b.exports=function d(a,b,c,d){var e,f,g,h,i,j=!1,k=a.bMarks[b]+a.tShift[b],l=a.eMarks[b];if(k+3>l)return!1;e=a.src.charCodeAt(k);if(e!==126&&e!==96)return!1;i=k,k=a.skipChars(k,e),f=k-i;if(f<3)return!1;g=a.src.slice(k,l).trim();if(g.indexOf("`")>=0)return!1;if(d)return!0;h=b;for(;;){h++;if(h>=c)break;k=i=a.bMarks[h]+a.tShift[h],l=a.eMarks[h];if(k<l&&a.tShift[h]<a.blkIndent)break;if(a.src.charCodeAt(k)!==e)continue;if(a.tShift[h]-a.blkIndent>=4)continue;k=a.skipChars(k,e);if(k-i<f)continue;k=a.skipSpaces(k);if(k<l)continue;j=!0;break}return f=a.tShift[b],a.line=h+(j?1:0),a.tokens.push({type:"fence",params:g,content:a.getLines(b+1,h,f,!0),lines:[b,a.line],level:a.level}),!0}},{}],25:[function(a,b,c){"use strict",b.exports=function d(a,b,c,d){var e,f,g,h,i,j=a.bMarks[b]+a.tShift[b],k=a.eMarks[b];if(j+4>k)return!1;if(a.src.charCodeAt(j)!==91)return!1;if(a.src.charCodeAt(j+1)!==94)return!1;if(a.level>=a.options.maxNesting)return!1;for(h=j+2;h<k;h++){if(a.src.charCodeAt(h)===32)return!1;if(a.src.charCodeAt(h)===93)break}return h===j+2?!1:h+1>=k||a.src.charCodeAt(++h)!==58?!1:d?!0:(h++,a.env.footnotes||(a.env.footnotes={}),a.env.footnotes.refs||(a.env.footnotes.refs={}),i=a.src.slice(j+2,h-2),a.env.footnotes.refs[":"+i]=-1,a.tokens.push({type:"footnote_reference_open",label:i,level:a.level++}),e=a.bMarks[b],f=a.tShift[b],g=a.parentType,a.tShift[b]=a.skipSpaces(h)-h,a.bMarks[b]=h,a.blkIndent+=4,a.parentType="footnote",a.tShift[b]<a.blkIndent&&(a.tShift[b]+=a.blkIndent,a.bMarks[b]-=a.blkIndent),a.parser.tokenize(a,b,c,!0),a.parentType=g,a.blkIndent-=4,a.tShift[b]=f,a.bMarks[b]=e,a.tokens.push({type:"footnote_reference_close",level:--a.level}),!0)}},{}],26:[function(a,b,c){"use strict",b.exports=function d(a,b,c,d){var e,f,g,h=a.bMarks[b]+a.tShift[b],i=a.eMarks[b];if(h>=i)return!1;e=a.src.charCodeAt(h);if(e!==35||h>=i)return!1;f=1,e=a.src.charCodeAt(++h);while(e===35&&h<i&&f<=6)f++,e=a.src.charCodeAt(++h);return f>6?!1:d?!0:(i=a.skipCharsBack(i,32,h),g=a.skipCharsBack(i,35,h),g>h&&a.src.charCodeAt(g-1)===32&&(i=g),a.line=b+1,a.tokens.push({type:"heading_open",hLevel:f,lines:[b,a.line],level:a.level}),h<i&&a.tokens.push({type:"inline",content:a.src.slice(h,i).trim(),level:a.level+1,lines:[b,a.line],children:[]}),a.tokens.push({type:"heading_close",hLevel:f,level:a.level}),!0)}},{}],27:[function(a,b,c){"use strict",b.exports=function d(a,b,c,d){var e,f,g,h=a.bMarks[b],i=a.eMarks[b];h+=a.tShift[b];if(h>i)return!1;e=a.src.charCodeAt(h++);if(e!==42&&e!==45&&e!==95)return!1;f=1;while(h<i){g=a.src.charCodeAt(h++);if(g!==e&&g!==32)return!1;g===e&&f++}return f<3?!1:d?!0:(a.line=b+1,a.tokens.push({type:"hr",lines:[b,a.line],level:a.level}),!0)}},{}],28:[function(a,b,c){function g(a){var b=a|32;return b>=97&&b<=122}"use strict";var d=a("../common/html_blocks"),e=/^<([a-zA-Z]{1,15})[\s\/>]/,f=/^<\/([a-zA-Z]{1,15})[\s>]/;b.exports=function h(a,b,c,h){var i,j,k,l=a.bMarks[b],m=a.eMarks[b],n=a.tShift[b];l+=n;if(!a.options.html)return!1;if(n>3||l+2>=m)return!1;if(a.src.charCodeAt(l)!==60)return!1;i=a.src.charCodeAt(l+1);if(i===33||i===63){if(h)return!0}else{if(i!==47&&!g(i))return!1;if(i===47){j=a.src.slice(l,m).match(f);if(!j)return!1}else{j=a.src.slice(l,m).match(e);if(!j)return!1}if(d[j[1].toLowerCase()]!==!0)return!1;if(h)return!0}k=b+1;while(k<a.lineMax&&!a.isEmpty(k))k++;return a.line=k,a.tokens.push({type:"htmlblock",level:a.level,lines:[b,a.line],content:a.getLines(b,k,0,!0)}),!0}},{"../common/html_blocks":2}],29:[function(a,b,c){"use strict",b.exports=function d(a,b,c){var d,e,f,g=b+1;return g>=c?!1:a.tShift[g]<a.blkIndent?!1:a.tShift[g]-a.blkIndent>3?!1:(e=a.bMarks[g]+a.tShift[g],f=a.eMarks[g],e>=f?!1:(d=a.src.charCodeAt(e),d!==45&&d!==61?!1:(e=a.skipChars(e,d),e=a.skipSpaces(e),e<f?!1:(e=a.bMarks[b]+a.tShift[b],a.line=g+1,a.tokens.push({type:"heading_open",hLevel:d===61?1:2,lines:[b,a.line],level:a.level}),a.tokens.push({type:"inline",content:a.src.slice(e,a.eMarks[b]).trim(),level:a.level+1,lines:[b,a.line-1],children:[]}),a.tokens.push({type:"heading_close",hLevel:d===61?1:2,level:a.level}),!0))))}},{}],30:[function(a,b,c){function d(a,b){var c,d,e;return d=a.bMarks[b]+a.tShift[b],e=a.eMarks[b],d>=e?-1:(c=a.src.charCodeAt(d++),c!==42&&c!==45&&c!==43?-1:d<e&&a.src.charCodeAt(d)!==32?-1:d)}function e(a,b){var c,d=a.bMarks[b]+a.tShift[b],e=a.eMarks[b];if(d+1>=e)return-1;c=a.src.charCodeAt(d++);if(c<48||c>57)return-1;for(;;){if(d>=e)return-1;c=a.src.charCodeAt(d++);if(c>=48&&c<=57)continue;if(c===41||c===46)break;return-1}return d<e&&a.src.charCodeAt(d)!==32?-1:d}function f(a,b){var c,d,e=a.level+2;for(c=b+2,d=a.tokens.length-2;c<d;c++)a.tokens[c].level===e&&a.tokens[c].type==="paragraph_open"&&(a.tokens[c+2].tight=!0,a.tokens[c].tight=!0,c+=2)}"use strict",b.exports=function g(a,b,c,g){var h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=!0,A,B,C,D;if((o=e(a,b))>=0)t=!0;else if((o=d(a,b))>=0)t=!1;else return!1;if(a.level>=a.options.maxNesting)return!1;s=a.src.charCodeAt(o-1);if(g)return!0;v=a.tokens.length,t?(n=a.bMarks[b]+a.tShift[b],r=Number(a.src.substr(n,o-n-1)),a.tokens.push({type:"ordered_list_open",order:r,lines:x=[b,0],level:a.level++})):a.tokens.push({type:"bullet_list_open",lines:x=[b,0],level:a.level++}),h=b,w=!1,A=a.parser.ruler.getRules("list");while(h<c){u=a.skipSpaces(o),p=a.eMarks[h],u>=p?q=1:q=u-o,q>4&&(q=1),q<1&&(q=1),i=o-a.bMarks[h]+q,a.tokens.push({type:"list_item_open",lines:y=[b,0],level:a.level++}),k=a.blkIndent,l=a.tight,j=a.tShift[b],m=a.parentType,a.tShift[b]=u-a.bMarks[b],a.blkIndent=i,a.tight=!0,a.parentType="list",a.parser.tokenize(a,b,c,!0);if(!a.tight||w)z=!1;w=a.line-b>1&&a.isEmpty(a.line-1),a.blkIndent=k,a.tShift[b]=j,a.tight=l,a.parentType=m,a.tokens.push({type:"list_item_close",level:--a.level}),h=b=a.line,y[1]=h,u=a.bMarks[b];if(h>=c)break;if(a.isEmpty(h))break;if(a.tShift[h]<a.blkIndent)break;D=!1;for(B=0,C=A.length;B<C;B++)if(A[B](a,h,c,!0)){D=!0;break}if(D)break;if(t){o=e(a,h);if(o<0)break}else{o=d(a,h);if(o<0)break}if(s!==a.src.charCodeAt(o-1))break}return a.tokens.push({type:t?"ordered_list_close":"bullet_list_close",level:--a.level}),x[1]=h,a.line=h,z&&f(a,v),!0}},{}],31:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f,g,h=b+1,i;c=a.lineMax;if(h<c&&!a.isEmpty(h)){i=a.parser.ruler.getRules("paragraph");for(;h<c&&!a.isEmpty(h);h++){if(a.tShift[h]-a.blkIndent>3)continue;e=!1;for(f=0,g=i.length;f<g;f++)if(i[f](a,h,c,!0)){e=!0;break}if(e)break}}return d=a.getLines(b,h,a.blkIndent,!1).trim(),a.line=h,d.length&&(a.tokens.push({type:"paragraph_open",tight:!1,lines:[b,a.line],level:a.level}),a.tokens.push({type:"inline",content:d,level:a.level+1,lines:[b,a.line],children:[]}),a.tokens.push({type:"paragraph_close",tight:!1,level:a.level})),!0}},{}],32:[function(a,b,c){function d(a,b,c,d,e){var f,g,h,i,j,k,l;this.src=a,this.parser=b,this.options=c,this.env=d,this.tokens=e,this.bMarks=[],this.eMarks=[],this.tShift=[],this.blkIndent=0,this.line=0,this.lineMax=0,this.tight=!1,this.parentType="root",this.ddIndent=-1,this.level=0,this.result="",g=this.src,k=0,l=!1;for(h=i=k=0,j=g.length;i<j;i++){f=g.charCodeAt(i);if(!l){if(f===32){k++;continue}l=!0}if(f===10||i===j-1)f!==10&&i++,this.bMarks.push(h),this.eMarks.push(i),this.tShift.push(k),l=!1,k=0,h=i+1}this.bMarks.push(g.length),this.eMarks.push(g.length),this.tShift.push(0),this.lineMax=this.bMarks.length-1}"use strict",d.prototype.isEmpty=function(a){return this.bMarks[a]+this.tShift[a]>=this.eMarks[a]},d.prototype.skipEmptyLines=function(a){for(var b=this.lineMax;a<b;a++)if(this.bMarks[a]+this.tShift[a]<this.eMarks[a])break;return a},d.prototype.skipSpaces=function(a){for(var b=this.src.length;a<b;a++)if(this.src.charCodeAt(a)!==32)break;return a},d.prototype.skipChars=function(a,b){for(var c=this.src.length;a<c;a++)if(this.src.charCodeAt(a)!==b)break;return a},d.prototype.skipCharsBack=function(a,b,c){if(a<=c)return a;while(a>c)if(b!==this.src.charCodeAt(--a))return a+1;return a},d.prototype.getLines=function j(a,b,c,d){var e,f,g,h,i,j=a;if(a>=b)return"";if(j+1===b)return f=this.bMarks[j]+Math.min(this.tShift[j],c),g=d?this.eMarks[j]+1:this.eMarks[j],this.src.slice(f,g);h=Array(b-a);for(e=0;j<b;j++,e++)i=this.tShift[j],i>c&&(i=c),i<0&&(i=0),f=this.bMarks[j]+i,j+1<b||d?g=this.eMarks[j]+1:g=this.eMarks[j],h[e]=this.src.slice(f,g);return h.join("")},b.exports=d},{}],33:[function(a,b,c){function d(a,b){var c=a.bMarks[b]+a.blkIndent,d=a.eMarks[b];return a.src.substr(c,d-c)}"use strict",b.exports=function e(a,b,c,e){var f,g,h,i,j,k,l,m,n,o,p;if(b+2>c)return!1;j=b+1;if(a.tShift[j]<a.blkIndent)return!1;h=a.bMarks[j]+a.tShift[j];if(h>=a.eMarks[j])return!1;f=a.src.charCodeAt(h);if(f!==124&&f!==45&&f!==58)return!1;g=d(a,b+1);if(!/^[-:| ]+$/.test(g))return!1;k=g.split("|");if(k<=2)return!1;m=[];for(i=0;i<k.length;i++){n=k[i].trim();if(!n){if(i===0||i===k.length-1)continue;return!1}if(!/^:?-+:?$/.test(n))return!1;n.charCodeAt(n.length-1)===58?m.push(n.charCodeAt(0)===58?"center":"right"):n.charCodeAt(0)===58?m.push("left"):m.push("")}g=d(a,b).trim();if(g.indexOf("|")===-1)return!1;k=g.replace(/^\||\|$/g,"").split("|");if(m.length!==k.length)return!1;if(e)return!0;a.tokens.push({type:"table_open",lines:o=[b,0],level:a.level++}),a.tokens.push({type:"thead_open",lines:[b,b+1],level:a.level++}),a.tokens.push({type:"tr_open",lines:[b,b+1],level:a.level++});for(i=0;i<k.length;i++)a.tokens.push({type:"th_open",align:m[i],lines:[b,b+1],level:a.level++}),a.tokens.push({type:"inline",content:k[i].trim(),lines:[b,b+1],level:a.level,children:[]}),a.tokens.push({type:"th_close",level:--a.level});a.tokens.push({type:"tr_close",level:--a.level}),a.tokens.push({type:"thead_close",level:--a.level}),a.tokens.push({type:"tbody_open",lines:p=[b+2,0],level:a.level++});var q="#ZXYZXY#";for(j=b+2;j<c;j++){if(a.tShift[j]<a.blkIndent)break;g=d(a,j).trim();if(g.indexOf("|")===-1)break;k=g.replace(/^\||\|$/g,"").replace(/([^\\])\|/g,"$1"+q).split(q),a.tokens.push({type:"tr_open",level:a.level++});for(i=0;i<k.length;i++)a.tokens.push({type:"td_open",align:m[i],level:a.level++}),l=k[i].substring(k[i].charCodeAt(0)===124?1:0,k[i].charCodeAt(k[i].length-1)===124?k[i].length-1:k[i].length).trim(),l=l.replace(/\\\|/g,"|"),a.tokens.push({type:"inline",content:l,level:a.level,children:[]}),a.tokens.push({type:"td_close",level:--a.level});a.tokens.push({type:"tr_close",level:--a.level})}return a.tokens.push({type:"tbody_close",level:--a.level}),a.tokens.push({type:"table_close",level:--a.level}),o[1]=p[1]=j,a.line=j,!0}},{}],34:[function(a,b,c){function f(a,b,c,f){var g,h,i,j,k,l;if(a.charCodeAt(0)!==42)return-1;if(a.charCodeAt(1)!==91)return-1;if(a.indexOf("]:")===-1)return-1;g=new d(a,b,c,f,[]),h=e(g,1);if(h<0||a.charCodeAt(h+1)!==58)return-1;j=g.posMax;for(i=h+2;i<j;i++)if(g.src.charCodeAt(i)===10)break;return k=a.slice(2,h),l=a.slice(h+2,i).trim(),l.length===0?-1:(f.abbreviations||(f.abbreviations={}),typeof f.abbreviations[":"+k]=="undefined"&&(f.abbreviations[":"+k]=l),i)}"use strict";var d=a("../rules_inline/state_inline"),e=a("../helpers/parse_link_label");b.exports=function g(a){var b=a.tokens,c,d,e,g;if(a.inlineMode)return;for(c=1,d=b.length-1;c<d;c++)if(b[c-1].type==="paragraph_open"&&b[c].type==="inline"&&b[c+1].type==="paragraph_close"){e=b[c].content;while(e.length){g=f(e,a.inline,a.options,a.env);if(g<0)break;e=e.slice(g).trim()}b[c].content=e,e.length||(b[c-1].tight=!0,b[c+1].tight=!0)}}},{"../helpers/parse_link_label":12,"../rules_inline/state_inline":56}],35:[function(a,b,c){function e(a){return a.replace(/([-()\[\]{}+?*.$\^|,:#<!\\])/g,"\\$1")}"use strict";var d=" \n()[]'\".,!?-";b.exports=function f(a){var b,c,f,g,h,i,j,k,l,m,n,o,p=a.tokens;if(!a.env.abbreviations)return;a.env.abbrRegExp||(o="(^|["+d.split("").map(e).join("")+"])"+"("+Object.keys(a.env.abbreviations).map(function(a){return a.substr(1)}).sort(function(a,b){return b.length-a.length}).map(e).join("|")+")"+"($|["+d.split("").map(e).join("")+"])",a.env.abbrRegExp=new RegExp(o,"g")),m=a.env.abbrRegExp;for(c=0,f=p.length;c<f;c++){if(p[c].type!=="inline")continue;g=p[c].children;for(b=g.length-1;b>=0;b--){h=g[b];if(h.type!=="text")continue;k=0,i=h.content,m.lastIndex=0,l=h.level,j=[];while(n=m.exec(i))m.lastIndex>k&&j.push({type:"text",content:i.slice(k,n.index+n[1].length),level:l}),j.push({type:"abbr_open",title:a.env.abbreviations[":"+n[2]],level:l++}),j.push({type:"text",content:n[2],level:l}),j.push({type:"abbr_close",level:--l}),k=m.lastIndex-n[3].length;if(!j.length)continue;k<i.length&&j.push({type:"text",content:i.slice(k),level:l}),p[c].children=g=[].concat(g.slice(0,b),j,g.slice(b+1))}}}},{}],36:[function(a,b,c){"use strict",b.exports=function(a){a.inlineMode?a.tokens.push({type:"inline",content:a.src.replace(/\n/g," ").trim(),level:0,lines:[0,1],children:[]}):a.block.parse(a.src,a.options,a.env,a.tokens)}},{}],37:[function(a,b,c){"use strict",b.exports=function d(a){var b,c,d,e,f,g,h,i,j,k=0,l=!1,m={};if(!a.env.footnotes)return;a.tokens=a.tokens.filter(function(a){return a.type==="footnote_reference_open"?(l=!0,i=[],j=a.label,!1):a.type==="footnote_reference_close"?(l=!1,m[":"+j]=i,!1):(l&&i.push(a),!l)});if(!a.env.footnotes.list)return;g=a.env.footnotes.list,a.tokens.push({type:"footnote_block_open",level:k++});for(b=0,c=g.length;b<c;b++){a.tokens.push({type:"footnote_open",id:b,level:k++}),g[b].tokens?(h=[],h.push({type:"paragraph_open",tight:!1,level:k++}),h.push({type:"inline",content:"",level:k,children:g[b].tokens}),h.push({type:"paragraph_close",tight:!1,level:--k})):g[b].label&&(h=m[":"+g[b].label]),a.tokens=a.tokens.concat(h),a.tokens[a.tokens.length-1].type==="paragraph_close"?f=a.tokens.pop():f=null,e=g[b].count>0?g[b].count:1;for(d=0;d<e;d++)a.tokens.push({type:"footnote_anchor",id:b,subId:d,level:k});f&&a.tokens.push(f),a.tokens.push({type:"footnote_close",level:--k})}a.tokens.push({type:"footnote_block_close",level:--k})}},{}],38:[function(a,b,c){"use strict",b.exports=function d(a){var b=a.tokens,c,d,e;for(d=0,e=b.length;d<e;d++)c=b[d],c.type==="inline"&&a.inline.parse(c.content,a.options,a.env,c.children)}},{}],39:[function(a,b,c){function f(a){return/^<a[>\s]/i.test(a)}function g(a){return/^<\/a\s*>/i.test(a)}function h(){var a=[],b=new d({stripPrefix:!1,url:!0,email:!0,twitter:!1,replaceFn:function(b,c){switch(c.getType()){case"url":a.push({text:c.matchedText,url:c.getUrl()});break;case"email":a.push({text:c.matchedText,url:"mailto:"+c.getEmail().replace(/^mailto:/i,"")})}return!1}});return{links:a,autolinker:b}}"use strict";var d=a("autolinker"),e=/www|@|\:\/\//;b.exports=function i(a){var b,c,d,i,j,k,l,m,n,o,p,q=a.tokens,r=null,s,t;if(!a.options.linkify)return;for(c=0,d=q.length;c<d;c++){if(q[c].type!=="inline")continue;i=q[c].children,p=0;for(b=i.length-1;b>=0;b--){j=i[b];if(j.type==="link_close"){b--;while(i[b].level!==j.level&&i[b].type!=="link_open")b--;continue}j.type==="htmltag"&&(f(j.content)&&p>0&&p--,g(j.content)&&p++);if(p>0)continue;if(j.type==="text"&&e.test(j.content)){r||(r=h(),s=r.links,t=r.autolinker),k=j.content,s.length=0,t.link(k);if(!s.length)continue;l=[],o=j.level;for(m=0;m<s.length;m++){if(!a.inline.validateLink(s[m].url))continue;n=k.indexOf(s[m].text),n&&(o=o,l.push({type:"text",content:k.slice(0,n),level:o})),l.push({type:"link_open",href:s[m].url,title:"",level:o++}),l.push({type:"text",content:s[m].text,level:o}),l.push({type:"link_close",level:--o}),k=k.slice(n+s[m].text.length)}k.length&&l.push({type:"text",content:k,level:o}),q[c].children=i=[].concat(i.slice(0,b),l,i.slice(b+1))}}}}},{autolinker:60}],40:[function(a,b,c){function i(a,b,c,i){var j,k,l,m,n,o,p,q,r;if(a.charCodeAt(0)!==91)return-1;if(a.indexOf("]:")===-1)return-1;j=new d(a,b,c,i,[]),k=e(j,0);if(k<0||a.charCodeAt(k+1)!==58)return-1;m=j.posMax;for(l=k+2;l<m;l++){n=j.src.charCodeAt(l);if(n!==32&&n!==10)break}if(!f(j,l))return-1;p=j.linkContent,l=j.pos,o=l;for(l=l+1;l<m;l++){n=j.src.charCodeAt(l);if(n!==32&&n!==10)break}l<m&&o!==l&&g(j,l)?(q=j.linkContent,l=j.pos):(q="",l=o);while(l<m&&j.src.charCodeAt(l)===32)l++;return l<m&&j.src.charCodeAt(l)!==10?-1:(r=h(a.slice(1,k)),typeof i.references[r]=="undefined"&&(i.references[r]={title:q,href:p}),l)}"use strict";var d=a("../rules_inline/state_inline"),e=a("../helpers/parse_link_label"),f=a("../helpers/parse_link_destination"),g=a("../helpers/parse_link_title"),h=a("../helpers/normalize_reference");b.exports=function(a){var b=a.tokens,c,d,e,f;a.env.references=a.env.references||{};if(a.inlineMode)return;for(c=1,d=b.length-1;c<d;c++)if(b[c].type==="inline"&&b[c-1].type==="paragraph_open"&&b[c+1].type==="paragraph_close"){e=b[c].content;while(e.length){f=i(e,a.inline,a.options,a.env);if(f<0)break;e=e.slice(f).trim()}b[c].content=e,e.length||(b[c-1].tight=!0,b[c+1].tight=!0)}}},{"../helpers/normalize_reference":10,"../helpers/parse_link_destination":11,"../helpers/parse_link_label":12,"../helpers/parse_link_title":13,"../rules_inline/state_inline":56}],41:[function(a,b,c){function g(a){return a.indexOf("(")<0?a:a.replace(e,function(a,b){return f[b.toLowerCase()]})}"use strict";var d=/\+-|\.\.|\?\?\?\?|!!!!|,,|--/,e=/\((c|tm|r|p)\)/ig,f={c:"©",r:"®",p:"§",tm:"™"};b.exports=function h(a){var b,c,e,f,h;if(!a.options.typographer)return;for(h=a.tokens.length-1;h>=0;h--){if(a.tokens[h].type!=="inline")continue;f=a.tokens[h].children;for(b=f.length-1;b>=0;b--)c=f[b],c.type==="text"&&(e=c.content,e=g(e),d.test(e)&&(e=e.replace(/\+-/g,"±").replace(/\.{2,}/g,"…").replace(/([?!])…/g,"$1..").replace(/([?!]){4,}/g,"$1$1$1").replace(/,{2,}/g,",").replace(/(^|[^-])---([^-]|$)/mg,"$1—$2").replace(/(^|\s)--(\s|$)/mg,"$1–$2").replace(/(^|[^-\s])--([^-\s]|$)/mg,"$1–$2")),c.content=e)}}},{}],42:[function(a,b,c){function h(a,b){return b<0||b>=a.length?!1:!f.test(a[b])}function i(a,b,c){return a.substr(0,b)+c+a.substr(b+1)}"use strict";var d=/['"]/,e=/['"]/g,f=/[-\s()\[\]]/,g="’";b.exports=function j(a){var b,c,f,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(!a.options.typographer)return;w=[];for(u=a.tokens.length-1;u>=0;u--){if(a.tokens[u].type!=="inline")continue;v=a.tokens[u].children,w.length=0;for(b=0;b<v.length;b++){c=v[b];if(c.type!=="text"||d.test(c.text))continue;m=v[b].level;for(s=w.length-1;s>=0;s--)if(w[s].level<=m)break;w.length=s+1,f=c.content,k=0,l=f.length;x:while(k<l){e.lastIndex=k,j=e.exec(f);if(!j)break;n=!h(f,j.index-1),k=j.index+1,t=j[0]==="'",o=!h(f,k);if(!o&&!n){t&&(c.content=i(c.content,j.index,g));continue}q=!o,r=!n;if(r)for(s=w.length-1;s>=0;s--){p=w[s];if(w[s].level<m)break;if(p.single===t&&w[s].level===m){p=w[s],t?(v[p.token].content=i(v[p.token].content,p.pos,a.options.quotes[2]),c.content=i(c.content,j.index,a.options.quotes[3])):(v[p.token].content=i(v[p.token].content,p.pos,a.options.quotes[0]),c.content=i(c.content,j.index,a.options.quotes[1])),w.length=s;continue x}}q?w.push({token:b,pos:j.index,single:t,level:m}):r&&t&&(c.content=i(c.content,j.index,g))}}}}},{}],43:[function(a,b,c){"use strict";var d=a("../common/url_schemas"),e=a("../helpers/normalize_link"),f=/^<([a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*)>/,g=/^<([a-zA-Z.\-]{1,25}):([^<>\x00-\x20]*)>/;b.exports=function h(a,b){var c,h,i,j,k,l=a.pos;return a.src.charCodeAt(l)!==60?!1:(c=a.src.slice(l),c.indexOf(">")<0?!1:(h=c.match(g),h?d.indexOf(h[1].toLowerCase())<0?!1:(j=h[0].slice(1,-1),k=e(j),a.parser.validateLink(j)?(b||(a.push({type:"link_open",href:k,level:a.level}),a.push({type:"text",content:j,level:a.level+1}),a.push({type:"link_close",level:a.level})),a.pos+=h[0].length,!0):!1):(i=c.match(f),i?(j=i[0].slice(1,-1),k=e("mailto:"+j),a.parser.validateLink(k)?(b||(a.push({type:"link_open",href:k,level:a.level}),a.push({type:"text",content:j,level:a.level+1}),a.push({type:"link_close",level:a.level})),a.pos+=i[0].length,!0):!1):!1)))}},{"../common/url_schemas":4,"../helpers/normalize_link":9}],44:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f,g,h=a.pos,i=a.src.charCodeAt(h);if(i!==96)return!1;c=h,h++,d=a.posMax;while(h<d&&a.src.charCodeAt(h)===96)h++;e=a.src.slice(c,h),f=g=h;while((f=a.src.indexOf("`",g))!==-1){g=f+1;while(g<d&&a.src.charCodeAt(g)===96)g++;if(g-f===e.length)return b||a.push({type:"code",content:a.src.slice(h,f).replace(/[ \n]+/g," ").trim(),block:!1,level:a.level}),a.pos=g,!0}return b||(a.pending+=e),a.pos+=e.length,!0}},{}],45:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f=a.posMax,g=a.pos,h,i;if(a.src.charCodeAt(g)!==126)return!1;if(b)return!1;if(g+4>=f)return!1;if(a.src.charCodeAt(g+1)!==126)return!1;if(a.level>=a.options.maxNesting)return!1;h=g>0?a.src.charCodeAt(g-1):-1,i=a.src.charCodeAt(g+2);if(h===126)return!1;if(i===126)return!1;if(i===32||i===10)return!1;d=g+2;while(d<f&&a.src.charCodeAt(d)===126)d++;if(d>g+3)return a.pos+=d-g,b||(a.pending+=a.src.slice(g,d)),!0;a.pos=g+2,e=1;while(a.pos+1<f){if(a.src.charCodeAt(a.pos)===126&&a.src.charCodeAt(a.pos+1)===126){h=a.src.charCodeAt(a.pos-1),i=a.pos+2<f?a.src.charCodeAt(a.pos+2):-1;if(i!==126&&h!==126){h!==32&&h!==10?e--:i!==32&&i!==10&&e++;if(e<=0){c=!0;break}}}a.parser.skipToken(a)}return c?(a.posMax=a.pos,a.pos=g+2,b||(a.push({type:"del_open",level:a.level++}),a.parser.tokenize(a),a.push({type:"del_close",level:--a.level})),a.pos=a.posMax+2,a.posMax=f,!0):(a.pos=g,!1)}},{}],46:[function(a,b,c){function d(a){return a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122}function e(a,b){var c=b,e,f,g,h=!0,i=!0,j=a.posMax,k=a.src.charCodeAt(b);e=b>0?a.src.charCodeAt(b-1):-1;while(c<j&&a.src.charCodeAt(c)===k)c++;c>=j&&(h=!1),g=c-b;if(g>=4)h=i=!1;else{f=c<j?a.src.charCodeAt(c):-1;if(f===32||f===10)h=!1;if(e===32||e===10)i=!1;k===95&&(d(e)&&(h=!1),d(f)&&(i=!1))}return{can_open:h,can_close:i,delims:g}}"use strict",b.exports=function f(a,b){var c,d,f,g,h,i,j,k=a.posMax,l=a.pos,m=a.src.charCodeAt(l);if(m!==95&&m!==42)return!1;if(b)return!1;j=e(a,l),c=j.delims;if(!j.can_open)return a.pos+=c,b||(a.pending+=a.src.slice(l,a.pos)),!0;if(a.level>=a.options.maxNesting)return!1;a.pos=l+c,i=[c];while(a.pos<k){if(a.src.charCodeAt(a.pos)===m){j=e(a,a.pos),d=j.delims;if(j.can_close){g=i.pop(),h=d;while(g!==h){if(h<g){i.push(g-h);break}h-=g;if(i.length===0)break;a.pos+=g,g=i.pop()}if(i.length===0){c=g,f=!0;break}a.pos+=d;continue}j.can_open&&i.push(d),a.pos+=d;continue}a.parser.skipToken(a)}return f?(a.posMax=a.pos,a.pos=l+c,b||((c===2||c===3)&&a.push({type:"strong_open",level:a.level++}),(c===1||c===3)&&a.push({type:"em_open",level:a.level++}),a.parser.tokenize(a),(c===1||c===3)&&a.push({type:"em_close",level:--a.level}),(c===2||c===3)&&a.push({type:"strong_close",level:--a.level})),a.pos=a.posMax+c,a.posMax=k,!0):(a.pos=l,!1)}},{}],47:[function(a,b,c){"use strict";var d=a("../common/entities"),e=a("../common/utils").has,f=a("../common/utils").isValidEntityCode,g=a("../common/utils").fromCodePoint,h=/^&#((?:x[a-f0-9]{1,8}|[0-9]{1,8}));/i,i=/^&([a-z][a-z0-9]{1,31});/i;b.exports=function j(a,b){var c,j,k,l=a.pos,m=a.posMax;if(a.src.charCodeAt(l)!==38)return!1;if(l+1<m){c=a.src.charCodeAt(l+1);if(c===35){k=a.src.slice(l).match(h);if(k)return b||(j=k[1][0].toLowerCase()==="x"?parseInt(k[1].slice(1),16):parseInt(k[1],10),a.pending+=f(j)?g(j):g(65533)),a.pos+=k[0].length,!0}else{k=a.src.slice(l).match(i);if(k&&e(d,k[1]))return b||(a.pending+=d[k[1]]),a.pos+=k[0].length,!0}}return b||(a.pending+="&"),a.pos++,!0}},{"../common/entities":1,"../common/utils":5}],48:[function(a,b,c){"use strict";var d=[];for(var e=0;e<256;e++)d.push(0);"\\!\"#$%&'()*+,./:;<=>?@[]^_`{|}~-".split("").forEach(function(a){d[a.charCodeAt(0)]=1}),b.exports=function f(a,b){var c,e=a.pos,f=a.posMax;if(a.src.charCodeAt(e)!==92)return!1;e++;if(e<f){c=a.src.charCodeAt(e);if(c<256&&d[c]!==0)return b||(a.pending+=a.src[e]),a.pos+=2,!0;if(c===10){b||a.push({type:"hardbreak",level:a.level}),e++;while(e<f&&a.src.charCodeAt(e)===32)e++;return a.pos=e,!0}}return b||(a.pending+="\\"),a.pos++,!0}},{}],49:[function(a,b,c){"use strict";var d=a("../helpers/parse_link_label");b.exports=function e(a,b){var c,e,f,g,h=a.posMax,i=a.pos;return i+2>=h?!1:a.src.charCodeAt(i)!==94?!1:a.src.charCodeAt(i+1)!==91?!1:a.level>=a.options.maxNesting?!1:(c=i+2,e=d(a,i+1),e<0?!1:(b||(a.env.footnotes||(a.env.footnotes={}),a.env.footnotes.list||(a.env.footnotes.list=[]),f=a.env.footnotes.list.length,a.pos=c,a.posMax=e,a.push({type:"footnote_ref",id:f,level:a.level}),a.linkLevel++,g=a.tokens.length,a.parser.tokenize(a),a.env.footnotes.list[f]={tokens:a.tokens.splice(g)},a.linkLevel--),a.pos=e+1,a.posMax=h,!0))}},{"../helpers/parse_link_label":12}],50:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f,g=a.posMax,h=a.pos;if(h+3>g)return!1;if(!a.env.footnotes||!a.env.footnotes.refs)return!1;if(a.src.charCodeAt(h)!==91)return!1;if(a.src.charCodeAt(h+1)!==94)return!1;if(a.level>=a.options.maxNesting)return!1;for(d=h+2;d<g;d++){if(a.src.charCodeAt(d)===32)return!1;if(a.src.charCodeAt(d)===10)return!1;if(a.src.charCodeAt(d)===93)break}return d===h+2?!1:d>=g?!1:(d++,c=a.src.slice(h+2,d-1),typeof a.env.footnotes.refs[":"+c]=="undefined"?!1:(b||(a.env.footnotes.list||(a.env.footnotes.list=[]),a.env.footnotes.refs[":"+c]<0?(e=a.env.footnotes.list.length,a.env.footnotes.list[e]={label:c,count:0},a.env.footnotes.refs[":"+c]=e):e=a.env.footnotes.refs[":"+c],f=a.env.footnotes.list[e].count,a.env.footnotes.list[e].count++,a.push({type:"footnote_ref",id:e,subId:f,level:a.level})),a.pos=d,a.posMax=g,!0))}},{}],51:[function(a,b,c){function e(a){var b=a|32;return b>=97&&b<=122}"use strict";var d=a("../common/html_re").HTML_TAG_RE;b.exports=function f(a,b){var c,f,g,h=a.pos;return a.options.html?(g=a.posMax,a.src.charCodeAt(h)!==60||h+2>=g?!1:(c=a.src.charCodeAt(h+1),c!==33&&c!==63&&c!==47&&!e(c)?!1:(f=a.src.slice(h).match(d),f?(b||a.push({type:"htmltag",content:a.src.slice(h,h+f[0].length),level:a.level}),a.pos+=f[0].length,!0):!1))):!1}},{"../common/html_re":3}],52:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f=a.posMax,g=a.pos,h,i;if(a.src.charCodeAt(g)!==43)return!1;if(b)return!1;if(g+4>=f)return!1;if(a.src.charCodeAt(g+1)!==43)return!1;if(a.level>=a.options.maxNesting)return!1;h=g>0?a.src.charCodeAt(g-1):-1,i=a.src.charCodeAt(g+2);if(h===43)return!1;if(i===43)return!1;if(i===32||i===10)return!1;d=g+2;while(d<f&&a.src.charCodeAt(d)===43)d++;if(d!==g+2)return a.pos+=d-g,b||(a.pending+=a.src.slice(g,d)),!0;a.pos=g+2,e=1;while(a.pos+1<f){if(a.src.charCodeAt(a.pos)===43&&a.src.charCodeAt(a.pos+1)===43){h=a.src.charCodeAt(a.pos-1),i=a.pos+2<f?a.src.charCodeAt(a.pos+2):-1;if(i!==43&&h!==43){h!==32&&h!==10?e--:i!==32&&i!==10&&e++;if(e<=0){c=!0;break}}}a.parser.skipToken(a)}return c?(a.posMax=a.pos,a.pos=g+2,b||(a.push({type:"ins_open",level:a.level++}),a.parser.tokenize(a),a.push({type:"ins_close",level:--a.level})),a.pos=a.posMax+2,a.posMax=f,!0):(a.pos=g,!1)}},{}],53:[function(a,b,c){"use strict";var d=a("../helpers/parse_link_label"),e=a("../helpers/parse_link_destination"),f=a("../helpers/parse_link_title"),g=a("../helpers/normalize_reference");b.exports=function h(a,b){var c,h,i,j,k,l,m,n,o=!1,p=a.pos,q=a.posMax,r=a.pos,s=a.src.charCodeAt(r);s===33&&(o=!0,s=a.src.charCodeAt(++r));if(s!==91)return!1;if(a.level>=a.options.maxNesting)return!1;c=r+1,h=d(a,r);if(h<0)return!1;l=h+1;if(l<q&&a.src.charCodeAt(l)===40){l++;for(;l<q;l++){n=a.src.charCodeAt(l);if(n!==32&&n!==10)break}if(l>=q)return!1;r=l,e(a,l)?(j=a.linkContent,l=a.pos):j="",r=l;for(;l<q;l++){n=a.src.charCodeAt(l);if(n!==32&&n!==10)break}if(l<q&&r!==l&&f(a,l)){k=a.linkContent,l=a.pos;for(;l<q;l++){n=a.src.charCodeAt(l);if(n!==32&&n!==10)break}}else k="";if(l>=q||a.src.charCodeAt(l)!==41)return a.pos=p,!1;l++}else{if(a.linkLevel>0)return!1;for(;l<q;l++){n=a.src.charCodeAt(l);if(n!==32&&n!==10)break}l<q&&a.src.charCodeAt(l)===91&&(r=l+1,l=d(a,l),l>=0?i=a.src.slice(r,l++):l=r-1),i||(typeof i=="undefined"&&(l=h+1),i=a.src.slice(c,h)),m=a.env.references[g(i)];if(!m)return a.pos=p,!1;j=m.href,k=m.title}return b||(a.pos=c,a.posMax=h,o?a.push({type:"image",src:j,title:k,alt:a.src.substr(c,h-c),level:a.level}):(a.push({type:"link_open",href:j,title:k,level:a.level++}),a.linkLevel++,a.parser.tokenize(a),a.linkLevel--,a.push({type:"link_close",level:--a.level}))),a.pos=l,a.posMax=q,!0}},{"../helpers/normalize_reference":10,"../helpers/parse_link_destination":11,"../helpers/parse_link_label":12,"../helpers/parse_link_title":13}],54:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e,f=a.posMax,g=a.pos,h,i;if(a.src.charCodeAt(g)!==61)return!1;if(b)return!1;if(g+4>=f)return!1;if(a.src.charCodeAt(g+1)!==61)return!1;if(a.level>=a.options.maxNesting)return!1;h=g>0?a.src.charCodeAt(g-1):-1,i=a.src.charCodeAt(g+2);if(h===61)return!1;if(i===61)return!1;if(i===32||i===10)return!1;d=g+2;while(d<f&&a.src.charCodeAt(d)===61)d++;if(d!==g+2)return a.pos+=d-g,b||(a.pending+=a.src.slice(g,d)),!0;a.pos=g+2,e=1;while(a.pos+1<f){if(a.src.charCodeAt(a.pos)===61&&a.src.charCodeAt(a.pos+1)===61){h=a.src.charCodeAt(a.pos-1),i=a.pos+2<f?a.src.charCodeAt(a.pos+2):-1;if(i!==61&&h!==61){h!==32&&h!==10?e--:i!==32&&i!==10&&e++;if(e<=0){c=!0;break}}}a.parser.skipToken(a)}return c?(a.posMax=a.pos,a.pos=g+2,b||(a.push({type:"mark_open",level:a.level++}),a.parser.tokenize(a),a.push({type:"mark_close",level:--a.level})),a.pos=a.posMax+2,a.posMax=f,!0):(a.pos=g,!1)}},{}],55:[function(a,b,c){"use strict",b.exports=function d(a,b){var c,d,e=a.pos;if(a.src.charCodeAt(e)!==10)return!1;c=a.pending.length-1,d=a.posMax;if(!b)if(c>=0&&a.pending.charCodeAt(c)===32)if(c>=1&&a.pending.charCodeAt(c-1)===32){for(var f=c-2;f>=0;f--)if(a.pending.charCodeAt(f)!==32){a.pending=a.pending.substring(0,f+1);break}a.push({type:"hardbreak",level:a.level})}else a.pending=a.pending.slice(0,-1),a.push({type:"softbreak",level:a.level});else a.push({type:"softbreak",level:a.level});e++;while(e<d&&a.src.charCodeAt(e)===32)e++;return a.pos=e,!0}},{}],56:[function(a,b,c){function d(a,b,c,d,e){this.src=a,this.env=d,this.options=c,this.parser=b,this.tokens=e,this.pos=0,this.posMax=this.src.length,this.level=0,this.pending="",this.pendingLevel=0,this.cache=[],this.isInLabel=!1,this.linkLevel=0,this.linkContent="",this.labelUnmatchedScopes=0}"use strict",d.prototype.pushPending=function(){this.tokens.push({type:"text",content:this.pending,level:this.pendingLevel}),this.pending=""},d.prototype.push=function(a){this.pending&&this.pushPending(),this.tokens.push(a),this.pendingLevel=this.level},d.prototype.cacheSet=function(a,b){for(var c=this.cache.length;c<=a;c++)this.cache.push(0);this.cache[a]=b},d.prototype.cacheGet=function(a){return a<this.cache.length?this.cache[a]:0},b.exports=d},{}],57:[function(a,b,c){"use strict";var d=/\\([ \\!"#$%&'()*+,.\/:;<=>?@[\]^_`{|}~-])/g;b.exports=function e(a,b){var c,e,f=a.posMax,g=a.pos;if(a.src.charCodeAt(g)!==126)return!1;if(b)return!1;if(g+2>=f)return!1;if(a.level>=a.options.maxNesting)return!1;a.pos=g+1;while(a.pos<f){if(a.src.charCodeAt(a.pos)===126){c=!0;break}a.parser.skipToken(a)}return!c||g+1===a.pos?(a.pos=g,!1):(e=a.src.slice(g+1,a.pos),e.match(/(^|[^\\])(\\\\)*\s/)?(a.pos=g,!1):(a.posMax=a.pos,a.pos=g+1,b||a.push({type:"sub",level:a.level,content:e.replace(d,"$1")}),a.pos=a.posMax+1,a.posMax=f,!0))}},{}],58:[function(a,b,c){"use strict";var d=/\\([ \\!"#$%&'()*+,.\/:;<=>?@[\]^_`{|}~-])/g;b.exports=function e(a,b){var c,e,f=a.posMax,g=a.pos;if(a.src.charCodeAt(g)!==94)return!1;if(b)return!1;if(g+2>=f)return!1;if(a.level>=a.options.maxNesting)return!1;a.pos=g+1;while(a.pos<f){if(a.src.charCodeAt(a.pos)===94){c=!0;break}a.parser.skipToken(a)}return!c||g+1===a.pos?(a.pos=g,!1):(e=a.src.slice(g+1,a.pos),e.match(/(^|[^\\])(\\\\)*\s/)?(a.pos=g,!1):(a.posMax=a.pos,a.pos=g+1,b||a.push({type:"sup",level:a.level,content:e.replace(d,"$1")}),a.pos=a.posMax+1,a.posMax=f,!0))}},{}],59:[function(a,b,c){function d(a){switch(a){case 10:case 92:case 96:case 42:case 95:case 94:case 91:case 93:case 33:case 38:case 60:case 62:case 123
:case 125:case 36:case 37:case 64:case 126:case 43:case 61:case 58:return!0;default:return!1}}"use strict",b.exports=function(a,b){var c=a.pos;while(c<a.posMax&&!d(a.src.charCodeAt(c)))c++;return c===a.pos?!1:(b||(a.pending+=a.src.slice(a.pos,c)),a.pos=c,!0)}},{}],60:[function(b,c,d){(function(b,e){typeof a=="function"&&a.amd?a([],function(){return b.Autolinker=e()}):typeof d=="object"?c.exports=e():b.Autolinker=e()})(this,function(){var a=function(b){a.Util.assign(this,b)};return a.prototype={constructor:a,urls:!0,email:!0,twitter:!0,newWindow:!0,stripPrefix:!0,truncate:undefined,className:"",htmlParser:undefined,matchParser:undefined,tagBuilder:undefined,link:function(a){var b=this.getHtmlParser(),c=b.parse(a),d=0,e=[];for(var f=0,g=c.length;f<g;f++){var h=c[f],i=h.getType(),j=h.getText();if(i==="element")h.getTagName()==="a"&&(h.isClosing()?d=Math.max(d-1,0):d++),e.push(j);else if(i==="entity")e.push(j);else if(d===0){var k=this.linkifyStr(j);e.push(k)}else e.push(j)}return e.join("")},linkifyStr:function(a){return this.getMatchParser().replace(a,this.createMatchReturnVal,this)},createMatchReturnVal:function(b){var c;this.replaceFn&&(c=this.replaceFn.call(this,this,b));if(typeof c=="string")return c;if(c===!1)return b.getMatchedText();if(c instanceof a.HtmlTag)return c.toString();var d=this.getTagBuilder(),e=d.build(b);return e.toString()},getHtmlParser:function(){var b=this.htmlParser;return b||(b=this.htmlParser=new a.htmlParser.HtmlParser),b},getMatchParser:function(){var b=this.matchParser;return b||(b=this.matchParser=new a.matchParser.MatchParser({urls:this.urls,email:this.email,twitter:this.twitter,stripPrefix:this.stripPrefix})),b},getTagBuilder:function(){var b=this.tagBuilder;return b||(b=this.tagBuilder=new a.AnchorTagBuilder({newWindow:this.newWindow,truncate:this.truncate,className:this.className})),b}},a.link=function(b,c){var d=new a(c);return d.link(b)},a.match={},a.htmlParser={},a.matchParser={},a.Util={abstractMethod:function(){throw"abstract"},assign:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},extend:function(b,c){var d=b.prototype,e=function(){};e.prototype=d;var f;c.hasOwnProperty("constructor")?f=c.constructor:f=function(){d.constructor.apply(this,arguments)};var g=f.prototype=new e;return g.constructor=f,g.superclass=d,delete c.constructor,a.Util.assign(g,c),f},ellipsis:function(a,b,c){return a.length>b&&(c=c==null?"..":c,a=a.substring(0,b-c.length)+c),a},indexOf:function(a,b){if(Array.prototype.indexOf)return a.indexOf(b);for(var c=0,d=a.length;c<d;c++)if(a[c]===b)return c;return-1},splitAndCapture:function(a,b){if(!b.global)throw new Error("`splitRegex` must have the 'g' flag set");var c=[],d=0,e;while(e=b.exec(a))c.push(a.substring(d,e.index)),c.push(e[0]),d=e.index+e[0].length;return c.push(a.substring(d)),c}},a.HtmlTag=a.Util.extend(Object,{whitespaceRegex:/\s+/,constructor:function(b){a.Util.assign(this,b),this.innerHtml=this.innerHtml||this.innerHTML},setTagName:function(a){return this.tagName=a,this},getTagName:function(){return this.tagName||""},setAttr:function(a,b){var c=this.getAttrs();return c[a]=b,this},getAttr:function(a){return this.getAttrs()[a]},setAttrs:function(b){var c=this.getAttrs();return a.Util.assign(c,b),this},getAttrs:function(){return this.attrs||(this.attrs={})},setClass:function(a){return this.setAttr("class",a)},addClass:function(b){var c=this.getClass(),d=this.whitespaceRegex,e=a.Util.indexOf,f=c?c.split(d):[],g=b.split(d),h;while(h=g.shift())e(f,h)===-1&&f.push(h);return this.getAttrs()["class"]=f.join(" "),this},removeClass:function(b){var c=this.getClass(),d=this.whitespaceRegex,e=a.Util.indexOf,f=c?c.split(d):[],g=b.split(d),h;while(f.length&&(h=g.shift())){var i=e(f,h);i!==-1&&f.splice(i,1)}return this.getAttrs()["class"]=f.join(" "),this},getClass:function(){return this.getAttrs()["class"]||""},hasClass:function(a){return(" "+this.getClass()+" ").indexOf(" "+a+" ")!==-1},setInnerHtml:function(a){return this.innerHtml=a,this},getInnerHtml:function(){return this.innerHtml||""},toString:function(){var a=this.getTagName(),b=this.buildAttrsStr();return b=b?" "+b:"",["<",a,b,">",this.getInnerHtml(),"</",a,">"].join("")},buildAttrsStr:function(){if(!this.attrs)return"";var a=this.getAttrs(),b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c+'="'+a[c]+'"');return b.join(" ")}}),a.AnchorTagBuilder=a.Util.extend(Object,{constructor:function(b){a.Util.assign(this,b)},build:function(b){var c=new a.HtmlTag({tagName:"a",attrs:this.createAttrs(b.getType(),b.getAnchorHref()),innerHtml:this.processAnchorText(b.getAnchorText())});return c},createAttrs:function(a,b){var c={href:b},d=this.createCssClass(a);return d&&(c["class"]=d),this.newWindow&&(c.target="_blank"),c},createCssClass:function(a){var b=this.className;return b?b+" "+b+"-"+a:""},processAnchorText:function(a){return a=this.doTruncate(a),a},doTruncate:function(b){return a.Util.ellipsis(b,this.truncate||Number.POSITIVE_INFINITY)}}),a.htmlParser.HtmlParser=a.Util.extend(Object,{htmlRegex:function(){var a=/[0-9a-zA-Z][0-9a-zA-Z:]*/,b=/[^\s\0"'>\/=\x01-\x1F\x7F]+/,c=/(?:"[^"]*?"|'[^']*?'|[^'"=<>`\s]+)/,d=b.source+"(?:\\s*=\\s*"+c.source+")?";return new RegExp(["(?:","<(!DOCTYPE)","(?:","\\s+","(?:",d,"|",c.source+")",")*",">",")","|","(?:","<(/)?","("+a.source+")","(?:","\\s+",d,")*","\\s*/?",">",")"].join(""),"gi")}(),htmlCharacterEntitiesRegex:/(&nbsp;|&#160;|&lt;|&#60;|&gt;|&#62;|&quot;|&#34;|&#39;)/gi,parse:function(a){var b=this.htmlRegex,c,d=0,e,f=[];while((c=b.exec(a))!==null){var g=c[0],h=c[1]||c[3],i=!!c[2],j=a.substring(d,c.index);j&&(e=this.parseTextAndEntityNodes(j),f.push.apply(f,e)),f.push(this.createElementNode(g,h,i)),d=c.index+g.length}if(d<a.length){var k=a.substring(d);k&&(e=this.parseTextAndEntityNodes(k),f.push.apply(f,e))}return f},parseTextAndEntityNodes:function(b){var c=[],d=a.Util.splitAndCapture(b,this.htmlCharacterEntitiesRegex);for(var e=0,f=d.length;e<f;e+=2){var g=d[e],h=d[e+1];g&&c.push(this.createTextNode(g)),h&&c.push(this.createEntityNode(h))}return c},createElementNode:function(b,c,d){return new a.htmlParser.ElementNode({text:b,tagName:c.toLowerCase(),closing:d})},createEntityNode:function(b){return new a.htmlParser.EntityNode({text:b})},createTextNode:function(b){return new a.htmlParser.TextNode({text:b})}}),a.htmlParser.HtmlNode=a.Util.extend(Object,{text:"",constructor:function(b){a.Util.assign(this,b)},getType:a.Util.abstractMethod,getText:function(){return this.text}}),a.htmlParser.ElementNode=a.Util.extend(a.htmlParser.HtmlNode,{tagName:"",closing:!1,getType:function(){return"element"},getTagName:function(){return this.tagName},isClosing:function(){return this.closing}}),a.htmlParser.EntityNode=a.Util.extend(a.htmlParser.HtmlNode,{getType:function(){return"entity"}}),a.htmlParser.TextNode=a.Util.extend(a.htmlParser.HtmlNode,{getType:function(){return"text"}}),a.matchParser.MatchParser=a.Util.extend(Object,{urls:!0,email:!0,twitter:!0,stripPrefix:!0,matcherRegex:function(){var a=/(^|[^\w])@(\w{1,15})/,b=/(?:[\-;:&=\+\$,\w\.]+@)/,c=/(?:[A-Za-z][-.+A-Za-z0-9]+:(?![A-Za-z][-.+A-Za-z0-9]+:\/\/)(?!\d+\/?)(?:\/\/)?)/,d=/(?:www\.)/,e=/[A-Za-z0-9\.\-]*[A-Za-z0-9\-]/,f=/\.(?:international|construction|contractors|enterprises|photography|productions|foundation|immobilien|industries|management|properties|technology|christmas|community|directory|education|equipment|institute|marketing|solutions|vacations|bargains|boutique|builders|catering|cleaning|clothing|computer|democrat|diamonds|graphics|holdings|lighting|partners|plumbing|supplies|training|ventures|academy|careers|company|cruises|domains|exposed|flights|florist|gallery|guitars|holiday|kitchen|neustar|okinawa|recipes|rentals|reviews|shiksha|singles|support|systems|agency|berlin|camera|center|coffee|condos|dating|estate|events|expert|futbol|kaufen|luxury|maison|monash|museum|nagoya|photos|repair|report|social|supply|tattoo|tienda|travel|viajes|villas|vision|voting|voyage|actor|build|cards|cheap|codes|dance|email|glass|house|mango|ninja|parts|photo|shoes|solar|today|tokyo|tools|watch|works|aero|arpa|asia|best|bike|blue|buzz|camp|club|cool|coop|farm|fish|gift|guru|info|jobs|kiwi|kred|land|limo|link|menu|mobi|moda|name|pics|pink|post|qpon|rich|ruhr|sexy|tips|vote|voto|wang|wien|wiki|zone|bar|bid|biz|cab|cat|ceo|com|edu|gov|int|kim|mil|net|onl|org|pro|pub|red|tel|uno|wed|xxx|xyz|ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cw|cx|cy|cz|de|dj|dk|dm|do|dz|ec|ee|eg|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sx|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw)\b/,g=/[\-A-Za-z0-9+&@#\/%=~_()|'$*\[\]?!:,.;]*[\-A-Za-z0-9+&@#\/%=~_()|'$*\[\]]/;return new RegExp(["(",a.source,")","|","(",b.source,e.source,f.source,")","|","(","(?:","(",c.source,e.source,")","|","(?:","(.?//)?",d.source,e.source,")","|","(?:","(.?//)?",e.source,f.source,")",")","(?:"+g.source+")?",")"].join(""),"gi")}(),charBeforeProtocolRelMatchRegex:/^(.)?\/\//,constructor:function(b){a.Util.assign(this,b),this.matchValidator=new a.MatchValidator},replace:function(a,b,c){var d=this;return a.replace(this.matcherRegex,function(a,e,f,g,h,i,j,k,l){var m=d.processCandidateMatch(a,e,f,g,h,i,j,k,l);if(!m)return a;var n=b.call(c,m.match);return m.prefixStr+n+m.suffixStr})},processCandidateMatch:function(b,c,d,e,f,g,h,i,j){var k=i||j,l,m="",n="";if(c&&!this.twitter||f&&!this.email||g&&!this.urls||!this.matchValidator.isValidMatch(g,h,k))return null;this.matchHasUnbalancedClosingParen(b)&&(b=b.substr(0,b.length-1),n=")");if(f)l=new a.match.Email({matchedText:b,email:f});else if(c)d&&(m=d,b=b.slice(1)),l=new a.match.Twitter({matchedText:b,twitterHandle:e});else{if(k){var o=k.match(this.charBeforeProtocolRelMatchRegex)[1]||"";o&&(m=o,b=b.slice(1))}l=new a.match.Url({matchedText:b,url:b,protocolUrlMatch:!!h,protocolRelativeMatch:!!k,stripPrefix:this.stripPrefix})}return{prefixStr:m,suffixStr:n,match:l}},matchHasUnbalancedClosingParen:function(a){var b=a.charAt(a.length-1);if(b===")"){var c=a.match(/\(/g),d=a.match(/\)/g),e=c&&c.length||0,f=d&&d.length||0;if(e<f)return!0}return!1}}),a.MatchValidator=a.Util.extend(Object,{invalidProtocolRelMatchRegex:/^[\w]\/\//,hasFullProtocolRegex:/^[A-Za-z][-.+A-Za-z0-9]+:\/\//,uriSchemeRegex:/^[A-Za-z][-.+A-Za-z0-9]+:/,hasWordCharAfterProtocolRegex:/:[^\s]*?[A-Za-z]/,isValidMatch:function(a,b,c){return b&&!this.isValidUriScheme(b)||this.urlMatchDoesNotHaveProtocolOrDot(a,b)||this.urlMatchDoesNotHaveAtLeastOneWordChar(a,b)||this.isInvalidProtocolRelativeMatch(c)?!1:!0},isValidUriScheme:function(a){var b=a.match(this.uriSchemeRegex)[0].toLowerCase();return b!=="javascript:"&&b!=="vbscript:"},urlMatchDoesNotHaveProtocolOrDot:function(a,b){return!!a&&(!b||!this.hasFullProtocolRegex.test(b))&&a.indexOf(".")===-1},urlMatchDoesNotHaveAtLeastOneWordChar:function(a,b){return a&&b?!this.hasWordCharAfterProtocolRegex.test(a):!1},isInvalidProtocolRelativeMatch:function(a){return!!a&&this.invalidProtocolRelMatchRegex.test(a)}}),a.match.Match=a.Util.extend(Object,{constructor:function(b){a.Util.assign(this,b)},getType:a.Util.abstractMethod,getMatchedText:function(){return this.matchedText},getAnchorHref:a.Util.abstractMethod,getAnchorText:a.Util.abstractMethod}),a.match.Email=a.Util.extend(a.match.Match,{getType:function(){return"email"},getEmail:function(){return this.email},getAnchorHref:function(){return"mailto:"+this.email},getAnchorText:function(){return this.email}}),a.match.Twitter=a.Util.extend(a.match.Match,{getType:function(){return"twitter"},getTwitterHandle:function(){return this.twitterHandle},getAnchorHref:function(){return"https://twitter.com/"+this.twitterHandle},getAnchorText:function(){return"@"+this.twitterHandle}}),a.match.Url=a.Util.extend(a.match.Match,{urlPrefixRegex:/^(https?:\/\/)?(www\.)?/i,protocolRelativeRegex:/^\/\//,protocolPrepended:!1,getType:function(){return"url"},getUrl:function(){var a=this.url;return!this.protocolRelativeMatch&&!this.protocolUrlMatch&&!this.protocolPrepended&&(a=this.url="http://"+a,this.protocolPrepended=!0),a},getAnchorHref:function(){var a=this.getUrl();return a.replace(/&amp;/g,"&")},getAnchorText:function(){var a=this.getUrl();return this.protocolRelativeMatch&&(a=this.stripProtocolRelativePrefix(a)),this.stripPrefix&&(a=this.stripUrlPrefix(a)),a=this.removeTrailingSlash(a),a},stripUrlPrefix:function(a){return a.replace(this.urlPrefixRegex,"")},stripProtocolRelativePrefix:function(a){return a.replace(this.protocolRelativeRegex,"")},removeTrailingSlash:function(a){return a.charAt(a.length-1)==="/"&&(a=a.slice(0,-1)),a}}),a})},{}],"/":[function(a,b,c){"use strict",b.exports=a("./lib/")},{"./lib/":14}]},{},[])("/")}),function(a,b){typeof exports=="object"&&typeof module!="undefined"?module.exports=b():typeof define=="function"&&define.amd?define(b):a.DOMPurify=b()}(this,function(){function p(a,b){m&&m(a,null);var c=b.length;while(c--){var d=b[c];if(typeof d=="string"){var e=d.toLowerCase();e!==d&&(Object.isFrozen(b)||(b[c]=e),d=e)}a[d]=!0}return a}function q(a){var b={},c=void 0;for(c in a)o(l,a,[c])&&(b[c]=a[c]);return b}function A(a){if(Array.isArray(a)){for(var b=0,c=Array(a.length);b<a.length;b++)c[b]=a[b];return c}return Array.from(a)}function H(){var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:F(),g=function(a){return H(a)};g.version="1.0.9",g.removed=[];if(!a||!a.document||a.document.nodeType!==9)return g.isSupported=!1,g;var l=a.document,m=!1,n=!1,o=a.document,r=a.DocumentFragment,B=a.HTMLTemplateElement,I=a.Node,J=a.NodeFilter,K=a.NamedNodeMap,L=K===undefined?a.NamedNodeMap||a.MozNamedAttrMap:K,M=a.Text,N=a.Comment,O=a.DOMParser,P=a.TrustedTypes;if(typeof B=="function"){var Q=o.createElement("template");Q.content&&Q.content.ownerDocument&&(o=Q.content.ownerDocument)}var R=G(P,l),S=R?R.createHTML(""):"",T=o,U=T.implementation,V=T.createNodeIterator,W=T.getElementsByTagName,X=T.createDocumentFragment,Y=l.importNode,Z={};g.isSupported=U&&typeof U.createHTMLDocument!="undefined"&&o.documentMode!==9;var $=s,_=t,ba=u,bb=v,bc=x,bd=y,be=w,bf=null,bg=p({},[].concat(A(b),A(c),A(d),A(e),A(f))),bh=null,bi=p({},[].concat(A(h),A(i),A(j),A(k))),bj=null,bk=null,bl=!0,bm=!0,bn=!1,bo=!1,bp=!1,bq=!1,br=!1,bs=!1,bt=!1,bu=!1,bv=!1,bw=!0,bx=!0,by=!1,bz={},bA=p({},["audio","head","math","script","style","template","svg","video"]),bB=p({},["audio","video","img","source","image"]),bC=p({},["alt","class","for","id","label","name","pattern","placeholder","summary","title","value","style","xmlns"]),bD=null,bE=o.createElement("form"),bF=function(a){if(bD&&bD===a)return;if(!a||(typeof a=="undefined"?"undefined":z(a))!=="object")a={};bf="ALLOWED_TAGS"in a?p({},a.ALLOWED_TAGS):bg,bh="ALLOWED_ATTR"in a?p({},a.ALLOWED_ATTR):bi,bj="FORBID_TAGS"in a?p({},a.FORBID_TAGS):{},bk="FORBID_ATTR"in a?p({},a.FORBID_ATTR):{},bz="USE_PROFILES"in a?a.USE_PROFILES:!1,bl=a.ALLOW_ARIA_ATTR!==!1,bm=a.ALLOW_DATA_ATTR!==!1,bn=a.ALLOW_UNKNOWN_PROTOCOLS||!1,bo=a.SAFE_FOR_JQUERY||!1,bp=a.SAFE_FOR_TEMPLATES||!1,bq=a.WHOLE_DOCUMENT||!1,bt=a.RETURN_DOM||!1,bu=a.RETURN_DOM_FRAGMENT||!1,bv=a.RETURN_DOM_IMPORT||!1,bs=a.FORCE_BODY||!1,bw=a.SANITIZE_DOM!==!1,bx=a.KEEP_CONTENT!==!1,by=a.IN_PLACE||!1,be=a.ALLOWED_URI_REGEXP||be,bp&&(bm=!1),bu&&(bt=!0),bz&&(bf=p({},[].concat(A(f))),bh=[],bz.html===!0&&(p(bf,b),p(bh,h)),bz.svg===!0&&(p(bf,c),p(bh,i),p(bh,k)),bz.svgFilters===!0&&(p(bf,d),p(bh,i),p(bh,k)),bz.mathMl===!0&&(p(bf,e),p(bh,j),p(bh,k))),a.ADD_TAGS&&(bf===bg&&(bf=q(bf)),p(bf,a.ADD_TAGS)),a.ADD_ATTR&&(bh===bi&&(bh=q(bh)),p(bh,a.ADD_ATTR)),a.ADD_URI_SAFE_ATTR&&p(bC,a.ADD_URI_SAFE_ATTR),bx&&(bf["#text"]=!0),bq&&p(bf,["html","head","body"]),bf.table&&p(bf,["tbody"]),E&&E(a),bD=a},bG=function(a){g.removed.push({element:a});try{a.parentNode.removeChild(a)}catch(b){a.outerHTML=S}},bH=function(a,b){try{g.removed.push({attribute:b.getAttributeNode(a),from:b})}catch(c){g.removed.push({attribute:null,from:b})}b.removeAttribute(a)},bI=function(a){var b=void 0,c=void 0;if(bs)a="<remove></remove>"+a;else{var d=a.match(/^[\s]+/);c=d&&d[0],c&&(a=a.slice(c.length))}if(m)try{b=(new O).parseFromString(a,"text/html")}catch(e){}n&&p(bj,["title"]);if(!b||!b.documentElement){b=U.createHTMLDocument("");var f=b,g=f.body;g.parentNode.removeChild(g.parentNode.firstElementChild),g.outerHTML=R?R.createHTML(a):a}return c&&b.body.insertBefore(o.createTextNode(c),b.body.childNodes[0]||null),W.call(b,bq?"html":"body")[0]};g.isSupported&&(function(){try{var a=bI('<svg><p><style><img src="</style><img src=x onerror=1//">');a.querySelector("svg img")&&(m=!0)}catch(b){}}(),function(){try{var a=bI("<x/><title>&lt;/title&gt;&lt;img&gt;");a.querySelector("title").innerHTML.match(/<\/title/)&&(n=!0)}catch(b){}}());var bJ=function(a){return V.call(a.ownerDocument||a,a,J.SHOW_ELEMENT|J.SHOW_COMMENT|J.SHOW_TEXT,function(){return J.FILTER_ACCEPT},!1)},bK=function(a){return a instanceof M||a instanceof N?!1:typeof a.nodeName=="string"&&typeof a.textContent=="string"&&typeof a.removeChild=="function"&&a.attributes instanceof L&&typeof a.removeAttribute=="function"&&typeof a.setAttribute=="function"?!1:!0},bL=function(a){return(typeof I=="undefined"?"undefined":z(I))==="object"?a instanceof I:a&&(typeof a=="undefined"?"undefined":z(a))==="object"&&typeof a.nodeType=="number"&&typeof a.nodeName=="string"},bM=function(a,b,c){if(!Z[a])return;Z[a].forEach(function(a){a.call(g,b,c,bD)})},bN=function(a){var b=void 0;bM("beforeSanitizeElements",a,null);if(bK(a))return bG(a),!0;var c=a.nodeName.toLowerCase();bM("uponSanitizeElement",a,{tagName:c,allowedTags:bf});if(!bf[c]||bj[c]){if(bx&&!bA[c]&&typeof a.insertAdjacentHTML=="function")try{var d=a.innerHTML;a.insertAdjacentHTML("AfterEnd",R?R.createHTML(d):d)}catch(e){}return bG(a),!0}return bo&&!a.firstElementChild&&(!a.content||!a.content.firstElementChild)&&/</g.test(a.textContent)&&(g.removed.push({element:a.cloneNode()}),a.innerHTML?a.innerHTML=a.innerHTML.replace(/</g,"&lt;"):a.innerHTML=a.textContent.replace(/</g,"&lt;")),bp&&a.nodeType===3&&(b=a.textContent,b=b.replace($," "),b=b.replace(_," "),a.textContent!==b&&(g.removed.push({element:a.cloneNode()}),a.textContent=b)),bM("afterSanitizeElements",a,null),!1},bO=function(a,b,c){if(bw&&(b==="id"||b==="name")&&(c in o||c in bE))return!1;bp&&(c=c.replace($," "),c=c.replace(_," "));if(!bm||!ba.test(b))if(!bl||!bb.test(b)){if(!bh[b]||bk[b])return!1;if(!bC[b]&&!be.test(c.replace(bd,""))&&(b!=="src"&&b!=="xlink:href"||a==="script"||c.indexOf("data:")!==0||!bB[a])&&(!bn||!!bc.test(c.replace(bd,"")))&&!!c)return!1}return!0},bP=function(a){var b=void 0,c=void 0,d=void 0,e=void 0,f=void 0;bM("beforeSanitizeAttributes",a,null);var h=a.attributes;if(!h)return;var i={attrName:"",attrValue:"",keepAttr:!0,allowedAttributes:bh};f=h.length;while(f--){b=h[f];var j=b,k=j.name,l=j.namespaceURI;c=b.value.trim(),d=k.toLowerCase(),i.attrName=d,i.attrValue=c,i.keepAttr=!0,bM("uponSanitizeAttribute",a,i),c=i.attrValue;if(d==="name"&&a.nodeName==="IMG"&&h.id)e=h.id,h=C(D,h,[]),bH("id",a),bH(k,a),h.indexOf(e)>f&&a.setAttribute("id",e.value);else{if(a.nodeName==="INPUT"&&d==="type"&&c==="file"&&(bh[d]||!bk[d]))continue;k==="id"&&a.setAttribute(k,""),bH(k,a)}if(!i.keepAttr)continue;var m=a.nodeName.toLowerCase();if(!bO(m,d,c))continue;try{l?a.setAttributeNS(l,k,c):a.setAttribute(k,c),g.removed.pop()}catch(n){}}bM("afterSanitizeAttributes",a,null)},bQ=function cb(a){var b=void 0,c=bJ(a);bM("beforeSanitizeShadowDOM",a,null);while(b=c.nextNode()){bM("uponSanitizeShadowNode",b,null);if(bN(b))continue;b.content instanceof r&&cb(b.content),bP(b)}bM("afterSanitizeShadowDOM",a,null)};return g.sanitize=function(b,c){var d=void 0,e=void 0,f=void 0,h=void 0,i=void 0;b||(b="<!-->");if(typeof b!="string"&&!bL(b)){if(typeof b.toString!="function")throw new TypeError("toString is not a function");b=b.toString();if(typeof b!="string")throw new TypeError("dirty is not a string, aborting")}if(!g.isSupported){if(z(a.toStaticHTML)==="object"||typeof a.toStaticHTML=="function"){if(typeof b=="string")return a.toStaticHTML(b);if(bL(b))return a.toStaticHTML(b.outerHTML)}return b}br||bF(c),g.removed=[];if(!by)if(b instanceof I)d=bI("<!-->"),e=d.ownerDocument.importNode(b,!0),e.nodeType===1&&e.nodeName==="BODY"?d=e:d.appendChild(e);else{if(!bt&&!bq&&b.indexOf("<")===-1)return R?R.createHTML(b):b;d=bI(b);if(!d)return bt?null:S}d&&bs&&bG(d.firstChild);var j=bJ(by?b:d);while(f=j.nextNode()){if(f.nodeType===3&&f===h)continue;if(bN(f))continue;f.content instanceof r&&bQ(f.content),bP(f),h=f}h=null;if(by)return b;if(bt){if(bu){i=X.call(d.ownerDocument);while(d.firstChild)i.appendChild(d.firstChild)}else i=d;return bv&&(i=Y.call(l,i,!0)),i}var k=bq?d.outerHTML:d.innerHTML;return R?R.createHTML(k):k},g.setConfig=function(a){bF(a),br=!0},g.clearConfig=function(){bD=null,br=!1},g.isValidAttribute=function(a,b,c){bD||bF({});var d=a.toLowerCase(),e=b.toLowerCase();return bO(d,e,c)},g.addHook=function(a,b){if(typeof b!="function")return;Z[a]=Z[a]||[],Z[a].push(b)},g.removeHook=function(a){Z[a]&&Z[a].pop()},g.removeHooks=function(a){Z[a]&&(Z[a]=[])},g.removeAllHooks=function(){Z={}},g}"use strict";var a=Object.freeze||function(a){return a},b=a(["a","abbr","acronym","address","area","article","aside","audio","b","bdi","bdo","big","blink","blockquote","body","br","button","canvas","caption","center","cite","code","col","colgroup","content","data","datalist","dd","decorator","del","details","dfn","dir","div","dl","dt","element","em","fieldset","figcaption","figure","font","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","img","input","ins","kbd","label","legend","li","main","map","mark","marquee","menu","menuitem","meter","nav","nobr","ol","optgroup","option","output","p","pre","progress","q","rp","rt","ruby","s","samp","section","select","shadow","small","source","spacer","span","strike","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","tr","track","tt","u","ul","var","video","wbr"]),c=a(["svg","a","altglyph","altglyphdef","altglyphitem","animatecolor","animatemotion","animatetransform","audio","canvas","circle","clippath","defs","desc","ellipse","filter","font","g","glyph","glyphref","hkern","image","line","lineargradient","marker","mask","metadata","mpath","path","pattern","polygon","polyline","radialgradient","rect","stop","style","switch","symbol","text","textpath","title","tref","tspan","video","view","vkern"]),d=a(["feBlend","feColorMatrix","feComponentTransfer","feComposite","feConvolveMatrix","feDiffuseLighting","feDisplacementMap","feDistantLight","feFlood","feFuncA","feFuncB","feFuncG","feFuncR","feGaussianBlur","feMerge","feMergeNode","feMorphology","feOffset","fePointLight","feSpecularLighting","feSpotLight","feTile","feTurbulence"]),e=a(["math","menclose","merror","mfenced","mfrac","mglyph","mi","mlabeledtr","mmultiscripts","mn","mo","mover","mpadded","mphantom","mroot","mrow","ms","mspace","msqrt","mstyle","msub","msup","msubsup","mtable","mtd","mtext","mtr","munder","munderover"]),f=a(["#text"]),g=Object.freeze||function(a){return a},h=g(["accept","action","align","alt","autocomplete","background","bgcolor","border","cellpadding","cellspacing","checked","cite","class","clear","color","cols","colspan","coords","crossorigin","datetime","default","dir","disabled","download","enctype","face","for","headers","height","hidden","high","href","hreflang","id","integrity","ismap","label","lang","list","loop","low","max","maxlength","media","method","min","multiple","name","noshade","novalidate","nowrap","open","optimum","pattern","placeholder","poster","preload","pubdate","radiogroup","readonly","rel","required","rev","reversed","role","rows","rowspan","spellcheck","scope","selected","shape","size","sizes","span","srclang","start","src","srcset","step","style","summary","tabindex","title","type","usemap","valign","value","width","xmlns"]),i=g(["accent-height","accumulate","additive","alignment-baseline","ascent","attributename","attributetype","azimuth","basefrequency","baseline-shift","begin","bias","by","class","clip","clip-path","clip-rule","color","color-interpolation","color-interpolation-filters","color-profile","color-rendering","cx","cy","d","dx","dy","diffuseconstant","direction","display","divisor","dur","edgemode","elevation","end","fill","fill-opacity","fill-rule","filter","flood-color","flood-opacity","font-family","font-size","font-size-adjust","font-stretch","font-style","font-variant","font-weight","fx","fy","g1","g2","glyph-name","glyphref","gradientunits","gradienttransform","height","href","id","image-rendering","in","in2","k","k1","k2","k3","k4","kerning","keypoints","keysplines","keytimes","lang","lengthadjust","letter-spacing","kernelmatrix","kernelunitlength","lighting-color","local","marker-end","marker-mid","marker-start","markerheight","markerunits","markerwidth","maskcontentunits","maskunits","max","mask","media","method","mode","min","name","numoctaves","offset","operator","opacity","order","orient","orientation","origin","overflow","paint-order","path","pathlength","patterncontentunits","patterntransform","patternunits","points","preservealpha","preserveaspectratio","r","rx","ry","radius","refx","refy","repeatcount","repeatdur","restart","result","rotate","scale","seed","shape-rendering","specularconstant","specularexponent","spreadmethod","stddeviation","stitchtiles","stop-color","stop-opacity","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-miterlimit","stroke-opacity","stroke","stroke-width","style","surfacescale","tabindex","targetx","targety","transform","text-anchor","text-decoration","text-rendering","textlength","type","u1","u2","unicode","values","viewbox","visibility","vert-adv-y","vert-origin-x","vert-origin-y","width","word-spacing","wrap","writing-mode","xchannelselector","ychannelselector","x","x1","x2","xmlns","y","y1","y2","z","zoomandpan"]),j=g(["accent","accentunder","align","bevelled","close","columnsalign","columnlines","columnspan","denomalign","depth","dir","display","displaystyle","fence","frame","height","href","id","largeop","length","linethickness","lspace","lquote","mathbackground","mathcolor","mathsize","mathvariant","maxsize","minsize","movablelimits","notation","numalign","open","rowalign","rowlines","rowspacing","rowspan","rspace","rquote","scriptlevel","scriptminsize","scriptsizemultiplier","selection","separator","separators","stretchy","subscriptshift","supscriptshift","symmetric","voffset","width","xmlns"]),k=g(["xlink:href","xml:id","xlink:title","xml:space","xmlns:xlink"]),l=Object.hasOwnProperty,m=Object.setPrototypeOf,n=typeof Reflect!="undefined"&&Reflect,o=n.apply;o||(o=function(a,b,c){return a.apply(b,c)});var r=Object.seal||function(a){return a},s=r(/\{\{[\s\S]*|[\s\S]*\}\}/gm),t=r(/<%[\s\S]*|[\s\S]*%>/gm),u=r(/^data-[\-\w.\u00B7-\uFFFF]/),v=r(/^aria-[\-\w]+$/),w=r(/^(?:(?:(?:f|ht)tps?|mailto|tel|callto|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i),x=r(/^(?:\w+script|data):/i),y=r(/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205f\u3000]/g),z=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(a){return typeof a}:function(a){return a&&typeof Symbol=="function"&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},B=typeof Reflect!="undefined"&&Reflect,C=B.apply,D=Array.prototype.slice,E=Object.freeze,F=function(){return typeof window=="undefined"?null:window};C||(C=function(a,b,c){return a.apply(b,c)});var G=function(a,b){if((typeof a=="undefined"?"undefined":z(a))!=="object"||typeof a.createPolicy!="function")return null;var c=null,d="data-tt-policy-suffix";b.currentScript&&b.currentScript.hasAttribute(d)&&(c=b.currentScript.getAttribute(d));var e="dompurify"+(c?"#"+c:"");try{return a.createPolicy(e,{createHTML:function(a){return a}})}catch(f){return console.warn("TrustedTypes policy "+e+" could not be created."),null}},I=H();return I}),maxkir.UploadShared={IMG_REG:/\[img: ?([^\]]+)]/g,IMG_REG_MD:/!\[([^\]]*)]\(([^)]+)\)/g,is_img:function(a){return a&&a.the_content_type&&a.the_content_type.indexOf("image/")===0},is_pdf:function(a){return a&&a.the_content_type&&a.the_content_type.indexOf("/pdf")>0},is_txt:function(a){return a&&a.the_content_type&&a.the_content_type.indexOf("/text")>0},is_archive:function(a){return a&&a.the_content_type&&a.the_content_type.indexOf("zip")>0},convert_images:function(a,b){if(-1===b.indexOf("![")&&-1===b.indexOf("[img"))return b;var c=function(a,b,c,d,e){var f=100;if(c){if(c.charAt(c.length-1)==="%"){var g=c.match(/\|?(\d+)%$/);g&&(f=g[1],c=c.substring(0,g.index))}if(g=c.match(/\|?(\d+)x(\d+)/))d=g[1],e=g[2],c=c.substring(0,g.index)}var h="";if(!maxkir.isWidget)if(d>0&&e>0){var i=d*f/100;h="width:"+i+"px;height:auto;",d>800&&f<100&&(h+="max-width:"+parseInt(f)+"%;")}else h+="max-width:"+parseInt(f)+"%;";return c=c?maxkir.escapeHtml(c):"","<div class='renderedImages'><img src='"+maxkir.escapeHtml(a)+"' alt=\""+c+"\" style='"+h+"' data-imgUrl='"+maxkir.escapeHtml(b)+"' data-scale='"+f+"'></div>"};return b=b.replace(this.IMG_REG_MD,function(b,d,e){if(e.indexOf("/")>=0)return c(e,e,d);for(var f=0;f<a.length;f++)if(a[f].the_file_name===e&&this.is_img(a[f]))return c(a[f].url,e,d,a[f].width,a[f].height);return b}.bind(this)),b=b.replace(this.IMG_REG,function(b,d){for(var e=0;e<a.length;e++)if(a[e].the_file_name===d&&this.is_img(a[e]))return c(a[e].url,d,"",a[e].width,a[e].height);return b}.bind(this)),b}},"use strict",maxkir.CommonRender={LIST_PREFIX:"/checklists/",stripTags:function(a){return a.replace(/<[^>]+>/gi,"").trim()},format_due:function(a){return a=="ASAP"?"asap":this.date(a).cl_format_date(!0,!0)},date:function(a){return maxkir.dates.date(a)},is_future_due:function(a){if(!a||"ASAP"==a)return!1;var b=this.date(a);return b.is_after_tomorrow()},is_local_url:function(a){"use strict";var b=a.replace(/https?:\/\//,"").replace(/\/.*$/,""),c=location.host;return b==c},due_date_css_class:function(a){var b="",c=a.details;c&&c.has_repeating&&(b+=" repeatingDue"+(c.has_repeating>1?" repeatingPaused":""));var d=a.due;if(!d)return b;if("ASAP"==d)return b+=" due_asap dueASAP",b;var e=this.date(d);return e.is_overdue()&&a.status==0?b+=" due_overdue dueOverdue":b+=e.is_today()?" due_today dueToday":e.is_tomorrow()?" dueTomorrow":e.is_after_tomorrow()?" dueFuture":"",b},sanitize_text:function(a){return this._sanitize_init||(this._sanitize_init=!0,DOMPurify.setConfig({WHOLE_DOCUMENT:!1,ADD_TAGS:["u","table","tr","td","th","thead","tbody","q"],FORBID_TAGS:["marquee"],ADD_ATTR:["border","cellspacing","cellpadding","hspace","vspace"],ALLOW_UNKNOWN_PROTOCOLS:!0})),DOMPurify.sanitize(a).toString()},format_for_rendering:function(a,b,c){a=this._process_gmail_and_links(a),a=maxkir.UploadShared.convert_images(c||[],a);var d=function(a){return maxkir.escapeHtml(a)},e=function(a){return"<div class='renderedImages'>"+a+"</div>"};if(b||maxkir.use_md&&maxkir.use_md()){if(!maxkir.md_converter){var f={html:!0,xhtmlOut:!1,breaks:!0,langPrefix:"language-",linkify:!1};typeof hljs!="undefined"&&(f.highlight=function(a,b){if(b&&hljs.getLanguage(b))try{return hljs.highlight(b,a).value}catch(c){}return""}),maxkir.md_converter=new Remarkable(f),maxkir.md_converter.renderer.rules.image=function(a,b,c){var f=' src="'+d(a[b].src)+'"',g=a[b].title?' title="'+d(a[b].title)+'"':"",h=' alt="'+(a[b].alt?d(a[b].alt):"")+'"',i=c.xhtmlOut?" /":"";return e("<img"+f+h+g+i+">")}}a=this._fix_checkmarks(a),a=maxkir.md_converter.render(a).trim();if(a.endsWith("</div></p>")){var g=a.indexOf("<div class='renderedImages");g>0&&(a=a.substring(0,g)+"</p>"+a.substring(g,a.length-4))}}else a=this._replace_new_lines(a);return a=this.make_clickable(a),a},format_for_breadcrumbs:function(a){var b=a.replace(/^\[[*1]?]\s*/,"");return b=maxkir.CommonRender.sanitize_text(maxkir.CommonRender.format_for_rendering(b,!0,[])),maxkir.CommonRender.stripTags(b)},_process_gmail_and_links:function(a){return a=a.replace(/\[(\d*)]/g,"#_CV_#BR$1##"),a.replace(this.LNKREG,this._extension_replacer).replace(/#_CV_#BR(\d*)##/g,"[$1]")},_fix_checkmarks:function(a){return a.replace(/- \[ ]/g,"- &#x2610;").replace(/- \[x]/g,"- &#x2611;")},LNKREG:/\[(\w+): *(.+?)\|\s*([-\w\/#]+|(([\w-]+:|\/)[^\]]+?))\]/g,_extension_replacer:function(a,b,c,d){var e=maxkir.CommonRender;switch(b){case"link":return'<A href="'+d+'">'+c+"</A>";case"gmail"
:return d.indexOf("#")==-1&&(d="0/#all/"+d),e.favicon(b)+'<A href="https://mail.google.com/mail/u/'+d+'">'+c+"</A>";case"list":return e.favicon(b)+'<A href="'+e.LIST_PREFIX+d+'">'+c+"</A>";case"jira":case"youtrack":case"github":return e.favicon(b)+'<A href="'+d+'">'+c+"</A>"}return a},favicon:function(a){var b="/assets/favicons/"+a+"_32.png 1.5x,/assets/favicons/"+a+"_16.png 1x";return'<img src="/assets/favicons/'+a+"_32.png\" srcset='"+b+"' style='border-radius:1px; width: 16px; height: 16px; border: none; vertical-align: text-bottom; margin-right: .3em;padding-bottom:1px;'/>"},_replace_new_lines:function(a){return a.replace(/\n/g,"<br>\n")},URL_REG:/(^|[^-='"\w])(\w[-\w]+\:(?:\/\/\/?|\\\\)(?:[a-zA-Z0-9]+)[:|_a-zA-Z0-9\-\.]*(?:\:[0-9]+)?(?:[^\s\n\r*<"\]\)\[\(]|\(\w+\)|\[\w*\])*)/gm,_URLREG:/(^|[^-='"\w])(\w[-\w]+\:(?:\/\/\/?|\\\\)(?:[a-zA-Z0-9]+)[:|_a-zA-Z0-9\-\.]*(?:\:[0-9]+)?(?:[^\s\n\r*<"\]\)\[\(]|\(\w+\)|\[\w*\])*)/m,make_clickable:function(a){return a.replace(this.URL_REG,function(a,b,c,d,e){var f=e.lastIndexOf("<",d),g=e.charAt(f+1);if(f>=0&&(g=="A"||g=="a")){if(b.charAt(0)==">")return a;var h=e.lastIndexOf(">",d);if(f>h)return a}return b+'<a class="toShorten" href="'+c+'">'+c+"</a>"})},user_short_name:function(a){return a.trim().replace(/ /g,"_").replace(/</g,"&lt;")},smart_syntax_attributes:function(a,b,c,d){var e=this.smart_syntax_tokens(a,b,c,d);return e.length?"  "+e.join(" "):""},smart_syntax_tokens:function(a,b,c,d){var e=[];a.due&&e.push("^"+this.format_due(a.due));var f=[];for(var g in a.tags)f.push(b(g));f=f.sort();for(var h=0;h<f.length;h++)e.push("#"+f[h]);var i=a.assignee_ids;if(i&&i.length&&d)for(h=0;h<i.length;h++){var j=c(i[h]);j&&e.push("@"+this.user_short_name(j))}return e},prepare_list_style:function(a,b){if(a.length&&a[0]==="["&&b){var c=["[]","boxesList","[ ]","boxesList","[*]","bulletsList","[1]","numberedList"];for(var d=0;d<c.length;d+=2){var e=c[d];if(a.indexOf(e)===0){var f=a.substr(e.length).trim();if(f.length>0)return{text:f,css_list_class:c[d+1]}}}}return{text:a,css_list_class:""}},HEADER_RE:/^<h([1-6])/i,header_class:function(a){var b=this.HEADER_RE.exec(a);return b?" header"+b[1]:""},_f:null},maxkir.TaskRenderer=function(a,b,c,d){this.task_data=a,this.id=a.id,this.checklist_id=a.checklist_id,this.processed=d||{},this.processed[a.id]=!0,this.read_only=b,this.task_data_provider=c||function(a){return maxkir.Task.data(a)},this.breadcrumbs_cache=maxkir.TaskRenderer.breadcrumbs_cache},maxkir.TaskRenderer.breadcrumbs_cache={},maxkir.extend(maxkir.TaskRenderer,{getLiHtml:function(){var a=this.full_task_content();return'  <li class="'+this.li_class()+'" id="task_'+this.id+'">'+this.up_down_border()+a+"  </li>"},li_class:function(){var a="";this.hasSubtasks()?(typeof this.has_open_child!="boolean"&&this.calc_has_open_child(),a=this.collapsed()?" node_collapsed":" node_expanded",a+=this.has_open_child?"":" noOpenChildren"):a=" leafItem";var b="";maxkir.TaskRendererContext&&maxkir.TaskRendererContext.is_hidden(this.task_data)&&(b=" hidden ");var c=maxkir.FindFilter&&maxkir.FindFilter.is_hidden("task_"+this.id)?" hiddenByFilter":"",d=maxkir.Task.isDivider(this.id)?" dividerClass":" nonDivider",e=maxkir.CommonRender.is_future_due(this.task_data.due)?" dueFuture":"";return"task dndNode"+c+b+d+a+e+(this._li_class_from_text||"")+this.progressCounter_class()},up_down_border:function(){return"<div class='frame'></div>"},updateContent:function(a,b){maxkir.debug("Update content for "+this.id+", with children: "+!!a);var c=$(this._id());if(!c){maxkir.info("Cannot update task "+this.task_data.content);return}var d=$("core_"+this.id);if(a){var e=maxkir.notes(this.id).extract_dom_fragment();maxkir.Task.update_position_data_from_parent(this.id),c.innerHTML=this.up_down_border()+this.full_task_content();if(e){var f=$("core_"+this.id).up().down(".dndUl");$("core_"+this.id).parentNode.insertBefore(e,f)}}else if(d){var g=d.lastRenderedHtml,h=d.className,i=this.main_task_content();if(g!==i||b)d.innerHTML=i,d.lastRenderedHtml=i;d.className=this.div_core_classes();var j=$("parentTask_"+this.id);j&&j[this.collapsed()?"addClassName":"removeClassName"]("hidden")}c.className=this.li_class(),maxkir.tree_nav&&maxkir.tree_nav.get_all_selection().indexOf(this._id())>=0&&maxkir.visible(this._id())&&maxkir.tree_nav.add_selection([this._id()])},updateOnFilter:function(){var a=$("tsk"+this.id);a&&(a.innerHTML=this.task_text());var b=new maxkir.TaskNotesFiles(this.id);b.update_line(),maxkir.NotesState.skip_remember_state(function(){var a=maxkir.notes(this.id);b.has_match_in_filter()?(a.hide_notes(!0),a.show_existing(),a._shown_from_filter=!0):(a._shown_from_filter&&a.hide_notes(!0),delete a._shown_from_filter)}.bind(this))},hasSubtasks:function(){var a=this.task_data.tasks;return a&&a.length&&a.length>0},_id:function(){return"task_"+this.id},full_task_content:function(){var a=this.main_task_content(),b="<div id='core_"+this.id+"' class='"+this.div_core_classes()+"'>";return b+=a,b+="</div> \n",b+this.children_html()},progress_counter:function(){if(this._withPc()){var a=maxkir.ProgressCounter.completion_stats(this.task_data);return maxkir.ProgressCounterElement.createElementHtml(a.percent_completed,a.total,a.completed,a.estimate,!1)}return""},_withPc:function(){return this.task_data.details.progress_counter},actions_icon:function(){return!maxkir.Task.isDivider(this.id)&&!this.read_only?"<i class='act far fa-ellipsis-v' title='Actions'></i>":""},div_core_classes:function(){return"coreDiv "+this.mark_class()+this.priority_class()+this.closed_class()+this.tags_css_classes()+maxkir.CommonRender.due_date_css_class(this.task_data)+this.header_class()},progressCounter_class:function(){return this._withPc()?" task--progressCounter":""},header_class:function(){return maxkir.CommonRender.header_class(this.rendered_content)},tags_css_classes:function(){var a="",b=this.task_data.tags;for(var c in b)if(b.hasOwnProperty(c)){var d=maxkir.Tags.findOrCreate(c);a+=" tag_"+d.tag}return a},collapsed:function(){return this.hasSubtasks()&&this.task_data.collapsed},main_task_content:function(){var a=this.task_text_tag(),b=a.split("renderedImages").length-1,c=this.due_date()+this.task_tags()+this.task_assignee()+this.task_notes_and_files(b)+this.task_before_update_details()+this.task_update_details();return a.endsWith("</div></span>")?a+="<div class='task__afterContentBlock'>"+c+"</div>":a+=c,this.pre_content()+"<span class='"+this.mark_class()+" editable priorityColored'>"+a+"</span>"+"<span class='bgMarker "+this.mark_class()+" priorityColored'></span>"+this.progress_counter()+this.actions_icon()},pre_content:function(){var a="",b=maxkir.Task.isDivider(this.id);return this.hasSubtasks()&&(a+='<div class="nodeImage '+(this.collapsed()?"node_collapsed":"")+'" id="handle_task_'+this.id+'"></div>'),!b&&(!this.hasSubtasks()||maxkir.Print&&maxkir.Print.is_shown())&&(a+='<i class="checkMark"></i><i class="icon-circle bulleted"></i>'),a},task_text_tag:function(){return maxkir.Task.isDivider(this.id)?"<div class='hrDivider'></div>":'<span id="tsk'+this.id+'" class="node_text taskContent userContent '+this.closed_class()+'" title="'+this.task_under()+'">'+this.task_text()+"</span>"},task_under:function(){var a=this.task_data.breadcrumbs;a?this.breadcrumbs_cache[this.task_data.id]=a:a=this.breadcrumbs_cache[this.task_data.id];if(maxkir.GroupByListOption&&!maxkir.GroupByListOption.on()){var b=maxkir.CommonRender.sanitize_text(maxkir.Lists.data(this.checklist_id).name);a?a=b+" > "+a:a=b}return a&&(a=I18N("under")+": "+a.stripTags().replace(/"/g,"")),a||""},task_text:function(){var a=this.task_data.content;return a==="/Edit text/"&&(a="<span class='emptyTextContainer'>"+I18N("empty_item_placeholder")+"</span>"),a=this.prepare_list_style(a),a=maxkir.format_for_rendering(a,this.task_data.checklist_id,this.task_data.uploads),maxkir.Task.from_email(this.task_data.id)&&(a='<i class="fal fa-envelope" title="'+I18N("from_email_tooltip")+'"></i> '+a),a=this.highlight_task_text(a),this.rendered_content=a,a},prepare_list_style:function(a){var b=maxkir.CommonRender.prepare_list_style(a,this.markdown());return this._li_class_from_text=" "+b.css_list_class,b.text},markdown:function(){var a=maxkir.Lists&&maxkir.Lists.data(this.task_data.checklist_id);return a&&a.markdown&&a.markdown()},highlight_task_text:function(a){return maxkir.Search?maxkir.Search.highlight_text(a):maxkir.FindFilter?maxkir.FindFilter.highlight_text(a):a},task_before_update_details:function(){return""},task_update_details:function(){return maxkir.Task.isDivider(this.id)?"":'<span class="updLine" id="updLine_'+this.id+'">'+this.update_line()+"</span>"},closed_class:function(){return this.task_data.status==1?" task_closed":this.task_data.status==2?" task_invalidated":""},mark_class:function(){return this.task_data.details.mark||""},priority_class:function(){var a=maxkir.Task.priority(this.task_data);return a>0?" priority_"+a:""},task_notes_and_files:function(a){return(new maxkir.TaskNotesFiles(this.id)).render(a)},due_date:function(){var a=this.task_data.due,b=this.due_presentation_data(a),c=this.task_data.details.has_repeating;if(!b[0]&&!c)return"";var d="",e="";return c&&(d=" repeating",e="<i class='far "+(c>1?"fa-pause":"fa-sync")+"'></i> "),b[0]?this.due_prefix(b[2]+d)+" title='"+b[1]+"'>"+e+b[0]+"</span>":this.due_prefix(""+d)+" title='This task has repeating due'>"+e+"</span>"},due_prefix:function(a){return"<span "+this.dd_id()+" class='afterTask dueDate "+a+"' "},due_tooltip:function(a){var b=a.cl_format_date(!0,!0),c=a.diff_days();return Math.abs(c)>1&&(b+=c>=2?" (in "+c+" days)":" ("+ -c+" days ago)"),b},due_presentation_data:function(a){if(!a)return[null];if("ASAP"==a)return["ASAP","This task is marked for ASAP completion","today"];var b=maxkir.dates.date(a),c=this.due_tooltip(b),d=b.cl_format_date(!0,!1);if(b.is_overdue()&&this.task_data.status==0)return[d,"Missed due date: "+c,"overdue"];var e=b.is_today()?" today":"";return[d,"Due date: "+c,e]},task_tags:function(){return maxkir.TagRenderer.renderTagMap(this.task_data.tags)},task_assignee:function(){var a=this.task_data.assignee_ids;if(!a||a.length==0)return"";var b="";return $A(a).each(function(a){var c=maxkir.user.user_by(a);c||(c={id:a,username:"This user doesn't collaborate on the list",short_name:function(){return"unshared user"}}),b+=maxkir.AssigneeRenderer.getHtml(c)}),b},dd_id:function(){return"id='dd"+this.id+"'"},update_line:function(){return this.task_data.status==2?"<em class='afterTask updateLine'>"+this.update_text()+"</em>":"<span class='afterTask updateLine'>"+this.update_text()+"</span>"},update_text:function(){var a=this.task_data.update_line||"";a&&a.length>0?a.startsWith("created")&&maxkir.Task.from_email(this.task_data.id)?a=I18N("emailed_in")+" ":a+=" | ":a=I18N("updated")+" ";if(this.task_data.updated_at){var b=maxkir.format_time(this.task_data.updated_at,!0);b.startsWith("at ")&&(b=maxkir.format_time(this.task_data.updated_at)),a+="<a class='hoverPopup' href='/checklists/"+this.checklist_id+"/tasks/"+this.id+"' data-popup-id='textPopup' data-text-key='js_item_timestamp_tooltip'>"+b+"</a>"}return a},calc_has_open_child:function(){this.has_open_child=!1;var a=this.task_data.tasks;if(a)for(var b=0;b<a.length;b++){var c=this.task_data_provider(a[b]);this.has_open_child=this.has_open_child||!c.status;if(this.has_open_child)break}},children_html:function(){var a="";this.has_open_child=!1;var b=this.task_data.tasks;if(b){maxkir.Task.sort_tasks(b);for(var c=0;c<b.length;c++)if(!this.processed[b[c]]){var d=this.task_data_provider(b[c]);this.has_open_child=this.has_open_child||!d.status;if(!this.collapsed()){maxkir.notes.visible(d.id)&&maxkir.notes(d.id).hide_notes(!0);var e=new maxkir.TaskRenderer(d,this.read_only,this.task_data_provider,this.processed);a+=e.getLiHtml()}}}var f="";return maxkir.TaskFocus&&maxkir.TaskFocus.shouldAddFocusActiveUL(this.task_data)&&(f+=" focusActive"),'<ul id="parentTask_'+this.id+'" class="dndUl'+f+'">'+a+"</ul>"}}),maxkir.TaskNotesFiles=function(a,b){this.task_id=a,this.task_data_provider=b||function(a){return maxkir.Task.data(a)}},maxkir.extend(maxkir.TaskNotesFiles,{render:function(a){return this.comments_count()>0||this.uploads_count()>a?'<a href="#" class="'+this._classes()+'" id="cc'+this.task_id+'" title="'+this._link_title()+'">'+this._link_content()+"</a>":""},_classes:function(){var a="afterTask notesFragment";return this.has_content()||(a+=" hidden"),this._shown()&&(a+=" notesFragmentShown"),a},update_line:function(){var a=document.getElementById("cc"+this.task_id);a&&(a.className=this._classes(),a.title=this._link_title(),a.innerHTML=this._link_content())},comments_count:function(){return this._tdata().comments_count||0},uploads_count:function(){return parseInt(this._tdata().details.uploads_count||0)},has_content:function(){return this.comments_count()+this.uploads_count()>0},_tdata:function(){return this.task_data_provider(this.task_id)||{details:{}}},_shown:function(){return maxkir.notes(this.task_id).is_visible()},_link_content:function(){var a="";this._shown()?a="hide "+this._what():(this.comments_count()>0&&(a+="<span class='hasSomethingIcon hasNote'>"+this.comments_count()+"</span>"),this.uploads_count()>0&&(a+="<span class='hasSomethingIcon hasAttachment'>"+this.uploads_count()+"</span>"));if(this._tdata().match_in_notes||this.has_match_in_filter())a='<span class="hlt" title="There is a search match in notes">'+a+"</span>";return a},_link_title:function(){var a=this.has_content()?"Press 'nn' to view":"Press ESC to hide";return a+" "+this._what()},_what:function(){return this.comments_count()>0&&this.uploads_count()>0?"notes and attachments":this.uploads_count()>0?"attachments":"notes"},has_match_in_filter:function(){var a=maxkir.FindFilter;return a&&a.get_result("task_"+this.task_id).has_match("notes")}}),maxkir.TaskData={},maxkir.Task={_editors:{},selected_task_id:function(){return maxkir.Task.id(maxkir.tree_nav.get_selection())},id:function(a){var b=parseInt(this.id_str(a));return isNaN(b)?0:b},id_str:function(a){return a&&a.startsWith("task_")?a.substring(5):"0"},updateParents:function(a){var b=this.id(a);if(!b)return;var c=this.data(b);while(c)maxkir.checklist&&maxkir.checklist.HideCompleted&&maxkir.checklist.HideCompleted.skip_hide_if_closed(c),this.updateTask(c.id),c=this.data(c.parent_id)},data:function(a){return maxkir.TaskData[a]},set_task_data:function(a,b){"use strict";for(var c=0;c<a.length;c++){var d=a[c];d.details||(d.details={}),d.tags||(d.tags={}),b&&maxkir.TaskData[d.id]&&(d.collapsed=maxkir.TaskData[d.id].collapsed),maxkir.TaskData[d.id]=d}},tags:function(a){var b=maxkir.Task.data(a);return b?b.tags:{}},renderer:function(a){var b=this.data(a);return b?new maxkir.TaskRenderer(b,maxkir.Task.read_only(a)):null},updateTaskFromServer:function(a,b){var c=this;return new Promise(function(d,e){new maxkir.AjaxCommand("/checklists/"+maxkir.Task.checklist_id(a)+"/tasks/"+a+".js",{method:"get",onComplete:function(c){b||this.updateTask(a),c.request.success()?d():e()}.bind(c)})})},updateTask:function(a,b){var c=this.data(a);return maxkir._debug&&(c?maxkir.debug("Update task "+(b?"with children ":"")+c.id+":'"+c.content.substr(0,50)+"'"):maxkir.debug("Cannot update task "+(b?"with children ":"")+a)),c&&!this.is_editing(a)&&(this._on_attachments_count_update(a),this.renderer(c.id).updateContent(b)),maxkir.ProgressCounter&&maxkir.ProgressCounter.show_for_list(),c},_on_attachments_count_update:function(a){var b=maxkir.notes(a),c=new maxkir.TaskNotesFiles(a);b.is_visible()&&c.uploads_count()!==$("task_"+a).querySelectorAll(".upload").length&&(b.hide_notes(),b.has_content()&&b.show_notes(function(){},!0))},rerender_tasks_with_parents:function(a,b){"use strict";var c={};for(var d=0;d<a.length;d++){var e=this.data(a[d]);e&&(this.updateTask(e.id,!!b),this.fix_sorting_ui(e.id),e=this.data(e.parent_id));while(e&&!c[e.id])c[e.id]=!0,e=this.data(e.parent_id)}for(var f in c)this.updateTask(f)},insert_new_tasks:function(a,b){"use strict";if(!a.length)return;this.delete_tasks_from_ui(a,!0);var c=[],d=[];a.forEach(function(a){var b=this.data(a).parent_id;b?d.push(b):c.push(a)}.bind(this)),maxkir.FindFilter&&b&&a.forEach(function(a){maxkir.FindFilter.mark_shown("task_"+a)}),this.rerender_tasks_with_parents(d,!0),this._insertTopLevelTasks(c),a.forEach(function(a){this._on_attachments_count_update(a)}.bind(this)),b&&maxkir.tree_nav.set_selection(a.map(function(a){return"task_"+a}))},_insertTopLevelTasks:function(a){for(var b=0;b<a.length;b++){var c=a[b];$("parentTask_0").insert(maxkir.Task.renderer(c).getLiHtml())}this.sort_tasks_under("parentTask_0")},update_positions:function(a){"use strict";for(var b in a){var c=this.data(b);c&&(c.position=a[b])}},is_editing:function(a){var b=this._editors[a];return b&&b.isEditing()},foreach:function(a){var b=maxkir.TaskData;for(var c in b)if(b.hasOwnProperty(c)){var d=b[c];d&&d.id&&d.id>0&&a(d)}},foreachDown:function(a,b,c){if(!a)return;c||(c={});var d=a.tasks,e=!d||!d.length;b(a,e),c[a.id]=!0;if(!e)for(var f=0;f<d.length;f++){var g=this.data(d[f]);g&&!c[g.id]&&this.foreachDown(g,b,c)}},is_leaf:function(a){var b=this.data(a);return b&&(!b.tasks||!b.tasks.length)},task_count:function(){var a=0;return this.foreach(function(){a++}),a},priority:function(a){switch(a.details.mark){case"fg1":return 1;case"fg2":return 2;case"fg3":return 3;case"bg1":return 4;case"bg2":return 5;case"bg3":return 6;case"bg7":return 7;case"bg8":return 8;case"bg9":return 9}return 0},checklist_id:function(a){var b=this.data(a);return b?b.checklist_id:maxkir.checklist_id},read_only:function(a){if(maxkir.read_only)return!0;var b=this.checklist_id(a);if(!b)return!0;var c=maxkir.Lists.data(b);return c&&c.read_only},writable_or_assignee:function(a){var b=this.data(a);return b?!this.read_only(a)||this._accessible_by_assignee(b):!1},_accessible_by_assignee:function(a){return a.assignee_ids&&a.assignee_ids.indexOf(maxkir.current_user_id)>=0},install_dblclick_editor:function(){var a=$(maxkir.TreeProvider.tree_model().getRoot()),b=$(a).on("dblclick",".coreDiv",function(a,b){var c=b.id.startsWith("core_")?b.id.substring("core_".length):null,d=Event.element(a);c&&!d.hasClassName("nodeImage")&&!d.hasClassName("checkMark")&&(maxkir.Task.edit_task(c),Event.stop(a))});$(a).uninstall_dblclick_editor=function(){b.stop(),delete $(a).uninstall_dblclick_editor}},uninstall_dblclick_editor:function(){var a=$(maxkir.TreeProvider.tree_model().getRoot());$(a).uninstall_dblclick_editor&&$(a).uninstall_dblclick_editor()},show:function(a,b){return maxkir.Task.data(a)?(maxkir.checklist.HideCompleted.is_hidden(a)&&maxkir.checklist.HideCompleted.toggle_hide(!0),maxkir.ChecklistNodeToggle.expand(a),maxkir.tree_nav.set_selection("task_"+a),maxkir.notes(a).show_existing(),!maxkir.Task.is_leaf(a)&&!b?maxkir.TaskFocus.add_focus(a):maxkir.TaskFocus.remove_focus(!0),!0):!1},start_editing:function(a){maxkir.tree_nav.hide_selection(),this.toggle_with_class(a,".afterTask")},stop_editing:function(a){maxkir.tree_nav.fix_selection(),maxkir.Task.renderer(a).updateContent(!1,!0)},toggle_with_class:function(a,b){$("core_"+a).select(b).each(function(a){a.toggle()})},uninstall_tree_data:function(){var a=$("parentTask_0").retrieve("dndSupport");a&&a.dispose(),maxkir.checklist.Dnd.stop_dnd(),this.uninstall_dblclick_editor($("parentTask_0")),$("parentTask_0").innerHTML=""},install_tree_data:function(){var a=[];maxkir.Task.foreach(function(b){b.parent_id==0&&a.push(b.id)}),maxkir.Task.sort_tasks(a);var b="";for(var c=0;c<a.length;c++){var d=a[c];b+=maxkir.Task.renderer(d).getLiHtml()}$("parentTask_0").innerHTML=b,this.install_dblclick_editor(),$("parentTask_0").store("dndSupport",this._init_dnd_support())},_init_dnd_support:function(){return maxkir.checklist.Dnd.install(),new maxkir.TreeDropSupport("parentTask_0",{handleOver:function(a,b){var c=maxkir.Task.id(b.getAttribute("id"));this.hasContent(a)&&c>0&&maxkir.Task.writable_or_assignee(c)?(a.dataTransfer.dropEffect="copy",maxkir.tree_nav.set_selection(b.getAttribute("id"))):a.dataTransfer.dropEffect="none",Event.stop(a)},handleDrop:function(a,b){var c=maxkir.Task.id(b.getAttribute("id")),d=maxkir.Task.data(c);if(d){var e=this.files(a),f=a.dataTransfer.getData("Text");maxkir.info("Dropped text "+f),maxkir.info("Dropped files: "+e);var g=/\b(sparrow|mailplane)\b/i;e&&(!f||!g.match(f))?(maxkir.info("Process file drop"),maxkir.Uploads.upload_dnd_files(c,e)):f&&f.trim&&(maxkir.info("Process text drop"),maxkir.add_task.create_task_from_content(f,d))}},files:function(a){if(a.dataTransfer.files&&a.dataTransfer.files.length>0)return a.dataTransfer.files},hasContent:function(a){var b=a.dataTransfer;if(!b)return!1;var c=b.types;for(var d=0;d<c.length;d++)if(c[d]=="Files"||c[d].indexOf("text")==0)return!0;return this.files(a)}})},sort_tasks:function(a){if(a.length<2)return;var b=maxkir.checklist&&maxkir.checklist.CompletedDown&&maxkir.checklist.CompletedDown.is_enabled(),c=function(a,b){return a.position-b.position},d=function(a,d){var e=maxkir.Task.data(a),f=maxkir.Task.data(d);if(!e||!f)return 0;if(b){var g=(e.status?1:0)-(f.status?1:0);if(g!=0)return g;if(e.status!=0&&e.updated_at&&e.updated_at){var h=Date.parse(f.updated_at)-Date.parse(e.updated_at);if(h!=0)return h}}return c(e,f)};a.sort(d)},fix_sorting_ui:function(a){var b=this.data(a);while(b){var c=b.id,d=document.getElementById("task_"+c);d&&maxkir.Task.sort_tasks_under($(d).up()),b=this.data(b.parent_id)}},sort_tasks_under:function(a){a=$(a);var b=[],c=maxkir.tree_model.getNodes(a,!0);for(var d=0;d<c.length;d++)b.push(maxkir.Task.id(c[d]));maxkir.Task.sort_tasks(b);if(b.length<2)return;var e=document.createElement("li");a.insertBefore(e,a.childNodes[0]);for(var d=0;d<b.length;d++)$("task_"+b[d])&&a.insertBefore($("task_"+b[d]),e);a.removeChild(e)},update_position_data_from_ui:function(){maxkir.tree_model.foreach(function(a,b){var c=maxkir.Task.id(a),d=maxkir.Task.data(c);d&&(d.position=b+1)})},update_position_data_from_parent:function(a){var b=this.data(a),c=b?b.tasks||[]:[];for(var d=0;d<c.length;d++){var e=this.data(c[d]);e&&(e.position=d+1)}},isDivider:function(a){var b=a.content?a:maxkir.Task.data(a);return b&&/^---+$/.test(b.content)},from_email:function(a){var b=this.data(a);return b&&b.details&&b.details.from_email},edit_task:function(a){this.is_editing(a)||(this.read_only(a)?this.no_write_access_message():this._create_task_editor(a).enterEditMode())},no_write_access_message:function(){new maxkir.ui.Message(I18N(maxkir.writer_invitation?"js_login_to_write_list":"js_error.no_write_access_to_selected"))},_create_task_editor:function(a){var b=this,c,d,e=maxkir.Task.checklist_id(a),f=maxkir.Task.task_text_fixer(this.data(a)),g=new maxkir.ui.InplaceEditor($("task_"+a).down(".editable"),"/checklists/"+e+"/tasks/"+a+".js?parse=true",{paramName:"task[content]",fieldPostCreation:!1,no_dblclick:!0,onEscUndo:function(b){this.esc_undo(maxkir.Task._editors[a],b)},onEnterEditMode:function(b){$("core_"+a).addClassName("coreDiv--editing"),setTimeout(function(){c=new maxkir.ui.InputHints(b.editField),d=maxkir.ui.EditorShortcuts(b.editField,e)},20)},onLeaveEditMode:function(b){$("core_"+a).removeClassName("coreDiv--editing"),c&&(c.dispose(),c=null,d.dispose(),d=null)},submitHandlerPromise:function(b){return b.parse=!0,b["task[content]"]=f.fix_content(b["task[content]"]),maxkir.Task.save([a],e,Object.toQueryString(b))}},{});g.getText=function(){var c=maxkir.Task.data(a);return c.content+b._smart_attributes(c)},g.updateOnSaving=function(b,c){var d=maxkir.Task.data(a);d&&(b.classList.add("userContent","priorityColored"),c=f.fix_content(c),b.innerHTML=maxkir.format_for_rendering(c,d.checklist_id,d.uploads))};var h=function(){var b=$("task_"+a);maxkir.Task.isDivider(a)?(b.addClassName("dividerClass"),b.removeClassName("nonDivider")):(b.removeClassName("dividerClass"),b.addClassName("nonDivider"))};return g.leaveEditMode=function(){var c=g._editing;maxkir.ui.InplaceEditor.prototype.leaveEditMode.call(this),c&&!maxkir.EditTracker.is_editing()&&(maxkir.DataCompleter.uninstall(this.editField),maxkir.Task.stop_editing(a),h(),delete b._editors[a],g.destroy())},maxkir.run_around(g,"handleFormSubmission",function(){var b=$A(arguments),c=b.shift(),d=$F(this._controls.editor);if(d!=null&&d.match(/^\s*$/)&&this.element){var f=new maxkir.TaskNotesFiles(a);f.has_content()?c.apply(this,b):(maxkir.Task.delete_tasks(e,[a]),this.handleFormCancellation())}else d!=null&&c.apply(this,b)}.bind(g)),maxkir.run_before(g,"customizeEditField",function(){maxkir.Task.start_editing(a);var b=maxkir.Task.data(a),c=maxkir.DataCompleter.create_completer(this.editField,{existing_tags_map:b?b.tags:{},task_content_editing:!0,checklist_id:b.checklist_id,afterUpdateElement:f.onElementComplete});c.addHandler(maxkir.UploadCompleter),c.addHandler(maxkir.ListCompleter),c.addHandler(maxkir.LinkCompleter),setTimeout(function(){var a=this.editField.value.match(/^(\[[\*|1]?\])?\s?#*\s*\*{0,2}/),b=a?a[0].length:0;b>0&&"["==this.editField.value.charAt(b-1)&&b--;var c=this.editField.value.search(/\**   (\(due:|\^|@|#)/);c<0&&(c=this.editField.value.search(/\**\s*$/)),c<b&&(c=this.editField.value.length),maxkir.set_selection_textarea(this.editField,b,c-b)}.bind(this),20)}),this._editors[a]=g,g},_smart_attributes:function(a){var b=this._smart_tokens(a);return b.length?"   "+b.join(" "):""},_smart_tokens:function(a){return maxkir.CommonRender.smart_syntax_tokens(a,function(a){return maxkir.Tags.findOrCreate(a).tag},function(a){var b=maxkir.user.user_by(a);return b?b.username:null},maxkir.is_pro)},update_tasks_content:function(a,b,c){var d={};a.forEach(function(a){var b=maxkir.Task.data(a);b&&(b.content=c(b.content,b),b.updated_at=(new Date).toISOString(),d[a]=b.content,maxkir.Task.updateTask(b.id))});if(b){var e="";for(var f in d)e+="&task[content]["+f+"]="+encodeURIComponent(d[f]);maxkir.Task.save(a,maxkir.Task.checklist_id(a[0]),e)}},save:function(task_ids,checklist_id,params){if(!task_ids.length||maxkir.Task.read_only(task_ids[0]))return;var due_was=maxkir.Task.data(task_ids[0]).due;return new Promise(function(resolve,reject){new maxkir.AjaxCommand("/checklists/"+checklist_id+"/tasks/"+task_ids[0]+".js",{parameters:params+"&task_ids="+task_ids.join(","),evalScripts:!0,method:"PUT",onSuccess:function(){maxkir.Notifications&&maxkir.Notifications.enable()},onComplete:function(response){response.request.success()?setTimeout(function(){try{eval(response.responseText);var due_new=maxkir.Task.data(task_ids[0]).due;due_was!==due_new&&due_new?maxkir.Due.refresh_after_due_change(task_ids):task_ids.forEach(function(a){try{maxkir.Task.updateTask(a);if(maxkir.ProgressCounter){var b=maxkir.Task.data(a);b&&maxkir.ProgressCounter.on_task_updated(b)}}catch(c){}}),maxkir.FindFilter.show_refresh_hint_if_needed(task_ids)}finally{resolve()}},10):reject()}})})},set_assignee:function(a,b,c){if(this.read_only(a[0]))return;a.forEach(function(a){var c=maxkir.Task.data(a);c.assignee_ids=b,maxkir.Task.updateTask(a)});if(!c){var d="task[assignee_ids][]=&";$A(b).each(function(a){d+="task[assignee_ids][]="+a+"&"});var e=maxkir.Task.checklist_id(a[0]);this.save(a,e,d)}},set_task_detail:function(a,b,c){if(!a||a.length==0)return;var d=maxkir.Task.checklist_id(a[0]);new maxkir.AjaxCommand("/checklists/"+d+"/tasks/"+a[0]+"/details",{method:"put",parameters:"details["+b+"]="+c+"&task_ids="+a.join(","),onComplete:function(){a.forEach(function(a){maxkir.Task.updateTask(a)}),maxkir.FindFilter.show_refresh_hint_if_needed(a)}})},task_text_fixer:function(a){var b=[];a&&(b=b.concat(this._smart_tokens(a)));var c=function(a){return b.length&&b.forEach(function(b){var c=a.indexOf(b);if(c>=0){var d=b.length;a.charAt(c+d)===" "&&d++,a=a.substring(0,c)+a.substring(c+d)+" "+b}}),a};return{onElementComplete:function(a,c){c&&b.push(Element.collectTextNodesIgnoreClass(c,"informal"))},fix_content:function(a){return c(a)}}},focused_task_id_from_url:function(){var a=document.location.hash,b=a.match(/#task_(\d+)/);return b&&b.length==2?b[1]:null},dump:function(){"use strict";var a={},b=[];for(var c in maxkir.TaskData)a[c]=maxkir.TaskData[c],a[c].parent_id||b.push(c);var d=function(b,c){var e="";return b.forEach(function(b){var f=a[b];e+=c+f.content+" "+f.position+"\n",f.tasks&&f.tasks.length&&(e+=d(f.tasks,c+"  "))}),e};return this.sort_tasks(b),d(b,"")}},maxkir.Task.delete_tasks=function(a,b,c){if(!b.length)return;maxkir.add_task.hide_add(),maxkir.CommandProcessor.flushDelayedQueue(),maxkir.checklist.Dnd.stop_dnd(),maxkir.Task.delete_tasks_from_ui(b,c);var d=function(){"use strict",b.forEach(function(a){delete maxkir.TaskData[a]}),maxkir.checklist.Dnd.install(),maxkir.ProgressCounter&&maxkir.ProgressCounter.show_for_list()};if(c){d();return}new maxkir.AjaxCommand(a+"/tasks/"+b[0]+".js",{method:"delete",parameters:"task_ids="+b.join(","),onSuccess:maxkir.Notifications.enable,evalJS:"force",onComplete:function(a){a.request.success()?d():(b.forEach(function(a){delete maxkir.TaskData[a]}),maxkir.checklist.Dnd.install())}})},maxkir.Task.delete_tasks_from_ui=function(a,b){var c=[];a.forEach(function(a){var b=$("task_"+a);b&&(b.deleted=!0,c.push(b))});var d={};a.forEach(function(a){var b="task_"+a;$(b)&&(d[maxkir.tree_model.getParent(b)]=!0)}),a.forEach(function(a){var b="task_"+a;delete d[b]});var e="task_"+a[a.length-1];return maxkir.Undo.restoreSelectionAfterUndo(e),b?(c.forEach(function(a){a.remove()}),maxkir.tree_nav.fix_selection(!0,e)):(c.forEach(function(a){a.addClassName("hiddenInit")}),maxkir.tree_nav.fix_selection(!0,e),setTimeout(function(){c.forEach(function(a){a.parentNode&&a.remove()}),$("parentTask_0").down("li")?maxkir.tree_nav.fix_selection(!0,e):maxkir.cmd.add_task()},300)),Object.keys(d)},maxkir.Task.set_task_status=function(a,b,c,d){b=b.filter(function(a){return $("task_"+a)?maxkir.Task.isDivider(a)?!1:maxkir.Task.data(a)?maxkir.Task.writable_or_assignee(a):!1:!1});if(!b.length)return;d=d||{};var e=Object.isUndefined(d.hide_completed)?maxkir.checklist.HideCompleted.is_hide():d.hide_completed,f=Object.isUndefined(d.completed_down)?maxkir.checklist.CompletedDown.is_enabled():d.completed_down,g=Object.isUndefined(d.on_success)?maxkir.Notifications.enable:d.on_success,h=function(a){maxkir.Task.fix_sorting_ui(a.id)};(function(){var a=b[b.length-1];maxkir.tree_nav.add_selection(["task_"+a]),(f||e)&&c!=="reopen"&&(maxkir.Undo.restoreSelectionAfterUndo("task_"+a),maxkir.ChecklistNodeToggle&&(maxkir.ChecklistNodeToggle.collapse(a),maxkir.notes(a).hide_notes(!0)),maxkir.tree_nav.add_selection(["task_"+a]),maxkir.tree_nav.fix_selection(!0,"task_"+a))})(),b.forEach(function(a){var b=maxkir.Task.data(a);b.status="close"==c?1:"reopen"==c?0:2,b.updated_at=(new Date).toString(),maxkir.Task.renderer(b.id).updateContent(!1),f&&h(b)}),new maxkir.AjaxCommand("/checklists/"+a+"/tasks/"+b+"/"+c+".js",{onSuccess:g,parameters:"task_ids="+b.join(","),onComplete:function(){var a=maxkir.checklist&&maxkir.checklist.Dnd;a&&maxkir.checklist.Dnd.stop_dnd();var d=!1;b.forEach(function g(b){maxkir.Task.updateTask(b,!0);var g=maxkir.Task.data(b);g&&g.parent_id&&(e&&a&&!d&&(maxkir.checklist.HideCompleted.show_hide_message(g.parent_id),d=!0),maxkir.Task.updateParents("task_"+g.parent_id),a&&c==="close"&&setTimeout(function(){var a=maxkir.Task.data(g.parent_id);a&&a.status&&maxkir.ChecklistNodeToggle.collapse(a.id)},0)),f&&h(g)}),a&&maxkir.checklist.Dnd.install(),maxkir.tree_nav.fix_selection()}})},maxkir.Task=maxkir.Task||{},maxkir.Task.Colorer={paint_by_index:function(a,b){this._paint(a,this.toCode(b))},_paint:function(a,b){b=this._update_local_color(a,b),maxkir.Task.set_task_detail(a,"mark",b),maxkir.ui.ColorPopup.hide_popup()},_update_local_color:function(a,b){return a.forEach(function(c){var d=maxkir.Task.data(c);d&&(b==d.details.mark&&c==a[0]&&(b="null"),b=="null"?delete d.details.mark:d.details.mark=b,maxkir.Task.updateTask(c))}),b},toCode:function(a){a=parseInt(a);switch(a){case 0:return"null";case 1:return"fg1";case 2:return"fg2";case 3:return"fg3";case 4:return"bg1";case 5:return"bg2";case 6:return"bg3";case 7:return"bg7";case 8:return"bg8";case 9:return"bg9"}}},maxkir.ui.ColorPopup=maxkir.ui.create_popup(!1,{popup_width:260,refresh:function(){var a=this;a._customize_mode=!1,this.popupContent||(this.popupContent=$("colorPopupData").innerHTML,$("colorPopupData").innerHTML=""),this.win.getContent().update(this.popupContent),this._select_current_color(),this.win.addEventHandler(".colorPopupData","click",".priorityStyles__item",function(b,c){if(a._customize_mode){maxkir.ui.PriorityStylesPopup.hide_popup();var d=c.getAttribute("data-priority");maxkir.ui.PriorityStylesPopup.show_popup(a.win.getContent(),{priority:d,removeOtherPopups:!1,swatchElement:c,y_shift:-60})}else maxkir.cmd.paint_color(c.getAttribute("data-priority"))});var b=function(b){a._customize_mode=!a._customize_mode,a._customize_mode?
b.target.up(".colorPopupData").classList.remove("colorPopupData--pickMode"):b.target.up(".colorPopupData").classList.add("colorPopupData--pickMode"),a.win.updateHeight()};this.win.addEventHandler(".colorPopupData__doneCustomize","click",b),this.win.addEventHandler(".colorPopupData__customize","click",function(a){var c=b.bind(this,a);maxkir.TemporaryUser&&maxkir.temporary?maxkir.TemporaryUser.on_pro_usage("priority colors customization").then(c):maxkir.is_pro?c():maxkir.ProSupport.ask_pro_dialog(I18N("colors.js-customization_pro"),c)})},_select_current_color:function(){var a=maxkir.cmd.task_id(),b=maxkir.Task.data(a);if(b){var c=maxkir.Task.priority(b);if(c>0){var d=document.querySelector(".priorityStyles__item.priority_"+c);d&&d.classList.add("priorityStyles__item--selected")}}}}),maxkir.ui.PriorityStylesPopup=maxkir.ui.create_popup(!1,{popup_width:260,reset_to_defaults:function(){this._save_params({priority_styles_reset:!0}).then(function(){new maxkir.ui.Message("Back to default colors!")})},refresh:function(){var a=this.win;this._template||(this._template=$("priorityStylesPopup").innerHTML,$("priorityStylesPopup").innerHTML=""),a.setHTMLContent(this._template),a.options.onBlur=this.hide_popup.bind(this)},setColorsJson:function(a){maxkir.info("Chosen color: "+JSON.stringify(a)),this.current_json=a;var b=document.querySelector(".editPriorities__example");b&&b.setStyle(a),this._mark_current_box(a),this.options.swatchElement&&this.options.swatchElement.setStyle(a)},_mark_current_box:function(a){var b=this._rgb2hex(a.color),c=this._rgb2hex(a.backgroundColor),d=document.querySelectorAll(".editPriorities__color");for(var e=0;e<d.length;e++){var f=d[e];f.classList.remove("editPriorities__color--selected");if(b!=="inherit"&&this._rgb2hex(f.getStyle("color"))!==b)continue;if(c!=="inherit"&&this._rgb2hex(f.getStyle("background-color"))!==c)continue;f.classList.add("editPriorities__color--selected")}},onShow:function(){maxkir.info("Show priority colors popup: "+this.options.priority);var a=this.options.priority;document.querySelector(".editPriorities__header").innerHTML="Select a color for key <kbd>"+this.options.priority+"</kbd>";var b=document.querySelectorAll(".editPriorities__color");Array.prototype.slice.call(b).forEach(function(b){b.innerHTML=a}),this._load_current_style(),this._init_picker_from_list(),this._init_server_updater(),this.scrollToShow()},_load_current_style:function(){var a=this;new maxkir.AjaxRequest("/theme/priority_styles.json",{method:"get",onSuccess:function(b){a.setColorsJson(b.responseJSON.priority_styles[a.options.priority])}})},_init_picker_from_list:function(){var a=this;this.win.addEventHandler(".editPriorities__colors","click",".editPriorities__color",function(b){var c=a._rgb2hex(b.target.getStyle("color")),d=a._rgb2hex(b.target.getStyle("backgroundColor"));a.setColorsJson({color:c,backgroundColor:d})})},_init_server_updater:function(){var a=this;this.win.addEventHandler(".editPriorities__cancel","click",this.hide_popup.bind(this)),this.win.addEventHandler(".editPriorities__save","click",function(b){var c={priority_styles:{}};c.priority_styles[a.options.priority]=a.current_json,b.target.disabled=!0,a._save_params(c).then(function(){b.target.disabled=!1,a.hide_popup()},function(){b.target.disabled=!1})})},_save_params:function(a){return new Promise(function(b,c){new maxkir.AjaxRequest("/theme/priority_styles.json",{method:"post",contentType:"application/json",postBody:JSON.stringify(a),onSuccess:function(a){this._update_page_styles(a.responseJSON.priority_styles),maxkir.info("Color saved!"),b()}.bind(this),onComplete:c})}.bind(this))},_update_page_styles:function(a){var b="";Object.keys(a).each(function(c){b+=".priority_"+c+".priorityColored, .priority_"+c+" .priorityColored {\n"+"color:"+a[c].color+";\n"+"background-color:"+a[c].backgroundColor+";\n"+"}\n"});var c=document.createElement("style");c.innerHTML=b,document.head.appendChild(c)},_rgb2hex:function(a){function i(a){if(a>255)throw"'"+a+"'' is greater than 255(0xff);";var b=Number(a).toString(16);return("0"+b).slice(-2)}if(!a.startsWith("rgb"))return a.toLowerCase();var b=/rgba?\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d+)\s*)?\)/,c=b.exec(a),d,e,f,g,h;if(!c)throw"Invalid format: "+a;return d=c[1],e=c[2],f=c[3],g=c[4],h=[i(d),i(e),i(f)],g&&h.push(i(g)),("#"+h.join("")).toLowerCase()},onHide:function(){this.options.swatchElement&&this.options.swatchElement.setStyle({color:null,backgroundColor:null})},f_:null}),function(a){"use strict";var b=function(){return a.UserPrefs&&a.UserPrefs.independent_parent_status};a.ProgressCounter={_ESTIMATE_REG:/^\d+([hdm])$/,time_tag:function(a){return a.match(this._ESTIMATE_REG)},toggle_progress_counter:function(b){var c=null,d=this;b.forEach(function(e){var f=a.Task.data(e);f&&(b.length===1||f.tasks&&f.tasks.length)&&(c===null&&(c=!f.details.progress_counter),d._enable_progress_counter_for(e,c),a.Task.updateTask(e))})},_enable_progress_counter_for:function(b,c){var d=a.Task.data(b);if(!d)return;a.Task.set_task_detail([d.id],"progress_counter",c?"true":null),d.details.progress_counter=!!c},toggle_progress_counter_list:function(b){var c=a.Lists.data(b);c&&c.set_progress_counter(!c.progress_counter(),!0)},show_for_list:function(){this._delayed_update||(this._delayed_update=a.delay_action(function(){var b=document.querySelector(".toolBar__listProgressCounter");if(b){var c=a.Lists.data(a.checklist_id);if(c&&c.progress_counter&&c.progress_counter()){var d=this.total_list_stats();b.innerHTML=a.ProgressCounterElement.createElementHtml(d.percent_completed,d.total,d.completed,null,!0),b.style.display=""}else b.style.display="none"}}.bind(this),100)),this._delayed_update.start()},total_list_stats:function(){var a=0,b=0;return this._collect_top_level_tasks().forEach(function(c){var d=this.completion_stats(c);a+=d.total,b+=d.completed}.bind(this)),{total:a,completed:b,percent_completed:a>0?100*b/a:0}},_collect_top_level_tasks:function(){var b=[];return a.Task.foreach(function(c){if(!c.parent_id){var d=a.Task.data(c.id);d&&b.push(d)}}),b},completion_stats:function(c){var d=0,e=0,f=0,g=0,h=function(a){var b=0;for(var c in a.tags||{}){var d;if(d=c.match(/^(\d+)m$/))b+=parseInt(d[1]);else if(d=c.match(/^(\d+)h$/))b+=parseInt(d[1])*60;else if(d=c.match(/^(\d+)d$/))b+=parseInt(d[1])*60*8}return b},i=b();return a.Task.foreachDown(c,function(b,c){if(b.status!=2&&!a.Task.isDivider(b)){if(i||c)d+=1,b.status==1&&(e+=1);var j=h(b);b.status||(f+=j),g+=j}}),{total:d,completed:e,percent_completed:d>0?100*e/d:0,estimate:{mins:f,total_mins:g}}},build_estimate_line:function(a,b){var c=Math.floor(a/60);a=a%60;var d=0;b||(d=Math.floor(c/8),c=c%8);var e="";return d>0&&(e&&(e+=" "),e+=d+"d"),c>0&&(e&&(e+=" "),e+=c+"h"),a>0&&(e&&(e+=" "),e+=a+"m"),e?e:"0h"},on_task_updated:function(b){this._has_estimate_tag(b)&&b.parent_id&&a.Task.updateTaskFromServer(b.parent_id),a.Task.updateParents("task_"+b.id)},_has_estimate_tag:function(a){var b=Object.keys(a.tags||{});for(var c=0;c<b.length;c++)if(this.time_tag(b[c]))return!0;return!1},install_tasks_hover_popups:function(){a.HoverPopups(document.body).addPopupProvider("indexProgressPopup",{buildContent:function(a){var b=a.getAttribute("data-total"),c=a.getAttribute("data-completed"),d=a.getAttribute("data-percent"),e;return c==0?e=I18N("js_index_progress_popup_none"):c===b?e=I18N("js_index_progress_popup_all"):e=c+" "+I18N("js_index_progress_popup_of")+" "+b,b===0?I18N("js_index_progress_popup_text_no_tasks"):(new Template(I18N("js_index_progress_popup_text"))).evaluate({percent:d,completed:e})}});var b=function(b,c){return a.ProgressCounter.build_estimate_line(b,c)},c=function(a,c,d){var e=a-c;return(new Template(I18N("js_index_progress_estimate_popup_text"))).evaluate({total:b(a,d),completed:e?b(e,d)+" completed":"",remains:c?b(c,d)+" remains"+(e?",":""):""})};a.HoverPopups(document.body).addPopupProvider("indexProgressPopupEstimate",{buildContent:function(a){var b=parseInt(a.getAttribute("data-total-time"));if(!b)return"";var d=parseInt(a.getAttribute("data-remains-time")),e="";return b>=480&&(e="<span style='display:none'>"+c(b,d,!0)+'</span>              <a href=\'#\' onclick=\'this.style.display="none";              this.previousElementSibling.style.display="inline-block";              this.previousElementSibling.previousElementSibling.style.display="none";              return false;\'>show hours</a>'),"<span>"+c(b,d)+"</span>"+e}})},_build_estimate_line:function(a){return this.build_estimate_line(this.completion_stats(a).estimate.mins)}},a.ProgressCounterElement=function(){var b=1,c=24;return{createElementHtml:function(b,c,d,e,f){var g=c-d===0,h=this.createSVG(b,g?c:c-d,f);b=Math.round(b*10)/10;var i="",j="";if(e&&e.total_mins){var k=e.total_mins,l=e.mins;j=' data-total-time="'+k+'" data-remains-time="'+l+'" ';var m=g?k:l,n=g?"progressCounter__estimate progressCounter__estimate--completed":"progressCounter__estimate";i="<span class='"+n+" hoverPopup' data-popup-id='indexProgressPopupEstimate' "+j+">"+"<i>"+a.ProgressCounter.build_estimate_line(m)+"</i></span>"}return"<span class='progressCounter '><span class='hoverPopup' data-popup-id='indexProgressPopup'  data-total='"+c+"' data-percent='"+b+"' data-completed='"+d+"' "+">"+h.html+"</span>"+i+"</span>"},createSVG:function(a,d,e){var f=1.7*c;d<1e3&&(f=1.3*c),d<100&&(f=c);var g=f/2,i=c/2,j=g-b,k=i-b,l,m="progressCounterText";if(a<100){var n=2*Math.PI*a/100,o=g+j*Math.sin(n),p=i-k*Math.cos(n),q=a<50?0:1,r='<path d="#spec" stroke-width="#w" class="completedProgressLine" />',s="M #cx "+b+" A #rx #ry 0 "+q+" 1 "+" "+o+" "+p;l=r.replace("#spec",s)}else l='<ellipse cx="#cx" cy="#cy" rx="#rx" ry="#ry" class="completedProgressLine"/>',m+=" progressCounterText--completed";l='<svg width="#l" height="#h"><ellipse cx="#cx" cy="#cy" rx="#rx" ry="#ry" class="defaultProgressLine"/>'+l+"</svg>";var t={l:f,h:c,rx:j,ry:k,cx:g,cy:i,w:b};Object.keys(t).forEach(function(a){l=l.replace(new RegExp("#"+a,"g"),t[a])});var u=e?I18N("options.js_show_progress_title_list"):I18N("options.js_show_progress_title_short");return l+="<div class='"+m+"' title='"+u+"' style='width: "+f+"px'>"+d+"</div>",{width:f,height:c,html:l}}}}()}(window.maxkir),maxkir.ChecklistRenderer=function(a,b,c){c||(c=""),this.data=a,this.id=c+this.data.id,this._task_ids=b||[]},maxkir.ChecklistRenderer.DEFAULT_LIST_TEXT="Name your project and press Enter",maxkir.ChecklistRenderer.updateListNode=function(a){$$(".coreDiv[data-list-id="+a+"]").forEach(function(b){b.innerHTML=(new maxkir.ChecklistRenderer(maxkir.Lists.data(a))).list_core_div()})},maxkir.extend(maxkir.ChecklistRenderer,{getLiHtml:function(){return"<li id='"+this.getLiId()+"' class='checklist node_expanded'>"+this.up_down_border()+this.full_list_content()+"</li>"},getLiId:function(){return"checklist_"+this.id},up_down_border:function(){return this.has_tasks()?"<div class='frame'></div>":""},full_list_content:function(){var a="<div id='core_lst_"+this.id+"' class='coreDiv listNameNode' data-list-id='"+this.data.id+"' title='"+I18N("go_to_list_title")+"'>"+this.list_core_div()+"</div> \n";return a+=this.children_html(),a},list_core_div:function(){var a="";return a+=this.main_list_content(),a+=this.list_tags(),a+=this.list_attributes(),a+=this.actions_icon(),a},list_tags:function(){return this.data.tags?maxkir.TagRenderer.renderTagMap(this.data.tags):""},list_attributes:function(){var a=this.data.archived?"archived":"";return this.data.read_only&&(a!=""&&(a+=", "),a+="read only"),a==""?"":" <span class='archivedList'>("+a+")</span>"},actions_icon:function(){return"<a class='goLink icon-external-link' title='"+I18N("go_to_list_title")+"' href='"+this._url()+"'></a>"},main_list_content:function(){return this.image_handle()+this.list_text_tag()},list_text_tag:function(){var a=maxkir.favicon("list");return"<span class='node_text editableList userContent'>"+a+" <a id='lst"+this.id+"' href='"+this._url()+"' target='_self'>"+this.list_text()+"</a></span>"},_url:function(){var a=maxkir.ChecklistRenderer.list_filter_text?maxkir.ChecklistRenderer.list_filter_text():"";return this.has_tasks()&&a&&(a="?filter="+encodeURIComponent(a)),"/checklists/"+this.data.id+a},list_text:function(){var a=this.data.name;return maxkir.Search&&(a=maxkir.Search.highlight_text(a)),maxkir.FindFilter&&(a=maxkir.FindFilter.highlight_text(a)),a.match(/^\s*$/)&&(a=maxkir.ChecklistRenderer.DEFAULT_LIST_TEXT),a},image_handle:function(){var a="";return this.has_tasks()&&(a+='<div class="nodeImage '+(this.collapsed()?"node_collapsed":"")+'"  id="handle_checklist_'+this.id+'"></div>'),a},has_tasks:function(){return this.task_ids().length>0},collapsed:function(){return this.data.collapsed},updateListText:function(){$("lst"+this.id)&&($("lst"+this.id).innerHTML=this.list_text())},children_html:function(){if(this.has_tasks()){var a=this.task_ids(),b="";for(var c=0;c<a.length;c++){var d=maxkir.Task.renderer(a[c]);d&&(b+=d.getLiHtml())}return'<ul id="parentList_'+this.id+'"  class="dndUl">'+b+"</ul>"}return""},task_ids:function(){return this._task_ids},_f:null}),Object.extend(Date.prototype,{monthnames:["January","February","March","April","May","June","July","August","September","October","November","December"],daynames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],set:function(a){var b=["Hours","Minutes","Seconds","Milliseconds"];for(var c in a)try{c=="Hours"&&Object.isArray(a[c])?a[c].each(function(a,c){this["set"+b[c]](a)}.bind(this)):this["set"+c](a[c])}catch(d){throw new SyntaxError("set"+c+" is not a Date method")}return this},succ:function(){return(new Date(this.getTime())).set({Date:this.getDate()+1})},firstofmonth:function(){return new Date(this.getFullYear(),this.getMonth(),1,10)},lastofmonth:function(){return new Date(this.getFullYear(),this.getMonth()+1,0,10)},formatPadding:!0,format:function(a){if(!this.valueOf())return"&nbsp;";var b=this,c={yyyy:b.getFullYear(),mmmm:this.monthnames[b.getMonth()],mmm:this.monthnames[b.getMonth()].substr(0,3),mm:this.formatPadding?b.getMonth().succ().toPaddedString(2):b.getMonth().succ(),dddd:this.daynames[b.getDay()],ddd:this.daynames[b.getDay()].substr(0,3),dd:b.getDate().toPaddedString(2),hh:b.getHours()%12?b.getHours()%12:12,nn:b.getMinutes(),ss:b.getSeconds(),"a/p":b.getHours()<12?"a":"p"};return a.gsub(/(yyyy|mmmm|mmm|mm|dddd|ddd|dd|hh|nn|ss|a\/p)/i,function(a){return c[a[0].toLowerCase()]})}});var scal={};scal=Class.create(),scal.prototype={initialize:function(a,b){this.element=$(a);var c=Try.these(function(){if(!Object.isUndefined(Effect))return"Effect"},function(){return"Element"});this.options=Object.extend({aftercalchange:Prototype.emptyFunction,beforecalchange:Prototype.K,daypadding:!1,titleformat:"mmmm yyyy",updateformat:"yyyy-mm-dd",closebutton:"X",prevbutton:"&laquo;",nextbutton:"&raquo;",yearnext:"&raquo;&raquo;",yearprev:"&laquo;&laquo;",openeffect:c=="Effect"?Effect.Appear:Element.show,closeeffect:c=="Effect"?Effect.Fade:Element.hide,exactweeks:!1,dayheadlength:2,weekdaystart:0,planner:!1,tabular:!1},arguments[2]||{}),this.table=!1,this.thead=!1,this.options.planner&&this._setupPlanner(this.options.planner),this.options.tabular&&(this.table=new Element("table",{"class":"cal_table",border:0,cellspacing:0,cellpadding:0}),this.thead=new Element("thead"),this.table.insert(this.thead),this.element.insert(this.table)),this.updateelement=b,this._setCurrentDate(this._setStartDate()),this.startdate=new Date(this.currentdate),Object.isString(this.options.weekdaystart)&&(this.options.weekdaystart=this.currentdate.daynames.indexOf(this.options.weekdaystart)||0),this.controls=this._buildControls(),this.title.setAttribute("title",this.startdate.format(this.options.titleformat)),this._updateTitles(),this[this.table?"thead":"element"].insert(this.controls),this.cal_wrapper=this._buildHead(),this.cells=[],this._buildSkel()},_setStartDate:function(){var a=new Date;a.setHours(10,0,0,0);var b=a.getDate(),c=this.options.month&&Object.isNumber(this.options.month)?this.options.month-1:a.getMonth(),d=this.options.year&&Object.isNumber(this.options.year)?this.options.year:a.getFullYear(),e=this.options.day&&Object.isNumber(this.options.day)?this.options.day:c!=a.getMonth()?1:b;return this.selectedDay=new Date(d,c,e,10,0,0,0),new Date(this.selectedDay.getTime())},_click:function(a,b){this._setCurrentDate(this.dateRange[b]),this.selectedDay?this.selectedDay.setTime(this.currentdate.getTime()):this.selectedDay=new Date(this.currentdate.getTime()),this._updateSelection(),this._updateExternal()},_updateSelection:function(){$$(".dayselected").invoke("removeClassName","dayselected");var a=this.getElementByDate(this.currentdate);a&&a.addClassName("dayselected")},_updateExternal:function(){if(Object.isFunction(this.updateelement))this.updateelement(this.currentdate);else{var a=$(this.updateelement);a[a.tagName=="INPUT"?"setValue":"update"](this.currentdate.format(this.options.updateformat))}},_buildHead:function(){var a=new Element(this.table?"tbody":"div",{"class":"cal_wrapper"}),b=new Element(this.table?"tr":"div",{"class":"weekbox weekboxname"});return Date.prototype.daynames.sortBy(function(a,b){return b-=this.options.weekdaystart,b<0?b+7:b}.bind(this)).each(function(a,c){var d=new Element(this.table?"td":"div",{"class":"cal_day_name_"+c});b.insert(d.addClassName("daybox").addClassName("dayboxname").update(a.substr(0,this.options.dayheadlength))),c==6&&d.addClassName("endweek")}.bind(this)),a.insert(b)},_buildWrapper:function(){var a=this.firstofmonth,b=this.lastofmonth,c=a.getDay(),d=a.getDate();if(this.options.exactweeks)while(b.getDay()<6)b=b.succ();c=this.options.weekdaystart-c<d?c-this.options.weekdaystart:c+7-this.options.weekdaystart,a.setDate(d-c);var e=b.getTime(),f=this.currentdate.getMonth(),g=new Date,h={today:g.getMonth()==f?g.setHours(10,0,0,0):!1,dayselected:this.selectedDay&&this.selectedDay.getMonth()==f?this.selectedDay.getTime():!1};this.maxIndicators=["today","dayselected"].findAll(function(a){return h[a]!==!1}).size(),this.dateRange=[],this.indicators=[],this.cells.each(function(b,c){var d=b.weeknumber===0&&c===0?a:this.dateRange[c-1].succ();this.cellClasses=["daybox",b.cid,"daybox"+d.daynames[d.getDay()].toLowerCase()],this.dateRange[c]=d,b.d.innerHTML=this.options.daypadding?d.getDate().toPaddedString(2):d.getDate(),this.maxIndicators>0&&this._compareDates(d,h),b.daynumber==6&&this.cellClasses.push("endweek"),this.cellClasses.push(d.getMonth()!=f?"dayoutmonth":"dayinmonth");if(this.options.exactweeks){var g=d.getTime()>e?"hide":"show";this.table?b.descendants().invoke(g):b[g]()}this.options.planner&&this._updatePlanner(d,b.v),b.className=this.cellClasses.join(" ")}.bind(this))},_compareDates:function(a,b){if(this.indicators.length==this.maxIndicators)return;var c=a.setHours(10,0,0,0);for(var d in b){if(!b[d])continue;this.indicators.indexOf(d)<0&&c==b[d]&&(this.cellClasses.push(d),this.indicators.push(d))}},_buildSkel:function(){if(this.cells.size()===0){this.cal_weeks_wrapper=this.table?this.cal_wrapper:new Element("div",{"class":"calweekswrapper"});var a="cal_day_#{week}_#{day}",b=0;$R(0,5).each(function(c,d){var e=(new Element(this.table?"tr":"div",{"class":"cal_week_"+d})).addClassName("weekbox");$R(0,6).each(function(f,g){var h=a.interpolate({week:c,day:f}),i=new Element(this.table?"td":"div",{"class":"daybox"}),j=(new Element("div",{"class":h+"_date"})).addClassName("dayboxdate"),k=(new Element("div",{"class":h+"_value"})).addClassName("dayboxvalue");Object.extend(i,{cid:h,weeknumber:d,daynumber:g,d:j,v:k}),this.cells[b]=i.observe("click",this._click.bindAsEventListener(this,b)),e.insert(i.insert(j).insert(k)),b+=1}.bind(this)),this.cal_weeks_wrapper.insert(e)}.bind(this)),this.table?this.table.insert(this.cal_wrapper):this.element.insert(this.cal_wrapper).insert(this.cal_weeks_wrapper)}this._buildWrapper()},_updateTitles:function(){var a=this.currentdate.getFullYear(),b=this.currentdate.getMonth();this.controls.select(".calcontrol").each(function(c){c.className.gsub(/cal(prev|next)(month|year)/,function(d){var e=!1;d[1]=="prev"?e=d[2]=="year"?a-1:Date.prototype.monthnames[b-1==-1?11:b-1]:d[1]=="next"&&(e=d[2]=="year"?a+1:Date.prototype.monthnames[b+1==12?0:b+1]),e&&c.setAttribute("title",e)})})},_buildControls:function(){var a=[{p:"calclose",u:this.options.closebutton,f:this.toggleCalendar.bindAsEventListener(this)},{p:"calprevmonth",u:this.options.prevbutton,f:this._switchCal.bindAsEventListener(this,"monthdown")},{p:"calprevyear",u:this.options.yearprev,f:this._switchCal.bindAsEventListener(this,"yeardown")},{p:"calnextyear",u:this.options.yearnext,f:this._switchCal.bindAsEventListener(this,"yearup")},{p:"calnextmonth",u:this.options.nextbutton,f:this._switchCal.bindAsEventListener(this,"monthup")},{p:"caltitle",u:this.currentdate.format(this.options.titleformat),f:this._switchCal.bindAsEventListener(this,"init")}];this.table&&(a=[a[1],a[2],a[5],a[3],a[4],a[0]]);var b=new Element(this.table?"tr":"div",{"class":"calheader"});return a.each(function(a){var c=new Element(this.table?"td":"div",{"class":a.p});a.p=="caltitle"?(this.title=c,this.table&&c.writeAttribute({colspan:2}),c.update(a.u).observe("click",a.f)):(c.addClassName("calcontrol"),c[typeof a.u=="object"?"insert":"update"](a.u).observe("click",a.f)),b.insert(c)}.bind(this)),b},_switchCal:function(){var a=arguments[1]?arguments[1]:arguments[0],b={f:"setTime",p:this.startdate.getTime()},c=this.currentdate.getDate();if(a!="init"){var d=this.currentdate[a.include("month")?"getMonth":"getFullYear"]();b={f:a.include("month")?"setMonth":"setYear",p:a.include("up")?d+1:d-1}}if(arguments[1]){var e=new Date(this.currentdate.getTime());e[b.f](b.p);if(!this.options.beforecalchange(e))return}this.currentdate[b.f](b.p),this.currentdate.getDate()!=c&&this.currentdate.setDate(0);if(arguments[1]){var f=arguments[0];f.date=this.currentdate,this.options.aftercalchange(f)}this._update()},_update:function(){this._setCurrentDate(arguments[0]?arguments[0]:this.currentdate),this.title.innerHTML=this.currentdate.format(this.options.titleformat),this._buildWrapper(),this._updateTitles()},_setCurrentDate:function(a){this.currentdate=new Date(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours()),this.firstofmonth=this.currentdate.firstofmonth(),this.lastofmonth=this.currentdate.lastofmonth()},_getCellIndexByDate:function(a){var b=a.toJSON(),c=0;return this.dateRange.each(function(a,d){if(a.toJSON()==b)throw c=d,$break}),c},destroy:function(){this.cells.invoke("stopObserving").invoke("remove"),this[this.table?"table":"cal_weeks_wrapper"].remove(),this.controls.descendants().invoke("stopObserving"),[this.cal_wrapper,this.controls].invoke("remove"),this.element.descendants().invoke("remove")},setCurrentDate:function(a){return this[a instanceof Date?"_update":"_switchCal"](a),arguments[1]||this._updateExternal(),this._updateSelection(),this.currentdate},toggleCalendar:function(){this.options[this.element.visible()?"closeeffect":"openeffect"](this.element)},getElementByDate:function(a){return this.cells[this._getCellIndexByDate(a)]},getElementsByWeek:function(a){return this.element.select(".weekbox:nth-of-type("+(a+1)+") .daybox:not(.dayboxname)")},getSelectedElement:function(){return this.element.select(".dayselected")[0]},getTodaysElement:function(){return this.element.select(".today")[0]},getDateByElement:function(a){return this.dateRange[this.cells.indexOf(a)]},_setupPlanner:Prototype.emptyFunction,_updatePlanner:Prototype.emptyFunction,openCalendar:function(){this.isOpen()||this.toggleCalendar()},closeCalendar:function(){this.isOpen()&&this.toggleCalendar()},isOpen:function(){return this.element.visible()},inc_date:function(a){var b=new Date(this.currentdate.getTime());b.setDate(b.getDate()+a),this.setCurrentDate(b)}},maxkir.ui.DatePicker=maxkir.ui.create_popup(!1,{popup_width:210,refresh:function(){var a=this.win;a.setHTMLContent("<div class='scal popupPresentation'></div>");var b={updateformat:"yyyy/mm/dd",closebutton:"",exactweeks:!0},c=this.anchor_element,d=c.value;if(d&&d!="ASAP"){var e=new Date(d);e.is_overdue()||(b.month=e.getMonth()+1,b.year=e.getFullYear(),b.day=e.getDate())}var f=function(a){if(a){var b=new Date(a);b.getTime()>0&&(c.value=b.cl_format_date(!0,!0),this.options.onUpdate&&this.options.onUpdate(),this.hide_popup())}else this.hide_popup()}.bind(this);b.aftercalchange=function(){setTimeout(function(){a.updateHeight()}.bind(this),10)}.bind(this),maxkir.week_starts_with_monday()&&(b.weekdaystart=1);var g=new scal(a.getContent().down(".scal"),f,b);this.win.addDisposerOnClose(function(){g.destroy()}),setTimeout(function(){c.activate()}.bind(this),50),this.scrollToShow()},install_on:function(a,b){return a.on("click",function(){maxkir.ui.DatePicker.toggle(a,Object.extend({removeOtherPopups:!1},b||{}))})},f_:null}),maxkir.Due={set_due:function(a,b,c){if(maxkir.Task.read_only(a[0]))return;maxkir.tree_model.getRoot()==="dueList"&&maxkir.tree_nav.fix_selection(!1,maxkir.tree_nav.get_selection()),this._set_due(a,b,c)},install_action_on_click:function(){this.uninstall_action_on_click(),this.click_handler=$(maxkir.tree_model.getRoot()).on("click",".afterTask.dueDate",function(a,b){var c=maxkir.Task.id_str(b.up("li").id);if(maxkir.Task.read_only(c))return;var d=maxkir.Task.data(c);d&&(d.due?maxkir.cmd.view_add_due():d.details.has_repeating&&maxkir.cmd.view_add_due_repeat())})},uninstall_action_on_click:function(){this.click_handler&&(this.click_handler.stop(),this.click_handler=null)},toggle_due_pref:function(a,b,c){maxkir.TaskData={},maxkir.user.set_user_prefs(b,!!(a.checked^c),{onSuccess:function(){maxkir.ajax_reload_block("due_content",function(){})}})},refresh_after_due_change:function(a){try{a.forEach(function(a){maxkir.Task.updateTask(a)})}catch(b){}try{maxkir.DueList&&maxkir.DueList.rerender()}catch(b){}},_set_due:function(a,b,c){var d=this;c&&c.setUTCFullYear&&(c.setUTCFullYear(c.getFullYear(),c.getMonth(),c.getDate()),c=c.toUTCString());var e=!1;return a.forEach(function(a){"use strict";var b=maxkir.Task.data(a);e=e||b&&b.due}),maxkir.Task.save(a,b,"task[due_date]="+(c?encodeURIComponent(c):"")).then(function(){!c&&!e&&a.forEach(function(a){d.clear_repeating_due(a,b)})})},clear_repeating_due:function(a,b){new maxkir.AjaxCommand("/checklists/"+b+"/tasks/"+a+"/repeat",{method:"delete",onComplete:function(){maxkir.Task.updateTask(a)}})}},maxkir.get_icalendar=function(){if(!maxkir.is_pro){maxkir.ProSupport.ask_for_pro("You need a PRO account to use integration with Calendar apps");return}maxkir.TemporaryUser&&maxkir.TemporaryUser.on_pro_usage("calendar integration");var a=function(a,b,c){a.down("input[name="+b+"]").checked=c;var d=new RegExp(b+"=\\w+"),e=a.down(".iCalendarInput");e.value=e.value.gsub(d,b+"="+!!c)},b,c;maxkir.ui.Dialog.confirm(I18N("calendar_integration.dialog_title"),$("icalendarPopup").innerHTML,function(){c.copy()},I18N("calendar_integration.button_copy"),$("icalendarHelp").innerHTML,function(d){var e=d.element;c=new maxkir.Clipboard,c.glue("ok_button_dialog"),c.addEventListener("onComplete",Dialog.cancelCallback);var f=$(e).down(".iCalendarInput");b=e.on("click","input[type=checkbox]",function(b,d){setTimeout(function(){a(e,d.name,d.checked),c.setText($F(f))},10)}),a(e,"show_not_mine",maxkir.user.get_boolean_pref("show_not_mine")),a(e,"include_archived_lists",!maxkir.user.get_boolean_pref("skip_archived_due")),c.setText($F(f))},function(){b.stop(),c.destroy(),maxkir.info("iCalendar dialog disposed")},{width:650})},maxkir.ui.DuePopup=maxkir.ui.create_popup(!1,{popup_width:300,refresh:function(){var a=this.win,b=new Template($("_dueDivTemplate").innerHTML),c=this.options.task_ids,d=c[0];this.checklist_id=maxkir.Task.checklist_id(d);var e=null;try{c.length==1&&(e=maxkir.Task.data(d).due)}catch(f){}a.setHTMLContent(b.evaluate({task_id:d,checklist_id:this.checklist_id,curr_due:e}));var g={updateformat:"yyyy/mm/dd",closebutton:"",exactweeks:!0};if(e&&e!=="ASAP"){var h=maxkir.dates.date(e);g.month=h.getMonth()+1,g.year=h.getFullYear(),g.day=h.getDate()}var i=function(a){a?this.input_field().value=maxkir.CommonRender.format_due(a):($("clearDue_"+d).hide(),this.fix_height()),this.no_submit||this.submit_form(this.input_field().form)}.bind(this);g.aftercalchange=function(){setTimeout(function(){this.fix_height(a)}.bind(this),10)}.bind(this),maxkir.week_starts_with_monday()&&(g.weekdaystart=1);var j=new scal("cal_"+d,i,g);maxkir.run_before(a,"close",function(){j.destroy()}),this.scal=j,setTimeout(function(){this.withoutSubmit(function(){i(e)}),$("cal_input_"+d).activate()}.bind(this),50),this.scrollToShow(),this.update_text_for_repeating_due(),this.init_keyboard(),this.add_focus_listener()},withoutSubmit:function(a){this.no_submit=!0,a(),this.no_submit=!1,this.fix_height()},update_text_for_repeating_due:function(){if(this.options.task_ids.length>1){maxkir.info("Repeating due is not supported for multiple selection"),this.win.getContent().down("a.repeat").hide();return}new maxkir.AjaxRequest("/checklists/"+this.checklist_id+"/tasks/"+this.options.task_ids[0]+"/repeat.txt",{method:"get",onSuccess:function(a){var b=a.responseText;if(b!=""){b=maxkir.firstDown(b);var c="icon-refresh";b.toLowerCase().indexOf("pause")>0&&(c="icon-pause"),this.win.getContent().down("a.repeat").update("<i class='"+c+"'></i> Repeat "+b+"..."),this.fix_height()}}.bind(this)})},init_keyboard:function(){document.querySelector(".calprevmonth").title+=" [pageup]",document.querySelector(".calnextmonth").title+=" [pagedown]";var a=this;this.kbd=new maxkir.KbdManager(document.querySelector(".dueDateForm")),this.kbd.addShortcut("enter",function(b){if(document.activeElement===a.focus_keeper()||document.activeElement===a.input_field())Event.stop(b),a.submit_form(a.input_field().form)},!0).addShortcut("up|k",function(){a.unfocus_field(),a.inc_date(-7)}).addShortcut("down|j",function(b){if(!a.focused_field()||b.keyCode!==74)a.unfocus_field(),a.inc_date(7),Event.stop(b)},!0).addShortcut("right|l",function(b){a.input_field().value===""&&a.unfocus_field(),a.focused_field()||(Event.stop(b),a.inc_date(1))},!0).addShortcut("left|h",function(b){a.input_field().value===""&&a.unfocus_field(),a.focused_field()||(Event.stop(b),a.inc_date(-1))},!0).addShortcut("pagedown",function(){a.unfocus_field(),a.withoutSubmit(function(){var b=new Date(a.scal.currentdate.getTime());b.setMonth(b.getMonth()+1);while(b.getMonth()-a.scal.currentdate.getMonth()===2)b.setDate(b.getDate()-1);a.scal.setCurrentDate(b)})}).addShortcut("pageup",function(){a.unfocus_field(),a.withoutSubmit(function(){var b=new Date(a.scal.currentdate.getTime());b.setMonth(b.getMonth()-1);while(b.getMonth()===a.scal.currentdate.getMonth())b.setDate(b.getDate()-1);a.scal.setCurrentDate(b)})})},inc_date:function(a){this.withoutSubmit(function(){this.scal.inc_date(a)}.bind(this))},input_field:function(){return $("cal_input_"+this.options.task_ids[0])},focus_keeper:function(){return this.input_field().form.focus_keeper},focused_field:function(){return document.activeElement===this.input_field()},unfocus_field:function(){return this.focused_field()?(this.input_field().blur(),this.focus_keeper().focus(),!0):!1},onHide:function(){this.focus_keeper().stopObserving(),this.kbd&&(this.kbd.dispose(),this.kbd=null)},fix_height:function(){this.win.updateHeight()},submit_form:function(a){var b=a.due.value.trim();this._processDueIncrement(b)||(maxkir.Due.set_due(this.options.task_ids,this.checklist_id,b),this.hide_popup())},_processDueIncrement:function(a){var b=/^([+-]?)(\d+)([dwmy]?)$/.exec(a);if(b){if(!b[1]&&!b[3]){a=parseInt(a);var c=this;return c.withoutSubmit(function(){var b=new Date,d=new Date(c.scal.currentdate),e=d.getDate();d.setFullYear(b.getFullYear(),b.getMonth(),a),a<e&&d.setMonth(d.getMonth()+1),c.scal.setCurrentDate(d)}),!0}var d=b[1]==="-"?-1:1;return d=d*b[2],b[3]==="w"&&(d=d*7),b[3]==="m"&&(d=d*30),b[3]==="y"&&(d=d*365),this.inc_date(d),!0}return!1},add_focus_listener:function(){this.focus_keeper().on("focus",function(){document.querySelector(".calendarContainer").classList.add("calendarContainer--focused")}),this.focus_keeper().on("blur",function(){document.querySelector(".calendarContainer").classList.remove("calendarContainer--focused")})}}),maxkir.ui.RepeatingDuePopup=maxkir.ui.create_popup(!1,{popup_width:450,refresh:function(){this.handlers=[],this.win.addDisposerOnClose(function(){this.unregister_handlers()}.bind(this)),new maxkir.AjaxRequest(this._base_path()+"/repeat.html",{method:"get",onSuccess:function(a){this.updateContent(a.responseText),this.last_state||(this.last_state=Form.serialize(this.get_form()),this.get_form().down("input[type=radio]").focus())}.bind(this)}),this.win.setHTMLContent("Loading...")},unregister_handlers:function(){this.handlers.each(function(a){a.stop()}),this.handlers=[]},updateContent:function(a){this.unregister_handlers
(),this.store_active_element();var b=this.win.getContent();b.update(a),b.select("input.datePicker").each(function(a){var b=maxkir.ui.DatePicker.install_on(a,{onUpdate:function(){this.refresh_form()}.bind(this)});this.handlers.push(b)}.bind(this));if(maxkir.week_starts_with_monday()){var c=b.down("tr.weekdays label");b.down("tr.weekdays td div").appendChild(c)}this.update_form(),this.win.updateHeight(),this.scrollToShow(),this.restore_active_element()},store_active_element:function(){this.position=null,document.activeElement.type=="text"&&(this.position=[document.activeElement.identify(),maxkir.get_selection_range(document.activeElement)])},restore_active_element:function(){this.position&&maxkir.set_selection_range($(this.position[0]),this.position[1]),this.position=null},onShow:function(){maxkir.TemporaryUser&&maxkir.TemporaryUser.on_pro_usage("repeating due");if(!this._handlersSet){this._handlersSet=!0,this.win.addDisposerOnClose(function(){this._handlersSet=!1}.bind(this));var a=function(){this.refresh_form()}.bind(this),b=this.win.getContent().on("change",".monitored",a);this.win.addDisposerOnClose(function(){b.stop()});var c=maxkir.callsCollecter(a);["input","paste","keyup"].each(function(a){var b=this.win.getContent().on(a,".monitored",c);this.win.addDisposerOnClose(function(){b.stop()})}.bind(this))}this.scrollToShow()},refresh_form:function(){var a=Form.serialize(this.get_form());this.last_state!=a&&(this.last_state=a,new maxkir.AjaxRequest(this._base_path()+"/repeat/preview.html",{method:"post",parameters:a,onSuccess:function(a){this.updateContent(a.responseText),this.get_form().down("input[type=radio]").focus()}.bind(this)}))},submit_form:function(a){new maxkir.AjaxRequest(this._base_path()+"/repeat.js",{method:"post",parameters:Form.serialize(this.get_form())+"&"+a,onComplete:function(a){a.request.success()?(maxkir.Task.updateTask(this.options.task_id),this.hide_popup()):this.refresh_form()}.bind(this)})},get_form:function(){return this.win.getContent().down("form")},update_form:function(){this.update_form_labels(),this.update_weekly_options()},update_form_labels:function(){var a=$("repeat_period"),b=$("repeat_period_count"),c=this.win.getContent(),d="day";a.selectedIndex>0&&(d=a.options[a.selectedIndex].value,d=d.substr(0,d.length-2)),b.selectedIndex>0&&(d+="s"),c.down(".periodName").update(d)},update_weekly_options:function(){var a=$("repeat_period"),b=a.options[a.selectedIndex].value=="weekly",c=this.win.getContent();c.down("tr.weekdays").style.display=b?"table-row":"none"},clear_due:function(){var a=this.options.task_id;maxkir.Due.clear_repeating_due(a,maxkir.Task.checklist_id(a)),this.hide_popup()},set_paused:function(a){this.submit_form(encodeURIComponent("repeat[paused]")+"="+a)},_base_path:function(){var a=this.options.task_id;return"/checklists/"+maxkir.Task.checklist_id(a)+"/tasks/"+a},_f:null}),maxkir.ui.AssigneePopup=Object.extend({},maxkir.ui.BaseListPopup),Object.extend(maxkir.ui.AssigneePopup,maxkir.ui.SecondPopupSupport),Object.extend(maxkir.ui.AssigneePopup,{popup_width:450,getContentTemplate:function(){var a=this.options.task_ids,b=a[0],c=maxkir.Task.checklist_id(b);return(new Template($("assigneePopupTemplate").innerHTML)).evaluate({lists:maxkir.ui.BaseListPopup.getContentTemplate(),task_id:b,checklist_id:c})},_setContent:function(a){maxkir.ui.BaseListPopup._setContent.call(this,a),$("clParent").addClassName("assigneeList")},doSetupKeyboard:function(){maxkir.ui.BaseListPopup.doSetupKeyboard.call(this),maxkir.ui.SecondPopupSupport.doSetupKeyboard.call(this)},onRebuildList:function(){maxkir.ui.SecondPopupSupport.onRebuildList.call(this),maxkir.ui.BaseListPopup.onRebuildList.call(this)},getListModel:function(a){var b=new maxkir.ui.ListBuilder(a),c=new Template($("_assignPopupItem").innerHTML),d=this.options.task_ids,e=d.length==1?maxkir.Task.data(d[0]).assignee_ids:[];e||(e=[]),b.create_li=function(a,b){var d=b;return d.user_id=a,d.checked=e.indexOf(a)>=0?"checked='checked'":"",d.gravatar_img=maxkir.user.gravatar_img(maxkir.user.user_by(a)),c.evaluate(d)};var f=maxkir.Task.checklist_id(d[0]),g=[],h=maxkir.user.checklist_users(),i=this.list_users(f);for(var j=0;j<h.length;j++){var k=h[j].id;(!i||i.indexOf(k)!=-1)&&g.push({id:k,text:"<b>"+maxkir.escapeHtml(h[j].username)+"</b> "+h[j].email})}return b.set_items(g),b},list_users:function(a){return maxkir.Lists.data(a)?maxkir.Lists.data(a).user_ids:null},set_assignee:function(){this.assigneeIds=this.win.getContent().select("input.assigneeId:checked").map(function(a){return a.value}),maxkir.Task.set_assignee(this.options.task_ids,this.assigneeIds,!0)},onShow:function(){this.scrollToShow(),this.popupFilter().title=I18N("filter_by_name_email"),this.popupFilter().placeholder=this.popupFilter().title,this.clickHandler=this.win.getContent().on("click","input[type=checkbox]",this.set_assignee.bind(this))},onHide:function(){this.assigneeIds&&maxkir.Task.set_assignee(this.options.task_ids,this.assigneeIds),this.clickHandler&&this.clickHandler.stop(),maxkir.ui.BaseListPopup.onHide.call(this)},activate_by_space:function(){return!0}});var qq=qq||{};qq.extend=function(a,b){for(var c in b)a[c]=b[c]},qq.indexOf=function(a,b,c){if(a.indexOf)return a.indexOf(b,c);c=c||0;var d=a.length;c<0&&(c+=d);for(;c<d;c++)if(c in a&&a[c]===b)return c;return-1},qq.getUniqueId=function(){var a=0;return function(){return a++}}(),qq.attach=function(a,b,c){return a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c),function(){qq.detach(a,b,c)}},qq.detach=function(a,b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.attachEvent&&a.detachEvent("on"+b,c)},qq.preventDefault=function(a){a.preventDefault?a.preventDefault():a.returnValue=!1},qq.insertBefore=function(a,b){b.parentNode.insertBefore(a,b)},qq.remove=function(a){a.parentNode.removeChild(a)},qq.contains=function(a,b){return a==b?!0:a.contains?a.contains(b):!!(b.compareDocumentPosition(a)&8)},qq.toElement=function(){var a=document.createElement("div");return function(b){a.innerHTML=b;var c=a.firstChild;return a.removeChild(c),c}}(),qq.css=function(a,b){b.opacity!=null&&typeof a.style.opacity!="string"&&typeof a.filters!="undefined"&&(b.filter="alpha(opacity="+Math.round(100*b.opacity)+")"),qq.extend(a.style,b)},qq.hasClass=function(a,b){var c=new RegExp("(^| )"+b+"( |$)");return c.test(a.className)},qq.addClass=function(a,b){qq.hasClass(a,b)||(a.className+=" "+b)},qq.removeClass=function(a,b){var c=new RegExp("(^| )"+b+"( |$)");a.className=a.className.replace(c," ").replace(/^\s+|\s+$/g,"")},qq.setText=function(a,b){a.innerText=b,a.textContent=b},qq.children=function(a){var b=[],c=a.firstChild;while(c)c.nodeType==1&&b.push(c),c=c.nextSibling;return b},qq.getByClass=function(a,b){if(a.querySelectorAll)return a.querySelectorAll("."+b);var c=[],d=a.getElementsByTagName("*"),e=d.length;for(var f=0;f<e;f++)qq.hasClass(d[f],b)&&c.push(d[f]);return c},qq.obj2url=function(a,b,c){var d=[],e="&",f=function(a,c){var e=b?/\[\]$/.test(b)?b:b+"["+c+"]":c;e!="undefined"&&c!="undefined"&&d.push(typeof a=="object"?qq.obj2url(a,e,!0):Object.prototype.toString.call(a)==="[object Function]"?encodeURIComponent(e)+"="+encodeURIComponent(a()):encodeURIComponent(e)+"="+encodeURIComponent(a))};if(!c&&b)e=/\?/.test(b)?/\?$/.test(b)?"":"&":"?",d.push(b),d.push(qq.obj2url(a));else if(Object.prototype.toString.call(a)==="[object Array]"&&typeof a!="undefined")for(var g=0,h=a.length;g<h;++g)f(a[g],g);else if(typeof a!="undefined"&&a!==null&&typeof a=="object")for(var g in a)f(a[g],g);else d.push(encodeURIComponent(b)+"="+encodeURIComponent(a));return d.join(e).replace(/^&/,"").replace(/%20/g,"+")};var qq=qq||{};qq.FileUploaderBasic=function(a){this._options={debug:!1,action:"/server/upload",params:{},button:null,multiple:!0,maxConnections:3,allowedExtensions:[],sizeLimit:0,minSizeLimit:0,onSubmit:function(a,b){},onProgress:function(a,b,c,d){},onComplete:function(a,b,c){},onCancel:function(a,b){},messages:{typeError:"{file} has invalid extension. Only {extensions} are allowed.",sizeError:"{file} is too large, maximum file size is {sizeLimit}.",minSizeError:"{file} is too small, minimum file size is {minSizeLimit}.",emptyError:"{file} is empty, please select files again without it.",onLeave:"The files are being uploaded, if you leave now the upload will be cancelled."},showMessage:function(a){alert(a)}},qq.extend(this._options,a),qq.extend(this,qq.DisposeSupport),this._filesInProgress=0,this._handler=this._createUploadHandler(),this._options.button&&(this._button=this._createUploadButton(this._options.button)),this._preventLeaveInProgress()},qq.FileUploaderBasic.prototype={setParams:function(a){this._options.params=a},getInProgress:function(){return this._filesInProgress},_createUploadButton:function(a){var b=this,c=new qq.UploadButton({element:a,multiple:this._options.multiple&&qq.UploadHandlerXhr.isSupported(),onChange:function(a){b._onInputChange(a)}});return this.addDisposer(function(){c.dispose()}),c},_createUploadHandler:function(){var a=this,b;qq.UploadHandlerXhr.isSupported()?b="UploadHandlerXhr":b="UploadHandlerForm";var c=new qq[b]({debug:this._options.debug,action:this._options.action,maxConnections:this._options.maxConnections,onProgress:function(b,c,d,e){a._onProgress(b,c,d,e),a._options.onProgress(b,c,d,e)},onComplete:function(b,c,d){a._onComplete(b,c,d),a._options.onComplete(b,c,d)},onCancel:function(b,c){a._onCancel(b,c),a._options.onCancel(b,c)}});return c},_preventLeaveInProgress:function(){var a=this;this._attach(window,"beforeunload",function(b){if(!a._filesInProgress)return;var b=b||window.event;return b.returnValue=a._options.messages.onLeave,a._options.messages.onLeave})},_onSubmit:function(a,b){this._filesInProgress++},_onProgress:function(a,b,c,d){},_onComplete:function(a,b,c){this._filesInProgress--,c.error&&this._options.showMessage(c.error)},_onCancel:function(a,b){this._filesInProgress--},_onInputChange:function(a){this._handler instanceof qq.UploadHandlerXhr?this._uploadFileList(a.files):this._validateFile(a)&&this._uploadFile(a),this._button.reset()},_uploadFileList:function(a){for(var b=0;b<a.length;b++)if(!this._validateFile(a[b]))return;for(var b=0;b<a.length;b++)this._uploadFile(a[b])},_uploadFile:function(a){var b=this._handler.add(a),c=this._handler.getName(b);this._options.onSubmit(b,c)!==!1&&(this._onSubmit(b,c),this._handler.upload(b,this._options.params))},_validateFile:function(a){var b,c;return a.value?b=a.value.replace(/.*(\/|\\)/,""):(b=a.fileName!=null?a.fileName:a.name,c=a.fileSize!=null?a.fileSize:a.size),this._isAllowedExtension(b)?c===0?(this._error("emptyError",b),!1):c&&this._options.sizeLimit&&c>this._options.sizeLimit?(this._error("sizeError",b),!1):c&&c<this._options.minSizeLimit?(this._error("minSizeError",b),!1):!0:(this._error("typeError",b),!1)},_error:function(a,b){function d(a,b){c=c.replace(a,b)}var c=this._options.messages[a];d("{file}",this._formatFileName(b)),d("{extensions}",this._options.allowedExtensions.join(", ")),d("{sizeLimit}",this._formatSize(this._options.sizeLimit)),d("{minSizeLimit}",this._formatSize(this._options.minSizeLimit)),this._options.showMessage(c)},_formatFileName:function(a){return a.length>45&&(a=a.slice(0,21)+"..."+a.slice(-20)),a},_isAllowedExtension:function(a){var b=-1!==a.indexOf(".")?a.replace(/.*[.]/,"").toLowerCase():"",c=this._options.allowedExtensions;if(!c.length)return!0;for(var d=0;d<c.length;d++)if(c[d].toLowerCase()==b)return!0;return!1},_formatSize:function(a){var b=-1;do a=a/1024,b++;while(a>99);return Math.max(a,.1).toFixed(1)+["kB","MB","GB","TB","PB","EB"][b]}},qq.FileUploader=function(a){qq.FileUploaderBasic.apply(this,arguments),qq.extend(this._options,{element:null,listElement:null,template:'<div class="qq-uploader"><div class="qq-upload-drop-area"><span>Drop files here to upload</span></div><div class="qq-upload-button">Upload a file</div><ul class="qq-upload-list"></ul></div>',fileTemplate:'<li><span class="qq-upload-file"></span><span class="qq-upload-spinner"></span><span class="qq-upload-size"></span><a class="qq-upload-cancel" href="#">Cancel</a><span class="qq-upload-failed-text">Failed</span></li>',classes:{button:"qq-upload-button",drop:"qq-upload-drop-area",dropActive:"qq-upload-drop-area-active",list:"qq-upload-list",file:"qq-upload-file",spinner:"qq-upload-spinner",size:"qq-upload-size",cancel:"qq-upload-cancel",success:"qq-upload-success",fail:"qq-upload-fail"}}),qq.extend(this._options,a),this._element=this._options.element,this._element.innerHTML=this._options.template,this._listElement=this._options.listElement||this._find(this._element,"list"),this._classes=this._options.classes,this._button=this._createUploadButton(this._find(this._element,"button")),this._bindCancelEvent(),this._setupDragDrop()},qq.extend(qq.FileUploader.prototype,qq.FileUploaderBasic.prototype),qq.extend(qq.FileUploader.prototype,{_find:function(a,b){var c=qq.getByClass(a,this._options.classes[b])[0];if(!c)throw new Error("element not found "+b);return c},_setupDragDrop:function(){var a=this,b=this._find(this._element,"drop"),c=new qq.UploadDropZone({element:b,onEnter:function(c){qq.addClass(b,a._classes.dropActive),c.stopPropagation()},onLeave:function(a){a.stopPropagation()},onLeaveNotDescendants:function(c){qq.removeClass(b,a._classes.dropActive)},onDrop:function(c){b.style.display="none",qq.removeClass(b,a._classes.dropActive),a._uploadFileList(c.dataTransfer.files)}});this.addDisposer(function(){c.dispose()}),b.style.display="none",this._attach(document,"dragenter",function(a){if(!c._isValidFileDrag(a))return;b.style.display="block"}),this._attach(document,"dragleave",function(a){if(!c._isValidFileDrag(a))return;var d=document.elementFromPoint(a.clientX,a.clientY);if(!d||d.nodeName=="HTML")b.style.display="none"})},_onSubmit:function(a,b){qq.FileUploaderBasic.prototype._onSubmit.apply(this,arguments),this._addToList(a,b)},_onProgress:function(a,b,c,d){qq.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var e=this._getItemByFileId(a),f=this._find(e,"size");f.style.display="inline";var g;c!=d?g=Math.round(c/d*100)+"% from "+this._formatSize(d):g=this._formatSize(d),qq.setText(f,g)},_onComplete:function(a,b,c){qq.FileUploaderBasic.prototype._onComplete.apply(this,arguments);var d=this._getItemByFileId(a);qq.remove(this._find(d,"cancel")),qq.remove(this._find(d,"spinner")),c.success?qq.addClass(d,this._classes.success):qq.addClass(d,this._classes.fail)},_addToList:function(a,b){var c=qq.toElement(this._options.fileTemplate);c.qqFileId=a;var d=this._find(c,"file");qq.setText(d,this._formatFileName(b)),this._find(c,"size").style.display="none",this._listElement.appendChild(c)},_getItemByFileId:function(a){var b=this._listElement.firstChild;while(b){if(b.qqFileId==a)return b;b=b.nextSibling}},_bindCancelEvent:function(){var a=this,b=this._listElement;this._attach(b,"click",function(b){b=b||window.event;var c=b.target||b.srcElement;if(qq.hasClass(c,a._classes.cancel)){qq.preventDefault(b);var d=c.parentNode;a._handler.cancel(d.qqFileId),qq.remove(d)}})}}),qq.UploadDropZone=function(a){this._options={element:null,onEnter:function(a){},onLeave:function(a){},onLeaveNotDescendants:function(a){},onDrop:function(a){}},qq.extend(this._options,a),qq.extend(this,qq.DisposeSupport),this._element=this._options.element,this._disableDropOutside(),this._attachEvents()},qq.UploadDropZone.prototype={_disableDropOutside:function(a){qq.UploadDropZone.dropOutsideDisabled||(qq.attach(document,"dragover",function(a){a.dataTransfer&&(a.dataTransfer.dropEffect="none",a.preventDefault())}),qq.UploadDropZone.dropOutsideDisabled=!0)},_attachEvents:function(){var a=this;a._attach(a._element,"dragover",function(b){if(!a._isValidFileDrag(b))return;var c=b.dataTransfer.effectAllowed;c=="move"||c=="linkMove"?b.dataTransfer.dropEffect="move":b.dataTransfer.dropEffect="copy",b.stopPropagation(),b.preventDefault()}),a._attach(a._element,"dragenter",function(b){if(!a._isValidFileDrag(b))return;a._options.onEnter(b)}),a._attach(a._element,"dragleave",function(b){if(!a._isValidFileDrag(b))return;a._options.onLeave(b);var c=document.elementFromPoint(b.clientX,b.clientY);if(qq.contains(this,c))return;a._options.onLeaveNotDescendants(b)}),a._attach(a._element,"drop",function(b){if(!a._isValidFileDrag(b))return;b.preventDefault(),a._options.onDrop(b)})},_isValidFileDrag:function(a){var b=a.dataTransfer,c=navigator.userAgent.indexOf("AppleWebKit")>-1;return b&&b.effectAllowed!="none"&&(b.files||!c&&b.types.contains&&b.types.contains("Files"))}},qq.UploadButton=function(a){this._options={element:null,multiple:!1,name:"file",onChange:function(a){},hoverClass:"qq-upload-button-hover",focusClass:"qq-upload-button-focus"},qq.extend(this._options,a),qq.extend(this,qq.DisposeSupport),this._element=this._options.element,qq.css(this._element,{position:"relative",overflow:"hidden",direction:"ltr"}),this._input=this._createInput()},qq.UploadButton.prototype={getInput:function(){return this._input},reset:function(){this._input.parentNode&&qq.remove(this._input),qq.removeClass(this._element,this._options.focusClass),this._input=this._createInput()},_createInput:function(){var a=document.createElement("input");this._options.multiple&&a.setAttribute("multiple","multiple"),a.setAttribute("type","file"),a.setAttribute("name",this._options.name),qq.css(a,{position:"absolute",right:0,top:0,fontFamily:"Arial",fontSize:"118px",margin:0,padding:0,cursor:"pointer",opacity:0}),this._element.appendChild(a);var b=this;return this._attach(a,"change",function(){b._options.onChange(a)}),this._attach(a,"mouseover",function(){qq.addClass(b._element,b._options.hoverClass)}),this._attach(a,"mouseout",function(){qq.removeClass(b._element,b._options.hoverClass)}),this._attach(a,"focus",function(){qq.addClass(b._element,b._options.focusClass)}),this._attach(a,"blur",function(){qq.removeClass(b._element,b._options.focusClass)}),window.attachEvent&&a.setAttribute("tabIndex","-1"),a}},qq.UploadHandlerAbstract=function(a){this._options={debug:!1,action:"/upload.php",maxConnections:999,onProgress:function(a,b,c,d){},onComplete:function(a,b,c){},onCancel:function(a,b){}},qq.extend(this._options,a),this._queue=[],this._params=[]},qq.UploadHandlerAbstract.prototype={log:function(a){this._options.debug&&window.console&&console.log("[uploader] "+a)},add:function(a){},upload:function(a,b){var c=this._queue.push(a),d={};qq.extend(d,b),this._params[a]=d,c<=this._options.maxConnections&&this._upload(a,this._params[a])},cancel:function(a){this._cancel(a),this._dequeue(a)},cancelAll:function(){for(var a=0;a<this._queue.length;a++)this._cancel(this._queue[a]);this._queue=[]},getName:function(a){},getSize:function(a){},getQueue:function(){return this._queue},_upload:function(a){},_cancel:function(a){},_dequeue:function(a){var b=qq.indexOf(this._queue,a);this._queue.splice(b,1);var c=this._options.maxConnections;if(this._queue.length>=c&&b<c){var d=this._queue[c-1];this._upload(d,this._params[d])}}},qq.UploadHandlerForm=function(a){qq.UploadHandlerAbstract.apply(this,arguments),this._inputs={}},qq.extend(qq.UploadHandlerForm.prototype,qq.UploadHandlerAbstract.prototype),qq.extend(qq.UploadHandlerForm.prototype,{add:function(a){a.setAttribute("name","qqfile");var b="qq-upload-handler-iframe"+qq.getUniqueId();return this._inputs[b]=a,a.parentNode&&qq.remove(a),b},getName:function(a){return this._inputs[a].value.replace(/.*(\/|\\)/,"")},_cancel:function(a){this._options.onCancel(a,this.getName(a)),delete this._inputs[a];var b=document.getElementById(a);b&&(b.setAttribute("src","javascript:false;"),qq.remove(b))},_upload:function(a,b){var c=this._inputs[a];if(!c)throw new Error("file with passed id was not added, or already uploaded or cancelled");var d=this.getName(a),e=this._createIframe(a),f=this._createForm(e,b);f.appendChild(c);var g=this;return this._attachLoadEvent(e,function(){g.log("iframe loaded");var b=g._getIframeContentJSON(e);g._options.onComplete(a,d,b),g._dequeue(a),delete g._inputs[a],setTimeout(function(){g._detach_event(),qq.remove(e)},1)}),f.submit(),qq.remove(f),a},_attachLoadEvent:function(a,b){this._detach_event=qq.attach(a,"load",function(){if(!a.parentNode)return;if(a.contentDocument&&a.contentDocument.body&&a.contentDocument.body.innerHTML=="false")return;b()})},_getIframeContentJSON:function(iframe){var doc=iframe.contentDocument?iframe.contentDocument:iframe.contentWindow.document,response;this.log("converting iframe's innerHTML to JSON"),this.log("innerHTML = "+doc.body.innerHTML);var data=doc.body.innerHTML;data=data.replace(/<[^>]+>/g,"");try{response=eval("("+data+")")}catch(err){response={}}return response},_createIframe:function(a){var b=qq.toElement('<iframe src="javascript:false;" name="'+a+'" />');return b.setAttribute("id",a),b.style.display="none",document.body.appendChild(b),b},_createForm:function(a,b){var c=qq.toElement('<form method="post" enctype="multipart/form-data"></form>'),d=qq.obj2url(b,this._options.action);return c.setAttribute("action",d),c.setAttribute("target",a.name),c.style.display="none",document.body.appendChild(c),c}}),qq.UploadHandlerXhr=function(a){qq.UploadHandlerAbstract.apply(this,arguments),this._files=[],this._xhrs=[],this._loaded=[]},qq.UploadHandlerXhr.isSupported=function(){function a(){var a=document.createElement("INPUT");return a.type="file","files"in a}function b(){var a=new XMLHttpRequest;return!!(a&&"upload"in a&&"onprogress"in a.upload)}function c(){return!!window.FormData}return a()&&b()&&c()},qq.extend(qq.UploadHandlerXhr.prototype,qq.UploadHandlerAbstract.prototype),qq.extend(qq.UploadHandlerXhr.prototype,{add:function(a){if(a instanceof File)return this._files.push(a)-1;throw new Error("Passed obj in not a File (in qq.UploadHandlerXhr)")},getName:function(a){var b=this._files[a];return b.fileName!=null?b.fileName:b.name},getSize:function(a){var b=this._files[a];return b.fileSize!=null?b.fileSize:b.size},getLoaded:function(a){return this._loaded[a]||0},_upload:function(a,b){var c=this._files[a],d=this.getName(a),e=this.getSize(a);this._loaded[a]=0;var f=this._xhrs[a]=new XMLHttpRequest,g=this;f.upload.onprogress=function(b){b.lengthComputable&&(g._loaded[a]=b.loaded,g._options.onProgress(a,d,b.loaded,b.total))},f.onreadystatechange=function(){f.readyState==4&&g._onComplete(a,f)},b=b||{};var h=new FormData,i=qq.obj2url(b,this._options.action);f.open("POST",i,!0),h.append("file",c),f.send(h)},_onComplete:function(id,xhr){if(!this._files[id])return;var name=this.getName(id),size=this.getSize(id);this._options.onProgress(id,name,size,size);if(xhr.status==200){this.log("xhr - server response received"),this.log("responseText = "+xhr.responseText);var response;try{response=eval("("+xhr.responseText+")")}catch(err){response={}}this._options.onComplete(id,name,response)}else this._options.onComplete(id,name,{});this._files[id]=null,this._xhrs[id]=null,this._dequeue(id)},_cancel:function(a){this._options.onCancel(a,this.getName(a)),this._files[a]=null,this._xhrs[a]&&(this._xhrs[a].abort(),this._xhrs[a]=null)}}),qq.DisposeSupport={_disposers:[],dispose:function(){var a;while(a=this._disposers.shift())a()},addDisposer:function(a){this._disposers.push(a)},_attach:function(){this.addDisposer(qq.attach.apply(this,arguments))}},function(){var a={HTMLEvents:/^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,MouseEvents:/^(?:click|mouse(?:down|up|over|move|out))$/},b={pointerX:0,pointerY:0,button:0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,bubbles:!0,cancelable:!0};Event.simulate=function(c,d){var e=Object.extend(b,arguments[2]||{}),f,g=null;c=$(c);for(var h in a)if(a[h].test(d)){g=h;break}if(!g)throw new SyntaxError("Only HTMLEvents and MouseEvents interfaces are supported");return document.createEvent?(f=document.createEvent(g),g=="HTMLEvents"?f.initEvent(d,e.bubbles,e.cancelable):f.initMouseEvent(d,e.bubbles,e.cancelable,document.defaultView,e.button,e.pointerX,e.pointerY,e.pointerX,e.pointerY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,c),c.dispatchEvent(f)):(e.clientX=e.pointerX,e.clientY=e.pointerY,f=Object.extend(document.createEventObject(),e),c.fireEvent("on"+d,f)),c},Element.addMethods({simulate:Event.simulate})}(),function(){var a,b,c,d={}.hasOwnProperty,e=function(a,b){function e(){this.constructor=a}for(var c in b)d.call(b,c)&&(a[c]=b[c]);return e.prototype=b.prototype,a.prototype=new e,a.__super__=b.prototype,a};b=function(){function a(){this.options_index=0,this.parsed=[]}return a.prototype.add_node=function(a){return a.nodeName.toUpperCase()==="OPTGROUP"?this.add_group(a):this.add_option(a)},a.prototype.add_group=function(a){var b,c,d,e,f,g;b=this.parsed.length,this.parsed.push({array_index:b,group:!0,label:this.escapeExpression(a.label),title:a.title?a.title:void 0,children:0,disabled:a.disabled,classes:a.className}),f=a.childNodes,g=[];for(d=0,e=f.length;d<e;d++)c=f[d],g.push(this.add_option(c,b,a.disabled));return g},a.prototype.add_option=function(a,b,c){if(a.nodeName.toUpperCase()==="OPTION")return a.text!==""?(b!=null&&(this.parsed[b].children+=1),this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,value:a.value,text:a.text,html:a.innerHTML,title:a.title?a.title:void 0,selected:a.selected,disabled:c===!0?c:a.disabled,group_array_index:b,group_label:b!=null?this.parsed[b].label:null,classes:a.className,style:a.style.cssText})):this.parsed.push({array_index:this.parsed.length,options_index:this.options_index,empty:!0}),this.options_index+=1},a.prototype.escapeExpression=function(a){var b,c;return a==null||a===!1?"":/[\&\<\>\"\'\`]/.test(a)?(b={"<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},c=/&(?!\w+;)|[\<\>\"\'\`]/g,a.replace(c,function(a){return b[a]||"&amp;"})):a},a}(),b.select_to_array=function(a){var c,d,e,f,g;d=new b,g=a.childNodes;for(e=0,f=g.length;e<f;e++)c=g[e],d.add_node(c);return d.parsed},a=function(){function a(b,c){this.form_field=b,this.options=c!=null?c:{};if(!a.browser_is_supported())return;this.is_multiple=this.form_field.multiple,this.set_default_text(),this.set_default_values(),this.setup(),this.set_up_html(),this.register_observers(),this.on_ready()}return a.prototype.set_default_values=function(){var a=this;return this.click_test_action=function(b){return a.test_active_click(b)},this.activate_action=function(b){return a.activate_field(b)},this.active_field=!1,this.mouse_on_container=!1,this.results_showing=!1,this.result_highlighted=null,this.allow_single_deselect=this.options.allow_single_deselect!=null&&this.form_field.options[0]!=null&&this.form_field.options[0].text===""?this.options.allow_single_deselect:!1,this.disable_search_threshold=this.options.disable_search_threshold||0,this.disable_search=this.options.disable_search||!1,this.enable_split_word_search=this.options.enable_split_word_search!=null?this.options.enable_split_word_search:!0,this.group_search=this.options.group_search!=null?this.options.group_search:!0,this.search_contains=this.options.search_contains||!1,this.single_backstroke_delete=this.options.single_backstroke_delete!=null?this.options.single_backstroke_delete:!0,this.max_selected_options=this.options.max_selected_options||Infinity,this.inherit_select_classes=this.options.inherit_select_classes||!1,this.display_selected_options=this.options.display_selected_options!=null?this.options.display_selected_options:!0,this.display_disabled_options=this.options.display_disabled_options!=null?this.options.display_disabled_options:!0,this.include_group_label_in_selected=this.options.include_group_label_in_selected||!1},a.prototype.set_default_text=function(){return this.form_field.getAttribute("data-placeholder")?this.default_text=this.form_field.getAttribute("data-placeholder"):this.is_multiple?this.default_text=this.options.placeholder_text_multiple||this.options.placeholder_text||a.default_multiple_text:this.default_text=this.options.placeholder_text_single||this.options.placeholder_text||a.default_single_text,this.results_none_found=this.form_field.getAttribute("data-no_results_text")||this.options.no_results_text||a.default_no_result_text},a.prototype.choice_label=function(a){return this.include_group_label_in_selected&&a.group_label!=null?"<b class='group-name'>"+a.group_label+"</b>"+a.html:a.html},a.prototype.mouse_enter=function(){return this.mouse_on_container=!0},a.prototype.mouse_leave=function(){return this.mouse_on_container=!1},a.prototype.input_focus=function(a){var b=this;if(this.is_multiple){if(!this.active_field)return setTimeout(function(){return b.container_mousedown()},50)}else if(!this.active_field)return this.activate_field()},a.prototype.input_blur=function(a){var b=this;if(!this.mouse_on_container)return this.active_field=!1,setTimeout(function(){return b.blur_test()},100)},a.prototype.results_option_build=function(a){var b,c,d,e,f;b="",f=this.results_data;for(d=0,e=f.length;d<e;d++){c=f[d],c.group?b+=this.result_add_group(c):b+=this.result_add_option(c);if(a!=null?a.first:void 0)c.selected&&this.is_multiple?this.choice_build(c):c.selected&&!this.is_multiple&&this.single_set_selected_text(this.choice_label(c))}return b},a.prototype.result_add_option=function(a){var b,c;return a.search_match?this.include_option_in_results(a)?(b=[],!a.disabled&&(!a.selected||!this.is_multiple)&&b.push("active-result"),a.disabled&&(!a.selected||!this.is_multiple)&&b.push("disabled-result"),a.selected&&b.push("result-selected"),a.group_array_index!=null&&b.push("group-option"),a.classes!==""&&b.push(a.classes),c=document.createElement("li"),c.className=b.join(" "),c.style.cssText=a.style,c.setAttribute("data-option-array-index",a.array_index),c.innerHTML=a.search_text,a.title&&(c.title=a.title),this.outerHTML(c)):"":""},a.prototype.result_add_group=function(a){var b,c;return!a.search_match&&!a.group_match?"":a.active_options>0?(b=[],b.push("group-result"),a.classes&&b.push(a.classes),c=document.createElement("li"),c.className=b.join(" "),c.innerHTML=a.search_text,a.title&&(c.title=a.title),this.outerHTML(c)):""},a.prototype.results_update_field=function(){this.set_default_text(),this.is_multiple||this.results_reset_cleanup(),this.result_clear_highlight(),this.results_build();if(this.results_showing)return this.winnow_results()},a.prototype.reset_single_select_options=function(){var a,b,c,d,e;d=this.results_data,e=[];for(b=0,c=d.length;b<c;b++)a=d[b],a.selected?e.push(a.selected=!1):e.push(void 0);return e},a.prototype.results_toggle=function(){return this.results_showing?this.results_hide():this.results_show()},a.prototype.results_search=function(a){return this.results_showing?this.winnow_results():this.results_show()},a.prototype.winnow_results=function(){var a,b,c,d,e,f,g,h,i,j,k,l;this.no_results_clear(),d=0,f=this.get_search_text(),a=f.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),i=new RegExp(a,"i"),c=this.get_search_regex(a),l=this.results_data;for(j=0,k=l.length;j<k;j++){b=l[j],b.search_match=!1,e=null;if(this.include_option_in_results(b)){b.group&&(b.group_match=!1,b.active_options=0),b.group_array_index!=null&&this.results_data[b.group_array_index]&&(e=this.results_data[b.group_array_index],e.active_options===0&&e.search_match&&(d+=1),e.active_options+=1),b.search_text=b.group?b.label:b.html;if(!b.group||!!this.group_search)b.search_match=this.search_string_match(b.search_text,c),b.search_match&&!b.group&&(d+=1),b.search_match?(f.length&&(g=b.search_text.search(i),h=b.search_text.substr(0,g+f.length)+"</em>"+b.search_text.substr(g+f.length),b.search_text=h.substr(0,g)+"<em>"+h.substr(g)),e!=null&&(e.group_match=!0)):b.group_array_index!=null&&this.results_data[b.group_array_index].search_match&&(b.search_match=!0)}}return this.result_clear_highlight(),d<1&&f.length?(this.update_results_content(""),this.no_results(f)):(this.update_results_content(this.results_option_build()),this.winnow_results_set_highlight())},a.prototype.get_search_regex=function(a){var b;return b=this.search_contains?"":"^",new RegExp(b+a,"i")},a.prototype.search_string_match=function(a,b){var c,d,e,f;if(b.test(a))return!0;if(this.enable_split_word_search&&(a.indexOf(" ")>=0||a.indexOf("[")===0)){d=a.replace(/\[|\]/g,"").split(" ");if(d.length)for(e=0,f=d.length;e<f;e++){c=d[e];if(b.test(c))return!0}}},a.prototype.choices_count=function(){var a,b,c,d;if(this.selected_option_count!=null)return this.selected_option_count;this.selected_option_count=0,d=this.form_field.options;for(b=0,c=d.length;b<c;b++)a=d[b],a.selected&&(this.selected_option_count+=1);return this.selected_option_count},a.prototype.choices_click=function(a){a.preventDefault();if(!this.results_showing&&!this.is_disabled)return this.results_show()},a.prototype.keyup_checker=function(a){var b,c;b=(c=a.which)!=null?c:a.keyCode,this.search_field_scale();switch(b){case 8:if(this.is_multiple&&
this.backstroke_length<1&&this.choices_count()>0)return this.keydown_backstroke();if(!this.pending_backstroke)return this.result_clear_highlight(),this.results_search();break;case 13:a.preventDefault();if(this.results_showing)return this.result_select(a);break;case 27:return this.results_showing&&this.results_hide(),!0;case 9:case 38:case 40:case 16:case 91:case 17:break;default:return this.results_search()}},a.prototype.clipboard_event_checker=function(a){var b=this;return setTimeout(function(){return b.results_search()},50)},a.prototype.container_width=function(){return this.options.width!=null?this.options.width:""+this.form_field.offsetWidth+"px"},a.prototype.include_option_in_results=function(a){return this.is_multiple&&!this.display_selected_options&&a.selected?!1:!this.display_disabled_options&&a.disabled?!1:a.empty?!1:!0},a.prototype.search_results_touchstart=function(a){return this.touch_started=!0,this.search_results_mouseover(a)},a.prototype.search_results_touchmove=function(a){return this.touch_started=!1,this.search_results_mouseout(a)},a.prototype.search_results_touchend=function(a){if(this.touch_started)return this.search_results_mouseup(a)},a.prototype.outerHTML=function(a){var b;return a.outerHTML?a.outerHTML:(b=document.createElement("div"),b.appendChild(a),b.innerHTML)},a.browser_is_supported=function(){return window.navigator.appName==="Microsoft Internet Explorer"?document.documentMode>=8:/iP(od|hone)/i.test(window.navigator.userAgent)?!1:/Android/i.test(window.navigator.userAgent)&&/Mobile/i.test(window.navigator.userAgent)?!1:!0},a.default_multiple_text="Select Some Options",a.default_single_text="Select an Option",a.default_no_result_text="No results match",a}(),this.Chosen=function(a){function d(){return c=d.__super__.constructor.apply(this,arguments),c}return e(d,a),d.prototype.setup=function(){return this.current_selectedIndex=this.form_field.selectedIndex,this.is_rtl=this.form_field.hasClassName("chosen-rtl")},d.prototype.set_default_values=function(){return d.__super__.set_default_values.call(this),this.single_temp=new Template('<a class="chosen-single chosen-default" tabindex="-1"><span>#{default}</span><div><b></b></div></a><div class="chosen-drop"><div class="chosen-search"><input type="text" autocomplete="off" /></div><ul class="chosen-results"></ul></div>'),this.multi_temp=new Template('<ul class="chosen-choices"><li class="search-field"><input type="text" value="#{default}" class="default" autocomplete="off" style="width:25px;" /></li></ul><div class="chosen-drop"><ul class="chosen-results"></ul></div>'),this.no_results_temp=new Template('<li class="no-results">'+this.results_none_found+' "<span>#{terms}</span>"</li>')},d.prototype.set_up_html=function(){var a,b;return a=["chosen-container"],a.push("chosen-container-"+(this.is_multiple?"multi":"single")),this.inherit_select_classes&&this.form_field.className&&a.push(this.form_field.className),this.is_rtl&&a.push("chosen-rtl"),b={"class":a.join(" "),style:"width: "+this.container_width()+";",title:this.form_field.title},this.form_field.id.length&&(b.id=this.form_field.id.replace(/[^\w]/g,"_")+"_chosen"),this.container=this.is_multiple?(new Element("div",b)).update(this.multi_temp.evaluate({"default":this.default_text})):(new Element("div",b)).update(this.single_temp.evaluate({"default":this.default_text})),this.form_field.hide().insert({after:this.container}),this.dropdown=this.container.down("div.chosen-drop"),this.search_field=this.container.down("input"),this.search_results=this.container.down("ul.chosen-results"),this.search_field_scale(),this.search_no_results=this.container.down("li.no-results"),this.is_multiple?(this.search_choices=this.container.down("ul.chosen-choices"),this.search_container=this.container.down("li.search-field")):(this.search_container=this.container.down("div.chosen-search"),this.selected_item=this.container.down(".chosen-single")),this.results_build(),this.set_tab_index(),this.set_label_behavior()},d.prototype.on_ready=function(){return this.form_field.fire("chosen:ready",{chosen:this})},d.prototype.register_observers=function(){var a=this;return this.container.observe("touchstart",function(b){return a.container_mousedown(b),b.preventDefault()}),this.container.observe("touchend",function(b){return a.container_mouseup(b),b.preventDefault()}),this.container.observe("mousedown",function(b){return a.container_mousedown(b)}),this.container.observe("mouseup",function(b){return a.container_mouseup(b)}),this.container.observe("mouseenter",function(b){return a.mouse_enter(b)}),this.container.observe("mouseleave",function(b){return a.mouse_leave(b)}),this.search_results.observe("mouseup",function(b){return a.search_results_mouseup(b)}),this.search_results.observe("mouseover",function(b){return a.search_results_mouseover(b)}),this.search_results.observe("mouseout",function(b){return a.search_results_mouseout(b)}),this.search_results.observe("mousewheel",function(b){return a.search_results_mousewheel(b)}),this.search_results.observe("DOMMouseScroll",function(b){return a.search_results_mousewheel(b)}),this.search_results.observe("touchstart",function(b){return a.search_results_touchstart(b)}),this.search_results.observe("touchmove",function(b){return a.search_results_touchmove(b)}),this.search_results.observe("touchend",function(b){return a.search_results_touchend(b)}),this.form_field.observe("chosen:updated",function(b){return a.results_update_field(b)}),this.form_field.observe("chosen:activate",function(b){return a.activate_field(b)}),this.form_field.observe("chosen:open",function(b){return a.container_mousedown(b)}),this.form_field.observe("chosen:close",function(b){return a.input_blur(b)}),this.search_field.observe("blur",function(b){return a.input_blur(b)}),this.search_field.observe("keyup",function(b){return a.keyup_checker(b)}),this.search_field.observe("keydown",function(b){return a.keydown_checker(b)}),this.search_field.observe("focus",function(b){return a.input_focus(b)}),this.search_field.observe("cut",function(b){return a.clipboard_event_checker(b)}),this.search_field.observe("paste",function(b){return a.clipboard_event_checker(b)}),this.is_multiple?this.search_choices.observe("click",function(b){return a.choices_click(b)}):this.container.observe("click",function(a){return a.preventDefault()})},d.prototype.destroy=function(){return this.container.ownerDocument.stopObserving("click",this.click_test_action),this.form_field.stopObserving(),this.container.stopObserving(),this.search_results.stopObserving(),this.search_field.stopObserving(),this.form_field_label!=null&&this.form_field_label.stopObserving(),this.is_multiple?(this.search_choices.stopObserving(),this.container.select(".search-choice-close").each(function(a){return a.stopObserving()})):this.selected_item.stopObserving(),this.search_field.tabIndex&&(this.form_field.tabIndex=this.search_field.tabIndex),this.container.remove(),this.form_field.show()},d.prototype.search_field_disabled=function(){this.is_disabled=this.form_field.disabled;if(this.is_disabled)return this.container.addClassName("chosen-disabled"),this.search_field.disabled=!0,this.is_multiple||this.selected_item.stopObserving("focus",this.activate_action),this.close_field();this.container.removeClassName("chosen-disabled"),this.search_field.disabled=!1;if(!this.is_multiple)return this.selected_item.observe("focus",this.activate_action)},d.prototype.container_mousedown=function(a){if(!this.is_disabled){a&&a.type==="mousedown"&&!this.results_showing&&a.stop();if(a==null||!a.target.hasClassName("search-choice-close"))return this.active_field?!this.is_multiple&&a&&(a.target===this.selected_item||a.target.up("a.chosen-single"))&&this.results_toggle():(this.is_multiple&&this.search_field.clear(),this.container.ownerDocument.observe("click",this.click_test_action),this.results_show()),this.activate_field()}},d.prototype.container_mouseup=function(a){if(a.target.nodeName==="ABBR"&&!this.is_disabled)return this.results_reset(a)},d.prototype.search_results_mousewheel=function(a){var b;b=a.deltaY||-a.wheelDelta||a.detail;if(b!=null)return a.preventDefault(),a.type==="DOMMouseScroll"&&(b=b*40),this.search_results.scrollTop=b+this.search_results.scrollTop},d.prototype.blur_test=function(a){if(!this.active_field&&this.container.hasClassName("chosen-container-active"))return this.close_field()},d.prototype.close_field=function(){return this.container.ownerDocument.stopObserving("click",this.click_test_action),this.active_field=!1,this.results_hide(),this.container.removeClassName("chosen-container-active"),this.clear_backstroke(),this.show_search_field_default(),this.search_field_scale()},d.prototype.activate_field=function(){return this.container.addClassName("chosen-container-active"),this.active_field=!0,this.search_field.value=this.search_field.value,this.search_field.focus()},d.prototype.test_active_click=function(a){return a.target.up(".chosen-container")===this.container?this.active_field=!0:this.close_field()},d.prototype.results_build=function(){return this.parsing=!0,this.selected_option_count=null,this.results_data=b.select_to_array(this.form_field),this.is_multiple?this.search_choices.select("li.search-choice").invoke("remove"):this.is_multiple||(this.single_set_selected_text(),this.disable_search||this.form_field.options.length<=this.disable_search_threshold?(this.search_field.readOnly=!0,this.container.addClassName("chosen-container-single-nosearch")):(this.search_field.readOnly=!1,this.container.removeClassName("chosen-container-single-nosearch"))),this.update_results_content(this.results_option_build({first:!0})),this.search_field_disabled(),this.show_search_field_default(),this.search_field_scale(),this.parsing=!1},d.prototype.result_do_highlight=function(a){var b,c,d,e,f;this.result_clear_highlight(),this.result_highlight=a,this.result_highlight.addClassName("highlighted"),d=parseInt(this.search_results.getStyle("maxHeight"),10),f=this.search_results.scrollTop,e=d+f,c=this.result_highlight.positionedOffset().top,b=c+this.result_highlight.getHeight();if(b>=e)return this.search_results.scrollTop=b-d>0?b-d:0;if(c<f)return this.search_results.scrollTop=c},d.prototype.result_clear_highlight=function(){return this.result_highlight&&this.result_highlight.removeClassName("highlighted"),this.result_highlight=null},d.prototype.results_show=function(){return this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field.fire("chosen:maxselected",{chosen:this}),!1):(this.container.addClassName("chosen-with-drop"),this.results_showing=!0,this.search_field.focus(),this.search_field.value=this.search_field.value,this.winnow_results(),this.form_field.fire("chosen:showing_dropdown",{chosen:this}))},d.prototype.update_results_content=function(a){return this.search_results.update(a)},d.prototype.results_hide=function(){return this.results_showing&&(this.result_clear_highlight(),this.container.removeClassName("chosen-with-drop"),this.form_field.fire("chosen:hiding_dropdown",{chosen:this})),this.results_showing=!1},d.prototype.set_tab_index=function(a){var b;if(this.form_field.tabIndex)return b=this.form_field.tabIndex,this.form_field.tabIndex=-1,this.search_field.tabIndex=b},d.prototype.set_label_behavior=function(){var a=this;this.form_field_label=this.form_field.up("label"),this.form_field_label==null&&(this.form_field_label=$$("label[for='"+this.form_field.id+"']").first());if(this.form_field_label!=null)return this.form_field_label.observe("click",function(b){return a.is_multiple?a.container_mousedown(b):a.activate_field()})},d.prototype.show_search_field_default=function(){return this.is_multiple&&this.choices_count()<1&&!this.active_field?(this.search_field.value=this.default_text,this.search_field.addClassName("default")):(this.search_field.value="",this.search_field.removeClassName("default"))},d.prototype.search_results_mouseup=function(a){var b;b=a.target.hasClassName("active-result")?a.target:a.target.up(".active-result");if(b)return this.result_highlight=b,this.result_select(a),this.search_field.focus()},d.prototype.search_results_mouseover=function(a){var b;b=a.target.hasClassName("active-result")?a.target:a.target.up(".active-result");if(b)return this.result_do_highlight(b)},d.prototype.search_results_mouseout=function(a){if(a.target.hasClassName("active-result")||a.target.up(".active-result"))return this.result_clear_highlight()},d.prototype.choice_build=function(a){var b,c,d=this;return b=(new Element("li",{"class":"search-choice"})).update("<span>"+this.choice_label(a)+"</span>"),a.disabled?b.addClassName("search-choice-disabled"):(c=new Element("a",{href:"#","class":"search-choice-close",rel:a.array_index}),c.observe("click",function(a){return d.choice_destroy_link_click(a)}),b.insert(c)),this.search_container.insert({before:b})},d.prototype.choice_destroy_link_click=function(a){a.preventDefault(),a.stopPropagation();if(!this.is_disabled)return this.choice_destroy(a.target)},d.prototype.choice_destroy=function(a){if(this.result_deselect(a.readAttribute("rel")))return this.show_search_field_default(),this.is_multiple&&this.choices_count()>0&&this.search_field.value.length<1&&this.results_hide(),a.up("li").remove(),this.search_field_scale()},d.prototype.results_reset=function(){this.reset_single_select_options(),this.form_field.options[0].selected=!0,this.single_set_selected_text(),this.show_search_field_default(),this.results_reset_cleanup(),typeof Event.simulate=="function"&&this.form_field.simulate("change");if(this.active_field)return this.results_hide()},d.prototype.results_reset_cleanup=function(){var a;this.current_selectedIndex=this.form_field.selectedIndex,a=this.selected_item.down("abbr");if(a)return a.remove()},d.prototype.result_select=function(a){var b,c;if(this.result_highlight)return b=this.result_highlight,this.result_clear_highlight(),this.is_multiple&&this.max_selected_options<=this.choices_count()?(this.form_field.fire("chosen:maxselected",{chosen:this}),!1):(this.is_multiple?b.removeClassName("active-result"):this.reset_single_select_options(),b.addClassName("result-selected"),c=this.results_data[b.getAttribute("data-option-array-index")],c.selected=!0,this.form_field.options[c.options_index].selected=!0,this.selected_option_count=null,this.is_multiple?this.choice_build(c):this.single_set_selected_text(this.choice_label(c)),(!a.metaKey&&!a.ctrlKey||!this.is_multiple)&&this.results_hide(),this.search_field.value="",typeof Event.simulate=="function"&&(this.is_multiple||this.form_field.selectedIndex!==this.current_selectedIndex)&&this.form_field.simulate("change"),this.current_selectedIndex=this.form_field.selectedIndex,a.preventDefault(),this.search_field_scale())},d.prototype.single_set_selected_text=function(a){return a==null&&(a=this.default_text),a===this.default_text?this.selected_item.addClassName("chosen-default"):(this.single_deselect_control_build(),this.selected_item.removeClassName("chosen-default")),this.selected_item.down("span").update(a)},d.prototype.result_deselect=function(a){var b;return b=this.results_data[a],this.form_field.options[b.options_index].disabled?!1:(b.selected=!1,this.form_field.options[b.options_index].selected=!1,this.selected_option_count=null,this.result_clear_highlight(),this.results_showing&&this.winnow_results(),typeof Event.simulate=="function"&&this.form_field.simulate("change"),this.search_field_scale(),!0)},d.prototype.single_deselect_control_build=function(){if(!this.allow_single_deselect)return;return this.selected_item.down("abbr")||this.selected_item.down("span").insert({after:'<abbr class="search-choice-close"></abbr>'}),this.selected_item.addClassName("chosen-single-with-deselect")},d.prototype.get_search_text=function(){return this.search_field.value.strip().escapeHTML()},d.prototype.winnow_results_set_highlight=function(){var a;this.is_multiple||(a=this.search_results.down(".result-selected.active-result")),a==null&&(a=this.search_results.down(".active-result"));if(a!=null)return this.result_do_highlight(a)},d.prototype.no_results=function(a){return this.search_results.insert(this.no_results_temp.evaluate({terms:a})),this.form_field.fire("chosen:no_results",{chosen:this})},d.prototype.no_results_clear=function(){var a,b;a=null,b=[];while(a=this.search_results.down(".no-results"))b.push(a.remove());return b},d.prototype.keydown_arrow=function(){var a;if(!this.results_showing||!this.result_highlight)return this.results_show();a=this.result_highlight.next(".active-result");if(a)return this.result_do_highlight(a)},d.prototype.keyup_arrow=function(){var a,b,c;if(!this.results_showing&&!this.is_multiple)return this.results_show();if(this.result_highlight)return c=this.result_highlight.previousSiblings(),a=this.search_results.select("li.active-result"),b=c.intersect(a),b.length?this.result_do_highlight(b.first()):(this.choices_count()>0&&this.results_hide(),this.result_clear_highlight())},d.prototype.keydown_backstroke=function(){var a;if(this.pending_backstroke)return this.choice_destroy(this.pending_backstroke.down("a")),this.clear_backstroke();a=this.search_container.siblings().last();if(a&&a.hasClassName("search-choice")&&!a.hasClassName("search-choice-disabled"))return this.pending_backstroke=a,this.pending_backstroke&&this.pending_backstroke.addClassName("search-choice-focus"),this.single_backstroke_delete?this.keydown_backstroke():this.pending_backstroke.addClassName("search-choice-focus")},d.prototype.clear_backstroke=function(){return this.pending_backstroke&&this.pending_backstroke.removeClassName("search-choice-focus"),this.pending_backstroke=null},d.prototype.keydown_checker=function(a){var b,c;b=(c=a.which)!=null?c:a.keyCode,this.search_field_scale(),b!==8&&this.pending_backstroke&&this.clear_backstroke();switch(b){case 8:this.backstroke_length=this.search_field.value.length;break;case 9:this.results_showing&&!this.is_multiple&&this.result_select(a),this.mouse_on_container=!1;break;case 13:this.results_showing&&a.preventDefault();break;case 32:this.disable_search&&a.preventDefault();break;case 38:a.preventDefault(),this.keyup_arrow();break;case 40:a.preventDefault(),this.keydown_arrow()}},d.prototype.search_field_scale=function(){var a,b,c,d,e,f,g,h,i;if(this.is_multiple){c=0,g=0,e="position:absolute; left: -1000px; top: -1000px; display:none;",f=["font-size","font-style","font-weight","font-family","line-height","text-transform","letter-spacing"];for(h=0,i=f.length;h<i;h++)d=f[h],e+=d+":"+this.search_field.getStyle(d)+";";return a=(new Element("div",{style:e})).update(this.search_field.value.escapeHTML()),document.body.appendChild(a),g=Element.measure(a,"width")+25,a.remove(),b=this.container.getWidth(),g>b-10&&(g=b-10),this.search_field.setStyle({width:g+"px"})}},d}(a)}.call(this),maxkir.Uploads={_uploaders:{},data:function(a,b){var c=maxkir.Task.data(a),d=c?c.uploads||[]:[];for(var e=0;e<d.length;e++)if(d[e].id==b)return d[e];return null},init_upload_with_img_completion:function(a,b,c){if(!this.check_pro())return;var d=this._create_uploader(a,null,b,c);if(qq.UploadHandlerXhr.isSupported()){var e=d._element.down("input[type=file]"),f=e.up(".qq-upload-button");e.focus(),e.click(),f.setStyle({width:"1px",height:"1px",visibility:"hidden",position:"absolute",overflow:"hidden"}),d._element.down(".qq-upload-cancel-link").hide()}else maxkir.info("submit via form");return d},check_pro:function(){return maxkir.is_pro?!0:(maxkir.ProSupport.ask_for_pro("You need a PRO account to attach files"),!1)},_create_uploader:function(a,b,c,d){var e=this._create_progress_list_node(a,c),f=0,g=0,h=0,i=function(a){if(g+h>=f){maxkir.Uploads.dispose(e.id);if(g>0){var b=a._options.task_id;maxkir.Task.updateTaskFromServer(b).then(function(){maxkir.notes(b).show_notes_and_select("li.upload:last",d),maxkir.TemporaryUser&&maxkir.TemporaryUser.on_pro_usage("attachments")})}}},j=this,k=new qq.FileUploader({task_id:a,element:b?b:document.createElement("div"),listElement:e.down("ul.qq-upload-list"),action:j.upload_action_str(a),template:$("_uploaderForm").innerHTML,fileTemplate:$("_uploadItem").innerHTML,sizeLimit:20971520,showMessage:function(a){new maxkir.ui.Message(a)},onComplete:function(a,b,c){maxkir.info("completed: "+a+" "+b),g++,j.process_JSON_response(c),i(k)},onCancel:function(a,b){maxkir.info("cancel: "+a+" "+b),h++,i(k)},onSubmit:function(a,b){maxkir.info("submit: "+a+" "+b),f++,setTimeout(function(){maxkir.UploadPopup.hide_popup()},20)},onProgress:function(a,b,c,d){var e=k._getItemByFileId(a);if(e){var f=e.down(".qq-file-size");f.innerHTML=k._formatSize(d);var g=(100*c/d).toFixed(1)+"%",h=e.down(".qq-progress-inner");h.setStyle({width:g}),e.down(".qq-progress-percent").innerHTML=g}}});return this._uploaders[e.id]=k,k._element.down(".qq-upload-cancel-link").on("click",function(){i(k)}),k},process_JSON_response:function(a){a&&a.rv&&maxkir.refresher&&maxkir.refresher.set_value(a.rv)},upload_action_str:function(a){return"/checklists/"+maxkir.Task.checklist_id(a)+"/tasks/"+a+"/uploads.html"},upload_dnd_files:function(a,b){if(!this.check_pro())return;if(!maxkir.Task.writable_or_assignee(a)){maxkir.Task.no_write_access_message();return}b=Array.prototype.slice.call(b);var c=this,d=0;for(var e=0;e<b.length;e++)this._is_image(b[e])&&d++;if(d>0&&maxkir.ui.Dialog){var f=d===1?I18N("js_upload_dnd_title_one"):I18N("js_upload_dnd_title");maxkir.ui.Dialog.confirm(f,"",function(d){c._upload_files(b,a,!0),d.close()},I18N("js_upload_dnd_ok"),"",function(a){},function(){},{cancelLabel:I18N("js_upload_dnd_no"),cancel:function(){c._upload_files(b,a,!1)}})}else this._upload_files(b,a,!1)},_is_image:function(a){return a.type.startsWith("image/")},_upload_files:function(a,b,c){var d=Prototype.emptyFunction;if(c){var e=this;d=function(){maxkir.notes(b).hide_notes();var c=[];for(var d=0;d<a.length;d++){var f=a[d];e._is_image(f)&&c.push(f.fileName||f.name)}maxkir.Task.update_tasks_content([b],!0,function(a){var b="";return c.forEach(function(a){b+="\n"+maxkir.UploadCompleter.createImageText({the_file_name:a.replace(/ /g,"_")},"")}),a+b})}}var f=this._create_uploader(b,null,$("core_"+b),d);f._uploadFileList(a),f.getInProgress()||this.dispose(f._element.id)},dispose:function(a){if(this._uploaders[a]){var b=this._uploaders[a]._element;this._uploaders[a].dispose(),maxkir.remove_element(b),maxkir.remove_element($(a)),delete this._uploaders[a]}maxkir.info("Upload form disposed: "+a)},_create_progress_list_node:function(a,b){b||(b=$("core_"+a));var c=$(b).next(".upload_container");c&&this.dispose(c.id);var d=b.tagName=="LI"?"li":"div";return b.insert({after:"<"+d+" class='task upload_container'><ul class='qq-upload-list'></ul></"+d+">"}),$(b.nextSibling).identify(),maxkir.info("Upload element created: "+$(b.nextSibling).id),$(b.nextSibling)},delete_uploads:function(a){var b=maxkir.cmd.task_id_from_child(a[0]),c=maxkir.Task.checklist_id(b),d=a.map(function(a){return a.startsWith("upload_")?maxkir.cmd.task_child_id("upload",a).child_id:""}).filter(function(a){return a}).join(",");b&&c&&d&&maxkir.Comments.delete_helper(b,"/checklists/"+c+"/tasks/"+b+"/uploads/"+d)},on_action:function(a,b){var c=maxkir.Uploads.data(a,b);if(c&&maxkir.UploadShared.is_img(c))maxkir.UploadPreview.show_preview(a,b);else{var d=$(maxkir.tree_nav.get_selection()).down("a.uploadLink");d&&maxkir.click_link(d)}}},maxkir.UploadsRenderer={render_uploads:function(a,b){var c=new Element("ul");c.className="attachments";var d="",e=new Template($("_attachItem").innerHTML),f=new Template($("_attachPreviewImage").innerHTML),g=new Template($("_attachPreviewFile").innerHTML),h=maxkir.Lists.data(maxkir.Task.checklist_id(a)).user_count>1,i=null,j="https:"==document.location.protocol;for(var k=0;k<b.length;k++){var l=b[k],m="";h&&this.need_user_pic(i,l)&&(i=l,m=(new Template($("_attachUserpic").innerHTML)).evaluate({gravatar_url:this.gravatar_url(l.user)}));var n=maxkir.UploadShared.is_img(l)&&l.thumb_url?f:g,o=l.upload_link?"linked":"uploaded";d+=e.evaluate(Object.extend({attachItemPreview:m+n.evaluate(l),attached_by:l.user?o+" by "+l.user.username:"",the_file_size_format:l.the_file_size>0?"("+maxkir.format_size(l.the_file_size)+")":"",updated_at_fmt:maxkir.format_time(l.the_updated_at,!0),linked_class:l.upload_link?"uploadIsLinkedURL":"",task_id:a},l))}return c.innerHTML=d,c},init_uploads_under:function(a){a.stopObserving(),a.on("mouseover","li.upload",function(a,b){b.addClassName("hovered")}),a.on("mouseout","li.upload",function(a,b){b.removeClassName("hovered")}),a.select("img.thumb").each(function(a){var b=maxkir.cmd.task_child_id("upload",a.up("li.upload").id).task_id;this.init_preview(a,a.up("li.upload").getAttribute("data-child_id"),b)}.bind(this))},init_preview:function(a,b,c){var d=a.up("li.upload").down("a.uploadLink"),e=new maxkir.TimeoutAction(500,300,function(){maxkir.UploadPreview.show_preview(c,b);var f=maxkir.UploadPreview.win.element;f.on("mouseover",e.bound_starting),f.on("mouseout",e.bound_stopping),d.observe("mouseover",e.bound_starting),d.observe("mouseout",e.bound_stopping),maxkir.UploadPreview.preview_url=a.getAttribute("data-url")},function(){maxkir.UploadPreview.preview_url==a.getAttribute("data-url")&&(maxkir.UploadPreview.hide_popup(),d.stopObserving("mouseover"),d.stopObserving("mouseout"))});a.on("mouseover",e.bound_starting),a.on("mouseout",e.bound_stopping)},need_user_pic:function(a,b){if(!b.user)return!1;if(!a)return!0;var c=5;return a.user.id!=a.user.id||(new Date(b.the_updated_at)).getTime()-(new Date(a.the_updated_at)).getTime()>c*60*1e3},gravatar_url:function(a){return maxkir.user.gravatar_url(a)}},maxkir.UploadPreview=maxkir.ui.create_popup(!1,{popup_width:50,maxImgWidth:850,maxImgHeight:650,show_preview:function(a,b){var c=$$("#upload_"+b+"_"+a+" img.thumb");if(c.length==1)return this.show_popup(c[0],{img_url:c[0].getAttribute("data-url"),className:"imgPreviewPopup",maxWidth:this.maxImgWidth,maxHeight:this.maxImgHeight}),!0},refresh:function(){var a=this.win,b=new Template("<img src='#{img_url}' class='previewImage'/>");a.getContent().update(b.evaluate({img_url:this.options.img_url})),a.getContent().setStyle({backgroundColor:"white"})},onShow:function(){var a=this,b=this.win,c=b.element.down("img.previewImage");c.setStyle({visibility:"hidden"});var d;d=c.on("load",function(){d.stop(),a.getImageDimensions(c.src).then(function(d){window.devicePixelRatio>1&&d[0]/window.devicePixelRatio<a.maxImgWidth&&d[1]/window.devicePixelRatio<a.maxImgHeight&&c.setStyle({width:d[0]/window.devicePixelRatio+"px",height:d[1]/window.devicePixelRatio+"px"}),c.getWidth()<=a.maxImgWidth&&c.getHeight()<=a.maxImgWidth?b.getContent().setStyle({overflow:"hidden"}):b.getContent().setStyle({overflow:"auto"}),b.setSize(c.getWidth(),c.getHeight()),c.setStyle({visibility:"visible"}),setTimeout(function(){b.setSize(c.getWidth(),c.getHeight()),a.fix_horizontal_position(),maxkir.scrollTo(b.getContent(),0,b.getContent().getHeight(),!0)},20)})}),this.kbd_handler=document.on("keydown",function(a){var b=function(){maxkir.UploadPreview.hide_popup();var a=maxkir.cmd.task_child_id("upload");a&&maxkir.UploadPreview.show_preview(a.task_id,a.child_id)};switch(a.keyCode){case Event.KEY_RETURN:maxkir.UploadPreview.hide_popup(),Event.stop(a);break;case Event.KEY_RIGHT:maxkir.cmd.key_right(maxkir.tree_nav.get_selection(),maxkir.tree_nav,maxkir.ChecklistNodeToggle),b(),Event.stop(a);break;case Event.KEY_LEFT:maxkir.cmd.key_left(maxkir.tree_nav.get_selection(),maxkir.tree_nav,maxkir.ChecklistNodeToggle),b(),Event.stop(a)}})},onHide:function(){this.kbd_handler&&(this.kbd_handler.stop(),this.kbd_handler=null)},getImageDimensions:function(a){var b=new Image;return new Promise(function(c,d){b.onload=function(){c([this.width,this.height])},b.src=a})}}),maxkir.UploadPopup=maxkir.ui.create_popup(!1,{show_attach:function(a){if(!maxkir.Uploads.check_pro())return;this.show_popup($("core_"+a),{task_id:a})},submit_upload_form:function(a){var b=this.options.task_id;if(!maxkir.good_url(a.file_url.value)){new maxkir.ui.Message("Looks like the URL is invalid");return}this.uploadProgressContainer().addClassName("uploading-via-url");var c=a.file_url.value,d=a.link.value=="true";if(!d)var e=this.uploader,f=qq.getUniqueId();var g=function(a,b,d){maxkir.info("Uploader callback for form "+(e?"":"without uploader")+": "+a,b,d),e&&(e["_"+a](f,c,b,d),e._options[a](f,c,b,d))};g("onSubmit");var h=function(){maxkir.notes(b).show_notes_and_select("li.upload:last")};return maxkir.Notifications&&maxkir.Notifications.enable(),new maxkir.AjaxCommand(a.action,{method:"post",parameters:Form.serialize(a),onSuccess:function(a){var c=a.responseText.evalJSON();maxkir.Uploads.process_JSON_response(c),maxkir.UploadPopup.hide_popup(),c.error?(g("onCancel"),maxkir.error(c),new maxkir.ui.Message(c.error)):maxkir.refresher&&(d&&(h(),h=Prototype.emptyFunction),maxkir.refresher.start_progress_mode(c.progress_id,function(a){return maxkir.info("Progress callback response: ",a),a===null||a=="done"?(maxkir.Task.updateTaskFromServer(b),g("onComplete",a||{}),h(),!1):a&&a.toString().indexOf("error:")==0?(maxkir.error(a),new maxkir.ui.Message("File upload problem: "+a.substr("error:".length)),g("onCancel"),!1):((a==0||a>0)&&g("onProgress",10*a,1e3),!0)}))}.bind(this)}),!1},refresh:function(){var a=this.win,b=this.options.task_id;a.setHTMLContent((new Template($("_uploadPopup").innerHTML)).evaluate({upload_action:"/checklists/"+maxkir.Task.checklist_id(b)+"/tasks/"+b+"/uploads"})),this.uploader=maxkir.Uploads._create_uploader(this.options.task_id,a.getContent().down(".uploadLocalFile"),this.uploadListAnchor()),a.updateHeight();var c=a.getContent().down("form.uploadFromUrl"),d=c.on("submit",function(a){return maxkir.UploadPopup.submit_upload_form(c),Event.stop(a),!1}),e=$("file_url"),f=e.on("focus",this._uploadButtonsUpdate),g=e.on("blur",this._uploadButtonsUpdate);a.addDisposerOnClose(function(){d.stop(),f.stop(),g.stop()}),this._uploadButtonsUpdate(),setTimeout(function(){a.getContent().down(".qq-upload-button").down("input").focus()},20)},_uploadButtonsUpdate:function(){setTimeout(function(){var a=$("file_url"),b=document.activeElement&&document.activeElement.parentNode===document.querySelector(".uploadFromUrl")||a.value;b?($("download_attach").addClassName("uibut").removeClassName("newbut"),$(document.querySelector(".qq-upload-button")).removeClassName("uibut").addClassName("newbut")):($("download_attach").removeClassName("uibut").addClassName("newbut"),$(document.querySelector(".qq-upload-button")).addClassName("uibut").removeClassName("newbut"))},10)},uploadListAnchor:function(){return $("core_"+this.options.task_id)},uploadProgressContainer:function(){return this.uploadListAnchor().next(".upload_container")},onHide:function(){var a=this.uploadProgressContainer();a&&!a.down("ul li")&&maxkir.Uploads.dispose(a.id)}}),maxkir.ImageScaler={rescale:function(a,b,c){var d=function(a,b,d,e,f){var g=e.lastIndexOf("|");return g>=0?e=e.substr(0,g)+"|"+c+"%":e=e+"|"+c+"%",a.substring(0,b)+"!["+e+"]("+f+")"+a.substring(d)};this._process_image(a,b,d)},unembed:function(a,b){var c=function(a,b,c,d,e){return a.substring(0,b)+a.substring(c)};this._process_image(a,b,c)},_process_image:function(a,b,c){var d=function(a,d){a.lastIndex=0;var e;while((e=a.exec(d))!=null){var f=e[2],g=e.index,h=e.index+e[0].length;if(f===b){var i=e[1];return c(d,g,h,i,f)}}return null};maxkir.Task.update_tasks_content([a.id],!0,function(a,b){var c;return c=d(maxkir.UploadCompleter.IMG_REG_NEW,a),c!=null?c:(c=d(maxkir.UploadCompleter.IMG_REG_OLD,a),c!=null?c:a)})}},maxkir.newCopyPaste=!maxkir.IE,maxkir.CopyGenerator=function(){var a=0,b=[],c={},d=function(a){return a.replace(/^\[([*1])?]\s*/g,"")},e=function(e,g){if(c[e.id])return"";c[e.id]=!0;var h=g+d(e.content)+"\n";b=b.concat(e.uploads||[]);if(!maxkir.NodeToggle.isCollapsed("task_"+e.id)){var i=e.tasks||[];i.forEach(function(b){a=a+1,h+=f(b,"   ".repeat(a)+"- "),a=a-1})}return h},f=function(a,b){var c=maxkir.Task.data(a);return c?e(c,b):""};return{generate_plain:function(d){var f="";return a=0,b=[],c={},d.forEach(function(a){var b=maxkir.Task.data(a);b&&(f+=e(b,""))}),f},get_uploads:function(){return b.forEach(function(a){a.url.startsWith("/")&&(a.url=document.location.origin+a.url)}),b}}},maxkir.CopyPaste={initialize:function(){if(maxkir.newCopyPaste){var a=this;maxkir.info("Initialize new copy/paste support");var b=maxkir.CopyGenerator(),c=function e(c){var d=maxkir.selectionText();if(!d){var e={operation:c.type},f=maxkir.selection.selection_pro_check();if(f.length){maxkir.tree_nav&&maxkir.tree_nav.save_selection_position();var g=maxkir.selection.task_ids_ui(),h=[];f.forEach(function(a){var b=maxkir.cmd.task_child_id("upload",a);b&&g.indexOf(b.task_id)<0&&h.push(b.child_id+"_"+b.task_id)}),e.items=g,e.upload_ids=h,e.operation==="cut"&&(a.remove_cut_mark(),a.add_cut_mark
(f));var i;e=JSON.stringify(e);try{var j;window.clipboardData&&typeof window.clipboardData.setData=="function"?(j=window.clipboardData,maxkir.info("Checkvist copy data via window: "+e)):(j=c.clipboardData,maxkir.info("Checkvist copy data via event: "+e));var k=b.generate_plain(g);i=j.setData("application/cv-json",e),j.setData("text/plain",k),j.setData("text/html",maxkir.format_for_rendering(k,maxkir.Task.checklist_id(g[0]),b.get_uploads())),maxkir.info("Checkvist copy data OK: "+i)}catch(c){localStorage.setItem("application/cv-json",e),maxkir.info("Checkvist copy data via localStorage: "+e)}c.preventDefault()}}};document.addEventListener("copy",c),document.addEventListener("cut",c);var d=function(a){var b=null;try{b=a.clipboardData.getData("application/cv-json")}catch(a){b=window.clipboardData&&window.clipboardData.getData("application/cv-json")}return b||(b=localStorage.getItem("application/cv-json"),localStorage.removeItem("application/cv-json")),b};document.body.addEventListener("paste",function(a){maxkir.set_flag("last_task_copy",null);if(maxkir.EditTracker.is_editing()||maxkir.is_focused_textfield())return;var b=a.clipboardData.getData("Text"),c=d(a);if(c){c=JSON.parse(c);var e=c.operation,f=c.items,g=c.upload_ids;a.preventDefault();var h="";if(f.length&&g.length){new maxkir.ui.Message("You have both attachments and tasks in the clipboard, cannot paste such combination");return}f.length?h="task_ids="+f.join(","):g.length&&(h="upload_ids="+g.join(",")),e==="cut"&&(h+="&move=true"),maxkir.checklist_id?maxkir.CopyPaste.paste(h):maxkir.info("Paste on non-list pages is not supported")}else if(a.clipboardData.files&&a.clipboardData.files.length){var i=maxkir.TreeProvider.tree_nav().get_selection(),j=maxkir.Task.id(i);j&&(maxkir.Uploads.upload_dnd_files(j,a.clipboardData.files),a.preventDefault())}else if(b&&b.trim()&&maxkir.checklist_id){var k=maxkir.Task.data(maxkir.Task.selected_task_id());k&&maxkir.add_task.create_task_from_content(b.trim(),k)}else maxkir.debug("non-processed paste")})}},remove_cut_mark:function(){$$(".itemWasCut").each(function(a){a.removeClassName("itemWasCut")})},add_cut_mark:function(a){a.forEach(function(a){$(a)&&(a.startsWith("task_")||a.startsWith("upload_"))&&$(a).addClassName("itemWasCut")})},copymove:function(a){var b=maxkir.selection.task_ids_ui(function(b){return a!="move"||!maxkir.Task.read_only(b)});maxkir.cmd.close_all_popups(),new maxkir.AjaxCommand("/checklists/"+maxkir.checklist_id+"/tasks/"+b[0]+"/"+a,{parameters:"task_ids="+b.join(","),onSuccess:function(){a=="move"&&(this.remove_cut_mark(),this.add_cut_mark(b.map(function(a){return"task_"+a})))}.bind(this)})},paste:function(a,b){var c=maxkir.cmd.task_id_from_child(maxkir.tree_nav.get_selection());b=b||maxkir.cmd.task_id()||c;if(!maxkir.cmd.can_run(!maxkir.Task.writable_or_assignee(c),!1))return;return a=a||"",new maxkir.AjaxCommand("/checklists/"+maxkir.Task.checklist_id(b)+"/tasks/"+b+"/paste",{evalScripts:!0,parameters:a,onFailure:function(a){a.responseText&&new maxkir.ui.Message(a.responseText)}}),!1},duplicate:function(){return maxkir.cmd.task_id()>0&&this.paste("dup=true",maxkir.cmd.task_id()),!1},extract_checklist:function(a){new maxkir.AjaxCommand("/checklists/"+maxkir.checklist_id+"/tasks/"+a+"/extract",{evalScripts:!0})},move_to_another_list:function(a){var b=new maxkir.ui.MoveTo(a);b.invoke()},move_to_list:function(a,b,c){a.name&&(maxkir.Lists.create_update_list(a.id,a.name),a=a.id),maxkir.CommandProcessor.flushDelayedQueue(),b=b||maxkir.selection.task_ids_to_write_ui();if(!b.length)return;var d="move_to="+a+"&task_ids="+b.join(",");return c&&(d=d+"&anchor="+c),this.paste(d,b[0]),!1},after_move_to:function(a,b,c){c=parseInt(c),maxkir.Task.delete_tasks_from_ui(a),a.forEach(function(a){var b=maxkir.Task.data(a);if(b){var c=maxkir.Task.data(b.parent_id);delete maxkir.TaskData[a],c&&(c.tasks=c.tasks.without(a)),maxkir.Task.updateParents("task_"+b.parent_id)}});var d=maxkir.Lists.data(b),e=d?d.name:"another list",f="",g;b===maxkir.checklist_id?(g="#",c>0&&(g+="task_"+c,f="maxkir.Task.show("+c+"); return false;")):(g="/checklists/"+b,c>0&&(g+="#task_"+c));var h="<a href='"+g+"' target='_self' onclick='"+f+"'>"+e+"</a>";a.length===1?maxkir.Undo.show_undo("Task was moved to "+h):maxkir.Undo.show_undo(a.length+" tasks were moved to "+h)}},maxkir.ui.CopyPopup=maxkir.ui.create_popup(!1,{popup_width:480,refresh:function(){var a=this.win;a.keep_on_escape=function(){return document.activeElement&&document.activeElement.type=="text"},a.setAjaxContent("/checklists/"+this.checklist_id+"/copymove.html",{method:"get",evalScripts:!0,onComplete:function(){setTimeout(function(){new Chosen($("target_checklist")),a.addDisposerOnClose(function(){maxkir.remove_element(a.getContent())})},50)}},!1)},showSingleNodeHelp:function(a){$(a).hide(),$(a).up().select(".single_node_help")[0].setStyle({display:"block"}),this.win.updateHeight()},submit_form:function(a){$("commit_copymove").value=$("remove_original")&&$("remove_original").checked?"Moving...":"Copying...",$("commit_copymove").disable(),new maxkir.AjaxCommand(a.action,{evalScripts:!0,parameters:Form.serialize(a)})}}),maxkir.ui.MoveTo=function(a){this.checklist_id=maxkir.checklist_id,this.task_ids=a,this.anchor_stack=[]},Object.extend(maxkir.ui.MoveTo.prototype,maxkir.ui.BaseChecklistPopup),Object.extend(maxkir.ui.MoveTo.prototype,{invoke:function(){this.show_popup("tsk"+this.task_ids[0],{x_shift:-4})},getListModel:function(a){return this._list_model||(this.ul_id=a,this._list_model=new maxkir.ui.ChecklistListBuilder(a)),this._list_model},right:function(a){var b=this.tree_nav.get_selection();if(!b)return;a&&Event.stop(a),b.startsWith("popup_checklist_")?(this.target_list_id=b.substr("popup_checklist_".length),this.target_anchor=0,this.setModelAccordingToTarget()):b.startsWith("popup_task_")&&(this.target_anchor=b.substr("popup_task_".length),this.setModelAccordingToTarget().catch(function(){this.target_anchor=this.anchor_stack[0]}.bind(this)))},left:function(a){a&&Event.stop(a);var b;this.anchor_stack.length>1?(b="popup_task_"+this.target_anchor,this.anchor_stack.shift(),this.target_anchor=this.anchor_stack.shift()):this.anchor_stack.length===1?(this.anchor_stack.shift(),b="popup_checklist_"+this.target_list_id,maxkir.Lists.mark_data_loaded(),this.target_list_id=0,this.target_anchor=0):(this.target_list_id=0,this.target_anchor=0),this.setModelAccordingToTarget().then(function(a){this.tree_nav.set_selection(b),this.update_scroll()}.bind(this))},on_lists_level:function(){return!this.target_list_id},setModelAccordingToTarget:function(){var a=this,b=function(b){a._list_model=b,a.updateListModel()};return this.target_list_id?new Promise(function(c,d){new maxkir.AjaxRequest("/checklists/"+a.target_list_id+"/tasks.json?parent_id="+a.target_anchor,{method:"GET",onSuccess:function(e){if(!a.tree_nav){d();return}e.responseJSON.length?(a.anchor_stack.unshift(a.target_anchor),b(new maxkir.ui.TaskListBuilder(a.ul_id,e.responseJSON)),a.list_filter.filter_field().placeholder=I18N("tasks_filter_placeholder"),a.list_filter.clear_filter(),c()):(new maxkir.ui.Message(I18N("no_subitems")),d())},onComplete:function(a){a.request.success()?c():d()}})}):(b(new maxkir.ui.ChecklistListBuilder(this.ul_id)),this.list_filter.filter_field().placeholder=I18N("lists_filter_placeholder"),Promise.resolve())},doOpen:function(a,b){b.target.classList.contains("checklistsList__deeper")?this.right():(a.id.startsWith("popup_checklist_")&&(this.target_list_id=a.id.substr("popup_checklist_".length),this.target_anchor=0,this.doMove()),a.id.startsWith("popup_task_")&&(this.target_anchor=a.id.substr("popup_task_".length),this.doMove()))},doMove:function(){this.hide_popup(),maxkir.CopyPaste.move_to_list(this.target_list_id,this.task_ids,this.target_anchor)},onRebuildList:function(){$$("#clParent li a").invoke("stopObserving"),this.updateListForMove(),maxkir.ui.BaseChecklistPopup.onRebuildList.call(this)},onShow:function(){maxkir.ui.BaseChecklistPopup.onShow.call(this),this.updateListForMove(),this.popupFilter().parentNode.insert({before:"<p class='checklistsPopupHeader'>"+I18N("move_dialog_title")+"</p>"}),this.scrollToShow(),this.activate_by_click_on_a=!0},updateListForMove:function(){var a=this.win;a.getContent().select("li.readOnly,li.specialItem").each(function(a){a.remove()}),$("clParent").addClassName("checklistsList--withNav")},onEnterWithoutMatch:function(a,b){Event.stop(a);if(!this.on_lists_level())return;this.hide_popup(),new maxkir.AjaxCommand("/checklists.json",{parameters:"checklist[name]="+encodeURIComponent(b)+"&callback=maxkir.CopyPaste.move_to_list",method:"post"})},addCreateNewList:function(){this.on_lists_level()&&maxkir.ui.BaseChecklistPopup.addCreateNewList.call(this)}}),maxkir.cmd=maxkir.cmd||{},maxkir.cmd.is_popup=function(a){var b=Windows.windows.length&&Windows.windows[0];return!b||!b.getContent()||!b.getContent().down()?!1:b.getContent().down().hasClassName(a)},maxkir.cmd.close_all_popups=function(a){maxkir.ui.Popups.hideAll(a)},maxkir.cmd.popup_visible=function(){if(!maxkir.ui||!maxkir.ui.Popups)return!1;var a=maxkir.ui.Popups.singlePopup();return a&&a.options.floating?!1:maxkir.ui.Popups.popupCount()>0},maxkir.cmd.can_run=function(a,b){return a&&maxkir.read_only?!1:maxkir.EditTracker.is_editing()?!1:maxkir.cmd.has_focused_filter()?!1:maxkir.cmd.popup_visible()?b&&(maxkir.cmd.is_popup("actionsPopupData")||maxkir.cmd.is_popup("colorPopupData")||maxkir.cmd.is_popup("introductionPopup")):!0},maxkir.cmd.task_id=function(){var a=maxkir.TreeProvider.tree_nav(),b=a&&a.selection_visible(!0),c=maxkir.add_task&&maxkir.add_task.is_adding();if(b||c){var d=maxkir.Task.selected_task_id();return d>0?d:!1}return!1},maxkir.cmd.task_id_from_child=function(a){var b=maxkir.cmd.task_child_id("note",a)||maxkir.cmd.task_child_id("upload",a);return b?b.task_id:null},maxkir.cmd.task_child_id=function(a,b){b=b||maxkir.tree_nav.get_single_selection();if(b&&b.indexOf(a)===0){var c=$(b).up("li.task");if(c)return{task_id:maxkir.Task.id(c.id),child_id:$(b).getAttribute("data-child_id")}}return null},maxkir.cmd.list=function(){var a=maxkir.cmd.task_id(),b=maxkir.Task.data(a);return b?maxkir.Lists.data(b.checklist_id):null},maxkir.cmd.isDivider=function(a){return maxkir.Task.isDivider(a)?(new maxkir.ui.Message("The operation is not applicable for list separators"),!0):!1},maxkir.cmd.task_id_to_write=function(a){if(!maxkir.cmd.can_run(!0,!0))return null;var b=maxkir.cmd.task_id();return!b&&a&&new maxkir.ui.Message(I18N("error.js_empty_selection")),b},maxkir.cmd.undo=function(){maxkir.cmd.can_run(!0,!1)&&maxkir.Undo.runUndo()},maxkir.cmd.with_task_selection_anchor=function(a){var b=maxkir.cmd.task_id();if(!maxkir.cmd.isDivider(b)){var c=b&&maxkir.TreeProvider.tree_nav().selection_visible()?$("tsk"+b):null;a(c)}},maxkir.cmd.import_items=function(a,b){if(maxkir.read_only)return;var c=maxkir.cmd.task_id();return maxkir.cmd.with_task_selection_anchor(function(d){if(maxkir.selection.error_multiple())return;maxkir.ui.ImportPopup.toggle(d||a,{task_id:c,checklist_id:maxkir.Task.checklist_id(c),align_to_right:b})}),!1},maxkir.cmd.run_import=function(a,b,c,d,e,f){new maxkir.AjaxCommand("/checklists/"+a+"/import.js",{evalScripts:!0,parameters:$H(Object.extend({import_content:d,parent_id:b,position:c},e)).toQueryString(),onComplete:f})},maxkir.cmd.export_items=function(a,b){var c=maxkir.selection.task_ids_ui();return maxkir.cmd.with_task_selection_anchor(function(d){maxkir.ui.ExportPopup.toggle(d||a||$("moreActionsLink"),{task_ids:c,checklist_id:maxkir.Task.checklist_id(c[0]),align_to_right:b})}),!1},maxkir.cmd.attach_file=function(){var a=maxkir.cmd.task_id_from_child();a||(a=maxkir.selection.task_id_non_divider_ui("error.js_attach_multiple_selection"));if(!maxkir.Task.writable_or_assignee(a))return;return a&&maxkir.UploadPopup.show_attach(a),!1},maxkir.cmd.view_actions=function(a,b){a?maxkir.read_only||maxkir.ui.ActionsPopup.toggle_popup(a,null,b):maxkir.cmd.with_task_selection_anchor(function(a){a&&!maxkir.read_only?maxkir.ui.ActionsPopup.toggle_popup(a,null,b):maxkir.ui.ListActionsPopup.toggle_popup($("moreActionsLink"),maxkir.checklist_id,!0)})},maxkir.cmd.view_deleted=function(){maxkir.DeletedTasks.show_dialog(maxkir.checklist_id)},maxkir.cmd.view_expand_collapse=function(){maxkir.ui.ExpandPopup.toggle_popup($("expandCollapseLink"),maxkir.checklist_id,!0)},maxkir.cmd.expand_branch=function(){var a=maxkir.tree_nav.get_selection();if(!a){new maxkir.ui.Message("Please select an item with sub-items");return}maxkir.ChecklistNodeToggle.expand_branch(a),maxkir.cmd.close_all_popups()},maxkir.cmd.collapse_branch=function(){var a=maxkir.tree_nav.get_selection();if(!a){new maxkir.ui.Message("Please select an item with sub-items");return}maxkir.ChecklistNodeToggle.collapse_branch(a),maxkir.cmd.close_all_popups()},maxkir.cmd.sort_by=function(a,b){if(maxkir.read_only)return;maxkir.checklist.Sorter.resort_by(a,b),maxkir.ui.ListSortPopup.hide_popup()},maxkir.cmd.set_tags=function(a){var b=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!b.length)return;maxkir.Tags.set_tags(b,a)},maxkir.cmd.delete_tags=function(){var a=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!a.length)return;var b=maxkir.task_child(maxkir.Task.selected_task_id(),".tag");maxkir.ui.DeleteTagPopup.show_popup(b,{task_ids:a})},maxkir.cmd.view_tags=function(){if(maxkir.read_only)return;if(maxkir.invoke_list_tags_popup(maxkir.TreeProvider.tree_nav().get_all_selection()))return;var a=maxkir.cmd.task_id_from_child(),b=a?[a]:maxkir.selection.task_ids_to_write_non_dividers_ui();if(!b.length)return;a=b[0];var c=maxkir.task_child(maxkir.Task.selected_task_id(),".tag"),d={tag:"",tags:b.length>1?{}:maxkir.Task.tags(a),set_tags_call:function(a){maxkir.Tags.set_tags(b,a)}};maxkir.ui.TTagsPopup.show_popup(c,d)},maxkir.task_child=function(a,b){return $("task_"+a).down(".coreDiv").down(b)||$("tsk"+a)},maxkir.cmd.add_task=function(a){if(!maxkir.cmd.can_run(!0,!1)||!maxkir.add_task)return!1;maxkir.cmd.close_all_popups(),maxkir.CommandProcessor.flushDelayedQueue();var b=maxkir.tree_nav.get_selection();if(!$(b)||!$(b).up("ul"))return maxkir.add_task.show_add(0,0),maxkir.add_task.is_adding();var c=$(b).up("ul").id.substr("parentTask_".length);if(a){var d=maxkir.tree_nav.getPrev(b,!1);maxkir.add_task.show_add(c,b==d||b==maxkir.tree_model.getFirstNode()?0:maxkir.Task.id(d))}else maxkir.add_task.show_add(c,maxkir.Task.id_str(b));return maxkir.add_task.is_adding()},maxkir.cmd.add_subtask=function(){var a=maxkir.cmd.task_id_to_write();if(!a)return;maxkir.cmd.close_all_popups(),maxkir.Task.isDivider(a)?maxkir.cmd.add_task():maxkir.add_task.change_parent(a)},maxkir.cmd.complete_reopen_task=function(){var a=maxkir.selection.task_ids_to_write_or_assigned_ui();if(!a.length)return!1;var b=!1;a.forEach(function(a){!maxkir.tree_model.isLeaf("task_"+a)&&maxkir.ChecklistNodeToggle.isCollapsed("task_"+a)&&(maxkir.ChecklistNodeToggle.expand(a),b=!0)});if(b)return!0;var c=$("tsk"+a[0]).hasClassName("task_closed")||$("tsk"+a[0]).hasClassName("task_invalidated")?"reopen":"close";return maxkir.Task.set_task_status(maxkir.checklist_id,a,c),!0},maxkir.cmd.invalidate_task=function(){var a=maxkir.selection.task_ids_to_write_or_assigned_ui();if(!a.length)return;maxkir.Task.set_task_status(maxkir.checklist_id,a,"invalidate")},maxkir.cmd.edit_task_or_note=function(){var a=maxkir.cmd.task_child_id("note");if(a){maxkir.notes(a.task_id).edit_comment(a.child_id);return}var b=maxkir.selection.task_ids();b.length?b.length==1?(maxkir.cmd.close_all_popups(),maxkir.Task.edit_task(b[0])):new maxkir.ui.Message(I18N("error.edit_multiple_selection")):(maxkir.cmd.close_all_popups(),maxkir.cmd.edit_title()||maxkir.Task.no_write_access_message())},maxkir.cmd.add_task_or_note=function(a){var b=maxkir.cmd.task_child_id("note");if(b){maxkir.notes(b.task_id).show_add_note(),a&&Event.stop(a);return}var c=maxkir.cmd.task_child_id("upload");if(c){maxkir.Uploads.on_action(c.task_id,c.child_id),a&&Event.stop(a);return}maxkir.cmd.add_task()&&a&&Event.stop(a)},maxkir.cmd.visit_first_link=function(){var a=maxkir.tree_nav.get_selection();$(a)&&($(a).down(".userContent")?a=$(a).down(".userContent"):$(a).down(".uploadLink")&&(a=$(a).down(".uploadLink"))),$(a)&&maxkir.click_link($(a))},maxkir.cmd.delete_selected=function(a){if(this.delete_disabled)return;this.key_up_monitor_installed||(this.key_up_monitor_installed=Event.observe(document,"keyup",function(){this.delete_disabled=!1}.bind(this))),a&&a.type.startsWith("key")&&(this.delete_disabled=!0);var b=maxkir.cmd.task_child_id("note");if(b){Event.stop(a),maxkir.notes(b.task_id).delete_comment(b.child_id);return}var c=maxkir.selection.selection_pro_check();if(c.every(function(a){return a.startsWith("upload_")})){Event.stop(a),maxkir.Uploads.delete_uploads(c);return}var d=maxkir.selection.task_ids_to_write_ui();if(!d.length)return;Event.stop(a),maxkir.Task.delete_tasks(maxkir.checklist_id,d)},maxkir.cmd.list_actions=function(){maxkir.ui.ListActionsPopup.toggle_popup($("moreActionsLink"),maxkir.checklist_id,!0)},maxkir.cmd.reset=function(){maxkir.cmd.whole_list_or_context_command("reset")},maxkir.cmd.wipe_closed=function(){maxkir.cmd.whole_list_or_context_command("wipe")},maxkir.cmd.whole_list_or_context_command=function(a){var b=maxkir.cmd.task_id();if(b&&maxkir.Task.read_only(b))return;if(maxkir.selection.error_multiple())return;maxkir.cmd.close_all_popups(),new maxkir.AjaxCommand("/checklists/"+maxkir.checklist_id+"/"+a+".js",{parameters:"parent_id="+b,method:"post"})},maxkir.cmd.view_add_note=function(){var a=maxkir.cmd.task_id_from_child();a||(a=maxkir.selection.task_id_non_divider_ui("error.js_note_multiple_selection")),a>0&&(maxkir.cmd.close_all_popups(),maxkir.notes(a).show_add_note())},maxkir.cmd.clear_notes=function(){var a=maxkir.selection.task_id_non_divider_ui("error.js_note_multiple_selection_remove");if(!a)return;maxkir.notes(a).clear_notes()},maxkir.cmd.view_add_due=function(){var a=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!a.length)return;maxkir.cmd.show_due_popup(a,maxkir.Task.selected_task_id())},maxkir.cmd.view_add_due_repeat=function(){if(!maxkir.is_pro){maxkir.ProSupport.ask_for_pro("You need a PRO account to use repeating tasks");return}var a=maxkir.selection.task_id_non_divider_ui();if(!a)return;maxkir.cmd.close_all_popups(),maxkir.ui.RepeatingDuePopup.toggle(maxkir.cmd.due_element(a),{task_id:a})},maxkir.cmd.due_element=function(a){var b=$("dd"+a);return b||(b=$("tsk"+a)),b},maxkir.cmd.show_due_popup=function(a,b){maxkir.ui.DuePopup.toggle(maxkir.cmd.due_element(b),{task_ids:a})},maxkir.cmd.set_due=function(a){var b=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!b.length)return;maxkir.Due.set_due(b,maxkir.Task.checklist_id(b[0]),a)},maxkir.cmd.set_assignee=function(a){if(!maxkir.is_pro||maxkir.temporary)return;var b=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!b.length)return;maxkir.Task.set_assignee(b,a||"")},maxkir.cmd.assign_user=function(){var a=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!a.length)return;if(maxkir.temporary)return;if(!maxkir.is_pro){maxkir.ProSupport.ask_for_pro("You need a PRO account to assign tasks");return}var b=maxkir.task_child(maxkir.Task.selected_task_id(),"a.assignee");maxkir.ui.AssigneePopup.show_popup(b,{task_ids:a})},maxkir.cmd.extract_checklist=function(){var a=maxkir.selection.task_id_non_divider_ui();if(!a)return;if(maxkir.Task.is_leaf(a)){new maxkir.ui.Message("Please select an item with sub-items");return}maxkir.cmd.close_all_popups(),maxkir.CopyPaste.extract_checklist(a)},maxkir.cmd.toggle_markdown_header=function(a){var b=function(a){var b="";for(var c=0;c<a;c++)b+="#";return b},c=function(a,c){var d=maxkir.cmd._extract_smart_prefix(a);a=d[0];var e=d[1];if(/^\s*#/.match(a))return e+a.replace(/^\s*#+\s*([^\n]+?)\s*#*\s*(\n|$)/,"$1$2");var f=maxkir.UserPrefs&&maxkir.UserPrefs.default_markdown_header_level||2,g=b(f),h=0;while(c&&c.parent_id>0&&c.id!=maxkir.TaskFocus.focusedTaskId()&&g!="######"){h++,c=maxkir.Task.data(c.parent_id);if(c&&c.content){var i=maxkir.cmd._extract_smart_prefix(c.content)[0],j=i.match(/^#+/);if(j&&j[0].length<6){h=0,g=b(j[0].length+1);break}}}return g+=b(h),e+g+" "+a};maxkir.cmd._update_task_content(a,c)},maxkir.cmd._extract_smart_prefix=function(a,b){var c=(b?/^(\[(1|\*)?\]\s*)?(#{0,6}\s?)?/:/^\[(1|\*)?\]\s*/).exec(a),d="";return c&&(d=c[0],a=a.substr(d.length)),[a,d]},maxkir.cmd.toggle_markup=function(a,b,c){var d=function(c){return c.length>2&&a=="*"&&b=="*"&&c[1]=="*"&&c[c.length-1]=="*"&&c[2]!="*"},e=function(c,e){var f=c.trim().split("\n"),g=f[0].trim(),h=maxkir.cmd._extract_smart_prefix(g,a.indexOf("#")===-1);g=h[0];var i=h[1];return a!=""&&g.indexOf(a)>1?(maxkir.debug("Line "+g+" contains "+a+" inside, do not toggle markup"),c):b!=""&&g.indexOf(b)>0&&g.indexOf(b)<g.length-b.length-1?(maxkir.debug("Line "+g+" contains "+b+" inside, do not toggle markup"),c):g.startsWith(a)&&g.endsWith(b)&&!d(g)?(f[0]=g.substring(a.length,g.length-b.length),i+f.join("\n")):(f[0]=a+g+b,i+f.join("\n"))};maxkir.cmd._update_task_content(c,e)},maxkir.cmd._update_task_content=function(a,b){var c=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!c.length)return;maxkir.Task.update_tasks_content(c,a,b)},maxkir.cmd.move_to_another_list=function(){var a=maxkir.selection.task_ids_to_write_ui();if(!a.length)return;maxkir.CopyPaste.move_to_another_list(a)},maxkir.cmd.apply_order=function(){maxkir.checklist&&maxkir.checklist.Dnd?maxkir.checklist.Dnd.updateStructure():maxkir.error("Cannot apply new order to server")},maxkir.cmd.move_left=function(){var a=maxkir.tree_model;if(maxkir.add_task&&maxkir.add_task.is_adding()){var b=$F("task_parent_id");if(b<=0)return;var c=a.getParent("task_"+b),d=c==null?0:maxkir.Task.id(c);maxkir.add_task.change_parent(d,b);return}var e=maxkir.selection.task_ids_to_write_same_level_ui().reverse();if(!e.length)return;for(var f=0;f<e.length;f++){var g=e[f],h=$("task_"+g),i=a.getParent(h.id);if(i==null||i==a.getRoot())continue;Element.cleanWhitespace($(i).parentNode),Element.remove(h),$(i).nextSibling?$(i).parentNode.insertBefore(h,$(i).nextSibling):$(i).parentNode.appendChild(h)}maxkir.cmd.apply_order()},maxkir.cmd.move_right=function(){if(maxkir.add_task&&maxkir.add_task.is_adding()){var a=maxkir.add_task.insert_after,b=a;maxkir.ChecklistNodeToggle.expand(b);if(b<=0)return;var c=maxkir.tree_model.getNodes("task_"+a,!0),d=c.length==0?0:maxkir.Task.id(c[c.length-1]);maxkir.add_task.change_parent(b,d);return}var e=maxkir.selection.task_ids_to_write_same_level_ui();if(!e.length)return;var f=maxkir.ChecklistNodeToggle,g={};for(var h=0;h<e.length;h++){var i=e[h],j=$("task_"+i);if(maxkir.tree_nav.is_first_node("task_"+i))return;var k=maxkir.tree_nav.getPrev("task_"+i),l=maxkir.Task.id(k);if(l>0&&$("parentTask_"+l)&&l!=i)Element.remove(j),f&&f.expand(l),$("parentTask_"+l).appendChild(j),g[l]=!0;else return}f&&Object.keys(g).forEach(function(a){f.isCollapsed("task_"+a)&&(f.collapse_deep("task_"+a),f.expand(a))}),maxkir.cmd.apply_order()},maxkir.cmd.move_up_crawl=function(){var a=!1;maxkir.cmd.move(function(b){if(a)return null;if(maxkir.tree_nav.is_first_node(b.id))return a=!0,null;var c=b.id,d=maxkir.tree_nav.getPrev(b.id,!0);while(d){if(maxkir.cmd._is_good_node_for_move(d))return maxkir.tree_nav.is_last_child(d)&&d!==maxkir.tree_model.getParent(c)?{placement:"after",anchor:d}:{placement:"before",anchor:d};c=d,d=maxkir.tree_nav.getPrev(d,!0)}return a=!0,null})},maxkir.cmd.move_down_crawl=function(){var a=function(a){var b=$(a).down("ul.dndUl"),c=!1;b&&!b.hasClassName("hidden")&&(b.addClassName("hidden"),c=!0);var d=maxkir.tree_nav.getNext(a,!0);return c&&b.removeClassName("hidden"),d},b=!1;maxkir.cmd.move(function(c){if(b)return null;var d=maxkir.tree_model.getParent(c.id),e=maxkir.tree_nav.is_last_child(c.id);if(e)return d==maxkir.tree_model.getRoot()?(b=!0,null):{placement:"after",anchor:d};if(maxkir.tree_nav.is_last_node(c.id))return b=!0,null;var f=a(c.id);while(f){if(maxkir.tree_nav.is_first_node(f))return b=!0,null;if(maxkir.cmd._is_good_node_for_move(f))return!maxkir.tree_model.isLeaf(f)&&maxkir.cmd._is_good_parent(f)?{placement:"top",anchor:$(f).down("ul.dndUl")}:{placement:"after",anchor:f};f=a(f)}return b=!0,null},!0)},maxkir.cmd.move_home=function(){maxkir.tree_nav.save_selection_position(),maxkir.cmd.move(function(a){return a.id==maxkir.tree_model.getFirstNode()?null:{placement:"before",anchor:maxkir.tree_model.getFirstNode()}},!0)},maxkir.cmd.move_end=function(){maxkir.tree_nav.save_selection_position(),maxkir.cmd.move(function(){var a=maxkir.tree_model.getRoot(),b=maxkir.tree_model.getNodes(a,!1);return b.length>0?{placement:"after",anchor:b[b.length-1]}:null})},maxkir.cmd.move_top=function(){var a=maxkir.selection.task_ids_to_write_same_level_ui();if(!a.length)return;var b="task_"+a[0];if(b==maxkir.tree_model.getFirstNode())return null;maxkir.tree_nav.save_selection_position();var c=maxkir.tree_model.getParent(b),d=b!==maxkir.tree_model.getNodes(c)[0];maxkir.cmd.move(function(a){var b=maxkir.tree_model.getParent(a.id);return a.id==maxkir.tree_model.getNodes(b)[0]?null:(b!=maxkir.tree_model.getRoot()&&(b=$(b).down("ul.dndUl")),{placement:"top",anchor:b})},d)},maxkir.cmd.move_bottom=function(){maxkir.tree_nav.save_selection_position(),maxkir.cmd.move(function(a){var b=maxkir.tree_model.getParent(a.id),c=maxkir.tree_model.getNodes(b,!1);return c.length>0?{placement:"after",anchor:c[c.length-1]}:null})},maxkir.cmd.move_up_jump=function(){var a=!1;maxkir.cmd.move(function(b){if(a)return null;var c=maxkir.tree_nav.getPrevSibling(b.id);if(c&&c.indexOf("task_")==0)return{placement:"before",anchor:c};var d=maxkir.cmd._get_deep_sibling_jump(b,"getPrevSibling",!0);return d?{placement:"bottom",anchor:$(d).down("ul.dndUl")}:(a=!0,null)})},maxkir.cmd.move_down_jump=function(){var a=!1;maxkir.cmd.move(function(b){if(a)return null;var c=maxkir.tree_nav.getNextSibling(b.id);if(c)return{placement:"after",anchor:c};var d=maxkir.cmd._get_deep_sibling_jump(b,"getNextSibling");return d?{placement:"top",anchor:$(d).down("ul.dndUl")}:(a=!0,null)},!0)},maxkir.cmd._get_deep_sibling_jump=function(a,b,c){var d=maxkir.tree_model,e=function(a){return d.getLevel(a)+1},f=function(b){var c=h(b,e(a.id)-1);return c&&maxkir.cmd._is_good_parent(c)},g=function(a){maxkir.debug("find_parent_sibling:"+a);var c=a;while(c!=null){var e=maxkir.tree_nav[b](c);maxkir.debug(e);while(e&&(!maxkir.cmd._is_good_parent(e)||!f(e)))e=maxkir.tree_nav[b](e),maxkir.debug(e);if(e!=null)return maxkir.debug("found_parent_sibling: "+e),e;c=d.getParent(c)}return null},h=function(a,f){maxkir.debug("go_down_till_level:"+a);while(d.getNodes(a).length>0&&e(a)!=f){var g=d.getNodes(a);a=g[c?g.length-1:0],maxkir.debug(a);while(a&&!maxkir.cmd._is_good_parent(a))a=maxkir.tree_nav[b](a),maxkir.debug(a)}return maxkir.debug("go_down_till_level return:"+a),a},i=g(d.getParent(a.id));return h(i,e(a.id)-1)},maxkir.cmd._is_good_parent=function(a){return maxkir.cmd._is_good_node_for_move(a)?maxkir.checklist&&maxkir.ChecklistNodeToggle?!maxkir.ChecklistNodeToggle.isCollapsed(a):a:!1},maxkir.cmd._is_good_node_for_move=function(a){return a&&a.indexOf("task_")!==-1},maxkir.cmd.move=function(a,b){var c=maxkir.selection.task_ids_to_write_ui_no_children();if(!c.length)return;b&&(c=c.reverse()),c.forEach(function(b){var c=$("task_"+b);if(!c)return;var d=a(c),e=d?$(d.anchor):null;if(!e||e.id==c.id)return;c.remove();var f={};f[d.placement]=c,e.insert(f)}),maxkir.tree_nav.fix_scrolling(),maxkir.cmd.apply_order()},maxkir.cmd.toggle_progress_counter=function(){var a=maxkir.selection.task_ids_to_write_non_dividers_ui();a.length?maxkir.ProgressCounter.toggle_progress_counter(a):maxkir.ProgressCounter.toggle_progress_counter_list(maxkir.checklist_id)},maxkir.cmd.paint_color=function(a){var b=maxkir.selection.task_ids_to_write_non_dividers_ui();if(!b.length)return;maxkir.cmd.set_task_color(b,a)},maxkir.cmd.set_task_color=function(a,b){maxkir.Task.Colorer.paint_by_index(a,b)},maxkir.cmd.toggle_hide_completed=function(a){maxkir.checklist.HideCompleted&&(maxkir.checklist.HideCompleted.toggle_hide(a),$("hide_completed")&&($("hide_completed").checked=maxkir.checklist.HideCompleted.is_hide()))},maxkir.cmd.toggle_show_details=function(){maxkir.DetailsMode.toggle(),$("show_details")&&($("show_details").checked=maxkir.DetailsMode.on())},maxkir.cmd.toggle_show_context=function(){maxkir.ShowContextOption.toggle(),$("show_context")&&($("show_context").checked=maxkir.ShowContextOption.on())},maxkir.cmd.edit_title=function(){return!maxkir.read_only&&maxkir.checklist.name_editor?maxkir.TaskFocus&&maxkir.TaskFocus.is_active()?!0:(setTimeout(function(){maxkir.checklist.name_editor.enterEditMode()},10),!0):!1},maxkir.cmd.toggle_focus=function(){var a=maxkir.cmd.task_id_from_child();return a||(a=maxkir.cmd.task_id()),a?maxkir.TaskFocus.toggle_focus(a):(new maxkir.ui.Message("Please select a list item"),!1)},maxkir.cmd.toggle_focus_toolbar=function(){maxkir.TaskFocus.is_active()?maxkir.TaskFocus.remove_focus(!0):maxkir.cmd.toggle_focus()},maxkir.cmd.is_upload=function(a,b){return b||(b=a.get_selection()),b&&b.indexOf("upload")==0},maxkir.cmd.key_down=function(a,b){var c=this.is_upload(b,a),d=b.key_down(a);while(d&&c&&this.is_upload(b))d=b.key_down(b.get_selection());return d},maxkir.cmd.key_up=function(a,b){var c=this.is_upload(b,a),d=b.key_up(a);return d&&this.is_upload(b)&&(c?b.key_left(b.get_selection()):b.set_selection(b.getSiblings(b.get_selection())[0])),d},maxkir.TreeSelectionHandler=function(a){var b=function(){return a||maxkir.TreeProvider.tree_nav()},c=function(){return b()&&b().selection_visible()},d=function(a){var b=[];a.length&&b.push(a[0]);var c=$("task_"+a[0]);for(var d=0;d<a.length-1;d++)c.contains($("task_"+a[d+1]))||(b.push(a[d+1]),c=$("task_"+a[d+1]));return b};return{task_ids_to_write_ui_no_children:function(){var a=this.task_ids_to_write_ui();return d(a)},task_ids_to_write_same_level_ui:function(){var a=this.task_ids_to_write_ui_no_children();if(a.length>0){var b=maxkir.TreeProvider.tree_model(),c=b.getLevel("task_"+a[0]);a.some(function(a){return c!=b.getLevel("task_"+a)})&&(maxkir.info("Some node has different parent than all others - return empty selection"),maxkir.ui&&new maxkir.ui.Message(I18N("error.js_move_different_levels")),a=[])}return a},task_ids_to_write_or_assigned_ui:function(){var a=this.task_ids(function(a){return maxkir.Task.writable_or_assignee(a)});return this.pro_ok(a)||(a=[]),a},task_ids_to_write_ui:function(){var a=this.task_ids(function(a){return!maxkir.Task.read_only(a)});return this.pro_ok(a)||(a=[]),a},task_ids_to_write_non_dividers_ui:function(){var a=this.task_ids(function(a){return!maxkir.Task.read_only(a)});return a.length==0?(b().selection_visible()&&maxkir.Task.no_write_access_message(),[]):(a=a.filter(function(a){return!maxkir.Task.isDivider(a)},!0),a.length==0?(new maxkir.ui.Message(I18N("error.need_non_separator_selection")),[]):this.pro_ok(a)?a:[])},task_id_non_divider_ui:function(a){var b=this.task_ids();if(b.length>1)return a||(a="error.js_not_supported_multiple"),new maxkir.ui.Message(I18N(a)),null;if(!b.length)return new maxkir.ui.Message(I18N("error.js_empty_selection")),null;var c=b[0];return maxkir.cmd.isDivider(c)?null:c},task_ids_ui:function(a){var b=this.task_ids(a);return this.pro_ok(b)||(b=[]),b},selection_pro_check:function(){if(!c())return[];var a=b().get_all_selection(),d=[];return a.forEach(function(a){d.push(a)}),this.pro_ok(d)||(d=[]),d},task_ids:function(a){return maxkir.cmd.can_run(!1,!0)?this.task_ids_no_can_run_check(a):[]},task_ids_no_can_run_check:function(a){if(!c())return[];var d=b().get_all_selection_ordered(),e=[];return d.forEach(function(b){var c=maxkir.Task.id(b);c>0&&(!a||a(c))&&e.push(c)}),e.length?e:[]},error_multiple:function(){return this.task_ids().length>1?(new maxkir.ui.Message(I18N("error.js_not_supported_multiple")),!0):!1},pro_ok:function(a){if(a.length>1)if(maxkir.is_pro)maxkir.TemporaryUser&&maxkir.TemporaryUser.on_pro_usage("multiple selection");else return maxkir.ProSupport.ask_for_pro("You need a PRO account to use multiple selection"),!1;return!0}}},maxkir.selection=maxkir.TreeSelectionHandler(null),maxkir.cmd=maxkir.cmd||{},maxkir.cmd.word_count=function(){maxkir.WordCountPopup.show_popup()},maxkir.WordCountPopup=maxkir.ui.create_popup(!1,{popup_width:null,recenterAuto:!0,with_children:!0,refresh:function(){var a=new Template($("wordCountPopup").innerHTML),b=this.calc_stats(".topLevel .userContent"),c=this.calc_stats(this.with_children?"li.selectedTask .userContent":"div.selectedTask .userContent");this.win.setHTMLContent(a.evaluate({"js-wc":b[0],"js-cc":b[1],"js-cc-space":b[2],"js-wc-sel":c[0],"js-cc-sel":c[1],"js-cc-space-sel":c[2],with_children_checked:this.with_children?"checked":""}))},toggle_children
:function(){this.with_children=!this.with_children,this.refresh()},calc_stats:function(a){var b=0,c=0,d=0;return $$(a).each(function(a){var e=a.innerHTML.stripTags().trim();b+=e.split(/[^\u00BF-\u1FFF\u2C00-\uD7FF\w]+/).without("").length,c+=e.replace(/\s+/g,"").length,d+=e.length}),[b,c,d]},f_:null}),maxkir.form_state=function(a){var a=maxkir.$(a),b=a.id||a.getAttribute("data-state-id"),c="form_state_"+b;return{save_state:function(){var b={},d=a.elements;for(var e=0;e<d.length;e++)if(maxkir.hasClassName(d[e],"remember_state")){var f=d[e];f.type.toLowerCase()=="checkbox"?b[f.name]=f.checked:f.type.toLowerCase()=="radio"?f.checked&&(b[f.name]=f.value):b[d[e].name]=f.value}localStorage.setItem(c,JSON.stringify(b))},restore_state:function(){var b=localStorage.getItem(c);if(b){var d=JSON.parse(b);maxkir.debug(d);for(var e in d)if(d.hasOwnProperty(e)){var f=a.elements[e];if(!f)continue;if(f.length){f.value=d[e];for(var g=0;g<f.length;g++)f[g].checked=f[g].value==d[e]}else f.type.toLowerCase()=="checkbox"?f.checked=d[e]:typeof f.value!="undefined"&&(f.value=d[e])}}},clear_state:function(){localStorage.removeItem(c)}}},maxkir.create_text_wrapper=function(a){var b=function(b,c,d){var e=a.value;this._head=e.substring(0,d[0]),this._middle=e.substring(d[0],d[1]),this._tail=e.substring(d[1]),console.info(this._head+"|"+this._middle+"|"+this._tail);var f=function(a,b,c){return a.startsWith(b)&&a.endsWith(c)&&a.length>=b.length+c.length};this.wrapping_bold_with_italic=function(a){return b!=="*"||c!=="*"?!1:this._head.endsWith("**")&&this._tail.startsWith("**")&&!this._head.endsWith("***")?!0:f(this._middle,"**","**")&&!f(this._middle,"***","***")&&!this._head.endsWith("*")&&!this._tail.startsWith("*")?!0:!1},this.wrap=function(){a.value=this._head+b+this._middle+c+this._tail,maxkir.set_selection(a,d[0]+b.length,d[0]+b.length+this._middle.length)};var g=function(){return this._head.endsWith(b)&&this._tail.startsWith(c)?(this._start_index=d[0]-b.length,this._end_index=d[1],!0):f(this._middle,b,c)?(this._start_index=d[0],this._end_index=d[1]-c.length,!0):!1}.bind(this);this.can_wrap=function(){return this._middle.indexOf(b)<0&&this._middle.indexOf(c)<0},this.unwrap=function(){return g()?(a.value=e.substring(0,this._start_index)+e.substring(this._start_index+b.length,this._end_index)+e.substring(this._end_index+c.length),maxkir.set_selection(a,this._start_index,this._end_index-b.length),!0):!1},this.run_wrap=function(){(this.wrapping_bold_with_italic(this._middle)||!this.unwrap()&&this.can_wrap())&&this.wrap()}};return{toggle_wrap:function(c,d){maxkir.select_word_under_cursor(a);var e=maxkir.get_selection_range(a);e[1]>e[0]&&a.value.charAt(e[1]-1)===" "&&(e[1]-=1);var f=new b(c,d,e);f.run_wrap()}}},maxkir.ui.EditorShortcuts=function(a,b){var c=maxkir.create_text_wrapper(a),d=new maxkir.KbdManager(a),e=function(){return maxkir.Lists.data(b).markdown()};return d.addShortcut(maxkir.meta_or_ctrl()+"B",function(){e()?c.toggle_wrap("**","**"):c.toggle_wrap("<b>","</b>")}).addShortcut(maxkir.meta_or_ctrl()+"I",function(){e()?c.toggle_wrap("*","*"):c.toggle_wrap("<em>","</em>")}).addShortcut(maxkir.meta_or_ctrl()+"K",function(){maxkir.activate_link_wrapper(a,e())}),{dispose:function(){d.dispose(),d=null,c=null}}},maxkir.activate_link_wrapper=function(a,b){maxkir.select_word_under_cursor(a,!0);var c=maxkir.get_selection_range(a),d=/\[link:[^\]]*\]?$/.exec(a.value.substr(0,c[1]));d?maxkir.ui.LinkTo.invoke_on_match(a,d):maxkir.ui.LinkTo.invoke(a,a.value.substring(c[0],c[1]),"","Add link",c)},maxkir.checklist=maxkir.checklist||{},maxkir.checklist.refresh=function(a){maxkir.info("DO FULL REFRESH");var b=(new Date).getTime();return maxkir.refresher&&maxkir.refresher.reset_refresh(),maxkir.checklist.refresh_topbar().then(function(){return maxkir.checklist.refresh_tree()}).then(function(){maxkir.info("FULL REFRESH DONE: "+((new Date).getTime()-b)+" msec")})},maxkir.checklist.refresh_tree=function(a,b){return new Promise(function(c,d){a=a||"",new maxkir.AjaxRequest("/checklists/"+maxkir.checklist_id,{parameters:"partial=list_data"+a,method:"get",onSuccess:function(a){!maxkir.EditTracker.is_editing()||b?(maxkir.tree_nav.keep_scrolling_once=!0,a.responseText.evalScripts(),maxkir.cmd.refresh_filter(),c()):(maxkir.info("POSTPONE tree refresh - we're editing the data"),maxkir.refresher.mark_for_refresh())},onComplete:d})})},maxkir.checklist.refresh_topbar=function(){return new Promise(function(a,b){new maxkir.AjaxUpdater("js-topbar","/checklists/"+maxkir.checklist_id,{parameters:"partial=update_topbar",method:"get",evalScripts:!0,onFailure:b,onComplete:a})})},maxkir.checklist.resort_children_of=function(a){maxkir.Jobs.add_job("resort"+a,function(){return!maxkir.add_task.is_adding()&&maxkir.CommandProcessor.is_empty()},function(){$(a)&&maxkir.Task.sort_tasks_under($(a))})},maxkir.add_checklist={do_add:function(){var a=$$(".popupFilter"),b=a.length==1?a[0].value.trim():"";new maxkir.AjaxRequest("/checklists.json?callback=maxkir.add_checklist.on_create",{parameters:"checklist[name]="+encodeURIComponent(b)})},on_create:function(a){document.location.href="/checklists/"+a.id+"#newList"}},maxkir.checklist.delete_checklist=function(a,b){maxkir.ui.Dialog.confirm(b+"?","<p style='text-align: center;'>Are you sure you want to "+b.toLowerCase().replace(" "," the ")+"?</p>",function(){"use strict",maxkir.checklist.archive_checklist(a,!0,"delete")},b.split(" ")[0])},maxkir.checklist.archive_checklist=function(a,b,c){b&&maxkir.Lists.remove_list(a),c||(c="post"),new maxkir.AjaxCommand("/checklists/"+(b?"archive":"unarchive")+".html",{method:c,parameters:"checklists_set[]="+a,onComplete:function(a){if(!a.request.success())return;setTimeout(function(){b&&c!="delete"?document.location.href="/checklists#archive":document.location.href="/checklists"},20)}})},maxkir.checklist.get_permalink=function(){maxkir.ui.Dialog.confirm(I18N("permalink_dialog_title"),"<input id='permalinkInDialog'>","",I18N("permalink_button_copy"),$("permalink_help").innerHTML,function(){var a=maxkir.ui.Dialog.bindClip2Dialog(),b=$H({filterForPermalink:$("findInput")?$("findInput").value.trim():"",focusedTaskId:maxkir.TaskFocus?maxkir.TaskFocus.focusedTaskId():""}).toQueryString();new maxkir.AjaxCommand("/checklists/"+maxkir.checklist_id+"/get_permalink",{parameters:b,onSuccess:function(b){$("permalinkInDialog").value=b.responseText,$("permalinkInDialog").activate(),a.setText($F("permalinkInDialog"))}})})},maxkir.checklist.add_via_email=function(){maxkir.ui.Dialog.confirm(I18N("add_via_email_dialog_title"),$("email_in_tasks_body").innerHTML,function(){return new maxkir.AjaxRequest("/checklists/"+maxkir.checklist_id+"/email_for_add_via_email",{method:"post",onSuccess:function(){new maxkir.ui.Message(I18N("add_via_email_humanized_confirmation"))}}),!0},I18N("add_via_email_button_send"),$("email_in_tasks_help").innerHTML,function(){})},maxkir.checklist.set_option=function(a,b){maxkir.no_user?maxkir.set_flag("cl_"+a,b):new maxkir.AjaxRequest("/checklists/"+maxkir.checklist_id+"/options.json",{parameters:"options["+a+"]="+b,method:"put"})},maxkir.checklist.get_option=function(a){return maxkir.no_user?maxkir.get_flag("cl_"+a):null},maxkir.checklist.Sorter={resort_by:function(a,b){if(a=="manual"){var c=maxkir.ReorderCommand.get_sort_order();c&&maxkir.CommandProcessor.add2Queue(new maxkir.ReorderCommand(c));return}maxkir.ReorderCommand.save_sorting_parameters(),new maxkir.AjaxRequest("/checklists/"+maxkir.checklist_id+"/sort.js",{parameters:"by="+a+(b?"&parent_id="+b:""),method:"post"})},add_manual_sort_item:function(a){var b=maxkir.ReorderCommand.get_sort_order();b&&a.insert({top:'<li id="manual_sorting">            <a href="#" onclick="maxkir.cmd.sort_by(\'manual\'); return false;">Restore last manual sorting</a>         </li>'})}},maxkir.checklist.show_list_tags=function(){$("header_span").nextSiblings().each(function(a){a.hasClassName("tag")&&a.remove()});var a=maxkir.Lists.data(maxkir.checklist_id);if(a&&a.tags){var b=maxkir.TagRenderer.renderTagMap(a.tags);$("header_span").insert({after:b})}},maxkir.checklist.update_list_data_ui=function(){maxkir.checklist.show_list_tags();var a=maxkir.Lists.data(maxkir.checklist_id);a.tags&&($("header_span").innerHTML=maxkir.CommonRender.sanitize_text(a.name))},maxkir.checklist.create_name_editor=function(a){if(maxkir.read_only)return;var b=new maxkir.ui.InplaceEditor($("header_span").up(".editable"),"/checklists/"+a+".js",{okButton:!1,cancelLink:!1,fieldPostCreation:"activate",paramName:"checklist[name]",onEscUndo:function(a){this.esc_undo(maxkir.checklist.name_editor,a)},onEnterEditMode:function(){$("header_span").nextSiblings().each(function(a){(a.tagName=="SPAN"||a.tagName=="A")&&a.hide()})},onLeaveEditMode:function(){$("header_span").nextSiblings().each(function(a){(a.tagName=="SPAN"||a.tagName=="A")&&a.show()}),maxkir.checklist.show_list_tags(),maxkir.add_task.show_if_empty_list&&setTimeout(maxkir.add_task.show_if_empty_list,50),document.location.href.toString().indexOf("#newList")>0&&setTimeout(function(){document.location.hash=""},50)}},{method:"PUT",onSuccess:function(a){maxkir.Notifications.enable()}});b.updateOnSaving=function(a,b){$("header_span").innerHTML=maxkir.CommonRender.sanitize_text(b)},b.updateOnComplete=function(b){var c=maxkir.Lists.data(a).name;maxkir.set_title(c),$("header_span").innerHTML=maxkir.CommonRender.sanitize_text(c)},b.getText=function(){var b=maxkir.Lists.data(a),c=b.name;for(var d in b.tags)c+=" #"+maxkir.Tags.findOrCreate(d).tag;return c},maxkir.run_before(b,"customizeEditField",function(){var a=maxkir.Lists.data(maxkir.checklist_id).archived;if(!a){var b=this;maxkir.Lists.process_list_data(function(){maxkir.DataCompleter.uninstall(b.editField),maxkir.DataCompleter.create_completer(b.editField,{existing_tags_map:{},list_content_editing:!0})})}}),maxkir.checklist.name_editor=b},maxkir.checklist.default_name=function(){return maxkir.Lists.data(maxkir.checklist_id).name==maxkir.ChecklistRenderer.DEFAULT_LIST_TEXT},maxkir.checklist.is_introductory=function(){return maxkir.Lists.data(maxkir.checklist_id).name.indexOf("ntroduction to Checkvist")>0},maxkir.ReorderCommand=function(a){maxkir.info("Start reordering server update"),maxkir.SyncronousAjaxCommand.call(this,"/checklists/"+maxkir.checklist_id+"/tasks/0/reorder",{parameters:a||maxkir.ReorderCommand.save_sorting_parameters(),evalScripts:!0,onComplete:function(b){maxkir.info("Done reordering server update: "+b.request.success());if(!b.request.success())return;maxkir.EditTracker.is_editing()||maxkir.tree_nav.fix_selection(),maxkir.Task.update_position_data_from_ui(),maxkir.ReorderCommand.clear_sort_order(),a&&maxkir.checklist.refresh_tree()}})},maxkir.ReorderCommand.save_sorting_parameters=function(){var a=$("parentTask_0");Sortable.options(a)||maxkir.checklist.Dnd.install(!0);var b=Sortable.serialize(a);return b},maxkir.ReorderCommand.get_sort_order=function(){return localStorage.getItem("manual_sort_"+maxkir.checklist_id)},maxkir.ReorderCommand.clear_sort_order=function(){localStorage.removeItem("manual_sort_"+maxkir.checklist_id)},maxkir.install_swipe=function(a,b,c){var d,e,f,g=document.body.on("touchstart",a,function(a,b){f=!1;if(a.touches&&a.touches.length==1){var c=$(a.touches[0].target);if(c.hasClassName("userContent")||c.up(".userContent"))d=a.touches[0].pageX,e=a.touches[0].pageY,f=b}}),h=document.body.on("touchmove",function(a){f&&a.touches&&a.touches.length==1?Math.abs(e-a.touches[0].pageY)>30?f=!1:a.preventDefault&&a.preventDefault():f=!1}),i=document.body.on("touchend",function(a){if(!f)return;var e=a.changedTouches[0].pageX,g=50,h=!c&&e-d>g||c&&d-e>g;h&&b.call(f,f,a),f=!1});return{stop:function(){g.stop(),h.stop(),i.stop()}}},maxkir.ui.ImageEditPopup=maxkir.ui.create_popup(!1,{popup_width:"auto",refresh:function(){var a=this.win,b=parseInt(this.options.current_scale);b||(b=100);var c="";[50,75,100].forEach(function(a){a===b?c+="<span>"+a+"%</span>":c+="<a href='#' data-scale="+a+">"+a+"%</a>"}),a.setHTMLContent("<div class='imageEditPopup'>"+c+"<a href='#' data-scale=0 class=imageEditPopup__unembed title='"+I18N("js_unembed_title")+"'>Unembed</a>"+"</div>")},onShow:function(){var a=this.win.element.on("click",".imageEditPopup > a",function(a){a.preventDefault();var b=a.target.getAttribute("data-scale");this._rescale(b),this.hide_popup()}.bind(this));this.win.addDisposerOnClose(function(){a.stop()})},_rescale:function(a){var b=maxkir.Task.data(this.options.task_id),c=this.options.image_name;a>0?maxkir.ImageScaler.rescale(b,c,a):maxkir.ImageScaler.unembed(b,c)},show_popup_img:function(a){var b=a.getAttribute("data-imgUrl"),c=a.getAttribute("data-scale"),d=maxkir.Task.id_str(a.closest(".task").id);b&&!maxkir.Task.read_only(d)&&maxkir.ui.ImageEditPopup.show_popup(a,{removeOtherPopups:!1,className:"cl2",y_shift:-a.offsetHeight-1,task_id:d,image_name:b,current_scale:c,img:a})},start_closing:function(){this._closer=setTimeout(function(){maxkir.ui.ImageEditPopup.hide_popup()},300)},stop_hiding:function(){this._closer&&(clearTimeout(this._closer),this._closer=null)},install:function(){maxkir.info("Installing on-hover image editor");var a=this;$(document.body).on("mouseover",".imageEditPopup",function(b){a.stop_hiding()}),$(document.body).on("mouseover",".renderedImages > img",function(b){a.stop_hiding(),maxkir.ui.ImageEditPopup.options&&maxkir.ui.ImageEditPopup.options.img!==b.target.closest("img")&&maxkir.ui.ImageEditPopup.hide_popup(),maxkir.ui.ImageEditPopup.is_visible()||maxkir.ui.ImageEditPopup.show_popup_img(b.target.closest("img"))}),$(document.body).on("mouseout",".renderedImages > img",function(b){a.start_closing()}),$(document.body).on("mouseout",".imageEditPopup",function(b){a.start_closing()})},f_:null}),maxkir.onDom(function(){maxkir.ui.ImageEditPopup.install()}),function(){var a=(new Date).getDate();setInterval(function(){if(a!=(new Date).getDate()||maxkir._force_refresh)if(!maxkir.EditTracker||!maxkir.EditTracker.is_editing_non_empty())a=(new Date).getDate(),maxkir.info("Reload page due to day change"),maxkir.Undo?maxkir.Undo.refresh():document.location.reload()},6e4)}(),maxkir.DeletedTasks={show_dialog:function(a){this.checklist_id=a;var b=this;maxkir.ui.Dialog.confirm(I18N("deleted_tasks_title"),$("_deletedTasksTemplate").innerHTML,function(a){b.restore_selected()},I18N("deleted_tasks_ok_text"),I18N("deleted_tasks_help"),b.onShow.bind(b),b.onHide.bind(b),{className:"deletedTasksDialog alert",width:"auto"})},restore_selected:function(){var a=maxkir.TreeSelectionHandler(this.tree_nav),b=a.task_ids_no_can_run_check();return b.length&&a.pro_ok(b)?(maxkir.info("Restoring deleted items",b),maxkir.AjaxCommand("/checklists/"+this.checklist_id+"/tasks/restore",{parameters:"task_ids="+b.join(","),onSuccess:function(){this._remove_old_elements(b);var a="task_"+b[b.length-1];maxkir.tree_nav.set_selection(a),this._load_data(!0)}.bind(this)}),!0):!1},onShow:function(a){this.win=a;var b=a.element.down(".deletedTasksContainer"),c=b.down("ul");this.doubleScroll=maxkir.double_scroll(b),c.identify(),this._install_tree(c),this.doubleScroll.start(),this._update_title(),this._load_data()},_remove_old_elements:function(a){var b=this.win.element.down(".deletedTasksContainer");a.forEach(function(a){var c=b.down("#task_"+a);c&&c.remove()})},_load_data:function(a){var b=this,c=this.win,d=c.element.down(".deletedTasksContainer");this._load_deleted_items(function e(e){b._tasks=e,b._render_tasks(d.down("ul"));if(b._deleted_count()==0){if(a){b.win.close();return}b._tasks=[],d.down(".noDeletedMessage").show(),d.down("ul").hide(),d.down("ul").innerHTML="",d.style.height="auto",$("ok_button_dialog").hide(),c.height=null,c.computeBounds(),c.updateHeight(),c._recenter()}b._update_title()})},onHide:function(a){this.doubleScroll.stop(),this.tree_handler&&(this.tree_handler.stop(),this.keyboard_manager.dispose(),this.tree_nav=null)},_load_deleted_items:function(a){var b=this;new maxkir.AjaxRequest("/checklists/"+this.checklist_id+"/tasks.json?deleted=true",{method:"GET",onFailure:function(){new maxkir.ui.Message(I18N("deleted_tasks_error_load")),b.win.close()},onSuccess:function(b){a(b.responseJSON)}})},_render_tasks:function(a){var b="",c={},d=[],e=function(a){return c[a]};this._tasks.forEach(function(a){c[a.id]=a}),this._tasks.forEach(function(a){c[a.parent_id]||d.push(a)});var f=function(a,b){return a=new Date(a.updated_at),b=new Date(b.updated_at),b.getTime()-a.getTime()};d=d.sort(f);var g=function(a){return!a.updated_at||(new Date(a.updated_at)).getTime()>(new Date).getTime()-864e5};d.forEach(function(a){var c=new maxkir.TaskRenderer(a,!0,e);g(a)&&(b+=c.getLiHtml())},this),a.innerHTML=b,this._update_title(),this.tree_nav&&(this.tree_nav.selectFirstInTree(),this.node_toggler.collapse_all())},_deleted_count:function(){var a=this.win.element.down(".deletedTasksContainer");return a.select("li.task").length},_update_title:function(){var a=this.win.element.down(".dialog_title");a.style.position="relative",a.innerHTML='<span class="titlePermanent">'+I18N("deleted_tasks_title")+"</span>";var b=a.down("span");if(this._deleted_count()>0){var c=a.down(".count");c||(c=new Element("span"),a.appendChild(c),c.className="count",c.setStyle({position:"absolute",top:0,left:b.offsetLeft+b.offsetWidth+5+"px"})),c.innerHTML=" ("+this._deleted_count()+")"}else{var c=a.down(".count");c&&c.remove()}},_install_tree:function(a){var b=new maxkir.TreeModel(a.id),c=new maxkir.TreeNavigation(b,"del_"+this.checklist_id,"selectedTask",!0),d=maxkir.NodeToggler(b);maxkir.TreeAddOn(c,d),this.tree_handler=c.install_basic_behaviour(),this.keyboard_manager=new maxkir.KbdManager,maxkir.TreeKbdNavigationInstall(this.keyboard_manager,c,d),this.keyboard_manager.addShortcut("r d",function(){this.restore_selected()}.bind(this)),c.selectFirstInTree(),d.collapse_all(),this.win.initSmoothMove(),this.tree_nav=c,this.node_toggler=d}},maxkir.Print={_options:{},is_shown:function(){return typeof this._shown=="undefined"&&(this._shown=maxkir.visible($("printOptionsSidebar"))),this._shown},set_option:function(a,b){a=="option_print_notes"&&this._el()&&maxkir.Comments?maxkir.CommentsAll.expand_all(b):a=="option_print_author_time"&&this._el()?maxkir.DetailsMode.set_value(b):this._el()&&(this.unset(a),b===!0?this._el().addClassName(a):typeof b=="string"&&this._el().addClassName(b),this._setOptionInner(a,b))},_get:function(a){return a=="option_print_author_time"?maxkir.DetailsMode.on():this._options[a]},unset:function(a){this._el().removeClassName(a),this._el().removeClassName(this._get(a))},_setOptionInner:function(a,b){this._options[a]=b,localStorage.setItem("printOptions",Object.toJSON(this._options))},_el:function(){return this.el=this.el||$$(".layoutDiv")[0],this.el},initialize:function(){this.is_shown()&&(maxkir.read_only=!0,this.set_click_handlers(),this.init_inner_state())},set_click_handlers:function(){$("printOptionsSidebar").on("click","input[type=checkbox]",function(a,b){maxkir.Print.set_option(b.id,b.checked)})},init_inner_state:function(){try{this._options=null,this._options=localStorage.getItem("printOptions").evalJSON()}catch(a){}var b=this;this._options?$("printOptionsSidebar").select("input[type=checkbox]").each(function(a){a.checked=b._get(a.id)}):this._options={},$("printOptionsSidebar").select("input[type=checkbox]").each(function(a){b.set_option(a.id,a.checked)}),setTimeout(function(){maxkir.checklist.ListBulletStyle&&maxkir.checklist.ListBulletStyle.set_current_option($("printOptionsContent").select(".listStyleControl")[0])},1e3)},reset_saved:function(){this._options={},this.el=null}},maxkir.onDom(function(){maxkir.Print.initialize()})